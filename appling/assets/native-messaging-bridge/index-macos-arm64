24210
{"version":0,"id":"e2b85048ae254af872b01f44095c6032019b7ef5ba2d05a4e1da1e0e08d26ff8","main":"/index.js","imports":{},"resolutions":{"/../../node_modules/events/events.js":{"#package":"/../../node_modules/events/package.json"},"/../../node_modules/events/package.json":{},"/commandDefinitions.js":{"#package":"/package.json"},"/index.js":{"#package":"/package.json","./commandDefinitions.js":"/commandDefinitions.js","./nativeMessagingHandler.js":"/nativeMessagingHandler.js","./utils.js":"/utils.js","pear-ipc":"/node_modules/pear-ipc/index.js"},"/nativeMessagingHandler.js":{"#package":"/package.json","./nativeMessagingProtocol.js":"/nativeMessagingProtocol.js","./utils":"/utils.js","events":"/../../node_modules/events/events.js"},"/nativeMessagingProtocol.js":{"#package":"/package.json"},"/node_modules/b4a/index.js":{"#package":"/node_modules/b4a/package.json"},"/node_modules/b4a/package.json":{},"/node_modules/bare-addon-resolve/index.js":{"#package":"/node_modules/bare-addon-resolve/package.json","./lib/errors":"/node_modules/bare-addon-resolve/lib/errors.js","bare-module-resolve":"/node_modules/bare-module-resolve/index.js","bare-semver":"/node_modules/bare-semver/index.js"},"/node_modules/bare-addon-resolve/lib/errors.js":{"#package":"/node_modules/bare-addon-resolve/package.json"},"/node_modules/bare-addon-resolve/package.json":{},"/node_modules/bare-events/index.js":{"#package":"/node_modules/bare-events/package.json","./lib/errors":"/node_modules/bare-events/lib/errors.js"},"/node_modules/bare-events/lib/errors.js":{"#package":"/node_modules/bare-events/package.json"},"/node_modules/bare-events/package.json":{},"/node_modules/bare-fs/binding.js":{"#package":"/node_modules/bare-fs/package.json",".":"/node_modules/bare-fs/prebuilds/darwin-arm64/bare-fs.bare"},"/node_modules/bare-fs/index.js":{"#package":"/node_modules/bare-fs/package.json","./binding":"/node_modules/bare-fs/binding.js","./lib/constants":"/node_modules/bare-fs/lib/constants.js","./lib/errors":"/node_modules/bare-fs/lib/errors.js","./promises":"/node_modules/bare-fs/promises.js","bare-events":"/node_modules/bare-events/index.js","bare-path":"/node_modules/bare-path/index.js","bare-stream":"/node_modules/bare-stream/index.js","bare-url":"/node_modules/bare-url/index.js","fast-fifo":"/node_modules/fast-fifo/index.js"},"/node_modules/bare-fs/lib/constants.js":{"#package":"/node_modules/bare-fs/package.json","../binding":"/node_modules/bare-fs/binding.js"},"/node_modules/bare-fs/lib/errors.js":{"#package":"/node_modules/bare-fs/package.json","bare-os":"/node_modules/bare-os/index.js"},"/node_modules/bare-fs/package.json":{},"/node_modules/bare-fs/prebuilds/darwin-arm64/bare-fs.bare":{"#package":"/node_modules/bare-fs/package.json"},"/node_modules/bare-fs/promises.js":{"#package":"/node_modules/bare-fs/package.json",".":"/node_modules/bare-fs/index.js","bare-events":"/node_modules/bare-events/index.js"},"/node_modules/bare-module-resolve/index.js":{"#package":"/node_modules/bare-module-resolve/package.json","./lib/errors":"/node_modules/bare-module-resolve/lib/errors.js","bare-semver":"/node_modules/bare-semver/index.js"},"/node_modules/bare-module-resolve/lib/errors.js":{"#package":"/node_modules/bare-module-resolve/package.json"},"/node_modules/bare-module-resolve/package.json":{},"/node_modules/bare-os/binding.js":{"#package":"/node_modules/bare-os/package.json",".":"/node_modules/bare-os/prebuilds/darwin-arm64/bare-os.bare"},"/node_modules/bare-os/index.js":{"#package":"/node_modules/bare-os/package.json","./binding":"/node_modules/bare-os/binding.js","./lib/constants":"/node_modules/bare-os/lib/constants.js","./lib/errors":"/node_modules/bare-os/lib/errors.js"},"/node_modules/bare-os/lib/constants.js":{"#package":"/node_modules/bare-os/package.json","../binding":"/node_modules/bare-os/binding.js"},"/node_modules/bare-os/lib/errors.js":{"#package":"/node_modules/bare-os/package.json"},"/node_modules/bare-os/package.json":{},"/node_modules/bare-os/prebuilds/darwin-arm64/bare-os.bare":{"#package":"/node_modules/bare-os/package.json"},"/node_modules/bare-path/index.js":{"#package":"/node_modules/bare-path/package.json","./lib/posix":"/node_modules/bare-path/lib/posix.js","./lib/win32":"/node_modules/bare-path/lib/win32.js"},"/node_modules/bare-path/lib/constants.js":{"#package":"/node_modules/bare-path/package.json"},"/node_modules/bare-path/lib/posix.js":{"#package":"/node_modules/bare-path/package.json","./constants":"/node_modules/bare-path/lib/constants.js","./shared":"/node_modules/bare-path/lib/shared.js","./win32":"/node_modules/bare-path/lib/win32.js","bare-os":"/node_modules/bare-os/index.js"},"/node_modules/bare-path/lib/shared.js":{"#package":"/node_modules/bare-path/package.json","./constants":"/node_modules/bare-path/lib/constants.js"},"/node_modules/bare-path/lib/win32.js":{"#package":"/node_modules/bare-path/package.json","./constants":"/node_modules/bare-path/lib/constants.js","./posix":"/node_modules/bare-path/lib/posix.js","./shared":"/node_modules/bare-path/lib/shared.js","bare-os":"/node_modules/bare-os/index.js"},"/node_modules/bare-path/package.json":{},"/node_modules/bare-pipe/binding.js":{"#package":"/node_modules/bare-pipe/package.json",".":"/node_modules/bare-pipe/prebuilds/darwin-arm64/bare-pipe.bare"},"/node_modules/bare-pipe/index.js":{"#package":"/node_modules/bare-pipe/package.json","./binding":"/node_modules/bare-pipe/binding.js","./lib/constants":"/node_modules/bare-pipe/lib/constants.js","./lib/errors":"/node_modules/bare-pipe/lib/errors.js","bare-events":"/node_modules/bare-events/index.js","bare-stream":"/node_modules/bare-stream/index.js"},"/node_modules/bare-pipe/lib/constants.js":{"#package":"/node_modules/bare-pipe/package.json"},"/node_modules/bare-pipe/lib/errors.js":{"#package":"/node_modules/bare-pipe/package.json"},"/node_modules/bare-pipe/package.json":{},"/node_modules/bare-pipe/prebuilds/darwin-arm64/bare-pipe.bare":{"#package":"/node_modules/bare-pipe/package.json"},"/node_modules/bare-semver/index.js":{"#package":"/node_modules/bare-semver/package.json","./lib/comparator":"/node_modules/bare-semver/lib/comparator.js","./lib/constants":"/node_modules/bare-semver/lib/constants.js","./lib/errors":"/node_modules/bare-semver/lib/errors.js","./lib/range":"/node_modules/bare-semver/lib/range.js","./lib/version":"/node_modules/bare-semver/lib/version.js"},"/node_modules/bare-semver/lib/comparator.js":{"#package":"/node_modules/bare-semver/package.json","./constants":"/node_modules/bare-semver/lib/constants.js"},"/node_modules/bare-semver/lib/constants.js":{"#package":"/node_modules/bare-semver/package.json"},"/node_modules/bare-semver/lib/errors.js":{"#package":"/node_modules/bare-semver/package.json"},"/node_modules/bare-semver/lib/range.js":{"#package":"/node_modules/bare-semver/package.json","./comparator":"/node_modules/bare-semver/lib/comparator.js","./constants":"/node_modules/bare-semver/lib/constants.js","./errors":"/node_modules/bare-semver/lib/errors.js","./version":"/node_modules/bare-semver/lib/version.js"},"/node_modules/bare-semver/lib/version.js":{"#package":"/node_modules/bare-semver/package.json","./errors":"/node_modules/bare-semver/lib/errors.js"},"/node_modules/bare-semver/package.json":{},"/node_modules/bare-stream/index.js":{"#package":"/node_modules/bare-stream/package.json","streamx":"/node_modules/streamx/index.js"},"/node_modules/bare-stream/package.json":{},"/node_modules/bare-url/binding.js":{"#package":"/node_modules/bare-url/package.json",".":"/node_modules/bare-url/prebuilds/darwin-arm64/bare-url.bare"},"/node_modules/bare-url/index.js":{"#package":"/node_modules/bare-url/package.json","./binding":"/node_modules/bare-url/binding.js","./lib/errors":"/node_modules/bare-url/lib/errors.js","./lib/url-search-params":"/node_modules/bare-url/lib/url-search-params.js","bare-path":"/node_modules/bare-path/index.js"},"/node_modules/bare-url/lib/errors.js":{"#package":"/node_modules/bare-url/package.json"},"/node_modules/bare-url/lib/url-search-params.js":{"#package":"/node_modules/bare-url/package.json"},"/node_modules/bare-url/package.json":{},"/node_modules/bare-url/prebuilds/darwin-arm64/bare-url.bare":{"#package":"/node_modules/bare-url/package.json"},"/node_modules/compact-encoding/endian.js":{"#package":"/node_modules/compact-encoding/package.json"},"/node_modules/compact-encoding/index.js":{"#package":"/node_modules/compact-encoding/package.json","./endian":"/node_modules/compact-encoding/endian.js","./lexint":"/node_modules/compact-encoding/lexint.js","./raw":"/node_modules/compact-encoding/raw.js","b4a":"/node_modules/b4a/index.js"},"/node_modules/compact-encoding/lexint.js":{"#package":"/node_modules/compact-encoding/package.json"},"/node_modules/compact-encoding/package.json":{},"/node_modules/compact-encoding/raw.js":{"#package":"/node_modules/compact-encoding/package.json","./endian":"/node_modules/compact-encoding/endian.js","b4a":"/node_modules/b4a/index.js"},"/node_modules/fast-fifo/fixed-size.js":{"#package":"/node_modules/fast-fifo/package.json"},"/node_modules/fast-fifo/index.js":{"#package":"/node_modules/fast-fifo/package.json","./fixed-size":"/node_modules/fast-fifo/fixed-size.js"},"/node_modules/fast-fifo/package.json":{},"/node_modules/framed-stream/index.js":{"#package":"/node_modules/framed-stream/package.json","b4a":"/node_modules/b4a/index.js","streamx":"/node_modules/streamx/index.js"},"/node_modules/framed-stream/package.json":{},"/node_modules/fs-native-extensions/binding.js":{"#package":"/node_modules/fs-native-extensions/package.json",".":"/node_modules/fs-native-extensions/prebuilds/darwin-arm64/fs-native-extensions.bare","require-addon":"/node_modules/require-addon/index.js"},"/node_modules/fs-native-extensions/index.js":{"#package":"/node_modules/fs-native-extensions/package.json","./binding":"/node_modules/fs-native-extensions/binding.js","which-runtime":"/node_modules/which-runtime/index.js"},"/node_modules/fs-native-extensions/package.json":{},"/node_modules/fs-native-extensions/prebuilds/darwin-arm64/fs-native-extensions.bare":{"#package":"/node_modules/fs-native-extensions/package.json"},"/node_modules/pear-ipc/api.js":{"#package":"/node_modules/pear-ipc/package.json","fs":"/node_modules/bare-fs/index.js","fs-native-extensions":"/node_modules/fs-native-extensions/index.js"},"/node_modules/pear-ipc/client.js":{"#package":"/node_modules/pear-ipc/package.json","./api":"/node_modules/pear-ipc/api.js","./constants":"/node_modules/pear-ipc/constants.js","./methods":"/node_modules/pear-ipc/methods.js","framed-stream":"/node_modules/framed-stream/index.js","net":"/node_modules/bare-pipe/index.js","path":"/node_modules/bare-path/index.js","ready-resource":"/node_modules/ready-resource/index.js","tiny-buffer-rpc":"/node_modules/tiny-buffer-rpc/index.js","tiny-buffer-rpc/any":"/node_modules/tiny-buffer-rpc/any.js","which-runtime":"/node_modules/which-runtime/index.js"},"/node_modules/pear-ipc/constants.js":{"#package":"/node_modules/pear-ipc/package.json","os":"/node_modules/bare-os/index.js","path":"/node_modules/bare-path/index.js","which-runtime":"/node_modules/which-runtime/index.js"},"/node_modules/pear-ipc/index.js":{"#package":"/node_modules/pear-ipc/package.json","./client":"/node_modules/pear-ipc/client.js","./server":"/node_modules/pear-ipc/server.js"},"/node_modules/pear-ipc/methods.js":{"#package":"/node_modules/pear-ipc/package.json"},"/node_modules/pear-ipc/package.json":{},"/node_modules/pear-ipc/server.js":{"#package":"/node_modules/pear-ipc/package.json","./api":"/node_modules/pear-ipc/api.js","./constants":"/node_modules/pear-ipc/constants.js","./methods":"/node_modules/pear-ipc/methods.js","framed-stream":"/node_modules/framed-stream/index.js","fs":"/node_modules/bare-fs/index.js","net":"/node_modules/bare-pipe/index.js","path":"/node_modules/bare-path/index.js","ready-resource":"/node_modules/ready-resource/index.js","streamx":"/node_modules/streamx/index.js","tiny-buffer-rpc":"/node_modules/tiny-buffer-rpc/index.js","tiny-buffer-rpc/any":"/node_modules/tiny-buffer-rpc/any.js","which-runtime":"/node_modules/which-runtime/index.js"},"/node_modules/ready-resource/index.js":{"#package":"/node_modules/ready-resource/package.json","events":"/node_modules/bare-events/index.js"},"/node_modules/ready-resource/package.json":{},"/node_modules/require-addon/index.js":{"#package":"/node_modules/require-addon/package.json","./lib/runtime":"/node_modules/require-addon/lib/runtime.js","./lib/runtime/bare":"/node_modules/require-addon/lib/runtime/bare.js","./lib/runtime/default":"/node_modules/require-addon/lib/runtime/default.js","./lib/runtime/node":"/node_modules/require-addon/lib/runtime/node.js"},"/node_modules/require-addon/lib/runtime.js":{"#package":"/node_modules/require-addon/package.json"},"/node_modules/require-addon/lib/runtime/bare.js":{"#package":"/node_modules/require-addon/package.json"},"/node_modules/require-addon/lib/runtime/default.js":{"#package":"/node_modules/require-addon/package.json"},"/node_modules/require-addon/lib/runtime/node.js":{"#package":"/node_modules/require-addon/package.json","bare-addon-resolve":"/node_modules/bare-addon-resolve/index.js","url":"/node_modules/bare-url/index.js"},"/node_modules/require-addon/package.json":{},"/node_modules/safety-catch/index.js":{"#package":"/node_modules/safety-catch/package.json"},"/node_modules/safety-catch/package.json":{},"/node_modules/streamx/index.js":{"#package":"/node_modules/streamx/package.json","events":"/node_modules/bare-events/index.js","fast-fifo":"/node_modules/fast-fifo/index.js","text-decoder":"/node_modules/text-decoder/index.js"},"/node_modules/streamx/package.json":{},"/node_modules/text-decoder/index.js":{"#package":"/node_modules/text-decoder/package.json","./lib/pass-through-decoder":"/node_modules/text-decoder/lib/pass-through-decoder.js","./lib/utf8-decoder":"/node_modules/text-decoder/lib/utf8-decoder.js"},"/node_modules/text-decoder/lib/pass-through-decoder.js":{"#package":"/node_modules/text-decoder/package.json","b4a":"/node_modules/b4a/index.js"},"/node_modules/text-decoder/lib/utf8-decoder.js":{"#package":"/node_modules/text-decoder/package.json","b4a":"/node_modules/b4a/index.js"},"/node_modules/text-decoder/package.json":{},"/node_modules/tiny-buffer-rpc/any.js":{"#package":"/node_modules/tiny-buffer-rpc/package.json","b4a":"/node_modules/b4a/index.js","compact-encoding":"/node_modules/compact-encoding/index.js"},"/node_modules/tiny-buffer-rpc/index.js":{"#package":"/node_modules/tiny-buffer-rpc/package.json","./messages.js":"/node_modules/tiny-buffer-rpc/messages.js","b4a":"/node_modules/b4a/index.js","compact-encoding":"/node_modules/compact-encoding/index.js","safety-catch":"/node_modules/safety-catch/index.js","streamx":"/node_modules/streamx/index.js"},"/node_modules/tiny-buffer-rpc/messages.js":{"#package":"/node_modules/tiny-buffer-rpc/package.json","compact-encoding":"/node_modules/compact-encoding/index.js"},"/node_modules/tiny-buffer-rpc/package.json":{},"/node_modules/which-runtime/index.js":{"#package":"/node_modules/which-runtime/package.json"},"/node_modules/which-runtime/package.json":{},"/package.json":{},"/utils.js":{"#package":"/package.json","bare-fs":"/node_modules/bare-fs/index.js","bare-os":"/node_modules/bare-os/index.js","bare-path":"/node_modules/bare-path/index.js"}},"addons":["/node_modules/bare-fs/prebuilds/darwin-arm64/bare-fs.bare","/node_modules/bare-os/prebuilds/darwin-arm64/bare-os.bare","/node_modules/bare-pipe/prebuilds/darwin-arm64/bare-pipe.bare","/node_modules/bare-url/prebuilds/darwin-arm64/bare-url.bare","/node_modules/fs-native-extensions/prebuilds/darwin-arm64/fs-native-extensions.bare"],"assets":[],"files":{"/../../node_modules/events/events.js":{"offset":0,"length":14890,"mode":420},"/../../node_modules/events/package.json":{"offset":14890,"length":859,"mode":420},"/commandDefinitions.js":{"offset":15749,"length":2206,"mode":420},"/index.js":{"offset":17955,"length":12092,"mode":420},"/nativeMessagingHandler.js":{"offset":30047,"length":9099,"mode":420},"/nativeMessagingProtocol.js":{"offset":39146,"length":1410,"mode":420},"/node_modules/b4a/index.js":{"offset":40556,"length":4092,"mode":420},"/node_modules/b4a/package.json":{"offset":44648,"length":701,"mode":420},"/node_modules/bare-addon-resolve/index.js":{"offset":45349,"length":10801,"mode":420},"/node_modules/bare-addon-resolve/lib/errors.js":{"offset":56150,"length":642,"mode":420},"/node_modules/bare-addon-resolve/package.json":{"offset":56792,"length":1175,"mode":420},"/node_modules/bare-events/index.js":{"offset":57967,"length":7322,"mode":420},"/node_modules/bare-events/lib/errors.js":{"offset":65289,"length":711,"mode":420},"/node_modules/bare-events/package.json":{"offset":66000,"length":944,"mode":420},"/node_modules/bare-fs/binding.js":{"offset":66944,"length":33,"mode":420},"/node_modules/bare-fs/index.js":{"offset":66977,"length":48249,"mode":420},"/node_modules/bare-fs/lib/constants.js":{"offset":115226,"length":1494,"mode":420},"/node_modules/bare-fs/lib/errors.js":{"offset":116720,"length":1163,"mode":420},"/node_modules/bare-fs/package.json":{"offset":117883,"length":1546,"mode":420},"/node_modules/bare-fs/prebuilds/darwin-arm64/bare-fs.bare":{"offset":119429,"length":75552,"mode":420},"/node_modules/bare-fs/promises.js":{"offset":194981,"length":1866,"mode":420},"/node_modules/bare-module-resolve/index.js":{"offset":196847,"length":21131,"mode":420},"/node_modules/bare-module-resolve/lib/errors.js":{"offset":217978,"length":1195,"mode":420},"/node_modules/bare-module-resolve/package.json":{"offset":219173,"length":1143,"mode":420},"/node_modules/bare-os/binding.js":{"offset":220316,"length":33,"mode":420},"/node_modules/bare-os/index.js":{"offset":220349,"length":2433,"mode":420},"/node_modules/bare-os/lib/constants.js":{"offset":222782,"length":113,"mode":420},"/node_modules/bare-os/lib/errors.js":{"offset":222895,"length":479,"mode":420},"/node_modules/bare-os/package.json":{"offset":223374,"length":1023,"mode":420},"/node_modules/bare-os/prebuilds/darwin-arm64/bare-os.bare":{"offset":224397,"length":71952,"mode":420},"/node_modules/bare-path/index.js":{"offset":296349,"length":306,"mode":420},"/node_modules/bare-path/lib/constants.js":{"offset":296655,"length":247,"mode":420},"/node_modules/bare-path/lib/posix.js":{"offset":296902,"length":5991,"mode":420},"/node_modules/bare-path/lib/shared.js":{"offset":302893,"length":1888,"mode":420},"/node_modules/bare-path/lib/win32.js":{"offset":304781,"length":13427,"mode":420},"/node_modules/bare-path/package.json":{"offset":318208,"length":796,"mode":420},"/node_modules/bare-pipe/binding.js":{"offset":319004,"length":33,"mode":420},"/node_modules/bare-pipe/index.js":{"offset":319037,"length":10662,"mode":420},"/node_modules/bare-pipe/lib/constants.js":{"offset":329699,"length":188,"mode":420},"/node_modules/bare-pipe/lib/errors.js":{"offset":329887,"length":711,"mode":420},"/node_modules/bare-pipe/package.json":{"offset":330598,"length":1255,"mode":420},"/node_modules/bare-pipe/prebuilds/darwin-arm64/bare-pipe.bare":{"offset":331853,"length":54128,"mode":420},"/node_modules/bare-semver/index.js":{"offset":385981,"length":469,"mode":420},"/node_modules/bare-semver/lib/comparator.js":{"offset":386450,"length":705,"mode":420},"/node_modules/bare-semver/lib/constants.js":{"offset":387155,"length":67,"mode":420},"/node_modules/bare-semver/lib/errors.js":{"offset":387222,"length":529,"mode":420},"/node_modules/bare-semver/lib/range.js":{"offset":387751,"length":2429,"mode":420},"/node_modules/bare-semver/lib/version.js":{"offset":390180,"length":3824,"mode":420},"/node_modules/bare-semver/package.json":{"offset":394004,"length":868,"mode":420},"/node_modules/bare-stream/index.js":{"offset":394872,"length":7649,"mode":420},"/node_modules/bare-stream/package.json":{"offset":402521,"length":1237,"mode":420},"/node_modules/bare-url/binding.js":{"offset":403758,"length":33,"mode":420},"/node_modules/bare-url/index.js":{"offset":403791,"length":9506,"mode":420},"/node_modules/bare-url/lib/errors.js":{"offset":413297,"length":881,"mode":420},"/node_modules/bare-url/lib/url-search-params.js":{"offset":414178,"length":3883,"mode":420},"/node_modules/bare-url/package.json":{"offset":418061,"length":1104,"mode":420},"/node_modules/bare-url/prebuilds/darwin-arm64/bare-url.bare":{"offset":419165,"length":124688,"mode":420},"/node_modules/compact-encoding/endian.js":{"offset":543853,"length":103,"mode":420},"/node_modules/compact-encoding/index.js":{"offset":543956,"length":19082,"mode":420},"/node_modules/compact-encoding/lexint.js":{"offset":563038,"length":2824,"mode":420},"/node_modules/compact-encoding/package.json":{"offset":565862,"length":713,"mode":420},"/node_modules/compact-encoding/raw.js":{"offset":566575,"length":4118,"mode":420},"/node_modules/fast-fifo/fixed-size.js":{"offset":570693,"length":875,"mode":420},"/node_modules/fast-fifo/index.js":{"offset":571568,"length":972,"mode":420},"/node_modules/fast-fifo/package.json":{"offset":572540,"length":682,"mode":420},"/node_modules/framed-stream/index.js":{"offset":573222,"length":3358,"mode":420},"/node_modules/framed-stream/package.json":{"offset":576580,"length":720,"mode":420},"/node_modules/fs-native-extensions/binding.js":{"offset":577300,"length":90,"mode":420},"/node_modules/fs-native-extensions/index.js":{"offset":577390,"length":6339,"mode":420},"/node_modules/fs-native-extensions/package.json":{"offset":583729,"length":1609,"mode":420},"/node_modules/fs-native-extensions/prebuilds/darwin-arm64/fs-native-extensions.bare":{"offset":585338,"length":90280,"mode":420},"/node_modules/pear-ipc/api.js":{"offset":675618,"length":1527,"mode":420},"/node_modules/pear-ipc/client.js":{"offset":677145,"length":5035,"mode":420},"/node_modules/pear-ipc/constants.js":{"offset":682180,"length":721,"mode":420},"/node_modules/pear-ipc/index.js":{"offset":682901,"length":164,"mode":420},"/node_modules/pear-ipc/methods.js":{"offset":683065,"length":1625,"mode":420},"/node_modules/pear-ipc/package.json":{"offset":684690,"length":1300,"mode":420},"/node_modules/pear-ipc/server.js":{"offset":685990,"length":7600,"mode":420},"/node_modules/ready-resource/index.js":{"offset":693590,"length":1091,"mode":420},"/node_modules/ready-resource/package.json":{"offset":694681,"length":769,"mode":420},"/node_modules/require-addon/index.js":{"offset":695450,"length":262,"mode":420},"/node_modules/require-addon/lib/runtime.js":{"offset":695712,"length":130,"mode":420},"/node_modules/require-addon/lib/runtime/bare.js":{"offset":695842,"length":45,"mode":420},"/node_modules/require-addon/lib/runtime/default.js":{"offset":695887,"length":260,"mode":420},"/node_modules/require-addon/lib/runtime/node.js":{"offset":696147,"length":1073,"mode":420},"/node_modules/require-addon/package.json":{"offset":697220,"length":1335,"mode":420},"/node_modules/safety-catch/index.js":{"offset":698555,"length":506,"mode":420},"/node_modules/safety-catch/package.json":{"offset":699061,"length":547,"mode":420},"/node_modules/streamx/index.js":{"offset":699608,"length":33340,"mode":420},"/node_modules/streamx/package.json":{"offset":732948,"length":912,"mode":420},"/node_modules/text-decoder/index.js":{"offset":733860,"length":1378,"mode":420},"/node_modules/text-decoder/lib/pass-through-decoder.js":{"offset":735238,"length":273,"mode":420},"/node_modules/text-decoder/lib/utf8-decoder.js":{"offset":735511,"length":2529,"mode":420},"/node_modules/text-decoder/package.json":{"offset":738040,"length":987,"mode":420},"/node_modules/tiny-buffer-rpc/any.js":{"offset":739027,"length":2475,"mode":420},"/node_modules/tiny-buffer-rpc/index.js":{"offset":741502,"length":11956,"mode":420},"/node_modules/tiny-buffer-rpc/messages.js":{"offset":753458,"length":2160,"mode":420},"/node_modules/tiny-buffer-rpc/package.json":{"offset":755618,"length":713,"mode":420},"/node_modules/which-runtime/index.js":{"offset":756331,"length":1248,"mode":420},"/node_modules/which-runtime/package.json":{"offset":757579,"length":602,"mode":420},"/package.json":{"offset":758181,"length":835,"mode":420},"/utils.js":{"offset":759016,"length":1391,"mode":420}}}
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

'use strict';

var R = typeof Reflect === 'object' ? Reflect : null
var ReflectApply = R && typeof R.apply === 'function'
  ? R.apply
  : function ReflectApply(target, receiver, args) {
    return Function.prototype.apply.call(target, receiver, args);
  }

var ReflectOwnKeys
if (R && typeof R.ownKeys === 'function') {
  ReflectOwnKeys = R.ownKeys
} else if (Object.getOwnPropertySymbols) {
  ReflectOwnKeys = function ReflectOwnKeys(target) {
    return Object.getOwnPropertyNames(target)
      .concat(Object.getOwnPropertySymbols(target));
  };
} else {
  ReflectOwnKeys = function ReflectOwnKeys(target) {
    return Object.getOwnPropertyNames(target);
  };
}

function ProcessEmitWarning(warning) {
  if (console && console.warn) console.warn(warning);
}

var NumberIsNaN = Number.isNaN || function NumberIsNaN(value) {
  return value !== value;
}

function EventEmitter() {
  EventEmitter.init.call(this);
}
module.exports = EventEmitter;
module.exports.once = once;

// Backwards-compat with node 0.10.x
EventEmitter.EventEmitter = EventEmitter;

EventEmitter.prototype._events = undefined;
EventEmitter.prototype._eventsCount = 0;
EventEmitter.prototype._maxListeners = undefined;

// By default EventEmitters will print a warning if more than 10 listeners are
// added to it. This is a useful default which helps finding memory leaks.
var defaultMaxListeners = 10;

function checkListener(listener) {
  if (typeof listener !== 'function') {
    throw new TypeError('The "listener" argument must be of type Function. Received type ' + typeof listener);
  }
}

Object.defineProperty(EventEmitter, 'defaultMaxListeners', {
  enumerable: true,
  get: function() {
    return defaultMaxListeners;
  },
  set: function(arg) {
    if (typeof arg !== 'number' || arg < 0 || NumberIsNaN(arg)) {
      throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received ' + arg + '.');
    }
    defaultMaxListeners = arg;
  }
});

EventEmitter.init = function() {

  if (this._events === undefined ||
      this._events === Object.getPrototypeOf(this)._events) {
    this._events = Object.create(null);
    this._eventsCount = 0;
  }

  this._maxListeners = this._maxListeners || undefined;
};

// Obviously not all Emitters should be limited to 10. This function allows
// that to be increased. Set to zero for unlimited.
EventEmitter.prototype.setMaxListeners = function setMaxListeners(n) {
  if (typeof n !== 'number' || n < 0 || NumberIsNaN(n)) {
    throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received ' + n + '.');
  }
  this._maxListeners = n;
  return this;
};

function _getMaxListeners(that) {
  if (that._maxListeners === undefined)
    return EventEmitter.defaultMaxListeners;
  return that._maxListeners;
}

EventEmitter.prototype.getMaxListeners = function getMaxListeners() {
  return _getMaxListeners(this);
};

EventEmitter.prototype.emit = function emit(type) {
  var args = [];
  for (var i = 1; i < arguments.length; i++) args.push(arguments[i]);
  var doError = (type === 'error');

  var events = this._events;
  if (events !== undefined)
    doError = (doError && events.error === undefined);
  else if (!doError)
    return false;

  // If there is no 'error' event listener then throw.
  if (doError) {
    var er;
    if (args.length > 0)
      er = args[0];
    if (er instanceof Error) {
      // Note: The comments on the `throw` lines are intentional, they show
      // up in Node's output if this results in an unhandled exception.
      throw er; // Unhandled 'error' event
    }
    // At least give some kind of context to the user
    var err = new Error('Unhandled error.' + (er ? ' (' + er.message + ')' : ''));
    err.context = er;
    throw err; // Unhandled 'error' event
  }

  var handler = events[type];

  if (handler === undefined)
    return false;

  if (typeof handler === 'function') {
    ReflectApply(handler, this, args);
  } else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      ReflectApply(listeners[i], this, args);
  }

  return true;
};

function _addListener(target, type, listener, prepend) {
  var m;
  var events;
  var existing;

  checkListener(listener);

  events = target._events;
  if (events === undefined) {
    events = target._events = Object.create(null);
    target._eventsCount = 0;
  } else {
    // To avoid recursion in the case that type === "newListener"! Before
    // adding it to the listeners, first emit "newListener".
    if (events.newListener !== undefined) {
      target.emit('newListener', type,
                  listener.listener ? listener.listener : listener);

      // Re-assign `events` because a newListener handler could have caused the
      // this._events to be assigned to a new object
      events = target._events;
    }
    existing = events[type];
  }

  if (existing === undefined) {
    // Optimize the case of one listener. Don't need the extra array object.
    existing = events[type] = listener;
    ++target._eventsCount;
  } else {
    if (typeof existing === 'function') {
      // Adding the second element, need to change to array.
      existing = events[type] =
        prepend ? [listener, existing] : [existing, listener];
      // If we've already got an array, just append.
    } else if (prepend) {
      existing.unshift(listener);
    } else {
      existing.push(listener);
    }

    // Check for listener leak
    m = _getMaxListeners(target);
    if (m > 0 && existing.length > m && !existing.warned) {
      existing.warned = true;
      // No error code for this since it is a Warning
      // eslint-disable-next-line no-restricted-syntax
      var w = new Error('Possible EventEmitter memory leak detected. ' +
                          existing.length + ' ' + String(type) + ' listeners ' +
                          'added. Use emitter.setMaxListeners() to ' +
                          'increase limit');
      w.name = 'MaxListenersExceededWarning';
      w.emitter = target;
      w.type = type;
      w.count = existing.length;
      ProcessEmitWarning(w);
    }
  }

  return target;
}

EventEmitter.prototype.addListener = function addListener(type, listener) {
  return _addListener(this, type, listener, false);
};

EventEmitter.prototype.on = EventEmitter.prototype.addListener;

EventEmitter.prototype.prependListener =
    function prependListener(type, listener) {
      return _addListener(this, type, listener, true);
    };

function onceWrapper() {
  if (!this.fired) {
    this.target.removeListener(this.type, this.wrapFn);
    this.fired = true;
    if (arguments.length === 0)
      return this.listener.call(this.target);
    return this.listener.apply(this.target, arguments);
  }
}

function _onceWrap(target, type, listener) {
  var state = { fired: false, wrapFn: undefined, target: target, type: type, listener: listener };
  var wrapped = onceWrapper.bind(state);
  wrapped.listener = listener;
  state.wrapFn = wrapped;
  return wrapped;
}

EventEmitter.prototype.once = function once(type, listener) {
  checkListener(listener);
  this.on(type, _onceWrap(this, type, listener));
  return this;
};

EventEmitter.prototype.prependOnceListener =
    function prependOnceListener(type, listener) {
      checkListener(listener);
      this.prependListener(type, _onceWrap(this, type, listener));
      return this;
    };

// Emits a 'removeListener' event if and only if the listener was removed.
EventEmitter.prototype.removeListener =
    function removeListener(type, listener) {
      var list, events, position, i, originalListener;

      checkListener(listener);

      events = this._events;
      if (events === undefined)
        return this;

      list = events[type];
      if (list === undefined)
        return this;

      if (list === listener || list.listener === listener) {
        if (--this._eventsCount === 0)
          this._events = Object.create(null);
        else {
          delete events[type];
          if (events.removeListener)
            this.emit('removeListener', type, list.listener || listener);
        }
      } else if (typeof list !== 'function') {
        position = -1;

        for (i = list.length - 1; i >= 0; i--) {
          if (list[i] === listener || list[i].listener === listener) {
            originalListener = list[i].listener;
            position = i;
            break;
          }
        }

        if (position < 0)
          return this;

        if (position === 0)
          list.shift();
        else {
          spliceOne(list, position);
        }

        if (list.length === 1)
          events[type] = list[0];

        if (events.removeListener !== undefined)
          this.emit('removeListener', type, originalListener || listener);
      }

      return this;
    };

EventEmitter.prototype.off = EventEmitter.prototype.removeListener;

EventEmitter.prototype.removeAllListeners =
    function removeAllListeners(type) {
      var listeners, events, i;

      events = this._events;
      if (events === undefined)
        return this;

      // not listening for removeListener, no need to emit
      if (events.removeListener === undefined) {
        if (arguments.length === 0) {
          this._events = Object.create(null);
          this._eventsCount = 0;
        } else if (events[type] !== undefined) {
          if (--this._eventsCount === 0)
            this._events = Object.create(null);
          else
            delete events[type];
        }
        return this;
      }

      // emit removeListener for all listeners on all events
      if (arguments.length === 0) {
        var keys = Object.keys(events);
        var key;
        for (i = 0; i < keys.length; ++i) {
          key = keys[i];
          if (key === 'removeListener') continue;
          this.removeAllListeners(key);
        }
        this.removeAllListeners('removeListener');
        this._events = Object.create(null);
        this._eventsCount = 0;
        return this;
      }

      listeners = events[type];

      if (typeof listeners === 'function') {
        this.removeListener(type, listeners);
      } else if (listeners !== undefined) {
        // LIFO order
        for (i = listeners.length - 1; i >= 0; i--) {
          this.removeListener(type, listeners[i]);
        }
      }

      return this;
    };

function _listeners(target, type, unwrap) {
  var events = target._events;

  if (events === undefined)
    return [];

  var evlistener = events[type];
  if (evlistener === undefined)
    return [];

  if (typeof evlistener === 'function')
    return unwrap ? [evlistener.listener || evlistener] : [evlistener];

  return unwrap ?
    unwrapListeners(evlistener) : arrayClone(evlistener, evlistener.length);
}

EventEmitter.prototype.listeners = function listeners(type) {
  return _listeners(this, type, true);
};

EventEmitter.prototype.rawListeners = function rawListeners(type) {
  return _listeners(this, type, false);
};

EventEmitter.listenerCount = function(emitter, type) {
  if (typeof emitter.listenerCount === 'function') {
    return emitter.listenerCount(type);
  } else {
    return listenerCount.call(emitter, type);
  }
};

EventEmitter.prototype.listenerCount = listenerCount;
function listenerCount(type) {
  var events = this._events;

  if (events !== undefined) {
    var evlistener = events[type];

    if (typeof evlistener === 'function') {
      return 1;
    } else if (evlistener !== undefined) {
      return evlistener.length;
    }
  }

  return 0;
}

EventEmitter.prototype.eventNames = function eventNames() {
  return this._eventsCount > 0 ? ReflectOwnKeys(this._events) : [];
};

function arrayClone(arr, n) {
  var copy = new Array(n);
  for (var i = 0; i < n; ++i)
    copy[i] = arr[i];
  return copy;
}

function spliceOne(list, index) {
  for (; index + 1 < list.length; index++)
    list[index] = list[index + 1];
  list.pop();
}

function unwrapListeners(arr) {
  var ret = new Array(arr.length);
  for (var i = 0; i < ret.length; ++i) {
    ret[i] = arr[i].listener || arr[i];
  }
  return ret;
}

function once(emitter, name) {
  return new Promise(function (resolve, reject) {
    function errorListener(err) {
      emitter.removeListener(name, resolver);
      reject(err);
    }

    function resolver() {
      if (typeof emitter.removeListener === 'function') {
        emitter.removeListener('error', errorListener);
      }
      resolve([].slice.call(arguments));
    };

    eventTargetAgnosticAddListener(emitter, name, resolver, { once: true });
    if (name !== 'error') {
      addErrorHandlerIfEventEmitter(emitter, errorListener, { once: true });
    }
  });
}

function addErrorHandlerIfEventEmitter(emitter, handler, flags) {
  if (typeof emitter.on === 'function') {
    eventTargetAgnosticAddListener(emitter, 'error', handler, flags);
  }
}

function eventTargetAgnosticAddListener(emitter, name, listener, flags) {
  if (typeof emitter.on === 'function') {
    if (flags.once) {
      emitter.once(name, listener);
    } else {
      emitter.on(name, listener);
    }
  } else if (typeof emitter.addEventListener === 'function') {
    // EventTarget does not have `error` event semantics like Node
    // EventEmitters, we do not listen for `error` events here.
    emitter.addEventListener(name, function wrapListener(arg) {
      // IE does not have builtin `{ once: true }` support so we
      // have to do it manually.
      if (flags.once) {
        emitter.removeEventListener(name, wrapListener);
      }
      listener(arg);
    });
  } else {
    throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type ' + typeof emitter);
  }
}
{
  "name": "events",
  "version": "3.3.0",
  "description": "Node's event emitter for all engines.",
  "keywords": [
    "events",
    "eventEmitter",
    "eventDispatcher",
    "listeners"
  ],
  "author": "Irakli Gozalishvili <rfobic@gmail.com> (http://jeditoolkit.com)",
  "repository": {
    "type": "git",
    "url": "git://github.com/Gozala/events.git",
    "web": "https://github.com/Gozala/events"
  },
  "bugs": {
    "url": "http://github.com/Gozala/events/issues/"
  },
  "main": "./events.js",
  "engines": {
    "node": ">=0.8.x"
  },
  "devDependencies": {
    "airtap": "^1.0.0",
    "functions-have-names": "^1.2.1",
    "has": "^1.0.3",
    "has-symbols": "^1.0.1",
    "isarray": "^2.0.5",
    "tape": "^5.0.0"
  },
  "scripts": {
    "test": "node tests/index.js",
    "test:browsers": "airtap -- tests/index.js"
  },
  "license": "MIT"
}
/**
 * Command definitions for the native messaging bridge
 */

/**
 * @typedef {Object} CommandDefinition
 * @property {number} id - Unique command ID
 * @property {string} name - Command name
 */

/** @type {CommandDefinition[]} */
const COMMAND_DEFINITIONS = [
  // Encryption commands
  { id: 1001, name: 'encryptionInit' },
  { id: 1002, name: 'encryptionGetStatus' },
  { id: 1003, name: 'encryptionGet' },
  { id: 1004, name: 'encryptionAdd' },

  // Vaults commands
  { id: 1005, name: 'vaultsInit' },
  { id: 1006, name: 'vaultsGetStatus' },
  { id: 1007, name: 'vaultsGet' },
  { id: 1008, name: 'vaultsList' },
  { id: 1009, name: 'vaultsAdd' },
  { id: 1010, name: 'vaultsClose' },

  // Active vault commands
  { id: 1011, name: 'activeVaultInit' },
  { id: 1012, name: 'activeVaultGetStatus' },
  { id: 1013, name: 'activeVaultGet' },
  { id: 1014, name: 'activeVaultList' },
  { id: 1015, name: 'activeVaultAdd' },
  { id: 1016, name: 'activeVaultRemove' },
  { id: 1017, name: 'activeVaultClose' },
  { id: 1018, name: 'activeVaultCreateInvite' },
  { id: 1019, name: 'activeVaultDeleteInvite' },

  // Password and encryption key commands
  { id: 1020, name: 'hashPassword' },
  { id: 1021, name: 'encryptVaultKeyWithHashedPassword' },
  { id: 1022, name: 'encryptVaultWithKey' },
  { id: 1023, name: 'getDecryptionKey' },
  { id: 1024, name: 'decryptVaultKey' },

  // Native Messaging secure channel (pairing/handshake)
  { id: 1100, name: 'nmGetAppIdentity' },
  { id: 1102, name: 'nmBeginHandshake' },
  { id: 1103, name: 'nmFinishHandshake' },
  { id: 1104, name: 'nmSecureRequest' },
  { id: 1105, name: 'nmCloseSession' },

  // Pairing and misc commands
  { id: 1025, name: 'pairActiveVault' },
  { id: 1026, name: 'initListener' },
  { id: 1027, name: 'closeAllInstances' },
  { id: 1028, name: 'cancelPairActiveVault' }
]

/** @type {string[]} */
const COMMAND_NAMES = COMMAND_DEFINITIONS.map((cmd) => cmd.name)

/**
 * Check if a command name is valid
 * @param {string} commandName - The command name to validate
 * @returns {boolean}
 */
const isValidCommand = (commandName) => COMMAND_NAMES.includes(commandName)

module.exports = {
  COMMAND_DEFINITIONS,
  isValidCommand
}
#!/usr/bin/env node

// Native messaging host - bridges browser extension to PearPass desktop app via IPC

const IPC = require('pear-ipc')

const {
  COMMAND_DEFINITIONS,
  isValidCommand
} = require('./commandDefinitions.js')
const { NativeMessagingHandler } = require('./nativeMessagingHandler.js')
const { getIpcPath, log } = require('./utils.js')

// Desktop app status constants
const DESKTOP_APP_STATUS = Object.freeze({
  CONNECTED: 'connected',
  NOT_RUNNING: 'not-running',
  INTEGRATION_DISABLED: 'integration-disabled',
  CONNECTING: 'connecting',
  UNKNOWN: 'unknown'
})

// Timeout constants (in milliseconds)
const TIMEOUTS = Object.freeze({
  IPC_CONNECTION: 3000, // 3 seconds to establish IPC connection
  IPC_CALL: 3000 // 3 seconds for IPC method calls
})

// Error messages for each status
const STATUS_MESSAGES = Object.freeze({
  [DESKTOP_APP_STATUS.NOT_RUNNING]: 'PearPass desktop app is not running',
  [DESKTOP_APP_STATUS.INTEGRATION_DISABLED]:
    'Browser extension integration is disabled in PearPass desktop app. Please enable it in Settings > Privacy',
  [DESKTOP_APP_STATUS.CONNECTING]: 'Connecting to PearPass desktop app...',
  [DESKTOP_APP_STATUS.UNKNOWN]: 'Unable to connect to PearPass desktop app'
})

/**
 * @typedef {Object} Message
 * @property {string} id - Unique message identifier
 * @property {string} [method] - Method to call
 * @property {string} [command] - Command to execute (alternative to method)
 * @property {Object} [params] - Parameters for the method/command
 */

/**
 * @typedef {Object} Response
 * @property {string} id - Message identifier
 * @property {boolean} success - Whether the operation succeeded
 * @property {*} [result] - Operation result
 * @property {string} [error] - Error message if failed
 * @property {string} [errorCode] - Error code if failed
 */

class NativeMessagingHost {
  constructor() {
    /** @type {NativeMessagingHandler} */
    this.handler = new NativeMessagingHandler()
    /** @type {import('pear-ipc').Client|null} */
    this.ipcClient = null
    /** @type {boolean} */
    this.isRunning = false
    /** @type {string} */
    this.socketPath = getIpcPath('pearpass-native-messaging')
    /** @type {string} */
    this.desktopAppStatus = DESKTOP_APP_STATUS.UNKNOWN
  }

  /**
   * @returns {Promise<void>}
   */
  async start() {
    if (this.isRunning) {
      return
    }

    try {
      log('INFO', 'Starting simple native messaging host...')

      // Set up native messaging handler first
      this.handler.on('message', async (message) => {
        log(
          'INFO',
          'Received message from extension: ' + JSON.stringify(message)
        )
        await this.handleMessage(message)
      })

      this.handler.on('disconnect', () => {
        log('INFO', 'Native messaging disconnected')
        this.stop()
      })

      this.handler.on('error', (error) => {
        log('INFO', 'Native messaging handler error: ' + error.message)
        if (error.stack) {
          log('INFO', 'Error stack: ' + error.stack)
        }
        this.stop()
      })

      // Start the native messaging handler
      this.handler.start()
      this.isRunning = true

      log(
        'INFO',
        'Simple native messaging host started, attempting IPC connection...'
      )

      // Try to connect to IPC server (non-blocking)
      this.connectToIPC().catch((error) => {
        log('INFO', 'Initial IPC connection failed: ' + error.message)
        this.updateDesktopAppStatus(error)
      })
    } catch (error) {
      log(
        'INFO',
        'Failed to start simple native messaging host: ' + error.message
      )
      throw error
    }
  }

  /**
   * @returns {Promise<void>}
   */
  async connectToIPC() {
    try {
      this.desktopAppStatus = DESKTOP_APP_STATUS.CONNECTING
      log('INFO', `Attempting to connect to IPC server at: ${this.socketPath}`)

      // Create new IPC client connection
      this.ipcClient = new IPC.Client({
        socketPath: this.socketPath,
        connect: true,
        connectTimeout: TIMEOUTS.IPC_CONNECTION,
        methods: COMMAND_DEFINITIONS
      })

      // Wait for connection with timeout
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => {
          reject(new Error('Connection timed out'))
        }, TIMEOUTS.IPC_CONNECTION)
      })

      await Promise.race([this.ipcClient.ready(), timeoutPromise])

      log('INFO', 'Successfully connected to IPC server')

      // Update status
      this.desktopAppStatus = DESKTOP_APP_STATUS.CONNECTED

      // Set up disconnect handler
      this.ipcClient.on('close', () => {
        log('INFO', 'IPC client disconnected')
        this.desktopAppStatus = DESKTOP_APP_STATUS.NOT_RUNNING
        this.ipcClient = null
      })
    } catch (error) {
      log('INFO', `Failed to connect to IPC server: ${error.message}`)
      this.updateDesktopAppStatus(error)

      // Clean up client on failure
      if (this.ipcClient) {
        try {
          this.ipcClient.close()
        } catch {
          // Ignore close errors
        }
        this.ipcClient = null
      }
    }
  }

  /**
   * @param {Error} error
   */
  updateDesktopAppStatus(error) {
    if (error.message.includes('ENOENT')) {
      this.desktopAppStatus = DESKTOP_APP_STATUS.NOT_RUNNING
    } else {
      this.desktopAppStatus = DESKTOP_APP_STATUS.INTEGRATION_DISABLED
    }
  }

  /**
   * @param {Message} message
   * @returns {Promise<void>}
   */
  async handleMessage(message) {
    const { id, method, command, params } = message
    const methodName = method || command

    try {
      // Remove any padding added to work around Chrome 255-byte bug
      const cleanParams = params ? { ...params } : {}
      delete cleanParams.padding

      log(
        'INFO',
        `Processing request: ${methodName} with params: ${JSON.stringify(cleanParams)}`
      )

      // Handle special checkAvailability command
      if (methodName === 'checkAvailability') {
        // Always try to connect when checking availability
        if (this.desktopAppStatus !== DESKTOP_APP_STATUS.CONNECTED) {
          log('INFO', 'Checking availability - attempting to connect...')
          try {
            await this.connectToIPC()
          } catch (connectError) {
            log(
              'INFO',
              `Availability check - connection failed: ${connectError.message}`
            )
          }
        }

        const response = {
          id,
          success: true,
          result: {
            available: this.desktopAppStatus === DESKTOP_APP_STATUS.CONNECTED,
            status: this.desktopAppStatus,
            message:
              STATUS_MESSAGES[this.desktopAppStatus] ||
              STATUS_MESSAGES[DESKTOP_APP_STATUS.UNKNOWN]
          }
        }
        this.handler.send(response)
        log(
          'INFO',
          `Sent availability check response: ${JSON.stringify(response)}`
        )
        return
      }

      // For all other commands, check if desktop app is available
      if (this.desktopAppStatus !== DESKTOP_APP_STATUS.CONNECTED) {
        // Try to reconnect first
        log('INFO', 'Desktop app not connected, attempting to connect...')
        try {
          await this.connectToIPC()
        } catch (connectError) {
          log('INFO', `Failed to connect: ${connectError.message}`)
        }

        // Check again after connection attempt
        if (this.desktopAppStatus !== DESKTOP_APP_STATUS.CONNECTED) {
          const errorMessage =
            STATUS_MESSAGES[this.desktopAppStatus] ||
            STATUS_MESSAGES[DESKTOP_APP_STATUS.UNKNOWN]
          this.handler.send({
            id,
            success: false,
            error: errorMessage,
            errorCode: this.desktopAppStatus
          })
          log('INFO', `Sent error response: ${errorMessage}`)
          return
        }
      }

      // Check if IPC client is still connected
      if (!this.ipcClient || this.ipcClient.closed) {
        log('INFO', 'IPC client is not connected, attempting to reconnect...')
        await this.reconnectIPC()
      }

      let result = null

      // Call the appropriate method on the IPC client with timeout
      if (isValidCommand(methodName) && this.ipcClient[methodName]) {
        // Create a timeout promise
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => {
            reject(
              new Error(
                `IPC call timed out after ${TIMEOUTS.IPC_CALL / 1000} seconds`
              )
            )
          }, TIMEOUTS.IPC_CALL)
        })

        try {
          // Race between the IPC call and timeout
          result = await Promise.race([
            this.ipcClient[methodName](cleanParams),
            timeoutPromise
          ])
        } catch (error) {
          // If it's a timeout or connection error, update status
          if (
            error.message.includes('timed out') ||
            error.message.includes('RPC destroyed')
          ) {
            log('INFO', 'IPC call failed, desktop app may have been closed')
            this.desktopAppStatus = DESKTOP_APP_STATUS.NOT_RUNNING
            this.ipcClient = null
          }
          throw error
        }
      } else {
        throw new Error(`Unknown method: ${methodName}`)
      }

      // Send success response
      this.handler.send({
        id,
        success: true,
        result
      })

      log('INFO', `Sent response for ${methodName}: ${JSON.stringify(result)}`)
    } catch (error) {
      log('INFO', `Error handling message: ${error.message}`)

      // If it's an RPC destroyed error, try to reconnect
      if (error.message.includes('RPC destroyed')) {
        log('INFO', 'RPC destroyed detected, attempting to reconnect...')
        try {
          await this.reconnectIPC()
          // Retry the message after reconnection
          return this.handleMessage(message)
        } catch (reconnectError) {
          log('INFO', `Failed to reconnect: ${reconnectError.message}`)
          this.updateDesktopAppStatus(reconnectError)
        }
      }

      // Send error response
      this.handler.send({
        id,
        success: false,
        error: error.message
      })
    }
  }

  /**
   * @returns {Promise<void>}
   */
  async reconnectIPC() {
    try {
      // Close existing client if any
      if (this.ipcClient) {
        try {
          this.ipcClient.close()
        } catch {
          // Ignore close errors
        }
        this.ipcClient = null
      }

      // Use connectToIPC which handles status updates
      await this.connectToIPC()

      if (this.desktopAppStatus !== DESKTOP_APP_STATUS.CONNECTED) {
        throw new Error(STATUS_MESSAGES[this.desktopAppStatus])
      }
    } catch (error) {
      log('INFO', `Failed to reconnect to IPC server: ${error.message}`)
      throw error
    }
  }

  stop() {
    if (!this.isRunning) {
      return
    }

    this.isRunning = false

    if (this.ipcClient) {
      this.ipcClient.close()
      this.ipcClient = null
    }

    if (this.handler) {
      this.handler.stop()
    }

    log('INFO', 'Simple native messaging host stopped')
  }
}

// Log early to verify logging works
log('INFO', 'Native messaging host script started')

// Create and start the host
const host = new NativeMessagingHost()

// Graceful shutdown
process.on('SIGINT', () => {
  host.stop()
  process.exit(0)
})

process.on('SIGTERM', () => {
  host.stop()
  process.exit(0)
})

process.on('uncaughtException', (error) => {
  log('INFO', 'Uncaught exception: ' + error.message)
  log('INFO', 'Stack trace: ' + error.stack)
  host.stop()
  process.exit(1)
})

process.on('unhandledRejection', (reason, promise) => {
  log('INFO', 'Unhandled rejection at: ' + promise + ' reason: ' + reason)
  host.stop()
  process.exit(1)
})

// Start the host
log('INFO', 'About to start host...')
host.start().catch((error) => {
  log('INFO', 'Failed to start host: ' + error.message)
  log('INFO', 'Stack trace: ' + error.stack)
  process.exit(1)
})
const { EventEmitter } = require('events')

const {
  wrapMessage,
  unwrapMessage,
  isWrappedMessage
} = require('./nativeMessagingProtocol.js')
const { log } = require('./utils')

// Constants
const MESSAGE_SIZE_LIMIT = 1024 * 1024 // 1MB
const HEADER_SIZE = 4

/**
 * Native Messaging Handler - handles Chrome native messaging protocol
 * Includes robust parsing to handle Chrome's length header bugs
 * @extends EventEmitter
 */
class NativeMessagingHandler extends EventEmitter {
  constructor() {
    super()
    /** @type {Buffer} */
    this.inputBuffer = Buffer.alloc(0)
    /** @type {boolean} */
    this.messageInProgress = false
    /** @type {number} */
    this.expectedMessageLength = 0
    /** @type {string} */
    this.accumulatedString = ''
    /** @type {boolean} */
    this.useRobustParsing = true // Use robust parsing by default
  }

  start() {
    log('INFO', 'Starting native messaging handler')
    this._setupStdinListeners()
    process.stdin.resume()
    log('INFO', 'Native messaging handler started')
  }

  /**
   * @private
   */
  _setupStdinListeners() {
    process.stdin.setEncoding(null)
    process.stdin.on('data', (chunk) => this.handleIncomingChunk(chunk))
    process.stdin.on('end', () => this.emit('disconnect'))
    process.stdin.on('error', (err) => {
      log('ERROR', `stdin error: ${err.message}`)
      this.emit('error', err)
    })
  }

  /**
   * @param {Buffer|string} chunk
   */
  handleIncomingChunk(chunk) {
    const buffer = this._ensureBuffer(chunk)
    this.inputBuffer = Buffer.concat([this.inputBuffer, buffer])

    while (this.processNextMessage()) {
      // Continue processing while we have complete messages
    }
  }

  /**
   * @private
   * @param {Buffer|string} chunk
   * @returns {Buffer}
   */
  _ensureBuffer(chunk) {
    return Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk, 'binary')
  }

  /**
   * @returns {boolean}
   */
  processNextMessage() {
    if (this.useRobustParsing) {
      return this.processNextMessageRobust()
    }
    return this._processStandardMessage()
  }

  /**
   * @private
   * @returns {boolean}
   */
  _processStandardMessage() {
    if (this.inputBuffer.length < HEADER_SIZE) {
      return false
    }

    if (!this.messageInProgress) {
      if (!this._readMessageLength()) {
        return false
      }
    }

    const totalLength = HEADER_SIZE + this.expectedMessageLength
    if (this.inputBuffer.length < totalLength) {
      return false
    }

    const messageBuffer = this.inputBuffer.slice(HEADER_SIZE, totalLength)
    this.inputBuffer = this.inputBuffer.slice(totalLength)
    this._resetMessageState()

    return this._parseAndEmitMessage(messageBuffer)
  }

  /**
   * @private
   * @returns {boolean}
   */
  _readMessageLength() {
    this.expectedMessageLength = this.inputBuffer.readUInt32LE(0)
    this.messageInProgress = true

    if (this.expectedMessageLength > MESSAGE_SIZE_LIMIT) {
      log('ERROR', `Message too large: ${this.expectedMessageLength}`)
      this._resetBuffer()
      return false
    }
    return true
  }

  /**
   * @private
   */
  _resetMessageState() {
    this.messageInProgress = false
    this.expectedMessageLength = 0
  }

  /**
   * @private
   */
  _resetBuffer() {
    this.inputBuffer = Buffer.alloc(0)
    this._resetMessageState()
  }

  /**
   * @private
   * @param {Buffer} messageBuffer
   * @returns {boolean}
   */
  _parseAndEmitMessage(messageBuffer) {
    try {
      const message = JSON.parse(messageBuffer.toString())
      this._handleParsedMessage(message)
      return true
    } catch (err) {
      log('ERROR', `Failed to parse message: ${err.message}`)
      this.emit('error', new Error('Invalid JSON message'))
      return false
    }
  }

  /**
   * @private
   * @param {Object} message
   */
  _handleParsedMessage(message) {
    if (isWrappedMessage(message)) {
      const unwrapped = unwrapMessage(message)
      if (unwrapped) {
        this.emit('message', unwrapped)
      } else {
        this.emit('error', new Error('Failed to unwrap protocol message'))
      }
    } else {
      this.emit('message', message)
    }
  }

  /**
   * Robust message processing that handles Chrome's length header bugs
   * Chrome sometimes sends incorrect length headers, especially around 255 bytes
   * @returns {boolean}
   */
  processNextMessageRobust() {
    if (this.inputBuffer.length < 4) {
      return false
    }

    // Skip Chrome's potentially incorrect length header
    const dataAfterHeader = this.inputBuffer.slice(4).toString('utf8')
    this.accumulatedString = dataAfterHeader

    // Find complete JSON objects by parsing braces
    let foundMessage = false
    let startIndex = 0

    while (startIndex < this.accumulatedString.length) {
      const openBrace = this.accumulatedString.indexOf('{', startIndex)
      if (openBrace === -1) {
        break
      }

      // Parse JSON manually to find the end
      let braceCount = 0
      let inString = false
      let escapeNext = false
      let endIndex = -1

      for (let i = openBrace; i < this.accumulatedString.length; i++) {
        const char = this.accumulatedString[i]

        if (escapeNext) {
          escapeNext = false
          continue
        }

        if (char === '\\') {
          escapeNext = true
          continue
        }

        if (char === '"' && !escapeNext) {
          inString = !inString
          continue
        }

        if (!inString) {
          if (char === '{') {
            braceCount++
          } else if (char === '}') {
            braceCount--
            if (braceCount === 0) {
              endIndex = i + 1
              break
            }
          }
        }
      }

      if (endIndex === -1) {
        // Incomplete JSON, wait for more data
        return false
      }

      const jsonStr = this.accumulatedString.substring(openBrace, endIndex)

      try {
        const message = JSON.parse(jsonStr)

        if (isWrappedMessage(message)) {
          const unwrapped = unwrapMessage(message)
          if (unwrapped) {
            this.emit('message', unwrapped)
          } else {
            this.emit('error', new Error('Failed to unwrap protocol message'))
          }
        } else {
          this.emit('message', message)
        }

        // Remove processed message from buffer
        const bytesToRemove =
          4 +
          Buffer.from(this.accumulatedString.substring(0, endIndex), 'utf8')
            .length
        this.inputBuffer = this.inputBuffer.slice(bytesToRemove)

        foundMessage = true
        break
      } catch (err) {
        log('ERROR', `Failed to parse JSON: ${err.message}`)
        startIndex = openBrace + 1
      }
    }

    // Clear buffer if it gets too large without valid messages
    if (!foundMessage && this.inputBuffer.length > 10000) {
      log('ERROR', 'Buffer too large without valid message, clearing')
      this.inputBuffer = Buffer.alloc(0)
      this.accumulatedString = ''
    }

    return foundMessage
  }

  /**
   * @param {Object} message
   */
  send(message) {
    try {
      log('DEBUG', `Sending message: ${JSON.stringify(message)}`)

      // Wrap the message with protocol
      const wrapped = wrapMessage(message)
      const jsonStr = JSON.stringify(wrapped)
      const jsonBuffer = Buffer.from(jsonStr)

      // Create 4-byte length header
      const header = Buffer.allocUnsafe(4)
      header.writeUInt32LE(jsonBuffer.length, 0)

      // Write header and message
      process.stdout.write(header)
      process.stdout.write(jsonBuffer)

      log('DEBUG', 'Message sent successfully')
    } catch (err) {
      log('ERROR', `Failed to send message: ${err.message}`)
      this.emit('error', err)
    }
  }

  stop() {
    process.stdin.pause()
    process.stdin.removeAllListeners()
    this.inputBuffer = Buffer.alloc(0)
    log('INFO', 'Native messaging handler stopped')
  }

  // eslint-disable-next-line no-unused-vars
  addListener(_eventName, _listener) {
    return undefined
  }

  eventNames() {
    return undefined
  }

  getMaxListeners() {
    return 0
  }

  // eslint-disable-next-line no-unused-vars
  listenerCount(_eventName, _listener) {
    return 0
  }

  // eslint-disable-next-line no-unused-vars
  listeners(_eventName) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  off(_eventName, _listener) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  once(_eventName, _listener) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  prependListener(_eventName, _listener) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  prependOnceListener(_eventName, _listener) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  rawListeners(_eventName) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  removeAllListeners(_eventName) {
    return undefined
  }

  // eslint-disable-next-line no-unused-vars
  setMaxListeners(_n) {
    return undefined
  }
}

module.exports = { NativeMessagingHandler }
/**
 * Protocol wrapper for native messaging
 */

/**
 * @typedef {Object} WrappedMessage
 * @property {number} length - Original message length in bytes
 * @property {Object} message - The actual message
 */

/**
 * Wrap a message with protocol metadata
 * @param {Object} message - The message to wrap
 * @returns {WrappedMessage}
 */
const wrapMessage = (message) => {
  const originalJson = JSON.stringify(message)
  const originalLength = Buffer.from(originalJson).length

  return {
    length: originalLength,
    message: message
  }
}

/**
 * Unwrap a message from protocol
 * @param {WrappedMessage} wrapped - The wrapped message
 * @returns {Object|null} The original message or null if invalid
 */
const unwrapMessage = (wrapped) => {
  if (
    !wrapped ||
    typeof wrapped !== 'object' ||
    !wrapped.message ||
    typeof wrapped.length !== 'number'
  ) {
    return null
  }

  const messageJson = JSON.stringify(wrapped.message)
  const actualLength = Buffer.from(messageJson).length

  if (actualLength !== wrapped.length) {
    return null
  }

  return wrapped.message
}

/**
 * Check if a message is wrapped
 * @param {*} message - The message to check
 * @returns {boolean}
 */
const isWrappedMessage = (message) =>
  !!message &&
  typeof message === 'object' &&
  'length' in message &&
  'message' in message

module.exports = {
  wrapMessage,
  unwrapMessage,
  isWrappedMessage
}
function isBuffer (value) {
  return Buffer.isBuffer(value) || value instanceof Uint8Array
}

function isEncoding (encoding) {
  return Buffer.isEncoding(encoding)
}

function alloc (size, fill, encoding) {
  return Buffer.alloc(size, fill, encoding)
}

function allocUnsafe (size) {
  return Buffer.allocUnsafe(size)
}

function allocUnsafeSlow (size) {
  return Buffer.allocUnsafeSlow(size)
}

function byteLength (string, encoding) {
  return Buffer.byteLength(string, encoding)
}

function compare (a, b) {
  return Buffer.compare(a, b)
}

function concat (buffers, totalLength) {
  return Buffer.concat(buffers, totalLength)
}

function copy (source, target, targetStart, start, end) {
  return toBuffer(source).copy(target, targetStart, start, end)
}

function equals (a, b) {
  return toBuffer(a).equals(b)
}

function fill (buffer, value, offset, end, encoding) {
  return toBuffer(buffer).fill(value, offset, end, encoding)
}

function from (value, encodingOrOffset, length) {
  return Buffer.from(value, encodingOrOffset, length)
}

function includes (buffer, value, byteOffset, encoding) {
  return toBuffer(buffer).includes(value, byteOffset, encoding)
}

function indexOf (buffer, value, byfeOffset, encoding) {
  return toBuffer(buffer).indexOf(value, byfeOffset, encoding)
}

function lastIndexOf (buffer, value, byteOffset, encoding) {
  return toBuffer(buffer).lastIndexOf(value, byteOffset, encoding)
}

function swap16 (buffer) {
  return toBuffer(buffer).swap16()
}

function swap32 (buffer) {
  return toBuffer(buffer).swap32()
}

function swap64 (buffer) {
  return toBuffer(buffer).swap64()
}

function toBuffer (buffer) {
  if (Buffer.isBuffer(buffer)) return buffer
  return Buffer.from(buffer.buffer, buffer.byteOffset, buffer.byteLength)
}

function toString (buffer, encoding, start, end) {
  return toBuffer(buffer).toString(encoding, start, end)
}

function write (buffer, string, offset, length, encoding) {
  return toBuffer(buffer).write(string, offset, length, encoding)
}

function writeDoubleLE (buffer, value, offset) {
  return toBuffer(buffer).writeDoubleLE(value, offset)
}

function writeFloatLE (buffer, value, offset) {
  return toBuffer(buffer).writeFloatLE(value, offset)
}

function writeUInt32LE (buffer, value, offset) {
  return toBuffer(buffer).writeUInt32LE(value, offset)
}

function writeInt32LE (buffer, value, offset) {
  return toBuffer(buffer).writeInt32LE(value, offset)
}

function readDoubleLE (buffer, offset) {
  return toBuffer(buffer).readDoubleLE(offset)
}

function readFloatLE (buffer, offset) {
  return toBuffer(buffer).readFloatLE(offset)
}

function readUInt32LE (buffer, offset) {
  return toBuffer(buffer).readUInt32LE(offset)
}

function readInt32LE (buffer, offset) {
  return toBuffer(buffer).readInt32LE(offset)
}

function writeDoubleBE (buffer, value, offset) {
  return toBuffer(buffer).writeDoubleBE(value, offset)
}

function writeFloatBE (buffer, value, offset) {
  return toBuffer(buffer).writeFloatBE(value, offset)
}

function writeUInt32BE (buffer, value, offset) {
  return toBuffer(buffer).writeUInt32BE(value, offset)
}

function writeInt32BE (buffer, value, offset) {
  return toBuffer(buffer).writeInt32BE(value, offset)
}

function readDoubleBE (buffer, offset) {
  return toBuffer(buffer).readDoubleBE(offset)
}

function readFloatBE (buffer, offset) {
  return toBuffer(buffer).readFloatBE(offset)
}

function readUInt32BE (buffer, offset) {
  return toBuffer(buffer).readUInt32BE(offset)
}

function readInt32BE (buffer, offset) {
  return toBuffer(buffer).readInt32BE(offset)
}

module.exports = {
  isBuffer,
  isEncoding,
  alloc,
  allocUnsafe,
  allocUnsafeSlow,
  byteLength,
  compare,
  concat,
  copy,
  equals,
  fill,
  from,
  includes,
  indexOf,
  lastIndexOf,
  swap16,
  swap32,
  swap64,
  toBuffer,
  toString,
  write,
  writeDoubleLE,
  writeFloatLE,
  writeUInt32LE,
  writeInt32LE,
  readDoubleLE,
  readFloatLE,
  readUInt32LE,
  readInt32LE,
  writeDoubleBE,
  writeFloatBE,
  writeUInt32BE,
  writeInt32BE,
  readDoubleBE,
  readFloatBE,
  readUInt32BE,
  readInt32BE

}
{
  "name": "b4a",
  "version": "1.6.7",
  "description": "Bridging the gap between buffers and typed arrays",
  "main": "index.js",
  "files": [
    "browser.js",
    "index.js",
    "lib"
  ],
  "browser": {
    "./index.js": "./browser.js"
  },
  "scripts": {
    "test": "standard && brittle test/*.mjs"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/b4a.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/b4a/issues"
  },
  "homepage": "https://github.com/holepunchto/b4a#readme",
  "devDependencies": {
    "brittle": "^3.5.2",
    "nanobench": "^3.0.0",
    "standard": "^17.1.0"
  }
}
const resolve = require('bare-module-resolve')
const { Version } = require('bare-semver')
const errors = require('./lib/errors')

module.exports = exports = function resolve(
  specifier,
  parentURL,
  opts,
  readPackage
) {
  if (typeof opts === 'function') {
    readPackage = opts
    opts = {}
  } else if (typeof readPackage !== 'function') {
    readPackage = defaultReadPackage
  }

  return {
    *[Symbol.iterator]() {
      const generator = exports.addon(specifier, parentURL, opts)

      let next = generator.next()

      while (next.done !== true) {
        const value = next.value

        if (value.package) {
          next = generator.next(readPackage(value.package))
        } else {
          next = generator.next(yield value.resolution)
        }
      }

      return next.value
    },

    async *[Symbol.asyncIterator]() {
      const generator = exports.addon(specifier, parentURL, opts)

      let next = generator.next()

      while (next.done !== true) {
        const value = next.value

        if (value.package) {
          next = generator.next(await readPackage(value.package))
        } else {
          next = generator.next(yield value.resolution)
        }
      }

      return next.value
    }
  }
}

function defaultReadPackage() {
  return null
}

const { UNRESOLVED, YIELDED, RESOLVED } = resolve.constants

exports.constants = {
  UNRESOLVED,
  YIELDED,
  RESOLVED
}

exports.addon = function* (specifier, parentURL, opts = {}) {
  const { resolutions = null } = opts

  if (exports.startsWithWindowsDriveLetter(specifier)) {
    specifier = '/' + specifier
  }

  let status

  if (resolutions) {
    status = yield* resolve.preresolved(specifier, resolutions, parentURL, opts)

    if (status) return status
  }

  status = yield* exports.url(specifier, parentURL, opts)

  if (status) return status

  let version = null

  const i = specifier.lastIndexOf('@')

  if (i > 0) {
    version = specifier.substring(i + 1)

    try {
      Version.parse(version)

      specifier = specifier.substring(0, i)
    } catch {
      version = null
    }
  }

  if (
    specifier === '.' ||
    specifier === '..' ||
    specifier[0] === '/' ||
    specifier[0] === '\\' ||
    specifier.startsWith('./') ||
    specifier.startsWith('.\\') ||
    specifier.startsWith('../') ||
    specifier.startsWith('..\\')
  ) {
    return yield* exports.directory(specifier, version, parentURL, opts)
  }

  return yield* exports.package(specifier, version, parentURL, opts)
}

exports.url = function* (url, parentURL, opts = {}) {
  let resolution
  try {
    resolution = new URL(url)
  } catch {
    return UNRESOLVED
  }

  const resolved = yield { resolution }

  return resolved ? RESOLVED : YIELDED
}

exports.package = function* (
  packageSpecifier,
  packageVersion,
  parentURL,
  opts = {}
) {
  if (packageSpecifier === '') {
    throw errors.INVALID_ADDON_SPECIFIER(
      `Addon specifier '${packageSpecifier}' is not a valid package name`
    )
  }

  let packageName

  if (packageSpecifier[0] !== '@') {
    packageName = packageSpecifier.split('/', 1).join()
  } else {
    if (!packageSpecifier.includes('/')) {
      throw errors.INVALID_ADDON_SPECIFIER(
        `Addon specifier '${packageSpecifier}' is not a valid package name`
      )
    }

    packageName = packageSpecifier.split('/', 2).join('/')
  }

  if (
    packageName[0] === '.' ||
    packageName.includes('\\') ||
    packageName.includes('%')
  ) {
    throw errors.INVALID_ADDON_SPECIFIER(
      `Addon specifier '${packageSpecifier}' is not a valid package name`
    )
  }

  const packageSubpath = '.' + packageSpecifier.substring(packageName.length)

  const status = yield* exports.packageSelf(
    packageName,
    packageSubpath,
    packageVersion,
    parentURL,
    opts
  )

  if (status) return status

  parentURL = new URL(parentURL.href)

  do {
    const packageURL = new URL('node_modules/' + packageName + '/', parentURL)

    parentURL.pathname = parentURL.pathname.substring(
      0,
      parentURL.pathname.lastIndexOf('/')
    )

    const info = yield { package: new URL('package.json', packageURL) }

    if (info) {
      return yield* exports.directory(
        packageSubpath,
        packageVersion,
        packageURL,
        opts
      )
    }
  } while (parentURL.pathname !== '' && parentURL.pathname !== '/')

  return UNRESOLVED
}

exports.packageSelf = function* (
  packageName,
  packageSubpath,
  packageVersion,
  parentURL,
  opts = {}
) {
  for (const packageURL of resolve.lookupPackageScope(parentURL, opts)) {
    const info = yield { package: packageURL }

    if (info) {
      if (info.name === packageName) {
        return yield* exports.directory(
          packageSubpath,
          packageVersion,
          packageURL,
          opts
        )
      }

      break
    }
  }

  return UNRESOLVED
}

exports.lookupPrebuildsScope = function* lookupPrebuildsScope(url, opts = {}) {
  const { resolutions = null } = opts

  if (resolutions) {
    for (const { resolution } of resolve.preresolved(
      '#prebuilds',
      resolutions,
      url,
      opts
    )) {
      if (resolution) return yield resolution
    }
  }

  const scopeURL = new URL(url.href)

  do {
    yield new URL('prebuilds/', scopeURL)

    scopeURL.pathname = scopeURL.pathname.substring(
      0,
      scopeURL.pathname.lastIndexOf('/')
    )

    if (
      scopeURL.pathname.length === 3 &&
      exports.isWindowsDriveLetter(scopeURL.pathname.substring(1))
    ) {
      break
    }
  } while (scopeURL.pathname !== '' && scopeURL.pathname !== '/')
}

exports.file = function* (filename, parentURL, opts = {}) {
  if (parentURL.protocol === 'file:' && /%2f|%5c/i.test(filename)) {
    throw errors.INVALID_ADDON_SPECIFIER(
      `Addon specifier '${filename}' is invalid`
    )
  }

  const { extensions = [] } = opts

  let status = UNRESOLVED

  for (const ext of extensions) {
    if (yield { resolution: new URL(filename + ext, parentURL) }) {
      return RESOLVED
    }

    status = YIELDED
  }

  return status
}

exports.directory = function* (dirname, version, parentURL, opts = {}) {
  const {
    resolutions = null,
    host = null, // Shorthand for single host resolution
    hosts = host !== null ? [host] : [],
    builtins = [],
    matchedConditions = []
  } = opts

  let directoryURL

  if (
    dirname[dirname.length - 1] === '/' ||
    dirname[dirname.length - 1] === '\\'
  ) {
    directoryURL = new URL(dirname, parentURL)
  } else {
    directoryURL = new URL(dirname + '/', parentURL)
  }

  // Internal preresolution path, do not depend on this! It will be removed without
  // warning.
  if (resolutions) {
    const status = yield* resolve.preresolved(
      'bare:addon',
      resolutions,
      directoryURL,
      opts
    )

    if (status) return status
  }

  const unversioned = version === null

  let name = null

  const info = yield { package: new URL('package.json', directoryURL) }

  if (info) {
    if (typeof info.name === 'string' && info.name !== '') {
      if (info.name.includes('__')) {
        throw errors.INVALID_PACKAGE_NAME(
          `Package name '${info.name}' is invalid`
        )
      }

      name = info.name.replace(/\//g, '__').replace(/^@/, '')
    } else {
      return UNRESOLVED
    }

    if (typeof info.version === 'string' && info.version !== '') {
      if (version !== null && info.version !== version) return UNRESOLVED

      version = info.version
    }
  } else {
    return UNRESOLVED
  }

  let status

  status = yield* resolve.builtinTarget(name, version, builtins, opts)

  if (status) return status

  for (const prebuildsURL of exports.lookupPrebuildsScope(directoryURL, opts)) {
    status = UNRESOLVED

    for (const host of hosts) {
      const conditions = host.split('-')

      matchedConditions.push(...conditions)

      if (version !== null) {
        status |= yield* exports.file(
          host + '/' + name + '@' + version,
          prebuildsURL,
          opts
        )
      }

      if (unversioned) {
        status |= yield* exports.file(host + '/' + name, prebuildsURL, opts)
      }

      for (const _ of conditions) matchedConditions.pop()
    }

    if (status === RESOLVED) return status
  }

  return yield* exports.linked(name, version, opts)
}

exports.linked = function* (name, version = null, opts = {}) {
  const {
    linked = true,
    host = null, // Shorthand for single host resolution
    hosts = host !== null ? [host] : [],
    matchedConditions = []
  } = opts

  if (linked === false || hosts.length === 0) return UNRESOLVED

  let status = UNRESOLVED

  for (const host of hosts) {
    const [platform = null] = host.split('-', 1)

    if (platform === null) continue

    matchedConditions.push(platform)

    status |= yield* platformArtefact(name, version, platform, opts)

    matchedConditions.pop()
  }

  return status
}

function* platformArtefact(name, version = null, platform, opts = {}) {
  const { linkedProtocol = 'linked:' } = opts

  if (platform === 'darwin' || platform === 'ios') {
    if (version !== null) {
      if (
        yield {
          resolution: new URL(
            `${linkedProtocol}${name}.${version}.framework/${name}.${version}`
          )
        }
      ) {
        return RESOLVED
      }

      if (platform === 'darwin') {
        if (
          yield {
            resolution: new URL(`${linkedProtocol}lib${name}.${version}.dylib`)
          }
        ) {
          return RESOLVED
        }
      }
    }

    if (
      yield {
        resolution: new URL(`${linkedProtocol}${name}.framework/${name}`)
      }
    ) {
      return RESOLVED
    }

    if (platform === 'darwin') {
      if (
        yield {
          resolution: new URL(`${linkedProtocol}lib${name}.dylib`)
        }
      ) {
        return RESOLVED
      }
    }

    return YIELDED
  }

  if (platform === 'linux' || platform === 'android') {
    if (version !== null) {
      if (
        yield {
          resolution: new URL(`${linkedProtocol}lib${name}.${version}.so`)
        }
      ) {
        return RESOLVED
      }
    }

    if (
      yield {
        resolution: new URL(`${linkedProtocol}lib${name}.so`)
      }
    ) {
      return RESOLVED
    }

    return YIELDED
  }

  if (platform === 'win32') {
    if (version !== null) {
      if (
        yield {
          resolution: new URL(`${linkedProtocol}${name}-${version}.dll`)
        }
      ) {
        return RESOLVED
      }
    }

    if (
      yield {
        resolution: new URL(`${linkedProtocol}${name}.dll`)
      }
    ) {
      return RESOLVED
    }
  }

  return UNRESOLVED
}

exports.isWindowsDriveLetter = resolve.isWindowsDriveLetter

exports.startsWithWindowsDriveLetter = resolve.startsWithWindowsDriveLetter
module.exports = class AddonResolveError extends Error {
  constructor(msg, code, fn = AddonResolveError) {
    super(`${code}: ${msg}`)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name() {
    return 'AddonResolveError'
  }

  static INVALID_ADDON_SPECIFIER(msg) {
    return new AddonResolveError(
      msg,
      'INVALID_ADDON_SPECIFIER',
      AddonResolveError.INVALID_ADDON_SPECIFIER
    )
  }

  static INVALID_PACKAGE_NAME(msg) {
    return new AddonResolveError(
      msg,
      'INVALID_PACKAGE_NAME',
      AddonResolveError.INVALID_PACKAGE_NAME
    )
  }
}
{
  "name": "bare-addon-resolve",
  "version": "1.9.4",
  "description": "Low-level addon resolution algorithm for Bare",
  "exports": {
    "./package": "./package.json",
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./errors": {
      "types": "./lib/errors.d.ts",
      "default": "./lib/errors.js"
    }
  },
  "files": [
    "index.js",
    "index.d.ts",
    "lib"
  ],
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-addon-resolve.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-addon-resolve/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-addon-resolve#readme",
  "dependencies": {
    "bare-module-resolve": "^1.10.0",
    "bare-semver": "^1.0.0"
  },
  "devDependencies": {
    "bare-url": "^2.1.3",
    "brittle": "^3.2.1",
    "prettier": "^3.3.3",
    "prettier-config-standard": "^7.0.0"
  },
  "peerDependencies": {
    "bare-url": "*"
  },
  "peerDependenciesMeta": {
    "bare-url": {
      "optional": true
    }
  }
}
const errors = require('./lib/errors')

class EventListener {
  constructor() {
    this.list = []
    this.count = 0
  }

  append(ctx, name, fn, once) {
    this.count++
    ctx.emit('newListener', name, fn) // Emit BEFORE adding
    this.list.push([fn, once])
  }

  prepend(ctx, name, fn, once) {
    this.count++
    ctx.emit('newListener', name, fn) // Emit BEFORE adding
    this.list.unshift([fn, once])
  }

  remove(ctx, name, fn) {
    for (let i = 0, n = this.list.length; i < n; i++) {
      const l = this.list[i]

      if (l[0] === fn) {
        this.list.splice(i, 1)

        if (this.count === 1) delete ctx._events[name]

        ctx.emit('removeListener', name, fn) // Emit AFTER removing

        this.count--
        return
      }
    }
  }

  removeAll(ctx, name) {
    const list = [...this.list]
    this.list = []

    if (this.count === list.length) delete ctx._events[name]

    for (let i = list.length - 1; i >= 0; i--) {
      ctx.emit('removeListener', name, list[i][0]) // Emit AFTER removing
    }

    this.count -= list.length
  }

  emit(ctx, name, ...args) {
    const list = [...this.list]

    for (let i = 0, n = list.length; i < n; i++) {
      const l = list[i]

      if (l[1] === true) this.remove(ctx, name, l[0])

      l[0].call(ctx, ...args)
    }

    return list.length > 0
  }
}

function appendListener(ctx, name, fn, once) {
  const e = ctx._events[name] || (ctx._events[name] = new EventListener())
  e.append(ctx, name, fn, once)
  return ctx
}

function prependListener(ctx, name, fn, once) {
  const e = ctx._events[name] || (ctx._events[name] = new EventListener())
  e.prepend(ctx, name, fn, once)
  return ctx
}

function removeListener(ctx, name, fn) {
  const e = ctx._events[name]
  if (e !== undefined) e.remove(ctx, name, fn)
  return ctx
}

function throwUnhandledError(...args) {
  let err

  if (args.length > 0) err = args[0]

  if (err instanceof Error === false) err = errors.UNHANDLED_ERROR(err)

  if (Error.captureStackTrace) {
    Error.captureStackTrace(err, exports.prototype.emit)
  }

  queueMicrotask(() => {
    throw err
  })
}

module.exports = exports = class EventEmitter {
  constructor() {
    this._events = Object.create(null)
  }

  addListener(name, fn) {
    return appendListener(this, name, fn, false)
  }

  addOnceListener(name, fn) {
    return appendListener(this, name, fn, true)
  }

  prependListener(name, fn) {
    return prependListener(this, name, fn, false)
  }

  prependOnceListener(name, fn) {
    return prependListener(this, name, fn, true)
  }

  removeListener(name, fn) {
    return removeListener(this, name, fn)
  }

  on(name, fn) {
    return appendListener(this, name, fn, false)
  }

  once(name, fn) {
    return appendListener(this, name, fn, true)
  }

  off(name, fn) {
    return removeListener(this, name, fn)
  }

  emit(name, ...args) {
    if (name === 'error' && this._events.error === undefined) {
      throwUnhandledError(...args)
    }

    const e = this._events[name]
    return e === undefined ? false : e.emit(this, name, ...args)
  }

  listeners(name) {
    const e = this._events[name]
    return e === undefined ? [] : [...e.list]
  }

  listenerCount(name) {
    const e = this._events[name]
    return e === undefined ? 0 : e.list.length
  }

  getMaxListeners() {
    return EventEmitter.defaultMaxListeners
  }

  setMaxListeners(n) {}

  removeAllListeners(name) {
    if (arguments.length === 0) {
      for (const key of Reflect.ownKeys(this._events)) {
        if (key === 'removeListener') continue
        this.removeAllListeners(key)
      }
      this.removeAllListeners('removeListener')
    } else {
      const e = this._events[name]
      if (e !== undefined) e.removeAll(this, name)
    }
    return this
  }
}

exports.EventEmitter = exports

exports.errors = errors

exports.defaultMaxListeners = 10

exports.on = function on(emitter, name, opts = {}) {
  const { signal } = opts

  if (signal && signal.aborted) {
    throw errors.OPERATION_ABORTED(signal.reason)
  }

  let error = null
  let done = false

  const events = []
  const promises = []

  emitter.on(name, onevent)

  if (name !== 'error') emitter.on('error', onerror)

  if (signal) signal.addEventListener('abort', onabort)

  return {
    next() {
      if (events.length) {
        return Promise.resolve({ value: events.shift(), done: false })
      }

      if (error) {
        const err = error

        error = null

        return Promise.reject(err)
      }

      if (done) return onclose()

      return new Promise((resolve, reject) =>
        promises.push({ resolve, reject })
      )
    },

    return() {
      return onclose()
    },

    throw(err) {
      return onerror(err)
    },

    [Symbol.asyncIterator]() {
      return this
    }
  }

  function onevent(...args) {
    if (promises.length) {
      promises.shift().resolve({ value: args, done: false })
    } else {
      events.push(args)
    }
  }

  function onerror(err) {
    if (promises.length) {
      promises.shift().reject(err)
    } else {
      error = err
    }

    return Promise.resolve({ done: true })
  }

  function onabort() {
    onerror(errors.OPERATION_ABORTED(signal.reason))
  }

  function onclose() {
    emitter.off(name, onevent)

    if (name !== 'error') emitter.off('error', onerror)

    if (signal) signal.removeEventListener('abort', onabort)

    done = true

    if (promises.length) promises.shift().resolve({ done: true })

    return Promise.resolve({ done: true })
  }
}

exports.once = function once(emitter, name, opts = {}) {
  const { signal } = opts

  if (signal && signal.aborted) {
    throw errors.OPERATION_ABORTED(signal.reason)
  }

  return new Promise((resolve, reject) => {
    if (name !== 'error') emitter.on('error', onerror)

    if (signal) signal.addEventListener('abort', onabort)

    emitter.once(name, (...args) => {
      if (name !== 'error') emitter.off('error', onerror)

      if (signal) signal.removeEventListener('abort', onabort)

      resolve(args)
    })

    function onerror(err) {
      emitter.off('error', onerror)

      reject(err)
    }

    function onabort() {
      signal.removeEventListener('abort', onabort)

      onerror(errors.OPERATION_ABORTED(signal.reason))
    }
  })
}

exports.forward = function forward(from, to, names, opts = {}) {
  if (typeof names === 'string') names = [names]

  const { emit = to.emit.bind(to) } = opts

  const listeners = names.map(
    (name) =>
      function onevent(...args) {
        emit(name, ...args)
      }
  )

  to.on('newListener', (name) => {
    const i = names.indexOf(name)

    if (i !== -1 && to.listenerCount(name) === 0) {
      from.on(name, listeners[i])
    }
  }).on('removeListener', (name) => {
    const i = names.indexOf(name)

    if (i !== -1 && to.listenerCount(name) === 0) {
      from.off(name, listeners[i])
    }
  })
}

exports.listenerCount = function listenerCount(emitter, name) {
  return emitter.listenerCount(name)
}

exports.getMaxListeners = function getMaxListeners(emitter) {
  return emitter.getMaxListeners()
}

exports.setMaxListeners = function setMaxListeners(n, ...emitters) {
  if (emitters.length === 0) exports.defaultMaxListeners = n
  else {
    for (const emitter of emitters) {
      emitter.setMaxListeners(n)
    }
  }
}
module.exports = class EventEmitterError extends Error {
  constructor(msg, code, fn = EventEmitterError, opts) {
    super(`${code}: ${msg}`, opts)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name() {
    return 'EventEmitterError'
  }

  static OPERATION_ABORTED(cause, msg = 'Operation aborted') {
    return new EventEmitterError(
      msg,
      'OPERATION_ABORTED',
      EventEmitterError.OPERATION_ABORTED,
      { cause }
    )
  }

  static UNHANDLED_ERROR(cause, msg = 'Unhandled error') {
    return new EventEmitterError(
      msg,
      'UNHANDLED_ERROR',
      EventEmitterError.UNHANDLED_ERROR,
      { cause }
    )
  }
}
{
  "name": "bare-events",
  "version": "2.6.0",
  "description": "Event emitters for JavaScript",
  "exports": {
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./package": "./package.json",
    "./errors": "./lib/errors.js"
  },
  "files": [
    "index.js",
    "index.d.ts",
    "lib"
  ],
  "scripts": {
    "test": "npm run lint && npm run test:bare && npm run test:node",
    "test:bare": "bare test.js",
    "test:node": "node test.js",
    "lint": "prettier . --check"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-events.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-events/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-events#readme",
  "devDependencies": {
    "brittle": "^3.3.2",
    "prettier": "^3.4.2",
    "prettier-config-standard": "^7.0.0"
  }
}
module.exports = require.addon()
const FIFO = require('fast-fifo')
const EventEmitter = require('bare-events')
const path = require('bare-path')
const { fileURLToPath } = require('bare-url')
const { Readable, Writable } = require('bare-stream')
const binding = require('./binding')
const constants = require('./lib/constants')
const FileError = require('./lib/errors')

const isWindows = Bare.platform === 'win32'

exports.constants = constants

class FileRequest {
  static _free = []

  static borrow() {
    if (this._free.length > 0) return this._free.pop()
    return new FileRequest()
  }

  static return(req) {
    if (this._free.length < 32) this._free.push(req.reset())
    else req.destroy()
  }

  constructor() {
    this._reset()
    this._handle = binding.requestInit(this, this._onresult)
  }

  get handle() {
    return this._handle
  }

  retain(value) {
    this._retain = value // Tie the lifetime of `value` to the lifetime of `this`
  }

  reset() {
    if (this._handle === null) return this

    binding.requestReset(this._handle)

    this._reset()

    return this
  }

  destroy() {
    if (this._handle === null) return this

    binding.requestDestroy(this._handle)

    this._reset()
    this._handle = null

    return this
  }

  then(resolve, reject) {
    return this._promise.then(resolve, reject)
  }

  return() {
    if (this._handle === null) return this

    FileRequest.return(this)

    return this
  }

  [Symbol.dispose]() {
    this.return()
  }

  _reset() {
    const { promise, resolve, reject } = Promise.withResolvers()

    this._promise = promise
    this._resolve = resolve
    this._reject = reject
    this._retain = null
  }

  _onresult(err, status) {
    if (err) this._reject(err)
    else this._resolve(status)
  }
}

function ok(result, cb) {
  if (typeof result === 'function') {
    cb = result
    result = undefined
  }

  if (cb) cb(null, result)
  else return result
}

function fail(err, cb) {
  if (cb) cb(err)
  else throw err
}

function done(err, result, cb) {
  if (typeof result === 'function') {
    cb = result
    result = undefined
  }

  if (err) fail(err, cb)
  else return ok(result, cb)
}

async function open(filepath, flags = 'r', mode = 0o666, cb) {
  if (typeof flags === 'function') {
    cb = flags
    flags = 'r'
    mode = 0o666
  } else if (typeof mode === 'function') {
    cb = mode
    mode = 0o666
  }

  if (typeof flags === 'string') flags = toFlags(flags)
  if (typeof mode === 'string') mode = toMode(mode)

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let fd
  let err = null
  try {
    binding.open(req.handle, filepath, flags, mode)

    fd = await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'open',
      code: e.code,
      path: filepath
    })
  }

  return done(err, fd, cb)
}

function openSync(filepath, flags = 'r', mode = 0o666) {
  if (typeof flags === 'string') flags = toFlags(flags)
  if (typeof mode === 'string') mode = toMode(mode)

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    return binding.openSync(req.handle, filepath, flags, mode)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'open',
      code: e.code,
      path: filepath
    })
  }
}

async function close(fd, cb) {
  using req = FileRequest.borrow()

  let err = null
  try {
    binding.close(req.handle, fd)

    await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'close', code: e.code, fd })
  }

  return done(err, cb)
}

function closeSync(fd) {
  using req = FileRequest.borrow()

  try {
    binding.closeSync(req.handle, fd)
  } catch (e) {
    throw new FileError(e.message, { operation: 'close', code: e.code, fd })
  }
}

async function access(filepath, mode = constants.F_OK, cb) {
  if (typeof mode === 'function') {
    cb = mode
    mode = constants.F_OK
  }

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.access(req.handle, filepath, mode)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'access',
      code: e.code,
      path: filepath
    })
  }

  return done(err, cb)
}

function accessSync(filepath, mode = constants.F_OK) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.accessSync(req.handle, filepath, mode)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'access',
      code: e.code,
      path: filepath
    })
  }
}

async function exists(filepath, cb) {
  let ok = true
  try {
    await access(filepath)
  } catch {
    ok = false
  }

  return done(null, ok, cb)
}

function existsSync(filepath) {
  try {
    accessSync(filepath)
  } catch {
    return false
  }

  return true
}

async function read(fd, buffer, offset = 0, len = buffer.byteLength - offset, pos = -1, cb) {
  if (typeof offset === 'function') {
    cb = offset
    offset = 0
    len = buffer.byteLength
    pos = -1
  } else if (typeof len === 'function') {
    cb = len
    len = buffer.byteLength - offset
    pos = -1
  } else if (typeof pos === 'function') {
    cb = pos
    pos = -1
  }

  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  let bytes
  let err = null
  try {
    binding.read(req.handle, fd, buffer, offset, len, pos)

    bytes = await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'read', code: e.code, fd })
  }

  return done(err, bytes, cb)
}

function readSync(fd, buffer, offset = 0, len = buffer.byteLength - offset, pos = -1) {
  using req = FileRequest.borrow()

  try {
    return binding.readSync(req.handle, fd, buffer, offset, len, pos)
  } catch (e) {
    throw new FileError(e.message, { operation: 'read', code: e.code, fd })
  }
}

async function readv(fd, buffers, pos = -1, cb) {
  if (typeof pos === 'function') {
    cb = pos
    pos = -1
  }

  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  let bytes
  let err = null
  try {
    binding.readv(req.handle, fd, buffers, pos)

    bytes = await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'readv', code: e.code, fd })
  }

  return done(err, bytes, cb)
}

function readvSync(fd, buffers, pos = -1) {
  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  try {
    return binding.readvSync(req.handle, fd, buffers, pos)
  } catch (e) {
    throw new FileError(e.message, { operation: 'readv', code: e.code, fd })
  }
}

async function write(fd, data, offset = 0, len, pos = -1, cb) {
  if (typeof data === 'string') {
    let encoding = len
    cb = pos
    pos = offset

    if (typeof pos === 'function') {
      cb = pos
      pos = -1
      encoding = 'utf8'
    } else if (typeof encoding === 'function') {
      cb = encoding
      encoding = 'utf8'
    }

    if (typeof pos === 'string') {
      encoding = pos
      pos = -1
    }

    data = Buffer.from(data, encoding)
    offset = 0
    len = data.byteLength
  } else if (typeof offset === 'function') {
    cb = offset
    offset = 0
    len = data.byteLength
    pos = -1
  } else if (typeof len === 'function') {
    cb = len
    len = data.byteLength - offset
    pos = -1
  } else if (typeof pos === 'function') {
    cb = pos
    pos = -1
  }

  if (typeof len !== 'number') len = data.byteLength - offset
  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  let bytes
  let err = null
  try {
    binding.write(req.handle, fd, data, offset, len, pos)

    bytes = await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'write', code: e.code, fd })
  }

  return done(err, bytes, cb)
}

function writeSync(fd, data, offset = 0, len, pos = -1) {
  if (typeof data === 'string') {
    let encoding = len
    pos = offset

    if (typeof pos === 'string') {
      encoding = pos
      pos = -1
    }

    data = Buffer.from(data, encoding)
    offset = 0
    len = data.byteLength
  }

  if (typeof len !== 'number') len = data.byteLength - offset
  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  try {
    return binding.writeSync(req.handle, fd, data, offset, len, pos)
  } catch (e) {
    throw new FileError(e.message, { operation: 'write', code: e.code, fd })
  }
}

async function writev(fd, buffers, pos = -1, cb) {
  if (typeof pos === 'function') {
    cb = pos
    pos = -1
  }

  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  let bytes
  let err = null
  try {
    binding.writev(req.handle, fd, buffers, pos)

    bytes = await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'writev', code: e.code, fd })
  }

  return done(err, bytes, cb)
}

function writevSync(fd, buffers, pos = -1) {
  if (typeof pos !== 'number') pos = -1

  using req = FileRequest.borrow()

  try {
    return binding.writevSync(req.handle, fd, buffers, pos)
  } catch (e) {
    throw new FileError(e.message, { operation: 'writev', code: e.code, fd })
  }
}

async function stat(filepath, cb) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let st
  let err = null
  try {
    binding.stat(req.handle, filepath)

    await req

    st = new Stats(...binding.requestResultStat(req.handle))
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'stat',
      code: e.code,
      path: filepath
    })
  }

  return done(err, st, cb)
}

function statSync(filepath) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.statSync(req.handle, filepath)

    return new Stats(...binding.requestResultStat(req.handle))
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'stat',
      code: e.code,
      path: filepath
    })
  }
}

async function lstat(filepath, cb) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let st
  let err = null
  try {
    binding.lstat(req.handle, filepath)

    await req

    st = new Stats(...binding.requestResultStat(req.handle))
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'lstat',
      code: e.code,
      path: filepath
    })
  }

  return done(err, st, cb)
}

function lstatSync(filepath) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.lstatSync(req.handle, filepath)

    return new Stats(...binding.requestResultStat(req.handle))
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'lstat',
      code: e.code,
      path: filepath
    })
  }
}

async function fstat(fd, cb) {
  using req = FileRequest.borrow()

  let st
  let err = null
  try {
    binding.fstat(req.handle, fd)

    await req

    st = new Stats(...binding.requestResultStat(req.handle))
  } catch (e) {
    err = new FileError(e.message, { operation: 'fstat', code: e.code, fd })
  }

  return done(err, st, cb)
}

function fstatSync(fd) {
  using req = FileRequest.borrow()

  try {
    binding.fstatSync(req.handle, fd)

    return new Stats(...binding.requestResultStat(req.handle))
  } catch (e) {
    throw new FileError(e.message, { operation: 'fstat', code: e.code, fd })
  }
}

async function ftruncate(fd, len = 0, cb) {
  if (typeof len === 'function') {
    cb = len
    len = 0
  }

  if (typeof len !== 'number') len = 0

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.ftruncate(req.handle, fd, len)

    await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'ftruncate', code: e.code, fd })
  }

  return done(err, cb)
}

function ftruncateSync(fd, len = 0) {
  if (typeof len !== 'number') len = 0

  using req = FileRequest.borrow()

  try {
    binding.ftruncateSync(req.handle, fd, len)
  } catch (e) {
    throw new FileError(e.message, { operation: 'ftruncate', code: e.code, fd })
  }
}

async function chmod(filepath, mode, cb) {
  if (typeof mode === 'string') mode = toMode(mode)

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.chmod(req.handle, filepath, mode)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'chmod',
      code: e.code,
      path: filepath
    })
  }

  return done(err, cb)
}

function chmodSync(filepath, mode) {
  if (typeof mode === 'string') mode = toMode(mode)

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.chmodSync(req.handle, filepath, mode)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'chmod',
      code: e.code,
      path: filepath
    })
  }
}

async function fchmod(fd, mode, cb) {
  if (typeof mode === 'string') mode = toMode(mode)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.fchmod(req.handle, fd, mode)

    await req
  } catch (e) {
    err = new FileError(e.message, { operation: 'fchmod', code: e.code, fd })
  }

  return done(err, cb)
}

function fchmodSync(fd, mode) {
  if (typeof mode === 'string') mode = toMode(mode)

  using req = FileRequest.borrow()

  try {
    binding.fchmodSync(req.handle, fd, mode)
  } catch (e) {
    throw new FileError(e.message, { operation: 'fchmod', code: e.code, fd })
  }
}

async function utimes(filepath, atime, mtime, cb) {
  if (typeof atime !== 'number') atime = atime.getTime() / 1000
  if (typeof mtime !== 'number') mtime = mtime.getTime() / 1000

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.utimes(req.handle, filepath, atime, mtime)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'utimes',
      code: e.code,
      path: filepath
    })
  }

  return done(err, cb)
}

function utimesSync(filepath, atime, mtime) {
  if (typeof atime !== 'number') atime = atime.getTime() / 1000
  if (typeof mtime !== 'number') mtime = mtime.getTime() / 1000

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.utimesSync(req.handle, filepath, atime, mtime)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'utimes',
      code: e.code,
      path: filepath
    })
  }
}

async function mkdir(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = { mode: 0o777 }
  }

  if (typeof opts === 'number') opts = { mode: opts }
  else if (!opts) opts = {}

  const mode = typeof opts.mode === 'number' ? opts.mode : 0o777

  filepath = toNamespacedPath(filepath)

  if (opts.recursive) {
    let err = null
    try {
      try {
        await mkdir(filepath, { mode })
      } catch (err) {
        if (err.code !== 'ENOENT') {
          if (!(await stat(filepath)).isDirectory()) throw err
        } else {
          while (filepath.endsWith(path.sep)) filepath = filepath.slice(0, -1)
          const i = filepath.lastIndexOf(path.sep)
          if (i <= 0) throw err

          await mkdir(filepath.slice(0, i), { mode, recursive: true })

          try {
            await mkdir(filepath, { mode })
          } catch (err) {
            if (!(await stat(filepath)).isDirectory()) throw err
          }
        }
      }
    } catch (e) {
      err = e
    }

    return done(err, cb)
  }

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.mkdir(req.handle, filepath, mode)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'mkdir',
      code: e.code,
      path: filepath
    })
  }

  return done(err, cb)
}

function mkdirSync(filepath, opts) {
  if (typeof opts === 'number') opts = { mode: opts }
  else if (!opts) opts = {}

  const mode = typeof opts.mode === 'number' ? opts.mode : 0o777

  filepath = toNamespacedPath(filepath)

  if (opts.recursive) {
    try {
      mkdirSync(filepath, { mode })
    } catch (err) {
      if (err.code !== 'ENOENT') {
        if (!statSync(filepath).isDirectory()) throw err
      } else {
        while (filepath.endsWith(path.sep)) filepath = filepath.slice(0, -1)
        const i = filepath.lastIndexOf(path.sep)
        if (i <= 0) throw err

        mkdirSync(filepath.slice(0, i), { mode, recursive: true })

        try {
          mkdirSync(filepath, { mode })
        } catch (err) {
          if (!statSync(filepath).isDirectory()) throw err
        }
      }
    }

    return
  }

  using req = FileRequest.borrow()

  try {
    binding.mkdirSync(req.handle, filepath, mode)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'mkdir',
      code: e.code,
      path: filepath
    })
  }
}

async function rmdir(filepath, cb) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.rmdir(req.handle, filepath)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'rmdir',
      code: e.code,
      path: filepath
    })
  }

  return done(err, cb)
}

function rmdirSync(filepath) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.rmdirSync(req.handle, filepath)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'rmdir',
      code: e.code,
      path: filepath
    })
  }
}

async function rm(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (!opts) opts = {}

  filepath = toNamespacedPath(filepath)

  let err = null
  try {
    const st = await lstat(filepath)

    if (st.isDirectory()) {
      if (opts.recursive) {
        try {
          await rmdir(filepath)
        } catch (err) {
          if (err.code !== 'ENOTEMPTY') throw err

          const files = await readdir(filepath)

          for (const file of files) {
            await rm(filepath + path.sep + file, opts)
          }

          await rmdir(filepath)
        }
      } else {
        throw new FileError('is a directory', {
          operation: 'rm',
          code: 'EISDIR',
          path: filepath
        })
      }
    } else {
      await unlink(filepath)
    }
  } catch (e) {
    if (e.code !== 'ENOENT' || !opts.force) err = e
  }

  return done(err, cb)
}

function rmSync(filepath, opts) {
  if (!opts) opts = {}

  filepath = toNamespacedPath(filepath)

  try {
    const st = lstatSync(filepath)

    if (st.isDirectory()) {
      if (opts.recursive) {
        try {
          rmdirSync(filepath)
        } catch (err) {
          if (err.code !== 'ENOTEMPTY') throw err

          const files = readdirSync(filepath)

          for (const file of files) {
            rmSync(filepath + path.sep + file, opts)
          }

          rmdirSync(filepath)
        }
      } else {
        throw new FileError('is a directory', {
          operation: 'rm',
          code: 'EISDIR',
          path: filepath
        })
      }
    } else {
      unlinkSync(filepath)
    }
  } catch (err) {
    if (err.code !== 'ENOENT' || !opts.force) throw err
  }
}

async function unlink(filepath, cb) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.unlink(req.handle, filepath)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'unlink',
      code: e.code,
      path: filepath
    })
  }

  return done(err, cb)
}

function unlinkSync(filepath) {
  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.unlinkSync(req.handle, filepath)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'unlink',
      code: e.code,
      path: filepath
    })
  }
}

async function rename(src, dst, cb) {
  src = toNamespacedPath(src)
  dst = toNamespacedPath(dst)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.rename(req.handle, src, dst)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'rename',
      code: e.code,
      path: src,
      destination: dst
    })
  }

  return done(err, cb)
}

function renameSync(src, dst) {
  src = toNamespacedPath(src)
  dst = toNamespacedPath(dst)

  using req = FileRequest.borrow()

  try {
    binding.renameSync(req.handle, src, dst)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'rename',
      code: e.code,
      path: src,
      destination: dst
    })
  }
}

async function copyFile(src, dst, mode = 0, cb) {
  if (typeof mode === 'function') {
    cb = mode
    mode = 0
  }

  src = toNamespacedPath(src)
  dst = toNamespacedPath(dst)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.copyfile(req.handle, src, dst, mode)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'copyfile',
      code: e.code,
      path: src,
      destination: dst
    })
  }

  return done(err, cb)
}

function copyFileSync(src, dst, mode = 0) {
  src = toNamespacedPath(src)
  dst = toNamespacedPath(dst)

  using req = FileRequest.borrow()

  try {
    binding.copyfileSync(req.handle, src, dst, mode)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'copyfile',
      code: e.code,
      path: src,
      destination: dst
    })
  }
}

async function cp(src, dst, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (!opts) opts = {}

  src = toNamespacedPath(src)
  dst = toNamespacedPath(dst)

  let err = null
  try {
    const st = await lstat(src)

    if (st.isDirectory()) {
      if (opts.recursive !== true) {
        throw new FileError('is a directory', {
          operation: 'cp',
          code: 'EISDIR',
          path: src
        })
      }

      try {
        await lstat(dst)
      } catch (e) {
        if (e.code === 'ENOENT') {
          await mkdir(dst, { mode: st.mode, recursive: true })
        } else {
          throw e
        }
      }

      const dir = await opendir(src)
      for await (const { name } of dir) {
        await cp(path.join(src, name), path.join(dst, name), opts)
      }
    } else if (st.isFile()) {
      await copyFile(src, dst)
      await chmod(dst, st.mode)
    }
  } catch (e) {
    err = e
  }

  return done(err, cb)
}

async function realpath(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { encoding = 'utf8' } = opts

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let res
  let err = null
  try {
    binding.realpath(req.handle, filepath)

    await req

    res = Buffer.from(binding.requestResultString(req.handle))

    if (encoding !== 'buffer') res = res.toString(encoding)
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'realpath',
      code: e.code,
      path: filepath
    })
  }

  return done(err, res, cb)
}

function realpathSync(filepath, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { encoding = 'utf8' } = opts

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.realpathSync(req.handle, filepath)

    let res = Buffer.from(binding.requestResultString(req.handle))

    if (encoding !== 'buffer') res = res.toString(encoding)

    return res
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'realpath',
      code: e.code,
      path: filepath
    })
  }
}

async function readlink(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { encoding = 'utf8' } = opts

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let res
  let err = null
  try {
    binding.readlink(req.handle, filepath)

    await req

    res = Buffer.from(binding.requestResultString(req.handle))

    if (encoding !== 'buffer') res = res.toString(encoding)
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'readlink',
      code: e.code,
      path: filepath
    })
  }

  return done(err, res, cb)
}

function readlinkSync(filepath, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { encoding = 'utf8' } = opts

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.readlinkSync(req.handle, filepath)

    let res = Buffer.from(binding.requestResultString(req.handle))

    if (encoding !== 'buffer') res = res.toString(encoding)

    return res
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'readlink',
      code: e.code,
      path: filepath
    })
  }
}

function normalizeSymlinkTarget(target, type, filepath) {
  if (isWindows) {
    if (type === 'junction') target = path.resolve(filepath, '..', target)

    if (path.isAbsolute(target)) return path.toNamespacedPath(target)

    return target.replace(/\//g, path.sep)
  }

  return target
}

async function symlink(target, filepath, type, cb) {
  if (typeof type === 'function') {
    cb = type
    type = null
  }

  filepath = toNamespacedPath(filepath)

  if (typeof type === 'string') {
    switch (type) {
      case 'file':
      default:
        type = 0
        break
      case 'dir':
        type = constants.UV_FS_SYMLINK_DIR
        break
      case 'junction':
        type = constants.UV_FS_SYMLINK_JUNCTION
        break
    }
  } else if (typeof type !== 'number') {
    if (isWindows) {
      target = path.resolve(filepath, '..', target)

      try {
        type = (await stat(target)).isDirectory()
          ? constants.UV_FS_SYMLINK_DIR
          : constants.UV_FS_SYMLINK_JUNCTION
      } catch {
        type = 0
      }
    } else {
      type = 0
    }
  }

  target = normalizeSymlinkTarget(target)

  using req = FileRequest.borrow()

  let err = null
  try {
    binding.symlink(req.handle, target, filepath, type)

    await req
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'symlink',
      code: e.code,
      path: target,
      destination: filepath
    })
  }

  return done(err, cb)
}

function symlinkSync(target, filepath, type) {
  filepath = toNamespacedPath(filepath)

  if (typeof type === 'string') {
    switch (type) {
      case 'file':
      default:
        type = 0
        break
      case 'dir':
        type = constants.UV_FS_SYMLINK_DIR
        break
      case 'junction':
        type = constants.UV_FS_SYMLINK_JUNCTION
        break
    }
  } else if (typeof type !== 'number') {
    if (isWindows) {
      target = path.resolve(filepath, '..', target)

      try {
        type = statSync(target).isDirectory()
          ? constants.UV_FS_SYMLINK_DIR
          : constants.UV_FS_SYMLINK_JUNCTION
      } catch {
        type = 0
      }
    } else {
      type = 0
    }
  }

  target = normalizeSymlinkTarget(target)

  using req = FileRequest.borrow()

  try {
    binding.symlinkSync(req.handle, target, filepath, type)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'symlink',
      code: e.code,
      path: target,
      destination: filepath
    })
  }
}

async function opendir(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  let dir
  let err = null
  try {
    binding.opendir(req.handle, filepath)

    await req

    dir = new Dir(filepath, binding.requestResultDir(req.handle), opts)
  } catch (e) {
    err = new FileError(e.message, {
      operation: 'opendir',
      code: e.code,
      path: filepath
    })
  }

  return done(err, dir, cb)
}

function opendirSync(filepath, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  filepath = toNamespacedPath(filepath)

  using req = FileRequest.borrow()

  try {
    binding.opendirSync(req.handle, filepath)

    return new Dir(filepath, binding.requestResultDir(req.handle), opts)
  } catch (e) {
    throw new FileError(e.message, {
      operation: 'opendir',
      code: e.code,
      path: filepath
    })
  }
}

async function readdir(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { withFileTypes = false } = opts

  filepath = toNamespacedPath(filepath)

  let result = []
  let err = null
  try {
    const dir = await opendir(filepath)

    for await (const entry of dir) {
      result.push(withFileTypes ? entry : entry.name)
    }
  } catch (e) {
    result = []
    err = e
  }

  return done(err, result, cb)
}

function readdirSync(filepath, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { withFileTypes = false } = opts

  filepath = toNamespacedPath(filepath)

  const dir = opendirSync(filepath, opts)
  const result = []

  for (const entry of dir) {
    result.push(withFileTypes ? entry : entry.name)
  }

  return result
}

async function readFile(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { encoding = 'buffer' } = opts

  let fd = -1
  let buffer = null
  let err = null
  try {
    fd = await open(filepath, opts.flag || 'r')

    const st = await fstat(fd)

    let len = 0

    if (st.size === 0) {
      const buffers = []

      while (true) {
        buffer = Buffer.allocUnsafe(8192)
        const r = await read(fd, buffer)
        len += r
        if (r === 0) break
        buffers.push(buffer.subarray(0, r))
      }

      buffer = Buffer.concat(buffers)
    } else {
      buffer = Buffer.allocUnsafe(st.size)

      while (true) {
        const r = await read(fd, len ? buffer.subarray(len) : buffer)
        len += r
        if (r === 0 || len === buffer.byteLength) break
      }

      if (len !== buffer.byteLength) buffer = buffer.subarray(0, len)
    }

    if (encoding !== 'buffer') buffer = buffer.toString(encoding)
  } catch (e) {
    err = e
  } finally {
    if (fd !== -1) await close(fd)
  }

  return done(err, buffer, cb)
}

function readFileSync(filepath, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  const { encoding = 'buffer' } = opts

  let fd = -1
  try {
    fd = openSync(filepath, opts.flag || 'r')

    const st = fstatSync(fd)

    let buffer
    let len = 0

    if (st.size === 0) {
      const buffers = []

      while (true) {
        buffer = Buffer.allocUnsafe(8192)
        const r = readSync(fd, buffer)
        len += r
        if (r === 0) break
        buffers.push(buffer.subarray(0, r))
      }

      buffer = Buffer.concat(buffers)
    } else {
      buffer = Buffer.allocUnsafe(st.size)

      while (true) {
        const r = readSync(fd, len ? buffer.subarray(len) : buffer)
        len += r
        if (r === 0 || len === buffer.byteLength) break
      }

      if (len !== buffer.byteLength) buffer = buffer.subarray(0, len)
    }

    if (encoding !== 'buffer') buffer = buffer.toString(encoding)

    return buffer
  } finally {
    if (fd !== -1) closeSync(fd)
  }
}

async function writeFile(filepath, data, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  if (typeof data === 'string') data = Buffer.from(data, opts.encoding)

  let fd = -1
  let len = 0
  let err = null
  try {
    fd = await open(filepath, opts.flag || 'w', opts.mode || 0o666)

    while (true) {
      len += await write(fd, len ? data.subarray(len) : data)
      if (len === data.byteLength) break
    }
  } catch (e) {
    err = e
  } finally {
    if (fd !== -1) await close(fd)
  }

  return done(err, len, cb)
}

function writeFileSync(filepath, data, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  if (typeof data === 'string') data = Buffer.from(data, opts.encoding)

  let fd = -1
  try {
    fd = openSync(filepath, opts.flag || 'w', opts.mode || 0o666)

    let len = 0

    while (true) {
      len += writeSync(fd, len ? data.subarray(len) : data)
      if (len === data.byteLength) break
    }
  } finally {
    if (fd !== -1) closeSync(fd)
  }
}

function appendFile(filepath, data, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  if (!opts.flag) opts = { ...opts, flag: 'a' }

  return writeFile(filepath, data, opts, cb)
}

function appendFileSync(filepath, data, opts) {
  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  if (!opts.flag) opts = { ...opts, flag: 'a' }

  return writeFileSync(filepath, data, opts)
}

function watch(filepath, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (typeof opts === 'string') opts = { encoding: opts }
  else if (!opts) opts = {}

  filepath = toNamespacedPath(filepath)

  return new Watcher(filepath, opts, cb)
}

class Stats {
  constructor(
    dev,
    mode,
    nlink,
    uid,
    gid,
    rdev,
    blksize,
    ino,
    size,
    blocks,
    atimeMs,
    mtimeMs,
    ctimeMs,
    birthtimeMs
  ) {
    this.dev = dev
    this.mode = mode
    this.nlink = nlink
    this.uid = uid
    this.gid = gid
    this.rdev = rdev
    this.blksize = blksize
    this.ino = ino
    this.size = size
    this.blocks = blocks
    this.atimeMs = atimeMs
    this.mtimeMs = mtimeMs
    this.ctimeMs = ctimeMs
    this.birthtimeMs = birthtimeMs
    this.atime = new Date(atimeMs)
    this.mtime = new Date(mtimeMs)
    this.ctime = new Date(ctimeMs)
    this.birthtime = new Date(birthtimeMs)
  }

  isDirectory() {
    return (this.mode & constants.S_IFMT) === constants.S_IFDIR
  }

  isFile() {
    return (this.mode & constants.S_IFMT) === constants.S_IFREG
  }

  isBlockDevice() {
    return (this.mode & constants.S_IFMT) === constants.S_IFBLK
  }

  isCharacterDevice() {
    return (this.mode & constants.S_IFCHR) === constants.S_IFCHR
  }

  isFIFO() {
    return (this.mode & constants.S_IFMT) === constants.S_IFIFO
  }

  isSymbolicLink() {
    return (this.mode & constants.S_IFMT) === constants.S_IFLNK
  }

  isSocket() {
    return (this.mode & constants.S_IFMT) === constants.S_IFSOCK
  }
}

class Dir {
  constructor(path, handle, opts = {}) {
    const { encoding = 'utf8', bufferSize = 32 } = opts

    this.path = path

    this._encoding = encoding
    this._capacity = bufferSize
    this._buffer = new FIFO()
    this._ended = false
    this._handle = handle
  }

  async read(cb) {
    if (this._buffer.length) return ok(this._buffer.shift(), cb)
    if (this._ended) return ok(null, cb)

    using req = FileRequest.borrow()

    let entries
    let err = null
    try {
      req.retain(binding.readdir(req.handle, this._handle, this._capacity))

      await req

      entries = binding.requestResultDirents(req.handle)
    } catch (e) {
      err = new FileError(e.message, {
        operation: 'readdir',
        code: e.code,
        path: this.path
      })
    }

    if (err) return fail(err, cb)

    if (entries.length === 0) {
      this._ended = true

      return ok(null, cb)
    }

    for (const entry of entries) {
      let name = Buffer.from(entry.name)

      if (this._encoding !== 'buffer') name = name.toString(this._encoding)

      this._buffer.push(new Dirent(this.path, name, entry.type))
    }

    return ok(this._buffer.shift(), cb)
  }

  readSync() {
    if (this._buffer.length) return this._buffer.shift()
    if (this._ended) return null

    using req = FileRequest.borrow()

    let entries
    try {
      req.retain(binding.readdirSync(req.handle, this._handle, this._capacity))

      entries = binding.requestResultDirents(req.handle)
    } catch (e) {
      throw new FileError(e.message, {
        operation: 'readdir',
        code: e.code,
        path: this.path
      })
    }

    if (entries.length === 0) {
      this._ended = true

      return null
    }

    for (const entry of entries) {
      let name = Buffer.from(entry.name)

      if (this._encoding !== 'buffer') name = name.toString(this._encoding)

      this._buffer.push(new Dirent(this.path, name, entry.type))
    }

    return this._buffer.shift()
  }

  async close(cb) {
    using req = FileRequest.borrow()

    let err = null
    try {
      binding.closedir(req.handle, this._handle)

      await req
    } catch (e) {
      err = new FileError(e.message, {
        operation: 'closedir',
        code: e.code,
        path: this.path
      })
    }

    this._handle = null

    return done(err, cb)
  }

  closeSync() {
    using req = FileRequest.borrow()

    try {
      binding.closedirSync(req.handle, this._handle)
    } catch (e) {
      throw new FileError(e.message, {
        operation: 'closedir',
        code: e.code,
        path: this.path
      })
    }

    this._handle = null
  }

  [Symbol.dispose]() {
    this.closeSync()
  }

  async [Symbol.asyncDispose]() {
    await this.close()
  }

  *[Symbol.iterator]() {
    while (true) {
      const entry = this.readSync()
      if (entry === null) break
      yield entry
    }

    this.closeSync()
  }

  async *[Symbol.asyncIterator]() {
    while (true) {
      const entry = await this.read()
      if (entry === null) break
      yield entry
    }

    await this.close()
  }
}

class Dirent {
  constructor(path, name, type) {
    this.path = path
    this.name = name
    this.type = type
  }

  isFile() {
    return this.type === constants.UV_DIRENT_FILE
  }

  isDirectory() {
    return this.type === constants.UV_DIRENT_DIR
  }

  isSymbolicLink() {
    return this.type === constants.UV_DIRENT_LINK
  }

  isFIFO() {
    return this.type === constants.UV_DIRENT_FIFO
  }

  isSocket() {
    return this.type === constants.UV_DIRENT_SOCKET
  }

  isCharacterDevice() {
    return this.type === constants.UV_DIRENT_CHAR
  }

  isBlockDevice() {
    return this.type === constants.UV_DIRENT_BLOCK
  }
}

class FileReadStream extends Readable {
  constructor(path, opts = {}) {
    const { eagerOpen = true } = opts

    super({ eagerOpen, ...opts })

    this.path = path
    this.fd = typeof opts.fd === 'number' ? opts.fd : -1
    this.flags = opts.flags || 'r'
    this.mode = opts.mode || 0o666

    this._offset = opts.start || 0
    this._missing = 0

    if (opts.length) {
      this._missing = opts.length
    } else if (typeof opts.end === 'number') {
      this._missing = opts.end - this._offset + 1
    } else {
      this._missing = -1
    }
  }

  async _open(cb) {
    let err

    if (this.fd === -1) {
      err = null
      try {
        this.fd = await open(this.path, this.flags, this.mode)
      } catch (e) {
        err = e
      }

      if (err) return cb(err)
    }

    let st
    err = null
    try {
      st = await fstat(this.fd)
    } catch (e) {
      err = e
    }

    if (err) return cb(err)

    if (this._missing === -1) this._missing = st.size

    if (st.size < this._offset) {
      this._offset = st.size
      this._missing = 0
    } else if (st.size < this._offset + this._missing) {
      this._missing = st.size - this._offset
    }

    cb(null)
  }

  async _read(size) {
    if (this._missing <= 0) return this.push(null)

    const data = Buffer.allocUnsafe(Math.min(this._missing, size))

    let len
    let err = null
    try {
      len = await read(this.fd, data, 0, data.byteLength, this._offset)
    } catch (e) {
      err = e
    }

    if (err) return this.destroy(err)

    if (len === 0) return this.push(null)

    if (this._missing < len) len = this._missing

    this._missing -= len
    this._offset += len

    this.push(data.subarray(0, len))
  }

  async _destroy(err, cb) {
    if (this.fd === -1) return cb(err)

    err = null
    try {
      await close(this.fd)
    } catch (e) {
      err = e
    }

    cb(err)
  }
}

class FileWriteStream extends Writable {
  constructor(path, opts = {}) {
    const { eagerOpen = true } = opts

    super({ eagerOpen, ...opts })

    this.path = path
    this.fd = typeof opts.fd === 'number' ? opts.fd : -1
    this.flags = opts.flags || 'w'
    this.mode = opts.mode || 0o666
  }

  async _open(cb) {
    if (this.fd !== -1) return cb(null)

    let err = null
    try {
      this.fd = await open(this.path, this.flags, this.mode)
    } catch (e) {
      err = e
    }

    cb(err)
  }

  async _writev(batch, cb) {
    let err = null
    try {
      await writev(
        this.fd,
        batch.map(({ chunk }) => chunk)
      )
    } catch (e) {
      err = e
    }

    cb(err)
  }

  async _destroy(err, cb) {
    if (this.fd === -1) return cb(err)

    err = null
    try {
      await close(this.fd)
    } catch (e) {
      err = e
    }

    cb(err)
  }
}

class Watcher extends EventEmitter {
  constructor(path, opts, onchange) {
    if (typeof opts === 'function') {
      onchange = opts
      opts = {}
    }

    if (!opts) opts = {}

    const { persistent = true, recursive = false, encoding = 'utf8' } = opts

    super()

    this._closed = false
    this._encoding = encoding
    this._handle = binding.watcherInit(path, recursive, this, this._onevent, this._onclose)

    if (!persistent) this.unref()

    if (onchange) this.on('change', onchange)
  }

  close() {
    if (this._closed) return
    this._closed = true

    binding.watcherClose(this._handle)
  }

  ref() {
    if (this._handle) binding.watcherRef(this._handle)
    return this
  }

  unref() {
    if (this._handle) binding.watcherUnref(this._handle)
    return this
  }

  [Symbol.asyncIterator]() {
    const buffer = []
    let done = false
    let error = null
    let next = null

    this.on('change', (eventType, filename) => {
      if (next) {
        next.resolve({ done: false, value: { eventType, filename } })
        next = null
      } else {
        buffer.push({ eventType, filename })
      }
    })
      .on('error', (err) => {
        done = true
        error = err

        if (next) {
          next.reject(error)
          next = null
        }
      })
      .on('close', () => {
        done = true

        if (next) {
          next.resolve({ done })
          next = null
        }
      })

    return {
      next: () =>
        new Promise((resolve, reject) => {
          if (error) return reject(error)

          if (buffer.length) return resolve({ done: false, value: buffer.shift() })

          if (done) return resolve({ done })

          next = { resolve, reject }
        })
    }
  }

  _onevent(err, events, filename) {
    if (err) {
      this.close()
      this.emit('error', err)
    } else {
      const path =
        this._encoding === 'buffer'
          ? Buffer.from(filename)
          : Buffer.from(filename).toString(this._encoding)

      if (events & binding.UV_RENAME) {
        this.emit('change', 'rename', path)
      }

      if (events & binding.UV_CHANGE) {
        this.emit('change', 'change', path)
      }
    }
  }

  _onclose() {
    this._handle = null

    this.emit('close')
  }
}

exports.access = access
exports.appendFile = appendFile
exports.chmod = chmod
// exports.chown = chown TODO
exports.close = close
exports.copyFile = copyFile
exports.cp = cp
exports.exists = exists
exports.fchmod = fchmod
// exports.fchown = fchown TODO
// exports.fdatasync = fdatasync TODO
exports.fstat = fstat
// exports.fsync = fsync TODO
exports.ftruncate = ftruncate
// exports.futimes = futimes TODO
// exports.lchmod = lchmod TODO
// exports.lchown = lchown TODO
// exports.lutimes = lutimes TODO
// exports.link = link TODO
exports.lstat = lstat
exports.mkdir = mkdir
// exports.mkdtemp = mkdtemp TODO
exports.open = open
exports.opendir = opendir
exports.read = read
exports.readFile = readFile
exports.readdir = readdir
exports.readlink = readlink
exports.readv = readv
exports.realpath = realpath
exports.rename = rename
exports.rm = rm
exports.rmdir = rmdir
exports.stat = stat
// exports.statfs = statfs TODO
exports.symlink = symlink
// exports.truncate = truncate TODO
exports.unlink = unlink
exports.utimes = utimes
exports.watch = watch
exports.write = write
exports.writeFile = writeFile
exports.writev = writev

exports.accessSync = accessSync
exports.appendFileSync = appendFileSync
exports.chmodSync = chmodSync
// exports.chownSync = chownSync TODO
exports.closeSync = closeSync
exports.copyFileSync = copyFileSync
exports.existsSync = existsSync
exports.fchmodSync = fchmodSync
// exports.fchownSync = fchownSync TODO
// exports.fdatasyncSync = fdatasyncSync TODO
exports.fstatSync = fstatSync
// exports.fsyncSync = fsyncSync TODO
exports.ftruncateSync = ftruncateSync
// exports.futimesSync = futimesSync TODO
// exports.lchmodSync = lchmodSync TODO
// exports.lchownSync = lchownSync TODO
// exports.lutimesSync = lutimesSync TODO
// exports.linkSync = linkSync TODO
exports.lstatSync = lstatSync
exports.mkdirSync = mkdirSync
// exports.mkdtempSync = mkdtempSync TODO
exports.openSync = openSync
exports.opendirSync = opendirSync
exports.readFileSync = readFileSync
exports.readSync = readSync
exports.readdirSync = readdirSync
exports.readlinkSync = readlinkSync
exports.readvSync = readvSync
exports.realpathSync = realpathSync
exports.renameSync = renameSync
exports.rmSync = rmSync
exports.rmdirSync = rmdirSync
exports.statSync = statSync
// exports.statfsSync = statfsSync TODO
exports.symlinkSync = symlinkSync
// exports.truncateSync = truncateSync TODO
exports.unlinkSync = unlinkSync
exports.utimesSync = utimesSync
exports.writeFileSync = writeFileSync
exports.writeSync = writeSync
exports.writevSync = writevSync

exports.promises = require('./promises')

exports.Stats = Stats
exports.Dir = Dir
exports.Dirent = Dirent
exports.Watcher = Watcher

exports.ReadStream = FileReadStream

exports.createReadStream = function createReadStream(path, opts) {
  return new FileReadStream(path, opts)
}

exports.WriteStream = FileWriteStream

exports.createWriteStream = function createWriteStream(path, opts) {
  return new FileWriteStream(path, opts)
}

function toNamespacedPath(filepath) {
  if (typeof filepath !== 'string') {
    if (URL.isURL(filepath)) filepath = fileURLToPath(filepath)
    else filepath = filepath.toString()
  }

  return path.toNamespacedPath(filepath)
}

function toFlags(flags) {
  switch (flags) {
    case 'r':
      return constants.O_RDONLY
    case 'rs': // Fall through.
    case 'sr':
      return constants.O_RDONLY | constants.O_SYNC
    case 'r+':
      return constants.O_RDWR
    case 'rs+': // Fall through.
    case 'sr+':
      return constants.O_RDWR | constants.O_SYNC

    case 'w':
      return constants.O_TRUNC | constants.O_CREAT | constants.O_WRONLY
    case 'wx': // Fall through.
    case 'xw':
      return constants.O_TRUNC | constants.O_CREAT | constants.O_WRONLY | constants.O_EXCL

    case 'w+':
      return constants.O_TRUNC | constants.O_CREAT | constants.O_RDWR
    case 'wx+': // Fall through.
    case 'xw+':
      return constants.O_TRUNC | constants.O_CREAT | constants.O_RDWR | constants.O_EXCL

    case 'a':
      return constants.O_APPEND | constants.O_CREAT | constants.O_WRONLY
    case 'ax': // Fall through.
    case 'xa':
      return constants.O_APPEND | constants.O_CREAT | constants.O_WRONLY | constants.O_EXCL
    case 'as': // Fall through.
    case 'sa':
      return constants.O_APPEND | constants.O_CREAT | constants.O_WRONLY | constants.O_SYNC

    case 'a+':
      return constants.O_APPEND | constants.O_CREAT | constants.O_RDWR
    case 'ax+': // Fall through.
    case 'xa+':
      return constants.O_APPEND | constants.O_CREAT | constants.O_RDWR | constants.O_EXCL
    case 'as+': // Fall through.
    case 'sa+':
      return constants.O_APPEND | constants.O_CREAT | constants.O_RDWR | constants.O_SYNC
    default:
      return 0
  }
}

function toMode(mode) {
  return parseInt(mode, 8)
}
const binding = require('../binding')

module.exports = {
  O_RDWR: binding.O_RDWR,
  O_RDONLY: binding.O_RDONLY,
  O_WRONLY: binding.O_WRONLY,
  O_CREAT: binding.O_CREAT,
  O_TRUNC: binding.O_TRUNC,
  O_APPEND: binding.O_APPEND,

  F_OK: binding.F_OK || 0,
  R_OK: binding.R_OK || 0,
  W_OK: binding.W_OK || 0,
  X_OK: binding.X_OK || 0,

  S_IFMT: binding.S_IFMT,
  S_IFREG: binding.S_IFREG,
  S_IFDIR: binding.S_IFDIR,
  S_IFCHR: binding.S_IFCHR,
  S_IFLNK: binding.S_IFLNK,
  S_IFBLK: binding.S_IFBLK || 0,
  S_IFIFO: binding.S_IFIFO || 0,
  S_IFSOCK: binding.S_IFSOCK || 0,

  S_IRUSR: binding.S_IRUSR || 0,
  S_IWUSR: binding.S_IWUSR || 0,
  S_IXUSR: binding.S_IXUSR || 0,
  S_IRGRP: binding.S_IRGRP || 0,
  S_IWGRP: binding.S_IWGRP || 0,
  S_IXGRP: binding.S_IXGRP || 0,
  S_IROTH: binding.S_IROTH || 0,
  S_IWOTH: binding.S_IWOTH || 0,
  S_IXOTH: binding.S_IXOTH || 0,

  UV_DIRENT_UNKNOWN: binding.UV_DIRENT_UNKNOWN,
  UV_DIRENT_FILE: binding.UV_DIRENT_FILE,
  UV_DIRENT_DIR: binding.UV_DIRENT_DIR,
  UV_DIRENT_LINK: binding.UV_DIRENT_LINK,
  UV_DIRENT_FIFO: binding.UV_DIRENT_FIFO,
  UV_DIRENT_SOCKET: binding.UV_DIRENT_SOCKET,
  UV_DIRENT_CHAR: binding.UV_DIRENT_CHAR,
  UV_DIRENT_BLOCK: binding.UV_DIRENT_BLOCK,

  COPYFILE_EXCL: binding.UV_FS_COPYFILE_EXCL,
  COPYFILE_FICLONE: binding.UV_FS_COPYFILE_FICLONE,
  COPYFILE_FICLONE_FORCE: binding.UV_FS_COPYFILE_FICLONE_FORCE,
  UV_FS_SYMLINK_DIR: binding.UV_FS_SYMLINK_DIR,
  UV_FS_SYMLINK_JUNCTION: binding.UV_FS_SYMLINK_JUNCTION
}
const os = require('bare-os')

module.exports = class FileError extends Error {
  constructor(msg, opts = {}) {
    const { code, operation = null, path = null, destination = null, fd = -1 } = opts

    if (operation !== null) msg += describe(operation, opts)

    super(`${code}: ${msg}`)

    this.code = code

    if (operation !== null) this.operation = operation
    if (path !== null) this.path = path
    if (destination !== null) this.destination = destination
    if (fd !== -1) this.fd = fd
  }

  get name() {
    return 'FileError'
  }

  // For Node.js compatibility
  get errno() {
    return os.constants.errnos[this.code]
  }

  // For Node.js compatibility
  get syscall() {
    return this.operation
  }

  // For Node.js compatibility
  get dest() {
    return this.destination
  }
}

function describe(operation, opts) {
  const { path = null, destination = null, fd = -1 } = opts

  let result = `, ${operation}`

  if (path !== null) {
    result += ` ${JSON.stringify(path)}`

    if (destination !== null) {
      result += ` -> ${JSON.stringify(destination)}`
    }
  } else if (fd !== -1) {
    result += ` ${fd}`
  }

  return result
}
{
  "name": "bare-fs",
  "version": "4.5.0",
  "description": "Native file system operations for Javascript",
  "exports": {
    "./package": "./package.json",
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./promises": {
      "types": "./promises.d.ts",
      "default": "./promises.js"
    },
    "./constants": {
      "types": "./lib/constants.d.ts",
      "default": "./lib/constants.js"
    }
  },
  "files": [
    "index.js",
    "index.d.ts",
    "promises.js",
    "promises.d.ts",
    "binding.c",
    "binding.js",
    "CMakeLists.txt",
    "lib",
    "prebuilds"
  ],
  "addon": true,
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-fs.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-fs/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-fs#readme",
  "engines": {
    "bare": ">=1.16.0"
  },
  "dependencies": {
    "bare-events": "^2.5.4",
    "bare-path": "^3.0.0",
    "bare-stream": "^2.6.4",
    "bare-url": "^2.2.2",
    "fast-fifo": "^1.3.2"
  },
  "devDependencies": {
    "bare-buffer": "^3.0.2",
    "bare-crypto": "^1.11.2",
    "brittle": "^3.1.1",
    "cmake-bare": "^1.1.7",
    "prettier": "^3.4.1",
    "prettier-config-holepunch": "^2.0.0"
  },
  "peerDependencies": {
    "bare-buffer": "*"
  },
  "peerDependenciesMeta": {
    "bare-buffer": {
      "optional": true
    }
  }
}
                         __TEXT                                                     __text          __TEXT                Z                                 __stubs         __TEXT          r      l      r                         __stub_helper   __TEXT          0v            0v                           __cstring       __TEXT          y      :      y                             __unwind_info   __TEXT          }            }                                   __DATA_CONST            @              @                  __got           __DATA_CONST                                   I                 __DATA                  @              @                   __la_symbol_ptr __DATA                 H                       L           __data          __DATA          H             H                                H   __LINKEDIT              @              '                       (              bare-fs@4.bare  "  0           @           H     H             X      P       q   q      s   L                                                      7t7i>|:2                      *                 8         xA   /usr/lib/libSystem.B.dylib      &      `    )                 @$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   &_WO{  5  
'  c2#    @ 5  :'  c@6#    @ 5  v'  c@9#    @ 5  '  cp;#    @ 5  '  c`#   t @ 5  B(  cP
#   e @ 5  (  c#   V @ 5  (  c#   G @ 5  (  c#   8 @~ 5  )  c#   ) @o 5  *)  c#    @` 5  R)  cP#    @Q 5  n)  c0#    @B 5  )  c#    @3 5  )  c#    @$ 5  )  c#    @ 5  )  c %#    @ 5  *  c@%#    @ 5  **  c`%#    @ 5  F*  c+#    @ 5  n*  c.#    @ 5  *  c`/#   u @ 5  *  c@3#   f @ 5  *  c3#   W @ 5  +  c 7#   H @ 5  .+  cp7#   9 @ 5  J+  c;#   * @p 5  v+  c <#    @a 5  +  c #    @R 5  +  c #    @C 5  +  c#    @4 5  ,  c`#    @% 5  .,  c@	#    @ 5  V,  c	#    @ 5  n,  c0#    @ 5  ,  c#    @ 5  ,  c #    @ 5  ,  c#    @ 5  ,  c#   v @ 5  -  c#   g @ 5  &-  c#   X @ 5  N-  c #   I @ 5  j-  c#   : @ 5  -  c#   + @q 5  -  cp #    @b 5  -  c #    @S 5  .  c`$#    @D 5  F.  c$#    @5 5  f.  c@)#    @& 5  .  c)#    @ 5  .  c0-#    @ 5  .  c-#    @ 5  /  c1#    @ 5  6/  c1#    @ 5  Z/  c 5#    @ 5  /  cp5#   w @ 5  /  c<#   h @ 5  /  c>#   Y @ 5  0  c #   J @ # A RS @"  BP0 #  RI @"  Bl0| # ! R? @"  B0r # @R5 @"  B0h # R+ @"  B0^ # R! @"  B0T #  R @"  B1J #  R @"  B,1@ # A R @"  B@16 # ! R @"  BT1, #  R @"  Bh1" #  R @"  B1 #  R @"  B1 #  R @"  B1 #  R @"  B1 #  R @"  B2 #  R @"  B$2 #  R @"  BD2 #  R @"  Bh2 # R @"  B2 # R @"  B2 # R @"  B2 # Rw @"  B2 # Rm @"  B3 #  Rc @"  B(3 # A RY @"  BH3 # ! RO @"  Bh3 #  RE @"  B3x # ! R; @"  B3n # A R1 @"  B4d # a R' @"  BD4Z #  R @"  B4P #  R @"  B4F #  R	 @"  B 5< #  R @"  B<52 # ! R @"  B|5( # A R @"  B5 #  R @"  B(6 # ! R @"  B6
 # A R @"  B6  # ! R @"  B@7 # A R @"  Bh7 {COBWA_CO{ (  @@H R C c     # <R @ y@" R @@!" R @C`  !` @^)  )@)@?  T{DOCC_N CWO{ (  @@ ( R # C   y @  q @t@u@ a@] a@Z [ @)  )@)@?  T  {DOCWBC_ O{  (  @@ ( R # C   J @  B @ @)  )@)@?  T  {COB_ #mO{C (  @@ ( R c    & @C   # R @9@  @ R8 @=@  @" R/ @A@  @B R& @E@  @b R @I@  @ R @M@  @ R @Y@  @ R @Q@  @ R @U@  @R @]@  @"R @ Mm a^!a^%g!h 	g I x  @BR @ Nm a^!a^!h I x  @bR @ Om a^!a^!h I x y @R @ Pm a^!a^!h I x k @R @@)  )@)@?  T{EOD#Cm_< CO{ (  @@( R c    h @C  ` @ 1@   # 0 @@1@ @^)  )@)@?  T{DOCC_ CO{ (  @@( R c    9 @C  1  # R @1@@( @^)  )@)@?  T{DOCC_ g_WO{	C (  @@' ( R     #@   @-@    @1@6  77  7(@  B @@!  C c  @A@ A A@#  @@  T@'@)  )@)@? T{IOHWG_FgE_ O{C 	
R0  @ ?@C (  @@ R c     \C   ] # R  ]3  ^#    @@A)  @  @) R	E9^)  )@)@?  T  @C{AO_G  R O{C (  @@H R     q @c  i @S  # h @@@  cp @) R	E9^)  )@)@?  T  {EOD_ {  Rt   {_O{C 	
R0  @ ?@C (  @@h R     4 ]c  , ] # R D ^S : # % @@@  p ` @) R	E9^)  )@)@?  T  @C{AO_ {  Rr   {_" R  R _WO{	C (  @@ R      @   #@  +@c  C  '@3  @|  }      @( 4 zw"      @B T   RA@'@  P"# v t @) R	E9\)  )@)@? T  {IOHWG_F_` " R  R _WO{	C (  @@ R      @  ~ #@  +@c  C y '@3 k @|  }    Z @( 4 zw"    c  @B T   RA@'@  0*   @) R	E9\)  )@)@? T  {IOHWG_F_ O{ (  @@h R     $ @   @s 9 #@C / #  @@@  .q @) R	E9^)  )@)@?  T  {FOE_ {  R   {_O{C 	
R0  @ ?@C (  @@h R      ]c   ] # R  ^S  #  @@@  3  @) R	E9^)  )@)@?  T  @C{AO_~ {  R   {_O{C (  @@h R c     @C   @3  @#    @@A)  8 @) R	E9^)  )@)@?  T  {EOD_B {  R   {_O{C 	R0  @ ?@ (  @@ R     b \  Z ] # R r ]c e ^C a # O @@Am  cP=  @) R	E9^)  )@)@?  T  @{AO_ {  R   {_O{C 	R0  @ ?@ (  @@h R C     ]#   ]@B| # R ( ^{ # R "   @  @B| { { @) R	E9^)  )@)@?  T  @{AO_ {  R   {_O{C 	
R0  @ ?@C (  @@ R c     \C   ]@B # R  ] # R  ^3    @@@  @B    @) R	E9^)  )@)@?  T  @C{AO_c {  R   {_O{C 	
R0  @ ?@C (  @@h R      ]c  { ] # R  ^S  # t @@@    @) R	E9^)  )@)@?  T  @C{AO_ {  R   {_O{C 	R0  @ ?@ (  @@H R c    > ]C  6 ^ # R N # 3 @  c  @) R	E9^)  )@)@?  T  @{AO_ {  R   {_O{C 	R0  @ ?@ (  @@H R c     ]C   ^ # R  #  @  cP s @) R	E9^)  )@)@?  T  @{AO_ {  R   {_O{C 	R0  @ ?@ (  @@H R c     ]C   ^ # R  #  @  c  @) R	E9^)  )@)@?  T  @{AO_a {  R   {_O{C (  @@H R      @c  ~ @S  # } @@@  c  @) R	E9^)  )@)@?  T  {EOD_) {  R$   {_O{C 	R0  @ ?@ (  @@H R c    I ]C  A ^ # R Y # > @  c#  @) R	E9^)  )@)@?  T  @{AO_
 {  R(   {_O{C 	R0  @ ?@ (  @@H R c    
 ]C   ^ # R  # 
 @  c`( r @) R	E9^)  )@)@?  T  @{AO_
 {  R3   {_O{C 	R0  @ ?@ (  @@H R c    
 ]C  
 ^ # R 
 # 
 @  c - 0 @) R	E9^)  )@)@?  T  @{AO_l
 {  R>   {_O{C 	
R0  @ ?@C (  @@ R c    
 \C  
 ]@B # R 
 ] # R 
 ^3 
  v
 @@@  2@B  
 @) R	E9^)  )@)@?  T  @C{AO_
 {  R:   {_O{C 	R0  @ ?@ (  @@H R c    >
 ]C  6
 ^ # R N
 # 3
 @  c07 
 @) R	E9^)  )@)@?  T  @{AO_	 {  RT   {_O{ (  @@h R     
 ]  	 ]  	 ^ 
 '@|C c 	 # 	 @@)@( '@B"@H @  c<V
 @) R	E9@^)  )@)@?  T{GOF_	  RW O{C (  @@H R     	 @c  	 @C  	 # 	 @@@  c 	 @) R	E9^)  )@)@?  T  {EOD_b	 {  Rv   {_WO{ 	R0  @ ?@ (  @@ R  C  	 [ # R 	 [ 	 # C ,RH	  r	 @	 7@@9uS  !  	 @ y\" RE	 \@" R?	 ]@!" R9	 @C`  !	 @])  )@)@? T@{BOAW_ ~	  	  _	   ])  )@)@?`T O{  (  @@ 4 R # C   	 @  	 @p	 @D9  !P	 @)  )@)@?  T  {COB_ O{  (  @@ ( R # C    @   @	 @	  )@)@?  T  {COB_ O{    @@ ( R # C    @   @g	 @	  )@)@?  T  {COB_ WO{ ( R(@9(DG9  4  7t@u@0	 a@ a@ {BOAW {BOAW_WO{ 	R  @ ?@   @@ R  #   [   \ # R  \s  ]c  C v @@C)  A q  @t 4  ) R	E9]	  )@)@? T$  Y@T7# 7 @]	  )@)@? T@{BOAW_    l   ]	  )@)@?`T   WO{   @@D9@G9@ 4@ @ @ ]	  )@)@?a T{FOEWD
  4 @c  @C  Z@ 7    E  #        @   !  A C R  @ ]	  )@)@?  T{FOEWD_ WO{   @@H R      @c   @S  #  @@@  q q @  4) R	E9  Y@T6  @   ]	  )@)@?  T{FOEWD_[ ^WO{ 	
R  @ ?@C   @@h R     \c  w \ # R  ]S  # p @@@  q q  @  4) R	E9  Y@T6    ~ ]	  )@)@?  T@C{BOAW_ W	O
{   @@ R+ Cc  4 /@# , 3@I 7@     / ;@ = ?@ 9 /@@?	 T+@J?
  T(K+   + C@ # c  @'E) 	=  A'@G@  A" q5 R# $ Rj '@T 4  E9]	  )@)@? T#  Y@47  @]	  )@)@? T{KOJWI_  o     ]	  )@)@?T W	O
{   @@ R+ Cc   /@#  3@ 7@      ;@  ?@  /@@?	 T+@J?
  T(K+   + C@  c  @'E) 	  A'@G@  !* q5 R# $ R '@T 4  E9]	  )@)@? T#  Y@47 H @]	  )@)@? T{KOJWI_    ~   ]	  )@)@?T WO{   @@h R     8 @  0 @s M #@C C # + @@@  . q @  4) R	E9  Y@T6Y    : ]	  )@)@?  T{GOFWE_ WO{ 	
R  @ ?@C   @@h R     \c   \ # R  ]S  #  @@@  3 q  @  4) R	E9  Y@T6
  ^   ]	  )@)@?  T@C{BOAW_x {WO{   @@h R c     @C   @3  @#    @@A)  8 q @  4) R	E9  Y@T6     ]	  )@)@?  T{FOEWD_1 4WO{ 	R  @ ?@   @@ R  #  U [  M \ # R e \c X ]C T # B @@Am  Q= q  @  4) R	E9  Y@T6o    P ]	  )@)@?  T@{BOAW_ WO{ 	R  @ ?@   @@h R C    \#   \@B| # R  ]{ # R 
   @   q@B| { a @  4) R	E9  Y@T6  p   ]	  )@)@?  T@{BOAW_ WO{ 	
R  @ ?@C   @@ R c #   [C   \@B # R  \ # R  ]3    @@@   q@B   @  4) R	E9  Y@T6     ]	  )@)@?  T@C{BOAW_1 4WO{ 	
R  @ ?@C   @@h R    U \c  M \ # R e ]S [ # F @@@   q  @  4) R	E9  Y@T6s    T ]	  )@)@?  T@C{BOAW_ WO{ 	R  @ ?@   @@H R c     \C   ] # R  #  @   q t @  4) R	E9  Y@T6)  }  
 ]	  )@)@?  T@{BOAW_ WO{ 	R  @ ?@   @@H R c     \C   ] # R  #  @  Q q - @  4) R	E9  Y@T6  3   ]	  )@)@?  T@{BOAW_M PWO{ 	R  @ ?@   @@H R c    q \C  i ] # R  # f @   q  @  4) R	E9  Y@T6    v ]	  )@)@?  T@{BOAW_ WO{   @@H R     , @c  $ @S A # # @@@  ! qx @  4) R	E9  Y@T6Q    2 ]	  )@)@?  T{FOEWD_ WO{ 	R  @ ?@   @@H R c     \C   ] # R  #  @  # q \ @  4) R	E9  Y@T6  \   ]	  )@)@?  T@{BOAW_v yWO{ 	R  @ ?@   @@H R c     \C   ] # R  #  @  a( q   @  4) R	E9  Y@T6     ]	  )@)@?  T@{BOAW_, /WO{ 	R  @ ?@   @@H R c    P \C  H ] # R ` # E @  - q  @  4) R	E9  Y@T6t    U ]	  )@)@?  T@{BOAW_ WO{ 	
R  @ ?@C   @@ R c #   [C   \@B # R  \ # R  ]3    @@@  2 q@B  l @  4) R	E9  Y@T6  o   ]	  )@)@?  T@C{BOAW_ WO{ 	R  @ ?@   @@H R c     \C   ] # R  #  @  17 q  @  4) R	E9  Y@T6  %   ]	  )@)@?  T@{BOAW_? BCWO{   @@h R    h #@  ` '@  [ +@ x '@|C c * # T @@)@( '@B"@H @  < q @  4) R	E9  Y@T6|    ] @]	  )@)@?  T{HOGWFC_  WO{   @@H R      @c   @C   # 	 @@@    qL @  4) R	E9  Y@T67     ]	  )@)@?  T{FOEWD_  C_WO{  @@@E9H	 5 @   @   @c   7    "      B C   @       C    ?  #    @  u  "  Rw  B   A c R \  @\  \	  )@)@?  T{HOGWF_EC_C  ( R(@9(DE9H  4_    CWO{ @@@E9h 4@Y  @V  @S    c   @C c  @# _  @D  @A  @>  @     @  6  {DOCWBC_0  @ 0  @ 0  
@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  "@ 0  &@ 0  *@ 0  .@ 0  2@ 0  6@ 0  :@ 0  >@ 0  B@ 0  F@ 0  J@ 0  N@ 0  R@ 0  V@ 0  Z@ 0  ^@ 0  b@ 0  f@ 0  j@ 0  n@ 0  r@ 0  v@ 0  z@ 0  ~@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  A 0  A 0  
A 0  A 0  A 0  A 0  A 0  A 0  "A 1  1"	G  
@ P      P     P  $   P  M   P  e   P     P     P     P     P     P  
  P  !  P  9  P  T  P  q  P    P    P    P    P    P  +  P  H  P  `  P  t  P    P    P    P    P    P    P  ?  P  [  P  x  P    P    P    P    P    P    P    P    P  ~'  P  {8  P  xL  P  ua  P  ru  P  o  P  l  P  i  P  f  P  c  P  `  P  ]  P  Z,  P  WD  P  TX  P  Ql  P  N  P  K  P  H  P  E  P  B  P  ?  P  <  P  9  P  6/  P  3B  P  0X  P  -m  P  *  P  '  P  $  P  !  bare-fs@4.5.0 requestInit requestDestroy requestReset requestResultStat requestResultString requestResultDir requestResultDirents open openSync close closeSync access accessSync read readSync readv write writeSync writev ftruncate ftruncateSync chmod chmodSync fchmod fchmodSync utimes utimesSync rename renameSync copyfile copyfileSync mkdir mkdirSync rmdir rmdirSync stat statSync lstat lstatSync fstat fstatSync unlink unlinkSync realpath realpathSync readlink readlinkSync symlink symlinkSync opendir opendirSync readdir readdirSync closedir closedirSync watcherInit watcherClose watcherRef watcherUnref O_RDWR O_RDONLY O_WRONLY O_CREAT O_TRUNC O_APPEND F_OK R_OK W_OK X_OK S_IFMT S_IFREG S_IFDIR S_IFCHR S_IFLNK S_IFBLK S_IFIFO S_IFSOCK S_IRUSR S_IWUSR S_IXUSR S_IRGRP S_IWGRP S_IXGRP S_IROTH S_IWOTH S_IXOTH UV_DIRENT_UNKNOWN UV_DIRENT_FILE UV_DIRENT_DIR UV_DIRENT_LINK UV_DIRENT_FIFO UV_DIRENT_SOCKET UV_DIRENT_CHAR UV_DIRENT_BLOCK UV_FS_COPYFILE_EXCL UV_FS_COPYFILE_FICLONE UV_FS_COPYFILE_FICLONE_FORCE UV_FS_SYMLINK_DIR UV_FS_SYMLINK_JUNCTION UV_RENAME UV_CHANGE name type            0       0                    T   T   r      T                   i         t 4         \ x p    ,!  <! " # # $ $ % % & & ' (  ) <) 4* P* 0+ L+ ,, H, (- D- . $. /  /  0 0 0 1 42 P2 03 L3 T4  \4 $5 @5 6 8 :  : @=  D= >  > t@  |@ lB  tB C  C D  D E  E 8G  <G H  H I  I (K  ,K PL  TL xM  |M N  N O  O P  P Q   R $S  (S T  T U  U W  W X  X Y  Y                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Hv      Tv      `v      lv      xv      v      v      v      v      v      v      v      v      v      v      v      w      w       w      ,w      8w      Dw      Pw      \w      hw      tw      w      w      w      w      w      w      w      w      w      w      w      x      x      x      (x      4x      @x      Lx      Xx      dx      px      |x      x      x      x      x      x      x      x      x      x      x       y      y      y      $y      0y      <y      Hy      Ty      `y      ly      xy      y      y      y      y                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              " `I   @___chkstk_darwin Qq @___stack_chk_guard @dyld_stub_binder  r @___stack_chk_fail  r@_free  r>@_js_add_deferred_teardown_callback  r>@_js_call_function  r >@_js_close_handle_scope  r(>@_js_create_array_with_length  r0>@_js_create_arraybuffer  r8>@_js_create_error  r@>@_js_create_function  rH>@_js_create_int32  rP>@_js_create_int64  rX>@_js_create_object  r`>@_js_create_reference  rh>@_js_create_string_utf8  rp>@_js_create_uint32  rx>@_js_delete_reference  r>@_js_finish_deferred_teardown_callback  r>@_js_get_array_elements  r>@_js_get_array_length  r>@_js_get_arraybuffer_info  r>@_js_get_callback_info  r>@_js_get_env_loop  r>@_js_get_null  r>@_js_get_reference_value  r>@_js_get_typedarray_info  r>@_js_get_value_bool  r>@_js_get_value_double  r>@_js_get_value_int32  r>@_js_get_value_int64  r>@_js_get_value_string_utf8  r>@_js_get_value_uint32  r>@_js_open_handle_scope  r>@_js_set_element  r>@_js_set_named_property  r>@_js_throw_error  r@_malloc  r@_memcpy  r@_strlen  r@_strncpy  r>@_uv_buf_init  r>@_uv_cancel  r>@_uv_close  r>@_uv_err_name  r>@_uv_fs_access  r>@_uv_fs_chmod  r>@_uv_fs_close  r>@_uv_fs_closedir  r>@_uv_fs_copyfile  r>@_uv_fs_event_init  r>@_uv_fs_event_start  r>@_uv_fs_event_stop  r>@_uv_fs_fchmod  r>@_uv_fs_fstat  r>@_uv_fs_ftruncate  r>@_uv_fs_lstat  r>@_uv_fs_mkdir  r>@_uv_fs_open  r>@_uv_fs_opendir  r>@_uv_fs_read  r>@_uv_fs_readdir  r>@_uv_fs_readlink  r>@_uv_fs_realpath  r>@_uv_fs_rename  r>@_uv_fs_req_cleanup  r>@_uv_fs_rmdir  r>@_uv_fs_stat  r>@_uv_fs_symlink  r>@_uv_fs_unlink  r>@_uv_fs_utime  r>@_uv_fs_write  r>@_uv_ref  r>@_uv_strerror  r>@_uv_unref          _bare_      0  0  get_module_name_v0 register_module_v0       0)|( C    ,      Y    -      r    P.          .          1          2          <3          4          5      "    5      1    x6      E    6      U    7      j    7      x    7          7          H9          P9          X9          :          ;          ;          <          <      +    =      @    =      P    >      e     ?      u    @           @          <A          XA          PB          lB          LC          hC          HD          dD      )    DE      =    `E      L    $F      `    @F      p     G          <G          H          8H          I          4I          PJ          lJ      	    LK      %	    hK      6	    pL      L	    xL      ^	    @M      u	    \M      	    O      	    O      	    0P      	    P      	    8Q      	    R      
    R      )
    TT      9
    \U      L
    `U      ]
    V      q
    V      
    X      
    X      
    X      
    Z      
    Z      
    Z      
    [          [          \      *    \      ;    ^      O    ^      `    T_      t    X_          `          `          b          b          Dc          Hc          ld          pd          e      )    e      9    f      L    f      \    g      o    g          h          h          j          j          @k          Dk          l          l          m      4    m      F     o      [    $o      n    0p          4p          q          q          H                      (      4             E             W             j             p                                                                                                      &            7            I            ^            u                                                                                                .            ;            S            k            ~                                                                                                 '            7            ?            G            O            X            e            p            z                                                                                                                                    !            2            ?            L            X            g            s                                                                                                                                                            (            2            t   v   w   x   y   z   {   |   }   ~                                                                                                                                                                                                s   u      t   v   w   x   y   z   {   |   }   ~                                                                                                                                                                                                      _bare_get_module_name_v0 _bare_register_module_v0 ___chkstk_darwin ___stack_chk_fail ___stack_chk_guard _free _js_add_deferred_teardown_callback _js_call_function _js_close_handle_scope _js_create_array_with_length _js_create_arraybuffer _js_create_error _js_create_function _js_create_int32 _js_create_int64 _js_create_object _js_create_reference _js_create_string_utf8 _js_create_uint32 _js_delete_reference _js_finish_deferred_teardown_callback _js_get_array_elements _js_get_array_length _js_get_arraybuffer_info _js_get_callback_info _js_get_env_loop _js_get_null _js_get_reference_value _js_get_typedarray_info _js_get_value_bool _js_get_value_double _js_get_value_int32 _js_get_value_int64 _js_get_value_string_utf8 _js_get_value_uint32 _js_open_handle_scope _js_set_element _js_set_named_property _js_throw_error _malloc _memcpy _strlen _strncpy _uv_buf_init _uv_cancel _uv_close _uv_err_name _uv_fs_access _uv_fs_chmod _uv_fs_close _uv_fs_closedir _uv_fs_copyfile _uv_fs_event_init _uv_fs_event_start _uv_fs_event_stop _uv_fs_fchmod _uv_fs_fstat _uv_fs_ftruncate _uv_fs_lstat _uv_fs_mkdir _uv_fs_open _uv_fs_opendir _uv_fs_read _uv_fs_readdir _uv_fs_readlink _uv_fs_realpath _uv_fs_rename _uv_fs_req_cleanup _uv_fs_rmdir _uv_fs_stat _uv_fs_symlink _uv_fs_unlink _uv_fs_utime _uv_fs_write _uv_ref _uv_strerror _uv_unref dyld_stub_binder _bare_fs_request_init _bare_fs_request_destroy _bare_fs_request_reset _bare_fs_request_result_stat _bare_fs_request_result_string _bare_fs_request_result_dir _bare_fs_request_result_dirents _bare_fs_open _bare_fs_open_sync _bare_fs_close _bare_fs_close_sync _bare_fs_access _bare_fs_access_sync _bare_fs_read _bare_fs_read_sync _bare_fs_readv _bare_fs_write _bare_fs_write_sync _bare_fs_writev _bare_fs_ftruncate _bare_fs_ftruncate_sync _bare_fs_chmod _bare_fs_chmod_sync _bare_fs_fchmod _bare_fs_fchmod_sync _bare_fs_utimes _bare_fs_utimes_sync _bare_fs_rename _bare_fs_rename_sync _bare_fs_copyfile _bare_fs_copyfile_sync _bare_fs_mkdir _bare_fs_mkdir_sync _bare_fs_rmdir _bare_fs_rmdir_sync _bare_fs_stat _bare_fs_stat_sync _bare_fs_lstat _bare_fs_lstat_sync _bare_fs_fstat _bare_fs_fstat_sync _bare_fs_unlink _bare_fs_unlink_sync _bare_fs_realpath _bare_fs_realpath_sync _bare_fs_readlink _bare_fs_readlink_sync _bare_fs_symlink _bare_fs_symlink_sync _bare_fs_opendir _bare_fs_opendir_sync _bare_fs_readdir _bare_fs_readdir_sync _bare_fs_closedir _bare_fs_closedir_sync _bare_fs_watcher_init _bare_fs_watcher_close _bare_fs_watcher_ref _bare_fs_watcher_unref _bare_fs__on_request_teardown _bare_fs__open _bare_fs__on_open _bare_fs__on_request_result _bare_fs__close _bare_fs__on_close _bare_fs__access _bare_fs__on_access _bare_fs__read _bare_fs__on_read _bare_fs__on_readv _bare_fs__write _bare_fs__on_write _bare_fs__on_writev _bare_fs__ftruncate _bare_fs__on_ftruncate _bare_fs__chmod _bare_fs__on_chmod _bare_fs__fchmod _bare_fs__on_fchmod _bare_fs__utimes _bare_fs__on_utimes _bare_fs__rename _bare_fs__on_rename _bare_fs__copyfile _bare_fs__on_copyfile _bare_fs__mkdir _bare_fs__on_mkdir _bare_fs__rmdir _bare_fs__on_rmdir _bare_fs__stat _bare_fs__on_stat _bare_fs__lstat _bare_fs__on_lstat _bare_fs__fstat _bare_fs__on_fstat _bare_fs__unlink _bare_fs__on_unlink _bare_fs__realpath _bare_fs__on_realpath _bare_fs__readlink _bare_fs__on_readlink _bare_fs__symlink _bare_fs__on_symlink _bare_fs__opendir _bare_fs__on_opendir _bare_fs__readdir _bare_fs__on_readdir _bare_fs__closedir _bare_fs__on_closedir _bare_fs__on_watcher_event _bare_fs__on_watcher_teardown _bare_fs__on_watcher_close __dyld_private                       g   X        $@                                        Z        bare-fs@4.bare k-31W\:B2JJd>RW	~^Y>D~Au3E5 >N!3E<7BZDi[u,Zf#GHA"!G0~P xeedv	I8L)vn5&W7k7
vIt *}
M#x~V'	hXofkOX||zH,XofkOX||zH,XofkOX||zH,XofkOX||zH,a"IwI+$~5zabl
BXofkOX||zH,XofkOX||zH,XofkOX||zH,!IF#,W-|
x,Di,arZtIy05"f$Q]nTt     const EventEmitter = require('bare-events')
const fs = require('.')

class FileHandle extends EventEmitter {
  constructor(fd) {
    this.fd = fd
  }

  async close() {
    await fs.close(fd)

    this.fd = -1
    this.emit('close')
  }

  async read(buffer, ...args) {
    return {
      bytesRead: await fs.read(this.fd, buffer, ...args),
      buffer
    }
  }

  async readv(buffers, ...args) {
    return {
      bytesRead: await fs.readv(this.fd, buffers, ...args),
      buffers
    }
  }

  async write(buffer, ...args) {
    return {
      bytesWritten: await fs.write(this.fd, buffer, ...args),
      buffer
    }
  }

  async writev(buffers, ...args) {
    return {
      bytesWritten: await fs.writev(this.fd, buffers, ...args),
      buffers
    }
  }

  async stat() {
    return fs.fstat(this.fd)
  }

  async chmod(mode) {
    await fs.fchmod(this.fd, mode)
  }

  createReadStream(opts) {
    return fs.createReadStream(null, { ...opts, fd: this.fd })
  }

  createWriteStream(opts) {
    return fs.createWriteStream(null, { ...opts, fd: this.fd })
  }

  async [Symbol.asyncDispose]() {
    await this.close()
  }
}

exports.open = async function open(filepath, flags, mode) {
  return new FileHandle(await fs.open(filepath, flags, mode))
}

exports.access = fs.access
exports.appendFile = fs.appendFile
exports.chmod = fs.chmod
exports.constants = fs.constants
exports.copyFile = fs.copyFile
exports.cp = fs.cp
exports.lstat = fs.lstat
exports.mkdir = fs.mkdir
exports.opendir = fs.opendir
exports.readFile = fs.readFile
exports.readdir = fs.readdir
exports.readlink = fs.readlink
exports.realpath = fs.realpath
exports.rename = fs.rename
exports.rm = fs.rm
exports.rmdir = fs.rmdir
exports.stat = fs.stat
exports.symlink = fs.symlink
exports.unlink = fs.unlink
exports.utimes = fs.utimes
exports.watch = fs.watch
exports.writeFile = fs.writeFile
const { satisfies } = require('bare-semver')
const errors = require('./lib/errors')

module.exports = exports = function resolve(
  specifier,
  parentURL,
  opts,
  readPackage
) {
  if (typeof opts === 'function') {
    readPackage = opts
    opts = {}
  } else if (typeof readPackage !== 'function') {
    readPackage = defaultReadPackage
  }

  return {
    *[Symbol.iterator]() {
      const generator = exports.module(specifier, parentURL, opts)

      let next = generator.next()

      while (next.done !== true) {
        const value = next.value

        if (value.package) {
          next = generator.next(readPackage(value.package))
        } else {
          next = generator.next(yield value.resolution)
        }
      }

      return next.value
    },

    async *[Symbol.asyncIterator]() {
      const generator = exports.module(specifier, parentURL, opts)

      let next = generator.next()

      while (next.done !== true) {
        const value = next.value

        if (value.package) {
          next = generator.next(await readPackage(value.package))
        } else {
          next = generator.next(yield value.resolution)
        }
      }

      return next.value
    }
  }
}

function defaultReadPackage() {
  return null
}

// No resolution candidate was yielded
const UNRESOLVED = 0x0
// At least 1 resolution candidate was yielded
const YIELDED = 0x1
// At least 1 resolution candidate was yielded and resolved
const RESOLVED = YIELDED | 0x2

exports.constants = {
  UNRESOLVED,
  YIELDED,
  RESOLVED
}

exports.module = function* (specifier, parentURL, opts = {}) {
  const { resolutions = null, imports = null } = opts

  if (exports.startsWithWindowsDriveLetter(specifier)) {
    specifier = '/' + specifier
  }

  let status

  if (resolutions) {
    status = yield* exports.preresolved(specifier, resolutions, parentURL, opts)

    if (status) return status
  }

  status = yield* exports.url(specifier, parentURL, opts)

  if (status) return status

  status = yield* exports.packageImports(specifier, parentURL, opts)

  if (status) return status

  if (
    specifier === '.' ||
    specifier === '..' ||
    specifier[0] === '/' ||
    specifier[0] === '\\' ||
    specifier.startsWith('./') ||
    specifier.startsWith('.\\') ||
    specifier.startsWith('../') ||
    specifier.startsWith('..\\')
  ) {
    if (imports) {
      status = yield* exports.packageImportsExports(
        specifier,
        imports,
        parentURL,
        true,
        opts
      )

      if (status) return status
    }

    status = yield* exports.deferred(specifier, opts)

    if (status) return status

    status = yield* exports.file(specifier, parentURL, false, opts)

    if (status === RESOLVED) return status

    return yield* exports.directory(specifier, parentURL, opts)
  }

  return yield* exports.package(specifier, parentURL, opts)
}

exports.url = function* (url, parentURL, opts = {}) {
  const { imports = null, deferredProtocol = 'deferred:' } = opts

  let resolution
  try {
    resolution = new URL(url)
  } catch {
    return UNRESOLVED
  }

  if (imports) {
    const status = yield* exports.packageImportsExports(
      resolution.href,
      imports,
      parentURL,
      true,
      opts
    )

    if (status) return status
  }

  if (resolution.protocol === deferredProtocol) {
    const specifier = resolution.pathname

    return yield* exports.module(specifier, parentURL, opts)
  }

  if (resolution.protocol === 'node:') {
    const specifier = resolution.pathname

    if (
      specifier === '.' ||
      specifier === '..' ||
      specifier[0] === '/' ||
      specifier.startsWith('./') ||
      specifier.startsWith('../')
    ) {
      throw errors.INVALID_MODULE_SPECIFIER(
        `Module specifier '${url}' is not a valid package name`
      )
    }

    return yield* exports.package(specifier, parentURL, opts)
  }

  const resolved = yield { resolution }

  return resolved ? RESOLVED : YIELDED
}

exports.preresolved = function* (specifier, resolutions, parentURL, opts = {}) {
  const imports = resolutions[parentURL.href]

  if (typeof imports === 'object' && imports !== null) {
    return yield* exports.packageImportsExports(
      specifier,
      imports,
      parentURL,
      true,
      opts
    )
  }

  return UNRESOLVED
}

exports.deferred = function* (specifier, opts = {}) {
  const { deferredProtocol = 'deferred:', defer = [] } = opts

  if (defer.includes(specifier)) {
    const resolved = yield { resolution: new URL(deferredProtocol + specifier) }

    return resolved ? RESOLVED : YIELDED
  }

  return UNRESOLVED
}

exports.package = function* (packageSpecifier, parentURL, opts = {}) {
  const { builtins = [] } = opts

  if (packageSpecifier === '') {
    throw errors.INVALID_MODULE_SPECIFIER(
      `Module specifier '${packageSpecifier}' is not a valid package name`
    )
  }

  let packageName

  if (packageSpecifier[0] !== '@') {
    packageName = packageSpecifier.split('/', 1).join()
  } else {
    if (!packageSpecifier.includes('/')) {
      throw errors.INVALID_MODULE_SPECIFIER(
        `Module specifier '${packageSpecifier}' is not a valid package name`
      )
    }

    packageName = packageSpecifier.split('/', 2).join('/')
  }

  if (
    packageName[0] === '.' ||
    packageName.includes('\\') ||
    packageName.includes('%')
  ) {
    throw errors.INVALID_MODULE_SPECIFIER(
      `Module specifier '${packageSpecifier}' is not a valid package name`
    )
  }

  let status

  status = yield* exports.builtinTarget(packageSpecifier, null, builtins, opts)

  if (status) return status

  status = yield* exports.deferred(packageSpecifier, opts)

  if (status) return status

  let packageSubpath = '.' + packageSpecifier.substring(packageName.length)

  status = yield* exports.packageSelf(
    packageName,
    packageSubpath,
    parentURL,
    opts
  )

  if (status) return status

  parentURL = new URL(parentURL.href)

  do {
    const packageURL = new URL('node_modules/' + packageName + '/', parentURL)

    parentURL.pathname = parentURL.pathname.substring(
      0,
      parentURL.pathname.lastIndexOf('/')
    )

    const info = yield { package: new URL('package.json', packageURL) }

    if (info) {
      if (info.engines) exports.validateEngines(packageURL, info.engines, opts)

      if (info.exports) {
        return yield* exports.packageExports(
          packageURL,
          packageSubpath,
          info.exports,
          opts
        )
      }

      if (packageSubpath === '.') {
        if (typeof info.main === 'string' && info.main !== '') {
          packageSubpath = info.main
        } else {
          return yield* exports.file('index', packageURL, true, opts)
        }
      }

      status = yield* exports.file(packageSubpath, packageURL, false, opts)

      if (status === RESOLVED) return status

      return yield* exports.directory(packageSubpath, packageURL, opts)
    }
  } while (parentURL.pathname !== '' && parentURL.pathname !== '/')

  return UNRESOLVED
}

exports.packageSelf = function* (
  packageName,
  packageSubpath,
  parentURL,
  opts = {}
) {
  for (const packageURL of exports.lookupPackageScope(parentURL, opts)) {
    const info = yield { package: packageURL }

    if (info) {
      if (info.name !== packageName) return false

      if (info.exports) {
        return yield* exports.packageExports(
          packageURL,
          packageSubpath,
          info.exports,
          opts
        )
      }

      if (packageSubpath === '.') {
        if (typeof info.main === 'string' && info.main !== '') {
          packageSubpath = info.main
        } else {
          return yield* exports.file('index', packageURL, true, opts)
        }
      }

      const status = yield* exports.file(
        packageSubpath,
        packageURL,
        false,
        opts
      )

      if (status === RESOLVED) return status

      return yield* exports.directory(packageSubpath, packageURL, opts)
    }
  }

  return UNRESOLVED
}

exports.packageExports = function* (
  packageURL,
  subpath,
  packageExports,
  opts = {}
) {
  if (subpath === '.') {
    let mainExport

    if (typeof packageExports === 'string' || Array.isArray(packageExports)) {
      mainExport = packageExports
    } else if (typeof packageExports === 'object' && packageExports !== null) {
      const keys = Object.keys(packageExports)

      if (keys.some((key) => key.startsWith('.'))) {
        if ('.' in packageExports) mainExport = packageExports['.']
      } else {
        mainExport = packageExports
      }
    }

    if (mainExport) {
      const status = yield* exports.packageTarget(
        packageURL,
        mainExport,
        null,
        false,
        opts
      )

      if (status) return status
    }
  } else if (typeof packageExports === 'object' && packageExports !== null) {
    const keys = Object.keys(packageExports)

    if (keys.every((key) => key.startsWith('.'))) {
      const status = yield* exports.packageImportsExports(
        subpath,
        packageExports,
        packageURL,
        false,
        opts
      )

      if (status) return status
    }
  }

  packageURL = new URL('package.json', packageURL)

  throw errors.PACKAGE_PATH_NOT_EXPORTED(
    `Package subpath '${subpath}' is not defined by "exports" in '${packageURL}'`
  )
}

exports.packageImports = function* (specifier, parentURL, opts = {}) {
  const { imports = null } = opts

  if (specifier === '#' || specifier.startsWith('#/')) {
    throw errors.INVALID_MODULE_SPECIFIER(
      `Module specifier '${specifier}' is not a valid internal imports specifier`
    )
  }

  for (const packageURL of exports.lookupPackageScope(parentURL, opts)) {
    const info = yield { package: packageURL }

    if (info) {
      if (info.imports) {
        const status = yield* exports.packageImportsExports(
          specifier,
          info.imports,
          packageURL,
          true,
          opts
        )

        if (status) return status
      }

      if (specifier.startsWith('#')) {
        throw errors.PACKAGE_IMPORT_NOT_DEFINED(
          `Package import specifier '${specifier}' is not defined by "imports" in '${packageURL}'`
        )
      }

      break
    }
  }

  if (imports) {
    const status = yield* exports.packageImportsExports(
      specifier,
      imports,
      parentURL,
      true,
      opts
    )

    if (status) return status
  }

  return UNRESOLVED
}

exports.packageImportsExports = function* (
  matchKey,
  matchObject,
  packageURL,
  isImports,
  opts = {}
) {
  if (matchKey in matchObject && !matchKey.includes('*')) {
    const target = matchObject[matchKey]

    return yield* exports.packageTarget(
      packageURL,
      target,
      null,
      isImports,
      opts
    )
  }

  const expansionKeys = Object.keys(matchObject)
    .filter((key) => key.includes('*'))
    .sort(exports.patternKeyCompare)

  for (const expansionKey of expansionKeys) {
    const patternIndex = expansionKey.indexOf('*')
    const patternBase = expansionKey.substring(0, patternIndex)

    if (matchKey.startsWith(patternBase) && matchKey !== patternBase) {
      const patternTrailer = expansionKey.substring(patternIndex + 1)

      if (
        patternTrailer === '' ||
        (matchKey.endsWith(patternTrailer) &&
          matchKey.length >= expansionKey.length)
      ) {
        const target = matchObject[expansionKey]

        const patternMatch = matchKey.substring(
          patternBase.length,
          matchKey.length - patternTrailer.length
        )

        return yield* exports.packageTarget(
          packageURL,
          target,
          patternMatch,
          isImports,
          opts
        )
      }
    }
  }

  return UNRESOLVED
}

exports.validateEngines = function validateEngines(
  packageURL,
  packageEngines,
  opts = {}
) {
  const { engines = {} } = opts

  for (const [engine, range] of Object.entries(packageEngines)) {
    if (engine in engines) {
      const version = engines[engine]

      if (!satisfies(version, range)) {
        packageURL = new URL('package.json', packageURL)

        throw errors.UNSUPPORTED_ENGINE(
          `Package not compatible with engine '${engine}' ${version}, requires range '${range}' defined by "engines" in '${packageURL}'`
        )
      }
    }
  }
}

exports.patternKeyCompare = function patternKeyCompare(keyA, keyB) {
  const patternIndexA = keyA.indexOf('*')
  const patternIndexB = keyB.indexOf('*')
  const baseLengthA = patternIndexA === -1 ? keyA.length : patternIndexA + 1
  const baseLengthB = patternIndexB === -1 ? keyB.length : patternIndexB + 1
  if (baseLengthA > baseLengthB) return -1
  if (baseLengthB > baseLengthA) return 1
  if (patternIndexA === -1) return 1
  if (patternIndexB === -1) return -1
  if (keyA.length > keyB.length) return -1
  if (keyB.length > keyA.length) return 1
  return 0
}

exports.packageTarget = function* (
  packageURL,
  target,
  patternMatch,
  isImports,
  opts = {}
) {
  const { conditions = [], matchedConditions = [] } = opts

  if (typeof target === 'string') {
    if (!target.startsWith('./') && !isImports) {
      packageURL = new URL('package.json', packageURL)

      throw errors.INVALID_PACKAGE_TARGET(
        `Invalid target '${target}' defined by "exports" in '${packageURL}'`
      )
    }

    if (patternMatch !== null) {
      target = target.replaceAll('*', patternMatch)
    }

    const status = yield* exports.url(target, packageURL, opts)

    if (status) return status

    if (
      target === '.' ||
      target === '..' ||
      target[0] === '/' ||
      target.startsWith('./') ||
      target.startsWith('../')
    ) {
      const resolved = yield { resolution: new URL(target, packageURL) }

      return resolved ? RESOLVED : YIELDED
    }

    return yield* exports.package(target, packageURL, opts)
  }

  if (Array.isArray(target)) {
    for (const targetValue of target) {
      const status = yield* exports.packageTarget(
        packageURL,
        targetValue,
        patternMatch,
        isImports,
        opts
      )

      if (status) return status
    }
  } else if (typeof target === 'object' && target !== null) {
    let status = UNRESOLVED

    for (const [condition, targetValue, subset] of exports.conditionMatches(
      target,
      conditions,
      opts
    )) {
      matchedConditions.push(condition)

      status |= yield* exports.packageTarget(
        packageURL,
        targetValue,
        patternMatch,
        isImports,
        { ...opts, conditions: subset }
      )

      matchedConditions.pop()
    }

    if (status) return status
  }

  return UNRESOLVED
}

exports.builtinTarget = function* (
  packageSpecifier,
  packageVersion,
  target,
  opts = {}
) {
  const {
    builtinProtocol = 'builtin:',
    conditions = [],
    matchedConditions = []
  } = opts

  if (typeof target === 'string') {
    const targetParts = target.split('@')

    let targetName
    let targetVersion

    if (target[0] !== '@') {
      targetName = targetParts[0]
      targetVersion = targetParts[1] || null
    } else {
      targetName = targetParts.slice(0, 2).join('@')
      targetVersion = targetParts[2] || null
    }

    if (packageSpecifier === targetName) {
      if (packageVersion === null && targetVersion === null) {
        const resolved = yield {
          resolution: new URL(builtinProtocol + packageSpecifier)
        }

        return resolved ? RESOLVED : YIELDED
      }

      let version = null

      if (packageVersion === null) {
        version = targetVersion
      } else if (targetVersion === null || packageVersion === targetVersion) {
        version = packageVersion
      }

      if (version !== null) {
        const resolved = yield {
          resolution: new URL(
            builtinProtocol + packageSpecifier + '@' + version
          )
        }

        return resolved ? RESOLVED : YIELDED
      }
    }
  } else if (Array.isArray(target)) {
    for (const targetValue of target) {
      const status = yield* exports.builtinTarget(
        packageSpecifier,
        packageVersion,
        targetValue,
        opts
      )

      if (status) return status
    }
  } else if (typeof target === 'object' && target !== null) {
    let status = UNRESOLVED

    for (const [condition, targetValue, subset] of exports.conditionMatches(
      target,
      conditions,
      opts
    )) {
      matchedConditions.push(condition)

      status |= yield* exports.builtinTarget(
        packageSpecifier,
        packageVersion,
        targetValue,
        { ...opts, conditions: subset }
      )

      matchedConditions.pop()
    }

    if (status) return status
  }

  return UNRESOLVED
}

exports.conditionMatches = function* conditionMatches(
  target,
  conditions,
  opts = {}
) {
  if (conditions.every((condition) => typeof condition === 'string')) {
    const keys = Object.keys(target)

    for (const condition of keys) {
      if (condition === 'default' || conditions.includes(condition)) {
        yield [condition, target[condition], conditions]

        return true
      }
    }

    return false
  }

  let yielded = false

  for (const subset of conditions) {
    if (yield* conditionMatches(target, subset, opts)) {
      yielded = true
    }
  }

  return yielded
}

exports.lookupPackageScope = function* lookupPackageScope(url, opts = {}) {
  const { resolutions = null } = opts

  if (resolutions) {
    for (const { resolution } of exports.preresolved(
      '#package',
      resolutions,
      url,
      opts
    )) {
      if (resolution) return yield resolution
    }

    // Internal preresolution path, do not depend on this! It will be removed without
    // warning.
    for (const { resolution } of exports.preresolved(
      'bare:package',
      resolutions,
      url,
      opts
    )) {
      if (resolution) return yield resolution
    }
  }

  const scopeURL = new URL(url.href)

  do {
    if (scopeURL.pathname.endsWith('/node_modules')) break

    yield new URL('package.json', scopeURL)

    scopeURL.pathname = scopeURL.pathname.substring(
      0,
      scopeURL.pathname.lastIndexOf('/')
    )

    if (
      scopeURL.pathname.length === 3 &&
      exports.isWindowsDriveLetter(scopeURL.pathname.substring(1))
    ) {
      break
    }
  } while (scopeURL.pathname !== '' && scopeURL.pathname !== '/')
}

exports.file = function* (filename, parentURL, isIndex, opts = {}) {
  if (
    filename === '.' ||
    filename === '..' ||
    filename[filename.length - 1] === '/' ||
    filename[filename.length - 1] === '\\'
  ) {
    return UNRESOLVED
  }

  if (parentURL.protocol === 'file:' && /%2f|%5c/i.test(filename)) {
    throw errors.INVALID_MODULE_SPECIFIER(
      `Module specifier '${filename}' is invalid`
    )
  }

  const { extensions = [] } = opts

  let status = UNRESOLVED

  if (!isIndex) {
    if (yield { resolution: new URL(filename, parentURL) }) {
      return RESOLVED
    }

    status = YIELDED
  }

  for (const ext of extensions) {
    if (yield { resolution: new URL(filename + ext, parentURL) }) {
      return RESOLVED
    }

    status = YIELDED
  }

  return status
}

exports.directory = function* (dirname, parentURL, opts = {}) {
  let directoryURL

  if (
    dirname[dirname.length - 1] === '/' ||
    dirname[dirname.length - 1] === '\\'
  ) {
    directoryURL = new URL(dirname, parentURL)
  } else {
    directoryURL = new URL(dirname + '/', parentURL)
  }

  const info = yield { package: new URL('package.json', directoryURL) }

  if (info) {
    if (info.exports) {
      return yield* exports.packageExports(
        directoryURL,
        '.',
        info.exports,
        opts
      )
    }

    if (typeof info.main === 'string' && info.main !== '') {
      const status = yield* exports.file(info.main, directoryURL, false, opts)

      if (status === RESOLVED) return status

      return yield* exports.directory(info.main, directoryURL, opts)
    }
  }

  return yield* exports.file('index', directoryURL, true, opts)
}

// https://infra.spec.whatwg.org/#ascii-upper-alpha
function isASCIIUpperAlpha(c) {
  return c >= 0x41 && c <= 0x5a
}

// https://infra.spec.whatwg.org/#ascii-lower-alpha
function isASCIILowerAlpha(c) {
  return c >= 0x61 && c <= 0x7a
}

// https://infra.spec.whatwg.org/#ascii-alpha
function isASCIIAlpha(c) {
  return isASCIIUpperAlpha(c) || isASCIILowerAlpha(c)
}

// https://url.spec.whatwg.org/#windows-drive-letter
exports.isWindowsDriveLetter = function isWindowsDriveLetter(input) {
  return (
    input.length >= 2 &&
    isASCIIAlpha(input.charCodeAt(0)) &&
    (input.charCodeAt(1) === 0x3a || input.charCodeAt(1) === 0x7c)
  )
}

// https://url.spec.whatwg.org/#start-with-a-windows-drive-letter
exports.startsWithWindowsDriveLetter = function startsWithWindowsDriveLetter(
  input
) {
  return (
    input.length >= 2 &&
    exports.isWindowsDriveLetter(input) &&
    (input.length === 2 ||
      input.charCodeAt(2) === 0x2f ||
      input.charCodeAt(2) === 0x5c ||
      input.charCodeAt(2) === 0x3f ||
      input.charCodeAt(2) === 0x23)
  )
}
module.exports = class ModuleResolveError extends Error {
  constructor(msg, code, fn = ModuleResolveError) {
    super(`${code}: ${msg}`)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name() {
    return 'ModuleResolveError'
  }

  static INVALID_MODULE_SPECIFIER(msg) {
    return new ModuleResolveError(
      msg,
      'INVALID_MODULE_SPECIFIER',
      ModuleResolveError.INVALID_MODULE_SPECIFIER
    )
  }

  static INVALID_PACKAGE_TARGET(msg) {
    return new ModuleResolveError(
      msg,
      'INVALID_PACKAGE_TARGET',
      ModuleResolveError.INVALID_PACKAGE_TARGET
    )
  }

  static PACKAGE_PATH_NOT_EXPORTED(msg) {
    return new ModuleResolveError(
      msg,
      'PACKAGE_PATH_NOT_EXPORTED',
      ModuleResolveError.PACKAGE_PATH_NOT_EXPORTED
    )
  }

  static PACKAGE_IMPORT_NOT_DEFINED(msg) {
    return new ModuleResolveError(
      msg,
      'PACKAGE_IMPORT_NOT_DEFINED',
      ModuleResolveError.PACKAGE_IMPORT_NOT_DEFINED
    )
  }

  static UNSUPPORTED_ENGINE(msg) {
    return new ModuleResolveError(
      msg,
      'UNSUPPORTED_ENGINE',
      ModuleResolveError.UNSUPPORTED_ENGINE
    )
  }
}
{
  "name": "bare-module-resolve",
  "version": "1.11.1",
  "description": "Low-level module resolution algorithm for Bare",
  "exports": {
    "./package": "./package.json",
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./errors": {
      "types": "./lib/errors.d.ts",
      "default": "./lib/errors.js"
    }
  },
  "files": [
    "index.js",
    "index.d.ts",
    "lib"
  ],
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-module-resolve.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-module-resolve/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-module-resolve#readme",
  "dependencies": {
    "bare-semver": "^1.0.0"
  },
  "devDependencies": {
    "bare-url": "^2.1.3",
    "brittle": "^3.2.1",
    "prettier": "^3.3.3",
    "prettier-config-standard": "^7.0.0"
  },
  "peerDependencies": {
    "bare-url": "*"
  },
  "peerDependenciesMeta": {
    "bare-url": {
      "optional": true
    }
  }
}
module.exports = require.addon()
const binding = require('./binding')
const errors = require('./lib/errors')
const constants = require('./lib/constants')

exports.constants = constants

exports.EOL = binding.platform === 'win32' ? '\r\n' : '\n'

exports.platform = function platform() {
  return binding.platform
}

exports.arch = function arch() {
  return binding.arch
}

exports.type = binding.type
exports.version = binding.version
exports.release = binding.release
exports.machine = binding.machine
exports.execPath = binding.execPath
exports.pid = binding.pid
exports.ppid = binding.ppid
exports.cwd = binding.cwd
exports.chdir = binding.chdir
exports.tmpdir = binding.tmpdir
exports.homedir = binding.homedir
exports.hostname = binding.hostname
exports.userInfo = binding.userInfo

exports.kill = function kill(pid, signal = constants.signals.SIGTERM) {
  if (typeof signal === 'string') {
    if (signal in constants.signals === false) {
      throw errors.UNKNOWN_SIGNAL('Unknown signal: ' + signal)
    }

    signal = constants.signals[signal]
  }

  binding.kill(pid, signal)
}

exports.endianness = function endianness() {
  return binding.isLittleEndian ? 'LE' : 'BE'
}

exports.availableParallelism = binding.availableParallelism

exports.cpuUsage = function cpuUsage(previous) {
  const current = binding.cpuUsage()

  if (previous) {
    return {
      user: current.user - previous.user,
      system: current.system - previous.system
    }
  }

  return current
}

exports.threadCpuUsage = function threadCpuUsage(previous) {
  const current = binding.threadCpuUsage()

  if (previous) {
    return {
      user: current.user - previous.user,
      system: current.system - previous.system
    }
  }

  return current
}

exports.resourceUsage = binding.resourceUsage
exports.memoryUsage = binding.memoryUsage
exports.freemem = binding.freemem
exports.totalmem = binding.totalmem
exports.uptime = binding.uptime
exports.loadavg = binding.loadavg
exports.cpus = binding.cpus

exports.getProcessTitle = binding.getProcessTitle

exports.setProcessTitle = function setProcessTitle(title) {
  if (typeof title !== 'string') title = title.toString()

  if (title.length >= 256) {
    throw errors.TITLE_OVERFLOW('Process title is too long')
  }

  binding.setProcessTitle(title)
}

exports.getEnvKeys = binding.getEnvKeys
exports.getEnv = binding.getEnv
exports.hasEnv = binding.hasEnv
exports.setEnv = binding.setEnv
exports.unsetEnv = binding.unsetEnv
const binding = require('../binding')

module.exports = {
  signals: binding.signals,
  errnos: binding.errnos
}
module.exports = class OSError extends Error {
  constructor(msg, code, fn = OSError) {
    super(`${code}: ${msg}`)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name() {
    return 'OSError'
  }

  static UNKNOWN_SIGNAL(msg) {
    return new OSError(msg, 'UNKNOWN_SIGNAL', OSError.UNKNOWN_SIGNAL)
  }

  static TITLE_OVERFLOW(msg) {
    return new OSError(msg, 'TITLE_OVERFLOW', OSError.TITLE_OVERFLOW)
  }
}
{
  "name": "bare-os",
  "version": "3.6.2",
  "description": "Operating system utilities for Javascript",
  "exports": {
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./package": "./package.json",
    "./constants": "./lib/constants.js",
    "./errors": "./lib/errors.js"
  },
  "files": [
    "index.js",
    "index.d.ts",
    "binding.c",
    "binding.js",
    "CMakeLists.txt",
    "lib",
    "prebuilds"
  ],
  "addon": true,
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-os.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-os/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-os#readme",
  "engines": {
    "bare": ">=1.14.0"
  },
  "devDependencies": {
    "brittle": "^3.1.1",
    "cmake-bare": "^1.1.6",
    "prettier": "^3.4.2",
    "prettier-config-standard": "^7.0.0"
  }
}
                       (  __TEXT                                                     __text          __TEXT          ?      3      ?                           __stubs         __TEXT          r            r                         __stub_helper   __TEXT          u            u                           __cstring       __TEXT          x            x                             __const         __TEXT          @              @                             __unwind_info   __TEXT          `             `                                   __DATA_CONST            @              @                  __got           __DATA_CONST                                   ?              8  __DATA                  @              @                   __la_symbol_ptr __DATA                                        B           __data          __DATA                                                    __bss           __DATA                                                        H   __LINKEDIT              @                                    (             bare-os@3.bare  "  0           @           H      H          g     (     P       #   #      %   B                                                     RL2i{=8
5DW2                      *                 8         xA   /usr/lib/libSystem.B.dylib      &      h @   )                 P                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "_  CWO{ @      !@!- !  !"c   @"  B"   !#c   @  B #   6#  cp!c    @   J#  c`$c    @   j#  c`'c    @   #  c`*c   u @   #  c`-c   f @   #  c0c   W @   #  c1c   H @s   #  c2c   9 @d   $  c@6c   * @U   $  c9c    @F   6$  c =c    @7   V$  c c    @(   z$  cc    @   $  cc    @
   $  cc    @   %  c
c    @   B%  cc    @   z%  cPc    @   %  cc    @   %  cpc    @   %  c`c   v @   
&  c`c   g @   *&  c c   X @   >&  c *c   I @t   ~&  c -c   : @e   &  c`/c   + @V   &  b3c    @F   'c    @8   "'  c`:c   
 @)   >'  c  c   
 @   b'  cpc   
 @ c ! R
 @  B' C 
 @  B'
 # ! R
 @  B'
 # A R
 @  B'
 # a R
 @  B(
 #  R
 @  B8(
 #  R
 @  BT(
 #  R
 @  Bt(
 #  R
 @  B(
 # AR
 @  B(
 # R
 @  B(
 # !R
 @  B(
 # R|
 @  B)
 # aRs
 @  B()
 # Rj
 @  BH)
 # Ra
 @  Bh)z
 # RX
 @  B)q
 # RO
 @  B)h
 # RF
 @  B)_
 # aR=
 @  B)V
 # !R4
 @  B*M
 # AR+
 @  B(*D
 # R"
 @  BH*;
 # R
 @  Bh*2
 # R
 @  B*)
 # R
 @  B* 
 # !R	 @  B*
 # AR	 @  B*
 # aR	 @  B+
 # R	 @  B,+	 # R	 @  BP+	 # R	 @  Bh+	 # R	 @  B+	 # 	 @  B+	   	 @  B+	  	 @  B+	  	 @  B+	  	 @  B ,	  	 @  BX,	  Az	 @  B,	  vq	 @  B,	  wh	 @  B,	  !w_	 @  B-	  xV	 @  B@-~	  AwM	 @  Bt-u	  awD	 @  B-l	  w;	 @  B-c	  w2	 @  B-Z	  w)	 @  B$.Q	  w 	 @  BP.H	  x	 @  B|.?	  x	 @  B.6	  !x	 @  B.-	  Ax @  B/$	   @  BH/	   @  Bl/	   @  B/		   @  B/ 	   @  B/   @  B/   @  B0   @  BP0   @  B|0   @  B0   @  B0  A @  B0   @  B 1  a ~ @  B41  u @  BL1   l @  Bh1  c @  Bx1  Z @  B1  Q @  B1y  H @  B1p  ? @  B1g  6 @  B2^  !- @  B@2U  A$ @  Bd2L   @  B2C   @  B2:  A	 @  B21  !   @  B2(  a @  B3   @  B$3  ! @  B@3  a @  Bp3  	 @  B3   @  B3  a @  B3  ! @  B3   @  B4   @  B84  a
 @  BX4    @  B4   @  B4  a @  B4  Ay @  B4  p @  B5  !g @  B85  ^ @  BT5  !U @  Bl5}  L @  B5t  A C @  B5k  a: @  B5b  !1 @  B5Y  !( @  B6P   @  B(6G   @  BH6>    @  BX65   @  Bp6,   @  B6#   @  B6   @  B6  	 @  B6  a @  B7  a @  B07   @  Bp7   @  B7    @  B7 {DOCWBC_    @8 WO{ C   @@# # @7#    @]	  )@)@? TC{BOAW_   '     ]	  )@)@?Td WO{ C   @@# #  @7  l @]	  )@)@? TC{BOAW_     ~   ]	  )@)@?T4 WO{ C   @@# #  @7  < @]	  )@)@? TC{BOAW_ m    N   ]	  )@)@?T WO{ C   @@# #  @7   @]	  )@)@? TC{BOAW_ =       ]	  )@)@?T WO{ 	R  @ ?@    @@ R c C  `7@c #  @]	  )@)@? T@ {BOAW_   _     ]	  )@)@?`T  O{  #  #  @{BOA _ O{    #  @{BOA _WO{ 	R  @ ?@    @@ R c C  `7@c #  @]	  )@)@? T@ {BOAW_   	     ]	  )@)@?`TF WO{ 	R  @ ?@    @@( R #    W ]C  R ` C y @6     ` ]	  )@)@? T  @ {BOAW_ WO{ 	R  @ ?@    @@ R c C  `7@c #  @]	  )@)@? T@ {BOAW_ A    "   ]	  )@)@?`T WO{ 	R  @ ?@    @@ R c C W `7@c #  @]	  )@)@? T@ {BOAW_ 	  c     ]	  )@)@?`T CWO{   @@( R _ #  @7@_   @]	  )@)@? T{TOSWRC_   1     ]	  )@)@?Tn WO{C   @@ H R C c    @3  @#  A) @6      @	  )@)@?  T  {EODWC_<  O{    *# G @{BOA _C#
mO{ C  # : Am a^!a^%g H x , @  B7Q Bm a^!a^ H x  @  B7D @{LOK#JmC_C#
mO{ C f #  Am a^!a^%g H x  @  B7# Bm a^!a^ H x  @  B7 @{LOK#JmC_C#
mO{ C 5 #  Am a^!a^%g H x  @  B 8 Bm a^!a^ H x  @  B08 @  @  Bh8 @  @  B8 #@  @  B8 '@  @  B9 +@  @  BT9 /@  @  B9 3@  @  B9 7@ { @  B9 ;@ r @  B: ?@ i @  B4: C@ ` @  BT: G@ W @  B:| K@ N @  B:s O@ E @  B;j @{LOK#JmC_O{C   = @ D c / C  @# & @@  B;J @? @ T  @@  B;> @? @ T  @@  B;2 @? @ T  @@  B;& @{EOD_ O{  ?  #  @{BOA _ O{  6  #  @{BOA _ O{  # w @  @{BOA _O{  c C R @# Rb R  @ @{COB_#mog_WO	{
     77  7@ 4  R	z(   :<@@eAYB@	@  B c   A  B<    a^c q A  B < c u A @c  C e A  B7 C \ A  BP< C S A  Bd<x C J A  Bt<o C A A  B<f   @!T7@   x    Y      R@r @{JOIWH_GgFoE#Dm_WO{   @@#  Ra @7#    @]	  )@)@? T{SORWQ_ A    "   ]	  )@)@?T O{   @@( R #     ^C  R  C t ^	  )@)@?  T  {SOR_ CWO{ 5  BR c S "  O 47#  @? qK T  @iu   @  B KT@ @{DOCWBC_  5     {DOCWBC_WO{C   @@ ( R c     @C    @    @C      @  R   R  #   1  T  1 T p   @  #    67@ H     @ + ) @@	  )@)@?a T{EODWC_    @ o    P    @	  )@)@?T _WO{   @@ H R C c    @#   " @  ,  @#  @    @    @  7  Bx ]  u V6  u        @	  )@)@? T  {FOEWD_C_  CWO{   @@ ( R # C     @     @     @   6  B/   - U6   -    s  @	  )@)@?  T  {DOCWBC_c  CWO{      4          {HOGWFC_ `  C@ V  B  B<~  K@ M  @@  B<t  @}   c H  @@  B<f  /@o   C :  @@  B4$X  +@  #  .    # ?  @@  B<H     @{HOGWFC_0  @ 0  @ 0  
@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  "@ 0  &@ 0  *@ 0  .@ 0  2@ 0  6@ 0  :@ 0  >@ 0  B@ 0  F@ 0  J@ 0  N@ 0  R@ 0  V@ 0  Z@ 0  ^@ 0  b@ 0  f@ 0  j@ 0  n@ 0  r@ 0  v@ 0  z@ 0  ~@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 1  1G  
@ P      P     P  $   P  G   P  d   P  |   P     P     P     P     P     P    P  -  P  C  P  _  P  }  P    P    P    P    P    P    P  9  P  P  P  _  P  o  P  ~  P    P    P    P    P    P    P    P  .  P  K  P  g  P  |  P    P    P    P  ~  P  {  P  x  P  u  P  r/  P  oD  P  l^  P  is  P  f  P  c  P  `  P  ]  P  Z  P  W  P  T  P  Q*  P  NC  P  K^  P  Hw  P  E  P  B  P  ?  bare-os@3.6.2 darwin platform arm64 arch type version release machine execPath pid ppid cwd chdir tmpdir homedir hostname kill availableParallelism cpuUsage threadCpuUsage resourceUsage memoryUsage freemem totalmem uptime loadavg cpus getProcessTitle setProcessTitle getEnvKeys getEnv hasEnv setEnv unsetEnv userInfo isLittleEndian signals SIGHUP SIGINT SIGQUIT SIGILL SIGTRAP SIGABRT SIGIOT SIGBUS SIGFPE SIGKILL SIGUSR1 SIGSEGV SIGUSR2 SIGPIPE SIGALRM SIGTERM SIGCHLD SIGCONT SIGSTOP SIGTSTP SIGTTIN SIGTTOU SIGURG SIGXCPU SIGXFSZ SIGVTALRM SIGPROF SIGWINCH SIGIO SIGINFO SIGSYS errnos E2BIG EACCES EADDRINUSE EADDRNOTAVAIL EAFNOSUPPORT EAGAIN EAI_ADDRFAMILY EAI_AGAIN EAI_BADFLAGS EAI_BADHINTS EAI_CANCELED EAI_FAIL EAI_FAMILY EAI_MEMORY EAI_NODATA EAI_NONAME EAI_OVERFLOW EAI_PROTOCOL EAI_SERVICE EAI_SOCKTYPE EALREADY EBADF EBUSY ECANCELED ECHARSET ECONNABORTED ECONNREFUSED ECONNRESET EDESTADDRREQ EEXIST EFAULT EFBIG EHOSTUNREACH EINTR EINVAL EIO EISCONN EISDIR ELOOP EMFILE EMSGSIZE ENAMETOOLONG ENETDOWN ENETUNREACH ENFILE ENOBUFS ENODEV ENOENT ENOMEM ENONET ENOPROTOOPT ENOSPC ENOSYS ENOTCONN ENOTDIR ENOTEMPTY ENOTSOCK ENOTSUP EOVERFLOW EPERM EPIPE EPROTO EPROTONOSUPPORT EPROTOTYPE ERANGE EROFS ESHUTDOWN ESPIPE ESRCH ETIMEDOUT ETXTBSY EXDEV UNKNOWN EOF ENXIO EMLINK EHOSTDOWN EREMOTEIO ENOTTY EFTYPE EILSEQ ESOCKTNOSUPPORT ENODATA EUNATCH ENOEXEC user system userCPUTime systemCPUTime maxRSS sharedMemorySize unsharedDataSize unsharedStackSize minorPageFault majorPageFault swappedOut fsRead fsWrite ipcSent ipcReceived signalsCount voluntaryContextSwitches involuntaryContextSwitches rss heapTotal heapUsed external model speed times nice sys idle irq uid gid username shell                    (       (             ?  L   L   r      L                    H              $" `" & ( *  + D,  / t0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      u      u      u      u      u      u      u      v      v      v      (v      4v      @v      Lv      Xv      dv      pv      |v      v      v      v      v      v      v      v      v      v      v       w      w      w      $w      0w      <w      Hw      Tw      `w      lw      xw      w      w      w      w      w      w      w      w      w      w      w      x      x       x      ,x      8x      Dx      Px      \x      hx      tx      x      x      x              0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            " `?   @___chkstk_darwin Qq @___stack_chk_guard @dyld_stub_binder  r @___stack_chk_fail  r@_free  r>@_js_create_array_with_length  r>@_js_create_arraybuffer  r >@_js_create_double  r(>@_js_create_function  r0>@_js_create_int32  r8>@_js_create_int64  r@>@_js_create_object  rH>@_js_create_string_utf8  rP>@_js_create_typedarray  rX>@_js_create_uint32  r`>@_js_get_boolean  rh>@_js_get_callback_info  rp>@_js_get_heap_statistics  rx>@_js_get_named_property  r>@_js_get_null  r>@_js_get_undefined  r>@_js_get_value_string_utf8  r>@_js_get_value_uint32  r>@_js_set_element  r>@_js_set_named_property  r>@_js_throw_error  r@_malloc  r@_realloc  r@_strlen  r>@_uv_available_parallelism  r>@_uv_chdir  r>@_uv_cpu_info  r>@_uv_cwd  r>@_uv_err_name  r>@_uv_exepath  r>@_uv_free_cpu_info  r>@_uv_get_free_memory  r>@_uv_get_process_title  r>@_uv_get_total_memory  r>@_uv_getrusage  r>@_uv_getrusage_thread  r>@_uv_kill  r>@_uv_loadavg  r>@_uv_once  r>@_uv_os_environ  r>@_uv_os_free_environ  r>@_uv_os_free_passwd  r>@_uv_os_get_passwd  r>@_uv_os_getenv  r>@_uv_os_gethostname  r>@_uv_os_getpid  r>@_uv_os_getppid  r>@_uv_os_homedir  r>@_uv_os_setenv  r>@_uv_os_tmpdir  r>@_uv_os_uname  r>@_uv_os_unsetenv  r>@_uv_resident_set_memory  r>@_uv_rwlock_init  r>@_uv_rwlock_rdlock  r>@_uv_rwlock_rdunlock  r>@_uv_rwlock_wrlock  r>@_uv_rwlock_wrunlock  r>@_uv_set_process_title  r>@_uv_strerror  r>@_uv_uptime      _bare_          get_module_name_v0 register_module_v0       1<<<<<@\          ?          PX          \X          Y          Y          Z          X[          8\      "    t\      0    \      =    ]      L    h^      \    H_      m    (`          `          a          a          b          dc          f           g          \g      *    g      :    g      K    4h      Y    j      t    Hk          k          l          n          p          q        	          	           
             ?           ?      4             E             W             j             p                                                                                                                    +            =            M            c            {                                                                                                                        (            0            J            T            a            i            v                                                                                                                                    #            7            J            \            j            }                                                                                                            
                        0            B            V            l            y                        &   (   )   *   +   ,   -   .   /   0   1   2   3   4   5   6   7   8   9   :   ;   <   =   >   ?   @   A   B   C   D   E   F   G   H   I   J   K   L   M   N   O   P   Q   R   S   T   U   V   W   X   Y   Z   [   \   ]   ^   _   `   a   b   c   d   e   %   '   f   &   (   )   *   +   ,   -   .   /   0   1   2   3   4   5   6   7   8   9   :   ;   <   =   >   ?   @   A   B   C   D   E   F   G   H   I   J   K   L   M   N   O   P   Q   R   S   T   U   V   W   X   Y   Z   [   \   ]   ^   _   `   a   b   c   d   e         _bare_get_module_name_v0 _bare_register_module_v0 ___chkstk_darwin ___stack_chk_fail ___stack_chk_guard _free _js_create_array_with_length _js_create_arraybuffer _js_create_double _js_create_function _js_create_int32 _js_create_int64 _js_create_object _js_create_string_utf8 _js_create_typedarray _js_create_uint32 _js_get_boolean _js_get_callback_info _js_get_heap_statistics _js_get_named_property _js_get_null _js_get_undefined _js_get_value_string_utf8 _js_get_value_uint32 _js_set_element _js_set_named_property _js_throw_error _malloc _realloc _strlen _uv_available_parallelism _uv_chdir _uv_cpu_info _uv_cwd _uv_err_name _uv_exepath _uv_free_cpu_info _uv_get_free_memory _uv_get_process_title _uv_get_total_memory _uv_getrusage _uv_getrusage_thread _uv_kill _uv_loadavg _uv_once _uv_os_environ _uv_os_free_environ _uv_os_free_passwd _uv_os_get_passwd _uv_os_getenv _uv_os_gethostname _uv_os_getpid _uv_os_getppid _uv_os_homedir _uv_os_setenv _uv_os_tmpdir _uv_os_uname _uv_os_unsetenv _uv_resident_set_memory _uv_rwlock_init _uv_rwlock_rdlock _uv_rwlock_rdunlock _uv_rwlock_wrlock _uv_rwlock_wrunlock _uv_set_process_title _uv_strerror _uv_uptime dyld_stub_binder _bare_os_exports _bare_os__on_env_lock_init _bare_os_type _bare_os_version _bare_os_release _bare_os_machine _bare_os_exec_path _bare_os_pid _bare_os_ppid _bare_os_cwd _bare_os_chdir _bare_os_tmpdir _bare_os_homedir _bare_os_hostname _bare_os_kill _bare_os_available_parallelism _bare_os_cpu_usage _bare_os_cpu_usage_thread _bare_os_resource_usage _bare_os_memory_usage _bare_os_freemem _bare_os_totalmem _bare_os_uptime _bare_os_loadavg _bare_os_cpus _bare_os_get_process_title _bare_os_set_process_title _bare_os_get_env_keys _bare_os_get_env _bare_os_set_env _bare_os_unset_env _bare_os_user_info __dyld_private _bare_os_env_lock_guard _bare_os_env_lock                                g   X        P                                        3        bare-os@3.bare 5B8+ajNL[:XofkOX||zH,XofkOX||zH,gNWNEk8,w_@jE\*m'01b7/7 `,F3@	dX'~Xh=$*w}BGH3ePeyJt@v1COm@STB+XofkOX||zH,XofkOX||zH,XofkOX||zH,XofkOX||zH,/&YlbDYXofkOX||zH,XofkOX||zH,XofkOX||zH,u/%pjui>gqim3.}+p]     /* global Bare */

// This export SHOULD NOT be shortened in any way as having the full
// `module.exports = require(...)` statement is crucial for synthesizing
// ESM exports.

if (Bare.platform === 'win32') {
  module.exports = require('./lib/win32')
} else {
  module.exports = require('./lib/posix')
}
module.exports = {
  CHAR_UPPERCASE_A: 0x41,
  CHAR_LOWERCASE_A: 0x61,
  CHAR_UPPERCASE_Z: 0x5a,
  CHAR_LOWERCASE_Z: 0x7a,
  CHAR_DOT: 0x2e,
  CHAR_FORWARD_SLASH: 0x2f,
  CHAR_BACKWARD_SLASH: 0x5c,
  CHAR_COLON: 0x3a,
  CHAR_QUESTION_MARK: 0x3f
}
const os = require('bare-os')

const { normalizeString } = require('./shared')
const {
  CHAR_DOT,
  CHAR_FORWARD_SLASH
} = require('./constants')

function isPosixPathSeparator (code) {
  return code === CHAR_FORWARD_SLASH
}

exports.win32 = require('./win32')
exports.posix = exports

exports.sep = '/'
exports.delimiter = ':'

exports.resolve = function resolve (...args) {
  let resolvedPath = ''
  let resolvedAbsolute = false

  for (let i = args.length - 1; i >= -1 && !resolvedAbsolute; i--) {
    const path = i >= 0 ? args[i] : os.cwd()

    if (path.length === 0) {
      continue
    }

    resolvedPath = `${path}/${resolvedPath}`
    resolvedAbsolute = path.charCodeAt(0) === CHAR_FORWARD_SLASH
  }

  resolvedPath = normalizeString(resolvedPath, !resolvedAbsolute, '/', isPosixPathSeparator)

  if (resolvedAbsolute) {
    return `/${resolvedPath}`
  }

  return resolvedPath.length > 0 ? resolvedPath : '.'
}

exports.normalize = function normalize (path) {
  if (path.length === 0) return '.'

  const isAbsolute = path.charCodeAt(0) === CHAR_FORWARD_SLASH
  const trailingSeparator = path.charCodeAt(path.length - 1) === CHAR_FORWARD_SLASH

  path = normalizeString(path, !isAbsolute, '/', isPosixPathSeparator)

  if (path.length === 0) {
    if (isAbsolute) return '/'
    return trailingSeparator ? './' : '.'
  }

  if (trailingSeparator) path += '/'

  return isAbsolute ? `/${path}` : path
}

exports.isAbsolute = function isAbsolute (path) {
  return path.length > 0 && path.charCodeAt(0) === CHAR_FORWARD_SLASH
}

exports.join = function join (...args) {
  if (args.length === 0) return '.'
  let joined
  for (let i = 0; i < args.length; ++i) {
    const arg = args[i]
    if (arg.length > 0) {
      if (joined === undefined) joined = arg
      else joined += `/${arg}`
    }
  }
  if (joined === undefined) return '.'
  return exports.normalize(joined)
}

exports.relative = function relative (from, to) {
  if (from === to) return ''

  from = exports.resolve(from)
  to = exports.resolve(to)

  if (from === to) return ''

  const fromStart = 1
  const fromEnd = from.length
  const fromLen = fromEnd - fromStart
  const toStart = 1
  const toLen = to.length - toStart

  const length = (fromLen < toLen ? fromLen : toLen)
  let lastCommonSep = -1
  let i = 0
  for (; i < length; i++) {
    const fromCode = from.charCodeAt(fromStart + i)
    if (fromCode !== to.charCodeAt(toStart + i)) {
      break
    } else if (fromCode === CHAR_FORWARD_SLASH) {
      lastCommonSep = i
    }
  }
  if (i === length) {
    if (toLen > length) {
      if (to.charCodeAt(toStart + i) === CHAR_FORWARD_SLASH) {
        return to.substring(toStart + i + 1)
      }
      if (i === 0) {
        return to.substring(toStart + i)
      }
    } else if (fromLen > length) {
      if (from.charCodeAt(fromStart + i) === CHAR_FORWARD_SLASH) {
        lastCommonSep = i
      } else if (i === 0) {
        lastCommonSep = 0
      }
    }
  }

  let out = ''
  for (i = fromStart + lastCommonSep + 1; i <= fromEnd; ++i) {
    if (i === fromEnd || from.charCodeAt(i) === CHAR_FORWARD_SLASH) {
      out += out.length === 0 ? '..' : '/..'
    }
  }

  return `${out}${to.substring(toStart + lastCommonSep)}`
}

exports.toNamespacedPath = function toNamespacedPath (path) {
  return path
}

exports.dirname = function dirname (path) {
  if (path.length === 0) return '.'
  const hasRoot = path.charCodeAt(0) === CHAR_FORWARD_SLASH
  let end = -1
  let matchedSlash = true
  for (let i = path.length - 1; i >= 1; --i) {
    if (path.charCodeAt(i) === CHAR_FORWARD_SLASH) {
      if (!matchedSlash) {
        end = i
        break
      }
    } else {
      matchedSlash = false
    }
  }

  if (end === -1) return hasRoot ? '/' : '.'
  if (hasRoot && end === 1) return '//'
  return path.substring(0, end)
}

exports.basename = function basename (path, suffix) {
  let start = 0
  let end = -1
  let matchedSlash = true

  if (suffix !== undefined && suffix.length > 0 && suffix.length <= path.length) {
    if (suffix === path) { return '' }
    let extIdx = suffix.length - 1
    let firstNonSlashEnd = -1
    for (let i = path.length - 1; i >= 0; --i) {
      const code = path.charCodeAt(i)
      if (code === CHAR_FORWARD_SLASH) {
        if (!matchedSlash) {
          start = i + 1
          break
        }
      } else {
        if (firstNonSlashEnd === -1) {
          matchedSlash = false
          firstNonSlashEnd = i + 1
        }
        if (extIdx >= 0) {
          if (code === suffix.charCodeAt(extIdx)) {
            if (--extIdx === -1) {
              end = i
            }
          } else {
            extIdx = -1
            end = firstNonSlashEnd
          }
        }
      }
    }

    if (start === end) end = firstNonSlashEnd
    else if (end === -1) end = path.length
    return path.substring(start, end)
  }

  for (let i = path.length - 1; i >= 0; --i) {
    if (path.charCodeAt(i) === CHAR_FORWARD_SLASH) {
      if (!matchedSlash) {
        start = i + 1
        break
      }
    } else if (end === -1) {
      matchedSlash = false
      end = i + 1
    }
  }

  if (end === -1) return ''
  return path.substring(start, end)
}

exports.extname = function extname (path) {
  let startDot = -1
  let startPart = 0
  let end = -1
  let matchedSlash = true
  let preDotState = 0
  for (let i = path.length - 1; i >= 0; --i) {
    const code = path.charCodeAt(i)
    if (code === CHAR_FORWARD_SLASH) {
      if (!matchedSlash) {
        startPart = i + 1
        break
      }
      continue
    }
    if (end === -1) {
      matchedSlash = false
      end = i + 1
    }
    if (code === CHAR_DOT) {
      if (startDot === -1) startDot = i
      else if (preDotState !== 1) preDotState = 1
    } else if (startDot !== -1) {
      preDotState = -1
    }
  }

  if (startDot === -1 || end === -1 || preDotState === 0 || (preDotState === 1 && startDot === end - 1 && startDot === startPart + 1)) {
    return ''
  }
  return path.substring(startDot, end)
}
const {
  CHAR_DOT,
  CHAR_FORWARD_SLASH
} = require('./constants')

exports.normalizeString = function normalizeString (path, allowAboveRoot, separator, isPathSeparator) {
  let res = ''
  let lastSegmentLength = 0
  let lastSlash = -1
  let dots = 0
  let code = 0
  for (let i = 0; i <= path.length; ++i) {
    if (i < path.length) {
      code = path.charCodeAt(i)
    } else if (isPathSeparator(code)) {
      break
    } else {
      code = CHAR_FORWARD_SLASH
    }

    if (isPathSeparator(code)) {
      if (lastSlash === i - 1 || dots === 1) ;
      else if (dots === 2) {
        if (res.length < 2 || lastSegmentLength !== 2 || res.charCodeAt(res.length - 1) !== CHAR_DOT || res.charCodeAt(res.length - 2) !== CHAR_DOT) {
          if (res.length > 2) {
            const lastSlashIndex = res.lastIndexOf(separator)
            if (lastSlashIndex === -1) {
              res = ''
              lastSegmentLength = 0
            } else {
              res = res.substring(0, lastSlashIndex)
              lastSegmentLength =
                res.length - 1 - res.lastIndexOf(separator)
            }
            lastSlash = i
            dots = 0
            continue
          } else if (res.length !== 0) {
            res = ''
            lastSegmentLength = 0
            lastSlash = i
            dots = 0
            continue
          }
        }
        if (allowAboveRoot) {
          res += res.length > 0 ? `${separator}..` : '..'
          lastSegmentLength = 2
        }
      } else {
        if (res.length > 0) {
          res += `${separator}${path.substring(lastSlash + 1, i)}`
        } else {
          res = path.substring(lastSlash + 1, i)
        }
        lastSegmentLength = i - lastSlash - 1
      }
      lastSlash = i
      dots = 0
    } else if (code === CHAR_DOT && dots !== -1) {
      ++dots
    } else {
      dots = -1
    }
  }
  return res
}
const os = require('bare-os')

const { normalizeString } = require('./shared')
const {
  CHAR_UPPERCASE_A,
  CHAR_LOWERCASE_A,
  CHAR_UPPERCASE_Z,
  CHAR_LOWERCASE_Z,
  CHAR_DOT,
  CHAR_FORWARD_SLASH,
  CHAR_BACKWARD_SLASH,
  CHAR_COLON,
  CHAR_QUESTION_MARK
} = require('./constants')

function isWindowsPathSeparator (code) {
  return code === CHAR_FORWARD_SLASH || code === CHAR_BACKWARD_SLASH
}

function isWindowsDeviceRoot (code) {
  return (code >= CHAR_UPPERCASE_A && code <= CHAR_UPPERCASE_Z) ||
         (code >= CHAR_LOWERCASE_A && code <= CHAR_LOWERCASE_Z)
}

exports.posix = require('./posix')
exports.win32 = exports

exports.sep = '\\'
exports.delimiter = ';'

exports.resolve = function resolve (...args) {
  let resolvedDevice = ''
  let resolvedTail = ''
  let resolvedAbsolute = false

  for (let i = args.length - 1; i >= -1; i--) {
    let path
    if (i >= 0) {
      path = args[i]

      if (path.length === 0) continue
    } else if (resolvedDevice.length === 0) {
      path = os.cwd()
    } else {
      path = os.getEnv(`=${resolvedDevice}`) || os.cwd()

      if (path === undefined || (path.substring(0, 2).toLowerCase() !== resolvedDevice.toLowerCase() && path.charCodeAt(2) === CHAR_BACKWARD_SLASH)) {
        path = `${resolvedDevice}\\`
      }
    }

    const len = path.length
    let rootEnd = 0
    let device = ''
    let isAbsolute = false
    const code = path.charCodeAt(0)

    if (len === 1) {
      if (isWindowsPathSeparator(code)) {
        rootEnd = 1
        isAbsolute = true
      }
    } else if (isWindowsPathSeparator(code)) {
      isAbsolute = true

      if (isWindowsPathSeparator(path.charCodeAt(1))) {
        let j = 2
        let last = j
        while (j < len && !isWindowsPathSeparator(path.charCodeAt(j))) {
          j++
        }
        if (j < len && j !== last) {
          const firstPart = path.substring(last, j)
          last = j
          while (j < len && isWindowsPathSeparator(path.charCodeAt(j))) {
            j++
          }
          if (j < len && j !== last) {
            last = j
            while (j < len && !isWindowsPathSeparator(path.charCodeAt(j))) {
              j++
            }
            if (j === len || j !== last) {
              device = `\\\\${firstPart}\\${path.substring(last, j)}`
              rootEnd = j
            }
          }
        }
      } else {
        rootEnd = 1
      }
    } else if (isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON) {
      device = path.substring(0, 2)
      rootEnd = 2
      if (len > 2 && isWindowsPathSeparator(path.charCodeAt(2))) {
        isAbsolute = true
        rootEnd = 3
      }
    }

    if (device.length > 0) {
      if (resolvedDevice.length > 0) {
        if (device.toLowerCase() !== resolvedDevice.toLowerCase()) { continue }
      } else {
        resolvedDevice = device
      }
    }

    if (resolvedAbsolute) {
      if (resolvedDevice.length > 0) { break }
    } else {
      resolvedTail = `${path.substring(rootEnd)}\\${resolvedTail}`
      resolvedAbsolute = isAbsolute
      if (isAbsolute && resolvedDevice.length > 0) {
        break
      }
    }
  }

  resolvedTail = normalizeString(resolvedTail, !resolvedAbsolute, '\\', isWindowsPathSeparator)

  return resolvedAbsolute ? `${resolvedDevice}\\${resolvedTail}` : `${resolvedDevice}${resolvedTail}` || '.'
}

exports.normalize = function normalize (path) {
  const len = path.length
  if (len === 0) return '.'
  let rootEnd = 0
  let device
  let isAbsolute = false
  const code = path.charCodeAt(0)

  if (len === 1) {
    return code === CHAR_FORWARD_SLASH ? '\\' : path
  }

  if (isWindowsPathSeparator(code)) {
    isAbsolute = true

    if (isWindowsPathSeparator(path.charCodeAt(1))) {
      let j = 2
      let last = j
      while (j < len && !isWindowsPathSeparator(path.charCodeAt(j))) {
        j++
      }
      if (j < len && j !== last) {
        const firstPart = path.substring(last, j)
        last = j
        while (j < len && isWindowsPathSeparator(path.charCodeAt(j))) {
          j++
        }
        if (j < len && j !== last) {
          last = j
          while (j < len && !isWindowsPathSeparator(path.charCodeAt(j))) {
            j++
          }
          if (j === len) {
            return `\\\\${firstPart}\\${path.substring(last)}\\`
          }
          if (j !== last) {
            device = `\\\\${firstPart}\\${path.substring(last, j)}`
            rootEnd = j
          }
        }
      }
    } else {
      rootEnd = 1
    }
  } else if (isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON) {
    device = path.substring(0, 2)
    rootEnd = 2
    if (len > 2 && isWindowsPathSeparator(path.charCodeAt(2))) {
      isAbsolute = true
      rootEnd = 3
    }
  }

  let tail = rootEnd < len ? normalizeString(path.substring(rootEnd), !isAbsolute, '\\', isWindowsPathSeparator) : ''
  if (tail.length === 0 && !isAbsolute) {
    tail = '.'
  }
  if (tail.length > 0 && isWindowsPathSeparator(path.charCodeAt(len - 1))) {
    tail += '\\'
  }
  if (device === undefined) {
    return isAbsolute ? `\\${tail}` : tail
  }
  return isAbsolute ? `${device}\\${tail}` : `${device}${tail}`
}

exports.isAbsolute = function isAbsolute (path) {
  const len = path.length
  if (len === 0) return false

  const code = path.charCodeAt(0)

  return isWindowsPathSeparator(code) || (len > 2 && isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON && isWindowsPathSeparator(path.charCodeAt(2)))
}

exports.join = function join (...args) {
  if (args.length === 0) return '.'

  let joined
  let firstPart
  for (let i = 0; i < args.length; ++i) {
    const arg = args[i]
    if (arg.length > 0) {
      if (joined === undefined) joined = firstPart = arg
      else joined += `\\${arg}`
    }
  }

  if (joined === undefined) return '.'

  let needsReplace = true
  let slashCount = 0
  if (isWindowsPathSeparator(firstPart.charCodeAt(0))) {
    ++slashCount
    const firstLen = firstPart.length
    if (firstLen > 1 && isWindowsPathSeparator(firstPart.charCodeAt(1))) {
      ++slashCount
      if (firstLen > 2) {
        if (isWindowsPathSeparator(firstPart.charCodeAt(2))) {
          ++slashCount
        } else {
          needsReplace = false
        }
      }
    }
  }
  if (needsReplace) {
    while (slashCount < joined.length && isWindowsPathSeparator(joined.charCodeAt(slashCount))) {
      slashCount++
    }

    if (slashCount >= 2) {
      joined = `\\${joined.substring(slashCount)}`
    }
  }

  return exports.normalize(joined)
}

exports.relative = function relative (from, to) {
  if (from === to) return ''

  const fromOrig = exports.resolve(from)
  const toOrig = exports.resolve(to)

  if (fromOrig === toOrig) return ''

  from = fromOrig.toLowerCase()
  to = toOrig.toLowerCase()

  if (from === to) return ''

  let fromStart = 0
  while (fromStart < from.length && from.charCodeAt(fromStart) === CHAR_BACKWARD_SLASH) {
    fromStart++
  }
  let fromEnd = from.length
  while (fromEnd - 1 > fromStart && from.charCodeAt(fromEnd - 1) === CHAR_BACKWARD_SLASH) {
    fromEnd--
  }
  const fromLen = fromEnd - fromStart

  let toStart = 0
  while (toStart < to.length && to.charCodeAt(toStart) === CHAR_BACKWARD_SLASH) {
    toStart++
  }
  let toEnd = to.length
  while (toEnd - 1 > toStart && to.charCodeAt(toEnd - 1) === CHAR_BACKWARD_SLASH) {
    toEnd--
  }
  const toLen = toEnd - toStart

  const length = fromLen < toLen ? fromLen : toLen
  let lastCommonSep = -1
  let i = 0
  for (; i < length; i++) {
    const fromCode = from.charCodeAt(fromStart + i)
    if (fromCode !== to.charCodeAt(toStart + i)) {
      break
    } else if (fromCode === CHAR_BACKWARD_SLASH) {
      lastCommonSep = i
    }
  }

  if (i !== length) {
    if (lastCommonSep === -1) return toOrig
  } else {
    if (toLen > length) {
      if (to.charCodeAt(toStart + i) === CHAR_BACKWARD_SLASH) {
        return toOrig.substring(toStart + i + 1)
      }
      if (i === 2) {
        return toOrig.substring(toStart + i)
      }
    }
    if (fromLen > length) {
      if (from.charCodeAt(fromStart + i) === CHAR_BACKWARD_SLASH) {
        lastCommonSep = i
      } else if (i === 2) {
        lastCommonSep = 3
      }
    }
    if (lastCommonSep === -1) lastCommonSep = 0
  }

  let out = ''
  for (i = fromStart + lastCommonSep + 1; i <= fromEnd; ++i) {
    if (i === fromEnd || from.charCodeAt(i) === CHAR_BACKWARD_SLASH) {
      out += out.length === 0 ? '..' : '\\..'
    }
  }

  toStart += lastCommonSep

  if (out.length > 0) {
    return `${out}${toOrig.substring(toStart, toEnd)}`
  }
  if (toOrig.charCodeAt(toStart) === CHAR_BACKWARD_SLASH) {
    ++toStart
  }
  return toOrig.substring(toStart, toEnd)
}

exports.toNamespacedPath = function toNamespacedPath (path) {
  if (path.length === 0) return path

  const resolvedPath = exports.resolve(path)

  if (resolvedPath.length <= 2) return path

  if (resolvedPath.charCodeAt(0) === CHAR_BACKWARD_SLASH) {
    if (resolvedPath.charCodeAt(1) === CHAR_BACKWARD_SLASH) {
      const code = resolvedPath.charCodeAt(2)
      if (code !== CHAR_QUESTION_MARK && code !== CHAR_DOT) {
        return `\\\\?\\UNC\\${resolvedPath.substring(2)}`
      }
    }
  } else if (
    isWindowsDeviceRoot(resolvedPath.charCodeAt(0)) &&
      resolvedPath.charCodeAt(1) === CHAR_COLON &&
      resolvedPath.charCodeAt(2) === CHAR_BACKWARD_SLASH
  ) {
    return `\\\\?\\${resolvedPath}`
  }

  return path
}

exports.dirname = function dirname (path) {
  const len = path.length
  if (len === 0) return '.'
  let rootEnd = -1
  let offset = 0
  const code = path.charCodeAt(0)

  if (len === 1) {
    return isWindowsPathSeparator(code) ? path : '.'
  }

  if (isWindowsPathSeparator(code)) {
    rootEnd = offset = 1

    if (isWindowsPathSeparator(path.charCodeAt(1))) {
      let j = 2
      let last = j
      while (j < len && !isWindowsPathSeparator(path.charCodeAt(j))) {
        j++
      }
      if (j < len && j !== last) {
        last = j
        while (j < len && isWindowsPathSeparator(path.charCodeAt(j))) {
          j++
        }
        if (j < len && j !== last) {
          last = j
          while (j < len && !isWindowsPathSeparator(path.charCodeAt(j))) {
            j++
          }
          if (j === len) {
            return path
          }
          if (j !== last) {
            rootEnd = offset = j + 1
          }
        }
      }
    }
  } else if (isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON) {
    rootEnd = len > 2 && isWindowsPathSeparator(path.charCodeAt(2)) ? 3 : 2
    offset = rootEnd
  }

  let end = -1
  let matchedSlash = true
  for (let i = len - 1; i >= offset; --i) {
    if (isWindowsPathSeparator(path.charCodeAt(i))) {
      if (!matchedSlash) {
        end = i
        break
      }
    } else {
      matchedSlash = false
    }
  }

  if (end === -1) {
    if (rootEnd === -1) return '.'

    end = rootEnd
  }
  return path.substring(0, end)
}

exports.basename = function basename (path, suffix) {
  let start = 0
  let end = -1
  let matchedSlash = true

  if (path.length >= 2 && isWindowsDeviceRoot(path.charCodeAt(0)) && path.charCodeAt(1) === CHAR_COLON) {
    start = 2
  }

  if (suffix !== undefined && suffix.length > 0 && suffix.length <= path.length) {
    if (suffix === path) return ''
    let extIdx = suffix.length - 1
    let firstNonSlashEnd = -1
    for (let i = path.length - 1; i >= start; --i) {
      const code = path.charCodeAt(i)
      if (isWindowsPathSeparator(code)) {
        if (!matchedSlash) {
          start = i + 1
          break
        }
      } else {
        if (firstNonSlashEnd === -1) {
          matchedSlash = false
          firstNonSlashEnd = i + 1
        }
        if (extIdx >= 0) {
          if (code === suffix.charCodeAt(extIdx)) {
            if (--extIdx === -1) {
              end = i
            }
          } else {
            extIdx = -1
            end = firstNonSlashEnd
          }
        }
      }
    }

    if (start === end) end = firstNonSlashEnd
    else if (end === -1) end = path.length
    return path.substring(start, end)
  }
  for (let i = path.length - 1; i >= start; --i) {
    if (isWindowsPathSeparator(path.charCodeAt(i))) {
      if (!matchedSlash) {
        start = i + 1
        break
      }
    } else if (end === -1) {
      matchedSlash = false
      end = i + 1
    }
  }

  if (end === -1) return ''
  return path.substring(start, end)
}

exports.extname = function extname (path) {
  let start = 0
  let startDot = -1
  let startPart = 0
  let end = -1
  let matchedSlash = true
  let preDotState = 0

  if (path.length >= 2 && path.charCodeAt(1) === CHAR_COLON && isWindowsDeviceRoot(path.charCodeAt(0))) {
    start = startPart = 2
  }

  for (let i = path.length - 1; i >= start; --i) {
    const code = path.charCodeAt(i)
    if (isWindowsPathSeparator(code)) {
      if (!matchedSlash) {
        startPart = i + 1
        break
      }
      continue
    }
    if (end === -1) {
      matchedSlash = false
      end = i + 1
    }
    if (code === CHAR_DOT) {
      if (startDot === -1) startDot = i
      else if (preDotState !== 1) preDotState = 1
    } else if (startDot !== -1) {
      preDotState = -1
    }
  }

  if (startDot === -1 || end === -1 || preDotState === 0 || (preDotState === 1 && startDot === end - 1 && startDot === startPart + 1)) {
    return ''
  }
  return path.substring(startDot, end)
}
{
  "name": "bare-path",
  "version": "3.0.0",
  "description": "Path manipulation library for JavaScript",
  "exports": {
    ".": "./index.js",
    "./package": "./package.json",
    "./posix": "./lib/posix.js",
    "./win32": "./lib/win32.js"
  },
  "files": [
    "index.js",
    "lib",
    "NOTICE"
  ],
  "scripts": {
    "test": "standard && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-path.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-path/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-path#readme",
  "dependencies": {
    "bare-os": "^3.0.1"
  },
  "devDependencies": {
    "brittle": "^3.3.2",
    "standard": "^17.0.0"
  }
}
module.exports = require.addon()
const EventEmitter = require('bare-events')
const { Duplex } = require('bare-stream')
const binding = require('./binding')
const constants = require('./lib/constants')
const errors = require('./lib/errors')

const defaultReadBufferSize = 65536

module.exports = exports = class Pipe extends Duplex {
  constructor(path, opts = {}) {
    if (typeof path === 'object' && path !== null) {
      opts = path
      path = null
    }

    const {
      allowHalfOpen = true,
      eagerOpen = true,
      readBufferSize = defaultReadBufferSize
    } = opts

    super({ eagerOpen })

    this._state = 0

    this._allowHalfOpen = allowHalfOpen

    this._fd = -1
    this._path = null

    this._pendingOpen = null
    this._pendingWrite = null
    this._pendingFinal = null
    this._pendingDestroy = null

    this._buffer = Buffer.alloc(readBufferSize)

    this._handle = binding.init(
      this._buffer,
      this,
      noop,
      this._onconnect,
      this._onwrite,
      this._onfinal,
      this._onread,
      this._onclose
    )

    if (typeof path === 'number') {
      this.open(path)
    } else if (typeof path === 'string') {
      this.connect(path)
    }
  }

  get connecting() {
    return (this._state & constants.state.CONNECTING) !== 0
  }

  get pending() {
    return (this._state & constants.state.CONNECTED) === 0
  }

  get readyState() {
    if (
      this._state & constants.state.READABLE &&
      this._state & constants.state.WRITABLE
    ) {
      return 'open'
    }

    if (this._state & constants.state.READABLE) {
      return 'readOnly'
    }

    if (this._state & constants.state.WRITABLE) {
      return 'writeOnly'
    }

    return 'opening'
  }

  open(fd, opts = {}, onconnect) {
    if (typeof opts === 'function') {
      onconnect = opts
      opts = {}
    }

    if (typeof fd === 'object' && fd !== null) {
      opts = fd || {}
      fd = opts.fd
    }

    try {
      const status = binding.open(this._handle, fd)

      this._state |= constants.state.CONNECTED
      this._fd = fd

      if (status & binding.READABLE) {
        this._state |= constants.state.READABLE
      } else {
        this.push(null)
      }

      if (status & binding.WRITABLE) {
        this._state |= constants.state.WRITABLE
      } else {
        this.end()
      }

      if (onconnect) this.once('connect', onconnect)

      queueMicrotask(() => this.emit('connect'))
    } catch (err) {
      queueMicrotask(() => {
        if (this._pendingOpen) this._pendingOpen(err)
        else this.destroy(err)
      })
    }

    return this
  }

  connect(path, opts = {}, onconnect) {
    if (
      this._state & constants.state.CONNECTING ||
      this._state & constants.state.CONNECTED
    ) {
      throw errors.PIPE_ALREADY_CONNECTED('Pipe is already connected')
    }

    this._state |= constants.state.CONNECTING

    if (typeof opts === 'function') {
      onconnect = opts
      opts = {}
    }

    if (typeof path === 'object' && path !== null) {
      opts = path || {}
      path = opts.path
    }

    try {
      binding.connect(this._handle, path)

      this._path = path

      if (onconnect) this.once('connect', onconnect)
    } catch (err) {
      queueMicrotask(() => {
        if (this._pendingOpen) this._pendingOpen(err)
        else this.destroy(err)
      })
    }

    return this
  }

  ref() {
    binding.ref(this._handle)
  }

  unref() {
    binding.unref(this._handle)
  }

  _open(cb) {
    if (this._state & constants.state.CONNECTED) return cb(null)
    this._pendingOpen = cb
  }

  _read() {
    if ((this._state & constants.state.READING) === 0) {
      this._state |= constants.state.READING
      binding.resume(this._handle)
    }
  }

  _writev(batch, cb) {
    this._pendingWrite = [cb, batch]
    binding.writev(
      this._handle,
      batch.map(({ chunk }) => chunk)
    )
  }

  _final(cb) {
    if (
      this._state & constants.state.READABLE &&
      this._state & constants.state.WRITABLE
    ) {
      this._pendingFinal = cb
      binding.end(this._handle)
    } else {
      cb(null)
    }
  }

  _predestroy() {
    if (this._state & constants.state.CLOSING) return
    this._state |= constants.state.CLOSING
    binding.close(this._handle)
  }

  _destroy(err, cb) {
    if (this._state & constants.state.CLOSING) return cb(err)
    this._state |= constants.state.CLOSING
    this._pendingDestroy = cb
    binding.close(this._handle)
  }

  _continueOpen(err) {
    if (this._pendingOpen === null) return
    const cb = this._pendingOpen
    this._pendingOpen = null
    cb(err)
  }

  _continueWrite(err) {
    if (this._pendingWrite === null) return
    const cb = this._pendingWrite[0]
    this._pendingWrite = null
    cb(err)
  }

  _continueFinal(err) {
    if (this._pendingFinal === null) return
    const cb = this._pendingFinal
    this._pendingFinal = null
    cb(err)
  }

  _continueDestroy() {
    if (this._pendingDestroy === null) return
    const cb = this._pendingDestroy
    this._pendingDestroy = null
    cb(null)
  }

  _onconnect(err) {
    if (err) {
      if (this._pendingOpen) this._continueOpen(err)
      else this.destroy(err)
      return
    }

    this._state |=
      constants.state.CONNECTED |
      constants.state.READABLE |
      constants.state.WRITABLE
    this._state &= ~constants.state.CONNECTING
    this._continueOpen()

    this.emit('connect')
  }

  _onread(err, read) {
    if (err) {
      this.destroy(err)
      return
    }

    if (read === 0) {
      this.push(null)
      if (this._allowHalfOpen === false) this.end()
      return
    }

    const copy = Buffer.allocUnsafe(read)
    copy.set(this._buffer.subarray(0, read))

    if (this.push(copy) === false && this.destroying === false) {
      this._state &= ~constants.state.READING
      binding.pause(this._handle)
    }
  }

  _onwrite(err) {
    this._continueWrite(err)
  }

  _onfinal(err) {
    this._continueFinal(err)
  }

  _onclose() {
    this._handle = null
    this._continueDestroy()
  }

  _onspawn(readable, writable) {
    this._state |= constants.state.CONNECTED

    if (readable) {
      this._state |= constants.state.READABLE
    } else {
      this.push(null)
    }

    if (writable) {
      this._state |= constants.state.WRITABLE
    } else {
      this.end()
    }

    this._continueOpen()
  }
}

exports.Pipe = exports

exports.pipe = function pipe() {
  return binding.pipe()
}

exports.Server = class PipeServer extends EventEmitter {
  constructor(opts = {}, onconnection) {
    if (typeof opts === 'function') {
      onconnection = opts
      opts = {}
    }

    super()

    const { readBufferSize = defaultReadBufferSize, allowHalfOpen = true } =
      opts

    this._state = 0

    this._readBufferSize = readBufferSize
    this._allowHalfOpen = allowHalfOpen

    this._path = null
    this._connections = new Set()

    this._error = null
    this._handle = null

    if (onconnection) this.on('connection', onconnection)
  }

  get listening() {
    return (this._state & constants.state.BOUND) !== 0
  }

  address() {
    if ((this._state & constants.state.BOUND) === 0) {
      return null
    }

    return this._path
  }

  listen(path, backlog = 511, opts = {}, onlistening) {
    if (
      this._state & constants.state.BINDING ||
      this._state & constants.state.BOUND
    ) {
      throw errors.SERVER_ALREADY_LISTENING('Server is already listening')
    }

    if (this._state & constants.state.CLOSING) {
      throw errors.SERVER_IS_CLOSED('Server is closed')
    }

    this._state |= constants.state.BINDING

    if (typeof backlog === 'function') {
      onlistening = backlog
      backlog = 511
    } else if (typeof opts === 'function') {
      onlistening = opts
      opts = {}
    }

    if (typeof path === 'object' && path !== null) {
      opts = path || {}
      path = opts.path
      backlog = opts.backlog || 511
    }

    this._handle = binding.init(
      empty,
      this,
      this._onconnection,
      noop,
      noop,
      noop,
      noop,
      this._onclose
    )

    if (this._state & constants.state.UNREFED) binding.unref(this._handle)

    try {
      binding.bind(this._handle, path, backlog)

      this._path = path
      this._state |= constants.state.BOUND
      this._state &= ~constants.state.BINDING

      if (onlistening) this.once('listening', onlistening)

      queueMicrotask(() => this.emit('listening'))
    } catch (err) {
      this._error = err

      binding.close(this._handle)
    }

    return this
  }

  close(onclose) {
    if (onclose) this.once('close', onclose)
    if (this._state & constants.state.CLOSING) return
    this._state |= constants.state.CLOSING
    this._closeMaybe()
  }

  ref() {
    this._state &= ~constants.state.UNREFED
    if (this._handle !== null) binding.ref(this._handle)
  }

  unref() {
    this._state |= constants.state.UNREFED
    if (this._handle !== null) binding.unref(this._handle)
  }

  _closeMaybe() {
    if (this._state & constants.state.CLOSING && this._connections.size === 0) {
      if (this._handle !== null) binding.close(this._handle)
      else queueMicrotask(() => this.emit('close'))
    }
  }

  _onconnection(err) {
    if (err) {
      this.emit('error', err)
      return
    }

    if (this._state & constants.state.CLOSING) return

    const pipe = new exports.Pipe({
      readBufferSize: this._readBufferSize,
      allowHalfOpen: this._allowHalfOpen
    })

    try {
      binding.accept(this._handle, pipe._handle)

      pipe._path = this._path
      pipe._state |=
        constants.state.CONNECTED |
        constants.state.READABLE |
        constants.state.WRITABLE

      this._connections.add(pipe)

      pipe.on('close', () => {
        this._connections.delete(pipe)
        this._closeMaybe()
      })

      this.emit('connection', pipe)
    } catch (err) {
      pipe.destroy()

      throw err
    }
  }

  _onclose() {
    const err = this._error

    this._state &= ~constants.state.BINDING
    this._error = null
    this._handle = null

    if (err) this.emit('error', err)
    else this.emit('close')
  }
}

exports.constants = constants
exports.errors = errors

exports.createConnection = function createConnection(path, opts, onconnect) {
  if (typeof opts === 'function') {
    onconnect = opts
    opts = {}
  }

  if (typeof path === 'object' && path !== null) {
    opts = path || {}
    path = opts.path
  }

  return new exports.Pipe(opts).connect(path, opts, onconnect)
}

exports.createServer = function createServer(opts, onconnection) {
  return new exports.Server(opts, onconnection)
}

const empty = Buffer.alloc(0)

function noop() {}
module.exports = {
  state: {
    CONNECTING: 0x1,
    CONNECTED: 0x2,
    BINDING: 0x4,
    BOUND: 0x8,
    READING: 0x10,
    CLOSING: 0x20,
    READABLE: 0x40,
    WRITABLE: 0x80
  }
}
module.exports = class PipeError extends Error {
  constructor(msg, code, fn = PipeError) {
    super(`${code}: ${msg}`)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name() {
    return 'PipeError'
  }

  static PIPE_ALREADY_CONNECTED(msg) {
    return new PipeError(
      msg,
      'PIPE_ALREADY_CONNECTED',
      PipeError.PIPE_ALREADY_CONNECTED
    )
  }

  static SERVER_ALREADY_LISTENING(msg) {
    return new PipeError(
      msg,
      'SERVER_ALREADY_LISTENING',
      PipeError.SERVER_ALREADY_LISTENING
    )
  }

  static SERVER_IS_CLOSED(msg) {
    return new PipeError(msg, 'SERVER_IS_CLOSED', PipeError.SERVER_IS_CLOSED)
  }
}
{
  "name": "bare-pipe",
  "version": "4.0.6",
  "description": "Native I/O pipes for JavaScript",
  "exports": {
    "./package": "./package.json",
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./constants": {
      "types": "./lib/constants.d.ts",
      "default": "./lib/constants.js"
    },
    "./errors": {
      "types": "./lib/errors.d.ts",
      "default": "./lib/errors.js"
    }
  },
  "files": [
    "index.js",
    "index.d.ts",
    "binding.c",
    "binding.js",
    "CMakeLists.txt",
    "lib",
    "prebuilds"
  ],
  "addon": true,
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-pipe.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-pipe/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-pipe#readme",
  "engines": {
    "bare": ">=1.16.0"
  },
  "dependencies": {
    "bare-events": "^2.0.0",
    "bare-stream": "^2.0.0"
  },
  "devDependencies": {
    "bare-path": "^3.0.0",
    "brittle": "^3.2.1",
    "cmake-bare": "^1.1.6",
    "prettier": "^3.4.1",
    "prettier-config-standard": "^7.0.0"
  }
}
                         __TEXT                   @               @                   __text          __TEXT          #            #                           __stubs         __TEXT          X:      X      X:                         __stub_helper   __TEXT          <      p      <                           __cstring       __TEXT           ?      ]        ?                             __unwind_info   __TEXT          ?             ?                                   __DATA_CONST     @       @       @       @                  __got           __DATA_CONST     @              @                2                 __DATA                  @              @                   __la_symbol_ptr __DATA                                        5           __data          __DATA                                                       H   __LINKEDIT              @             p                       0              bare-pipe@4.bare        "  0           @           H      (         h  L     `     P                   5                           (  g                          59'w2                      *                 8         xA   /usr/lib/libSystem.B.dylib      &      8  0   )      h            0  @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          WO{    <  cp#    @   <  c##    @   <  c0(#    @   <  c,#    @   <  c`1#    @   <  c4#   p @   =  c:#   a @   &=  c=#   R @   B=  c@#   C @z   Z=  c`#   4 @k   r=  c#   % @\   =  c#    @M   =  c #    @> # ! R @  B=4 # A R @  B=* {COBWA_WO{	C   @@R      c  # C ]R @@ R.  	7@My@!
A
    @@
" R @@
" R #@@
" R '@@
" R +@@" R /@@!" R 3@@A" R @C  ! } @]	  )@)@? T{IOHWG_        ]	  )@)@?TZ WO{ 	R  @ ?@    @@H R #    } \  u ]_ # R  @b _     @_ $ R @6     y ]	  )@)@? T  @ {BOAW_ WO{   @@H R     < @c  4 @S E @@u  7@]   q@\ 2  q#  @]	  )@)@? T{FOEWD_ B  f  ,   ]	  )@)@?T WO{ 	R  @ ?@   @@h R C    @#   @ # R  
@  @    # R  7@@  B @6       ]	  )@)@? T  @{BOAW_ WO{C   @@ H R C c    @#   @   @ @6      @	  )@)@?  T  {EODWC_M _WO{   @@ H R C c   t @#  l @ d @|  }    S @( 4 zw"    \  @B T   R@ !     	  V6g    Q @	  )@)@? T  {FOEWD_C_ CWO{   @@ ( R # C    @   @ !  B0Z @6 3  W   @	  )@)@?  T  {DOCWBC_ CWO{   @@ ( R # C    @   @
   4@  !#  B# @6   !   @	  )@)@?  T  {DOCWBC_ CWO{   @@ ( R # C    @   @  4@ @6      @	  )@)@?  T  {DOCWBC_Q O{    @@ 4 R # C   z @  r @`9  ! @	  )@)@?  T  {COB_+ O{    @@ ( R # C   T @  L @ @	  )@)@?  T  {COB_ O{    @@ ( R # C   1 @  ) @ @	  )@)@?  T  {COB_ CO{   @@ RRJ c A R #C  '#  A R @@" R @^	  )@)@?  T{DOCC_ ( R(d9(`K9H  4_   CWO{ LApAc  RAC  jA#  VA ZA ^A bA fA jA RA fK9  5@    @  {DOCWBC_WO{  @@ @fK9 5NA  RA  ZAc   7      C  r   #  k @ X A # R F @F ]	  )@)@?  T{FOEWD_. WO{  @@dK9 5 LA k RA [ VAc W  7 P   t  C  -   #  & @  A # R  @ ]	  )@)@?  T{FOEWD_  WO{  @@ @fK9 5NA & RA  ^Ac   7    /  C    O  #    @   A # R   @  ]	  )@)@?  T{FOEWD_  WO{  @@ @fK9 5NA   RA   bAc    7        C    
  #    @   A # R w  @w  ]	  )@)@?  T{FOEWD__   
 =@ =_WO{   @@??  Ta  fK9 4]	  )@)@? T{FOEWD_ fK9h5NA   RAc w  fAC s  4  k  "      #  E       >  @  *  "  R,  A C R   @  ]	  )@)@?T  0  @ 0  @ 0  
@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  "@ 0  &@ 0  *@ 0  .@ 0  2@ 0  6@ 0  :@ 0  >@ 0  B@ 0  F@ 0  J@ 0  N@ 0  R@ 0  V@ 0  Z@ 0  ^@ 0  b@ 0  f@ 0  j@ 0  n@ 0  r@ 0  v@ 0  z@ 0  ~@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 1  1BG  
@ P      P     P  $   P  M   P  e   P     P     P     P     P     P  
  P  !  P  <  P  Y  P  q  P    P    P    P    P    P  /  P  G  P  [  P  z  P    P    P    P    P  
  P  (  P  ?  P  N  P  ]  P  o  P    P    P    P    P    P    P    P  ~  P  {(  P  x=  P  uS  P  rh  P  ow  P  l  P  i  P  f  init connect open bind accept writev end resume pause close ref unref pipe READABLE WRITABLE             $       $           #  H   H   X:      H                    ,      	       P `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <      <      <      <      <      =      =      =      (=      4=      @=      L=      X=      d=      p=      |=      =      =      =      =      =      =      =      =      =      =       >      >      >      $>      0>      <>      H>      T>      `>      l>      x>      >      >      >      >      >      >      >      >      >      >      >      ?      ?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      " `2   @___chkstk_darwin Qq @___stack_chk_guard @dyld_stub_binder  r @___stack_chk_fail  r@_free  r>@_js_add_deferred_teardown_callback  r>@_js_call_function  r >@_js_close_handle_scope  r(>@_js_create_array_with_length  r0>@_js_create_arraybuffer  r8>@_js_create_error  r@>@_js_create_function  rH>@_js_create_int32  rP>@_js_create_int64  rX>@_js_create_reference  r`>@_js_create_string_utf8  rh>@_js_create_uint32  rp>@_js_delete_reference  rx>@_js_finish_deferred_teardown_callback  r>@_js_get_array_elements  r>@_js_get_array_length  r>@_js_get_arraybuffer_info  r>@_js_get_callback_info  r>@_js_get_env_loop  r>@_js_get_null  r>@_js_get_reference_value  r>@_js_get_typedarray_info  r>@_js_get_value_string_utf8  r>@_js_get_value_uint32  r>@_js_open_handle_scope  r>@_js_set_element  r>@_js_set_named_property  r>@_js_throw_error  r@_malloc  r@_strlen  r>@_uv_accept  r>@_uv_close  r>@_uv_err_name  r>@_uv_is_readable  r>@_uv_is_writable  r>@_uv_listen  r>@_uv_pipe  r>@_uv_pipe_bind2  r>@_uv_pipe_connect2  r>@_uv_pipe_init  r>@_uv_pipe_open  r>@_uv_read_start  r>@_uv_read_stop  r>@_uv_ref  r>@_uv_shutdown  r>@_uv_strerror  r>@_uv_unref  r>@_uv_write          _bare_register_module_v0       G    G(          '          (          *          (+          X,          (-      *    .      9    x/      K    P0      \    1      m    1      |    <2          2          3          3          4          5          6          7      (    8      =    8      Q               #                   ,             >             Q             W             z                                                                                                                   3            J            \            q                                                                                                (            @            Z            o                                                                                                                                                            "            1            C            Q            _            n            |                                                                                                 !   "   #   $   %   &   '   (   )   *   +   ,   -   .   /   0   1   2   3   4   5   6   7   8   9   :   ;   <   =   >   ?   @   A   B   C   D   E   F   G   H   I   J         K                            !   "   #   $   %   &   '   (   )   *   +   ,   -   .   /   0   1   2   3   4   5   6   7   8   9   :   ;   <   =   >   ?   @   A   B   C   D   E   F   G   H   I   J         _bare_register_module_v0 ___chkstk_darwin ___stack_chk_fail ___stack_chk_guard _free _js_add_deferred_teardown_callback _js_call_function _js_close_handle_scope _js_create_array_with_length _js_create_arraybuffer _js_create_error _js_create_function _js_create_int32 _js_create_int64 _js_create_reference _js_create_string_utf8 _js_create_uint32 _js_delete_reference _js_finish_deferred_teardown_callback _js_get_array_elements _js_get_array_length _js_get_arraybuffer_info _js_get_callback_info _js_get_env_loop _js_get_null _js_get_reference_value _js_get_typedarray_info _js_get_value_string_utf8 _js_get_value_uint32 _js_open_handle_scope _js_set_element _js_set_named_property _js_throw_error _malloc _strlen _uv_accept _uv_close _uv_err_name _uv_is_readable _uv_is_writable _uv_listen _uv_pipe _uv_pipe_bind2 _uv_pipe_connect2 _uv_pipe_init _uv_pipe_open _uv_read_start _uv_read_stop _uv_ref _uv_shutdown _uv_strerror _uv_unref _uv_write dyld_stub_binder _bare_pipe_init _bare_pipe_connect _bare_pipe_open _bare_pipe_bind _bare_pipe_accept _bare_pipe_writev _bare_pipe_end _bare_pipe_resume _bare_pipe_pause _bare_pipe_close _bare_pipe_ref _bare_pipe_unref _bare_pipe_pipe _bare_pipe__on_teardown _bare_pipe__on_close _bare_pipe__on_connect _bare_pipe__on_connection _bare_pipe__on_write _bare_pipe__on_shutdown _bare_pipe__on_alloc _bare_pipe__on_read __dyld_private           =            )       i   X         0                                                bare-pipe@4.bare e;KQG9NnO=L:N/WXofkOX||zH,	)sVW79H!UbFSzl&#[XofkOX||zH,XofkOX||zH,XofkOX||zH,XofkOX||zH,5.>u6T.`ZP&|XofkOX||zH,XofkOX||zH,XofkOX||zH,^	!T><MsBptrrUG]YWaoWj%E   exports.constants = require('./lib/constants')
exports.errors = require('./lib/errors')

const Version = exports.Version = require('./lib/version')
const Range = exports.Range = require('./lib/range')
exports.Comparator = require('./lib/comparator')

exports.satisfies = function satisfies (version, range) {
  if (typeof version === 'string') version = Version.parse(version)
  if (typeof range === 'string') range = Range.parse(range)

  return range.test(version)
}
const constants = require('./constants')

const symbols = {
  [constants.EQ]: '=',
  [constants.LT]: '<',
  [constants.LTE]: '<=',
  [constants.GT]: '>',
  [constants.GTE]: '>='
}

module.exports = class Comparator {
  constructor (operator, version) {
    this.operator = operator
    this.version = version
  }

  test (version) {
    const result = version.compare(this.version)

    switch (this.operator) {
      case constants.LT: return result < 0
      case constants.LTE: return result <= 0
      case constants.GT: return result > 0
      case constants.GTE: return result >= 0
      default: return result === 0
    }
  }

  toString () {
    return symbols[this.operator] + this.version
  }
}
module.exports = {
  EQ: 1,
  LT: 2,
  LTE: 3,
  GT: 4,
  GTE: 5
}
module.exports = class SemVerError extends Error {
  constructor (msg, code, fn = SemVerError) {
    super(`${code}: ${msg}`)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name () {
    return 'SemVerError'
  }

  static INVALID_VERSION (msg, fn = SemVerError.INVALID_VERSION) {
    return new SemVerError(msg, 'INVALID_VERSION', fn)
  }

  static INVALID_RANGE (msg, fn = SemVerError.INVALID_RANGE) {
    return new SemVerError(msg, 'INVALID_RANGE', fn)
  }
}
const constants = require('./constants')
const errors = require('./errors')
const Version = require('./version')
const Comparator = require('./comparator')

const Range = module.exports = exports = class Range {
  constructor (comparators = []) {
    this.comparators = comparators
  }

  test (version) {
    for (const set of this.comparators) {
      let matches = true

      for (const comparator of set) {
        if (comparator.test(version)) continue
        matches = false
        break
      }

      if (matches) return true
    }

    return false
  }

  toString () {
    let result = ''
    let first = true

    for (const set of this.comparators) {
      if (first) first = false
      else result += ' || '

      result += set.join(' ')
    }

    return result
  }
}

exports.parse = function parse (input, state = { position: 0, partial: false }) {
  let i = state.position
  let c

  const unexpected = (expected) => {
    let msg

    if (i >= input.length) {
      msg = `Unexpected end of input in '${input}'`
    } else {
      msg = `Unexpected token '${input[i]}' in '${input}' at position ${i}`
    }

    if (expected) msg += `, ${expected}`

    throw errors.INVALID_VERSION(msg, unexpected)
  }

  const comparators = []

  while (i < input.length) {
    const set = []

    while (i < input.length) {
      c = input[i]

      let operator = constants.EQ

      if (c === '<') {
        operator = constants.LT
        c = input[++i]

        if (c === '=') {
          operator = constants.LTE
          c = input[++i]
        }
      } else if (c === '>') {
        operator = constants.GT
        c = input[++i]

        if (c === '=') {
          operator = constants.GTE
          c = input[++i]
        }
      } else if (c === '=') {
        c = input[++i]
      }

      const state = { position: i, partial: true }

      set.push(new Comparator(operator, Version.parse(input, state)))

      c = input[i = state.position]

      while (c === ' ') c = input[++i]

      if (c === '|' && input[i + 1] === '|') {
        c = input[i += 2]

        while (c === ' ') c = input[++i]

        break
      }

      if (c && c !== '<' && c !== '>') unexpected('expected \'||\', \'<\', or \'>\'')
    }

    if (set.length) comparators.push(set)
  }

  if (i < input.length && state.partial === false) unexpected('expected end of input')

  state.position = i

  return new Range(comparators)
}
const errors = require('./errors')

const Version = module.exports = exports = class Version {
  constructor (major, minor, patch, opts = {}) {
    const {
      prerelease = [],
      build = []
    } = opts

    this.major = major
    this.minor = minor
    this.patch = patch
    this.prerelease = prerelease
    this.build = build
  }

  compare (version) {
    return exports.compare(this, version)
  }

  toString () {
    let result = `${this.major}.${this.minor}.${this.patch}`

    if (this.prerelease.length) {
      result += '-' + this.prerelease.join('.')
    }

    if (this.build.length) {
      result += '+' + this.build.join('.')
    }

    return result
  }
}

exports.parse = function parse (input, state = { position: 0, partial: false }) {
  let i = state.position
  let c

  const unexpected = (expected) => {
    let msg

    if (i >= input.length) {
      msg = `Unexpected end of input in '${input}'`
    } else {
      msg = `Unexpected token '${input[i]}' in '${input}' at position ${i}`
    }

    if (expected) msg += `, ${expected}`

    throw errors.INVALID_VERSION(msg, unexpected)
  }

  const components = []

  while (components.length < 3) {
    c = input[i]

    if (components.length > 0) {
      if (c === '.') c = input[++i]
      else unexpected('expected \'.\'')
    }

    if (c === '0') {
      components.push(0)

      i++
    } else if (c >= '1' && c <= '9') {
      let j = 0
      do c = input[i + ++j]
      while (c >= '0' && c <= '9')

      components.push(parseInt(input.substring(i, i + j)))

      i += j
    } else unexpected('expected /[0-9]/')
  }

  const prerelease = []

  if (input[i] === '-') {
    i++

    while (true) {
      c = input[i]

      let tag = ''
      let j = 0

      while (c >= '0' && c <= '9') c = input[i + ++j]

      let isNumeric = false

      if (j) {
        tag += input.substring(i, i + j)

        c = input[i += j]

        isNumeric = tag[0] !== '0' || tag.length === 1
      }

      j = 0

      while ((c >= '0' && c <= '9') || (c >= 'a' && c <= 'z') || (c >= 'A' && c <= 'Z') || c === '-') c = input[i + ++j]

      if (j) {
        tag += input.substring(i, i + j)

        c = input[i += j]
      } else if (!isNumeric) unexpected('expected /[a-zA-Z-]/')

      prerelease.push(tag)

      if (c === '.') c = input[++i]
      else break
    }
  }

  const build = []

  if (input[i] === '+') {
    i++

    while (true) {
      c = input[i]

      let tag = ''
      let j = 0

      while ((c >= '0' && c <= '9') || (c >= 'a' && c <= 'z') || (c >= 'A' && c <= 'Z') || c === '-') c = input[i + ++j]

      if (j) {
        tag += input.substring(i, i + j)

        c = input[i += j]
      } else unexpected('expected /[0-9a-zA-Z-]/')

      build.push(tag)

      if (c === '.') c = input[++i]
      else break
    }
  }

  if (i < input.length && state.partial === false) unexpected('expected end of input')

  state.position = i

  return new Version(...components, { prerelease, build })
}

const integer = /^[0-9]+$/

exports.compare = function compare (a, b) {
  if (a.major > b.major) return 1
  if (a.major < b.major) return -1

  if (a.minor > b.minor) return 1
  if (a.minor < b.minor) return -1

  if (a.patch > b.patch) return 1
  if (a.patch < b.patch) return -1

  if (a.prerelease.length === 0) return b.prerelease.length === 0 ? 0 : 1
  if (b.prerelease.length === 0) return -1

  let i = 0
  do {
    let x = a.prerelease[i]
    let y = b.prerelease[i]

    if (x === undefined) return y === undefined ? 0 : -1
    if (y === undefined) return 1

    if (x === y) continue

    const xInt = integer.test(x)
    const yInt = integer.test(y)

    if (xInt && yInt) {
      x = +x
      y = +y
    } else {
      if (xInt) return -1
      if (yInt) return 1
    }

    return x > y ? 1 : -1
  } while (++i)
}
{
  "name": "bare-semver",
  "version": "1.0.1",
  "description": "Minimal semantic versioning library for Bare",
  "exports": {
    ".": "./index.js",
    "./package": "./package.json",
    "./constants": "./lib/constants.js",
    "./errors": "./lib/errors.js",
    "./version": "./lib/version.js",
    "./range": "./lib/range.js",
    "./comparator": "./lib/comparator.js"
  },
  "files": [
    "index.js",
    "lib"
  ],
  "scripts": {
    "test": "standard && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-semver.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-semver/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-semver#readme",
  "devDependencies": {
    "brittle": "^3.2.1",
    "standard": "^17.0.0"
  }
}
const stream = require('streamx')

const defaultEncoding = 'utf8'

module.exports = exports = stream.Stream

exports.pipeline = stream.pipeline

exports.isStream = stream.isStream
exports.isEnded = stream.isEnded
exports.isFinished = stream.isFinished
exports.isDisturbed = stream.isDisturbed

exports.getStreamError = stream.getStreamError

exports.Stream = exports

exports.Readable = class Readable extends stream.Readable {
  constructor(opts = {}) {
    super({
      ...opts,
      byteLength: null,
      byteLengthReadable: null,
      map: null,
      mapReadable: null
    })

    if (this._construct) this._open = this._construct

    if (this._read !== stream.Readable.prototype._read) {
      this._read = read.bind(this, this._read)
    }

    if (this._destroy !== stream.Stream.prototype._destroy) {
      this._destroy = destroy.bind(this, this._destroy)
    }
  }

  push(chunk, encoding) {
    if (typeof chunk === 'string') {
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    }

    return super.push(chunk)
  }

  unshift(chunk, encoding) {
    if (typeof chunk === 'string') {
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    }

    super.unshift(chunk)
  }
}

exports.Writable = class Writable extends stream.Writable {
  constructor(opts = {}) {
    super({
      ...opts,
      byteLength: null,
      byteLengthWritable,
      map: null,
      mapWritable: null
    })

    if (this._construct) this._open = this._construct

    if (this._write !== stream.Writable.prototype._write) {
      this._write = write.bind(this, this._write)
    }

    if (this._destroy !== stream.Stream.prototype._destroy) {
      this._destroy = destroy.bind(this, this._destroy)
    }
  }

  write(chunk, encoding, cb) {
    if (typeof encoding === 'function') {
      cb = encoding
      encoding = null
    }

    if (typeof chunk === 'string') {
      encoding = encoding || defaultEncoding
      chunk = Buffer.from(chunk, encoding)
    } else {
      encoding = 'buffer'
    }

    const result = super.write({ chunk, encoding })

    if (cb) stream.Writable.drained(this).then(() => cb(null), cb)

    return result
  }

  end(chunk, encoding, cb) {
    if (typeof chunk === 'function') {
      cb = chunk
      chunk = null
    } else if (typeof encoding === 'function') {
      cb = encoding
      encoding = null
    }

    if (typeof chunk === 'string') {
      encoding = encoding || defaultEncoding
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    } else {
      encoding = 'buffer'
    }

    const result =
      chunk !== undefined && chunk !== null
        ? super.end({ chunk, encoding })
        : super.end()

    if (cb) this.once('end', () => cb(null))

    return result
  }
}

exports.Duplex = class Duplex extends stream.Duplex {
  constructor(opts = {}) {
    super({
      ...opts,
      byteLength: null,
      byteLengthReadable: null,
      byteLengthWritable,
      map: null,
      mapReadable: null,
      mapWritable: null
    })

    if (this._construct) this._open = this._construct

    if (this._read !== stream.Readable.prototype._read) {
      this._read = read.bind(this, this._read)
    }

    if (this._write !== stream.Duplex.prototype._write) {
      this._write = write.bind(this, this._write)
    }

    if (this._destroy !== stream.Stream.prototype._destroy) {
      this._destroy = destroy.bind(this, this._destroy)
    }
  }

  push(chunk, encoding) {
    if (typeof chunk === 'string') {
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    }

    return super.push(chunk)
  }

  unshift(chunk, encoding) {
    if (typeof chunk === 'string') {
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    }

    super.unshift(chunk)
  }

  write(chunk, encoding, cb) {
    if (typeof encoding === 'function') {
      cb = encoding
      encoding = null
    }

    if (typeof chunk === 'string') {
      encoding = encoding || defaultEncoding
      chunk = Buffer.from(chunk, encoding)
    } else {
      encoding = 'buffer'
    }

    const result = super.write({ chunk, encoding })

    if (cb) stream.Writable.drained(this).then(() => cb(null), cb)

    return result
  }

  end(chunk, encoding, cb) {
    if (typeof chunk === 'function') {
      cb = chunk
      chunk = null
    } else if (typeof encoding === 'function') {
      cb = encoding
      encoding = null
    }

    if (typeof chunk === 'string') {
      encoding = encoding || defaultEncoding
      chunk = Buffer.from(chunk, encoding)
    } else {
      encoding = 'buffer'
    }

    const result =
      chunk !== undefined && chunk !== null
        ? super.end({ chunk, encoding })
        : super.end()

    if (cb) this.once('end', () => cb(null))

    return result
  }
}

exports.Transform = class Transform extends stream.Transform {
  constructor(opts = {}) {
    super({
      ...opts,
      byteLength: null,
      byteLengthReadable: null,
      byteLengthWritable,
      map: null,
      mapReadable: null,
      mapWritable: null
    })

    if (this._transform !== stream.Transform.prototype._transform) {
      this._transform = transform.bind(this, this._transform)
    } else {
      this._transform = passthrough
    }
  }

  push(chunk, encoding) {
    if (typeof chunk === 'string') {
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    }

    return super.push(chunk)
  }

  unshift(chunk, encoding) {
    if (typeof chunk === 'string') {
      chunk = Buffer.from(chunk, encoding || defaultEncoding)
    }

    super.unshift(chunk)
  }

  write(chunk, encoding, cb) {
    if (typeof encoding === 'function') {
      cb = encoding
      encoding = null
    }

    if (typeof chunk === 'string') {
      encoding = encoding || defaultEncoding
      chunk = Buffer.from(chunk, encoding)
    } else {
      encoding = 'buffer'
    }

    const result = super.write({ chunk, encoding })

    if (cb) stream.Writable.drained(this).then(() => cb(null), cb)

    return result
  }

  end(chunk, encoding, cb) {
    if (typeof chunk === 'function') {
      cb = chunk
      chunk = null
    } else if (typeof encoding === 'function') {
      cb = encoding
      encoding = null
    }

    if (typeof chunk === 'string') {
      encoding = encoding || defaultEncoding
      chunk = Buffer.from(chunk, encoding)
    } else {
      encoding = 'buffer'
    }

    const result =
      chunk !== undefined && chunk !== null
        ? super.end({ chunk, encoding })
        : super.end()

    if (cb) this.once('end', () => cb(null))

    return result
  }
}

exports.PassThrough = class PassThrough extends exports.Transform {}

exports.finished = function finished(stream, opts, cb) {
  if (typeof opts === 'function') {
    cb = opts
    opts = {}
  }

  if (!opts) opts = {}

  const { cleanup = false } = opts

  const done = () => {
    cb(exports.getStreamError(stream, { all: true }))

    if (cleanup) detach()
  }

  const detach = () => {
    stream.off('close', done)
    stream.off('error', noop)
  }

  if (stream.destroyed) {
    done()
  } else {
    stream.on('close', done)
    stream.on('error', noop)
  }

  return detach
}

function read(read, cb) {
  read.call(this, 65536)

  cb(null)
}

function write(write, data, cb) {
  write.call(this, data.chunk, data.encoding, cb)
}

function transform(transform, data, cb) {
  transform.call(this, data.chunk, data.encoding, cb)
}

function destroy(destroy, cb) {
  destroy.call(this, exports.getStreamError(this), cb)
}

function passthrough(data, cb) {
  cb(null, data.chunk)
}

function byteLengthWritable(data) {
  return data.chunk.byteLength
}

function noop() {}
{
  "name": "bare-stream",
  "version": "2.6.5",
  "description": "Streaming data for JavaScript",
  "exports": {
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./package": "./package.json",
    "./promises": "./promises.js",
    "./web": "./web.js",
    "./global": "./global.js"
  },
  "files": [
    "index.js",
    "index.d.ts",
    "promises.js",
    "web.js",
    "global.js"
  ],
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-stream.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-stream/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-stream#readme",
  "dependencies": {
    "streamx": "^2.21.0"
  },
  "devDependencies": {
    "bare-buffer": "^3.0.0",
    "bare-events": "^2.5.4",
    "brittle": "^3.5.2",
    "prettier": "^3.3.3",
    "prettier-config-standard": "^7.0.0"
  },
  "peerDependencies": {
    "bare-buffer": "*",
    "bare-events": "*"
  },
  "peerDependenciesMeta": {
    "bare-buffer": {
      "optional": true
    },
    "bare-events": {
      "optional": true
    }
  }
}
module.exports = require.addon()
const path = require('bare-path')
const binding = require('./binding')
const errors = require('./lib/errors')
const URLSearchParams = require('./lib/url-search-params')

const kind = Symbol.for('bare.url.kind')

const isWindows = Bare.platform === 'win32'

module.exports = exports = class URL {
  static get [kind]() {
    return 0 // Compatibility version
  }

  constructor(input, base, opts = {}) {
    if (arguments.length === 0) throw errors.INVALID_URL()

    input = String(input)

    if (base !== undefined) base = String(base)

    this._components = new Uint32Array(8)

    this._parse(input, base, opts.throw !== false)

    if (this._href) this._params = new URLSearchParams(this.search, this)
  }

  get [kind]() {
    return URL[kind]
  }

  // https://url.spec.whatwg.org/#dom-url-href

  get href() {
    return this._href
  }

  set href(value) {
    this._update(value)

    this._params._parse(this.search)
  }

  // https://url.spec.whatwg.org/#dom-url-protocol

  get protocol() {
    return this._slice(0, this._components[0]) + ':'
  }

  set protocol(value) {
    this._update(
      this._replace(value.replace(/:+$/, ''), 0, this._components[0])
    )
  }

  // https://url.spec.whatwg.org/#dom-url-username

  get username() {
    return this._slice(this._components[0] + 3 /* :// */, this._components[1])
  }

  set username(value) {
    if (cannotHaveCredentialsOrPort(this)) {
      return
    }

    if (this.username === '') value += '@'

    this._update(
      this._replace(
        value,
        this._components[0] + 3 /* :// */,
        this._components[1]
      )
    )
  }

  // https://url.spec.whatwg.org/#dom-url-password

  get password() {
    return this._href.slice(
      this._components[1] + 1 /* : */,
      this._components[2] - 1 /* @ */
    )
  }

  set password(value) {
    if (cannotHaveCredentialsOrPort(this)) {
      return
    }

    let start = this._components[1] + 1 /* : */
    let end = this._components[2] - 1 /* @ */

    if (this.password === '') {
      value = ':' + value
      start--
    }

    if (this.username === '') {
      value += '@'
      end++
    }

    this._update(this._replace(value, start, end))
  }

  // https://url.spec.whatwg.org/#dom-url-host

  get host() {
    return this._slice(this._components[2], this._components[5])
  }

  set host(value) {
    if (hasOpaquePath(this)) {
      return
    }

    this._update(
      this._replace(
        value,
        this._components[2],
        this._components[value.includes(':') ? 5 : 3]
      )
    )
  }

  // https://url.spec.whatwg.org/#dom-url-hostname

  get hostname() {
    return this._slice(this._components[2], this._components[3])
  }

  set hostname(value) {
    if (hasOpaquePath(this)) {
      return
    }

    this._update(this._replace(value, this._components[2], this._components[3]))
  }

  // https://url.spec.whatwg.org/#dom-url-port

  get port() {
    return this._slice(this._components[3] + 1 /* : */, this._components[5])
  }

  set port(value) {
    if (cannotHaveCredentialsOrPort(this)) {
      return
    }

    let start = this._components[3] + 1 /* : */

    if (this.port === '') {
      value = ':' + value
      start--
    }

    this._update(this._replace(value, start, this._components[5]))
  }

  // https://url.spec.whatwg.org/#dom-url-pathname

  get pathname() {
    return this._slice(this._components[5], this._components[6] - 1 /* ? */)
  }

  set pathname(value) {
    if (hasOpaquePath(this)) {
      return
    }

    if (value[0] !== '/' && value[0] !== '\\') {
      value = '/' + value
    }

    this._update(
      this._replace(value, this._components[5], this._components[6] - 1 /* ? */)
    )
  }

  // https://url.spec.whatwg.org/#dom-url-search

  get search() {
    return this._slice(
      this._components[6] - 1 /* ? */,
      this._components[7] - 1 /* # */
    )
  }

  set search(value) {
    if (value && value[0] !== '?') value = '?' + value

    this._update(
      this._replace(
        value,
        this._components[6] - 1 /* ? */,
        this._components[7] - 1 /* # */
      )
    )

    this._params._parse(this.search)
  }

  // https://url.spec.whatwg.org/#dom-url-searchparams

  get searchParams() {
    return this._params
  }

  // https://url.spec.whatwg.org/#dom-url-hash

  get hash() {
    return this._slice(this._components[7] - 1 /* # */)
  }

  set hash(value) {
    if (value && value[0] !== '#') value = '#' + value

    this._update(this._replace(value, this._components[7] - 1 /* # */))
  }

  toString() {
    return this._href
  }

  toJSON() {
    return this._href
  }

  [Symbol.for('bare.inspect')]() {
    return {
      __proto__: { constructor: URL },

      href: this.href,
      protocol: this.protocol,
      username: this.username,
      password: this.password,
      host: this.host,
      hostname: this.hostname,
      port: this.port,
      pathname: this.pathname,
      search: this.search,
      searchParams: this.searchParams,
      hash: this.hash
    }
  }

  _slice(start, end = this._href.length) {
    return this._href.slice(start, end)
  }

  _replace(replacement, start, end = this._href.length) {
    return this._slice(0, start) + replacement + this._slice(end)
  }

  _parse(input, base, shouldThrow) {
    try {
      this._href = binding.parse(
        String(input),
        base ? String(base) : null,
        this._components,
        shouldThrow
      )
    } catch (err) {
      if (err instanceof TypeError) throw err

      throw errors.INVALID_URL()
    }
  }

  _update(input) {
    try {
      this._parse(input, null, true)
    } catch (err) {
      if (err instanceof TypeError) throw err
    }
  }
}

// https://url.spec.whatwg.org/#url-opaque-path
function hasOpaquePath(url) {
  return url.pathname[0] !== '/'
}

// https://url.spec.whatwg.org/#cannot-have-a-username-password-port
function cannotHaveCredentialsOrPort(url) {
  return url.hostname === '' || url.protocol === 'file:'
}

const URL = exports

exports.URL = URL
exports.URLSearchParams = URLSearchParams

exports.errors = errors

exports.isURL = function isURL(value) {
  if (value instanceof URL) return true

  return (
    typeof value === 'object' && value !== null && value[kind] === URL[kind]
  )
}

// https://url.spec.whatwg.org/#dom-url-parse
exports.parse = function parse(input, base) {
  const url = new URL(input, base, { throw: false })
  return url._href ? url : null
}

// https://url.spec.whatwg.org/#dom-url-canparse
exports.canParse = function canParse(input, base) {
  return binding.canParse(String(input), base ? String(base) : null)
}

exports.fileURLToPath = function fileURLToPath(url) {
  if (typeof url === 'string') {
    url = new URL(url)
  }

  if (url.protocol !== 'file:') {
    throw errors.INVALID_URL_SCHEME('The URL must use the file: protocol')
  }

  if (isWindows) {
    if (/%2f|%5c/i.test(url.pathname)) {
      throw errors.INVALID_FILE_URL_PATH(
        'The file: URL path must not include encoded \\ or / characters'
      )
    }
  } else {
    if (url.hostname) {
      throw errors.INVALID_FILE_URL_HOST(
        "The file: URL host must be 'localhost' or empty"
      )
    }

    if (/%2f/i.test(url.pathname)) {
      throw errors.INVALID_FILE_URL_PATH(
        'The file: URL path must not include encoded / characters'
      )
    }
  }

  const pathname = path.normalize(decodeURIComponent(url.pathname))

  if (isWindows) {
    if (url.hostname) return '\\\\' + url.hostname + pathname

    const letter = pathname.charCodeAt(1) | 0x20

    if (
      letter < 0x61 /* a */ ||
      letter > 0x7a /* z */ ||
      pathname.charCodeAt(2) !== 0x3a /* : */
    ) {
      throw errors.INVALID_FILE_URL_PATH('The file: URL path must be absolute')
    }

    return pathname.slice(1)
  }

  return pathname
}

exports.pathToFileURL = function pathToFileURL(pathname) {
  let resolved = path.resolve(pathname)

  if (pathname[pathname.length - 1] === '/') {
    resolved += '/'
  } else if (isWindows && pathname[pathname.length - 1] === '\\') {
    resolved += '\\'
  }

  resolved = resolved
    .replaceAll('%', '%25') // Must be first
    .replaceAll('#', '%23')
    .replaceAll('?', '%3f')
    .replaceAll('\n', '%0a')
    .replaceAll('\r', '%0d')
    .replaceAll('\t', '%09')

  if (!isWindows) {
    resolved = resolved.replaceAll('\\', '%5c')
  }

  return new URL('file:' + resolved)
}

exports.format = function format(parts) {
  const {
    protocol,
    auth,
    host,
    hostname,
    port,
    pathname,
    search,
    query,
    hash,
    slashes
  } = parts

  let result = ''

  if (typeof protocol === 'string') {
    result += protocol

    if (protocol[protocol.length - 1] !== ':') {
      result += ':'
    }

    if (slashes === true || /https?|ftp|gopher|file/.test(protocol)) {
      result += '//'
    }
  }

  if (typeof auth === 'string') {
    if (host || hostname) result += auth + '@'
  }

  if (typeof host === 'string') result += host
  else {
    result += hostname

    if (port) result += ':' + port
  }

  if (typeof pathname === 'string' && pathname !== '') {
    if (pathname[0] !== '/') result += '/'
    result += pathname
  }

  if (typeof search === 'string') {
    if (search[0] !== '?') result += '?'
    result += search
  } else if (typeof query === 'object' && query !== null) {
    result += '?' + new URLSearchParams(query)
  }

  if (typeof hash === 'string') {
    if (hash[0] !== '#') result += '#'
    result += hash
  }

  return result
}
module.exports = class URLError extends Error {
  constructor(msg, code, fn = URLError) {
    super(`${code}: ${msg}`)
    this.code = code

    if (Error.captureStackTrace) {
      Error.captureStackTrace(this, fn)
    }
  }

  get name() {
    return 'URLError'
  }

  static INVALID_URL(msg = 'Invalid URL') {
    return new URLError(msg, 'INVALID_URL', URLError.INVALID_URL)
  }

  static INVALID_URL_SCHEME(msg = 'Invalid URL') {
    return new URLError(msg, 'INVALID_URL_SCHEME', URLError.INVALID_URL_SCHEME)
  }

  static INVALID_FILE_URL_HOST(msg = 'Invalid file: URL host') {
    return new URLError(
      msg,
      'INVALID_FILE_URL_HOST',
      URLError.INVALID_FILE_URL_HOST
    )
  }

  static INVALID_FILE_URL_PATH(msg = 'Invalid file: URL path') {
    return new URLError(
      msg,
      'INVALID_FILE_URL_PATH',
      URLError.INVALID_FILE_URL_PATH
    )
  }
}
module.exports = class URLSearchParams {
  static _urls = new WeakMap()

  // https://url.spec.whatwg.org/#dom-urlsearchparams-urlsearchparams
  constructor(init, url = null) {
    this._params = new Map()

    if (url) URLSearchParams._urls.set(this, url)

    if (typeof init === 'string') {
      this._parse(init)
    } else if (init) {
      for (const [name, value] of typeof init[Symbol.iterator] === 'function'
        ? init
        : Object.entries(init)) {
        this.append(name, value)
      }
    }
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-size
  get size() {
    return this._params.length
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-append
  append(name, value = null) {
    if (value === null) return

    let list = this._params.get(name)

    if (list === undefined) {
      list = []
      this._params.set(name, list)
    }

    list.push(value)

    this._update()
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-delete
  delete(name, value = null) {
    if (value === null) this._params.delete(name)
    else {
      let list = this._params.get(name)

      if (list === undefined) return

      list = list.filter((found) => found !== value)

      if (list.length === 0) this._params.delete(name)
      else this._params.set(name, list)
    }

    this._update()
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-get
  get(name) {
    const list = this._params.get(name)

    if (list === undefined) return null

    return list[0]
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-getall
  getAll(name) {
    const list = this._params.get(name)

    if (list === undefined) return []

    return Array.from(list)
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-has
  has(name, value = null) {
    const list = this._params.get(name)

    if (list === undefined) return false

    if (value === null) return true

    return list.includes(value)
  }

  // https://url.spec.whatwg.org/#dom-urlsearchparams-set
  set(name, value = null) {
    if (value === null) this._params.delete(name)
    else this._params.set(name, [value])

    this._update()
  }

  toString() {
    return this._serialize()
  }

  toJSON() {
    return [...this]
  }

  *[Symbol.iterator]() {
    for (const [name, values] of this._params) {
      for (const value of values) yield [name, value]
    }
  }

  [Symbol.for('bare.inspect')]() {
    const object = {
      __proto__: { constructor: URLSearchParams }
    }

    for (const [name, values] of this._params) {
      if (values.length === 1) object[name] = values[0]
      else object[name] = values
    }

    return object
  }

  // https://url.spec.whatwg.org/#concept-urlsearchparams-update
  _update() {
    const url = URLSearchParams._urls.get(this)

    if (url === undefined) return

    url.search = this._serialize()
  }

  // https://url.spec.whatwg.org/#concept-urlencoded-parser
  _parse(input) {
    if (input[0] === '?') input = input.substring(1)

    this._params = new Map()

    for (const sequence of input.split('&')) {
      if (sequence.length === 0) continue

      let i = sequence.indexOf('=')
      if (i === -1) i = sequence.length

      const name = decodeURIComponent(sequence.substring(0, i))
      const value = decodeURIComponent(
        sequence.substring(i + 1, sequence.length)
      )

      let list = this._params.get(name)

      if (list === undefined) {
        list = []
        this._params.set(name, list)
      }

      list.push(value)
    }
  }

  // https://url.spec.whatwg.org/#concept-urlencoded-serializer
  _serialize() {
    let output = ''

    for (let [name, values] of this._params) {
      name = encodeURIComponent(name)

      for (const value of values) {
        if (output) output += '&'

        output += name + '=' + encodeURIComponent(value)
      }
    }

    return output
  }
}
{
  "name": "bare-url",
  "version": "2.3.1",
  "description": "WHATWG URL implementation for JavaScript",
  "exports": {
    "./package": "./package.json",
    ".": {
      "types": "./index.d.ts",
      "default": "./index.js"
    },
    "./global": {
      "types": "./global.d.ts",
      "default": "./global.js"
    }
  },
  "files": [
    "index.js",
    "index.d.ts",
    "global.js",
    "global.d.ts",
    "binding.c",
    "binding.js",
    "CMakeLists.txt",
    "lib",
    "prebuilds"
  ],
  "addon": true,
  "scripts": {
    "test": "prettier . --check && bare test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/bare-url.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/bare-url/issues"
  },
  "homepage": "https://github.com/holepunchto/bare-url",
  "dependencies": {
    "bare-path": "^3.0.0"
  },
  "devDependencies": {
    "brittle": "^3.3.2",
    "cmake-bare": "^1.1.6",
    "cmake-fetch": "^1.0.0",
    "prettier": "^3.3.3",
    "prettier-config-standard": "^7.0.0"
  }
}
            `           (  __TEXT                   @              @                  __text          __TEXT          4            4                           __stubs         __TEXT          p0            p0                        __stub_helper   __TEXT          T1            T1                          __const         __TEXT          P2     8      P2                            __cstring       __TEXT          >     O       >                            __unwind_info   __TEXT          >            >                                  __DATA_CONST     @      @       @      @                  __got           __DATA_CONST     @             @                                __DATA                 @             @                   __la_symbol_ptr __DATA                                                  __data          __DATA                                                     H   __LINKEDIT             @            '                       (             bare-url@2.bare "  0         0           8    0                   P       )   )   _                                  (                         ~&9\g2                      *                 8         xA   /usr/lib/libSystem.B.dylib      &           )                  `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              :_WO{    ^:  c0#   > @>   v:  cp #   > @> {COBWA_g_WO{   @@ R  > [> Z> 9o    ==<b X8 4Z   > @>  Z > @_   T>     > 
7Y  > 3@>  Y >  9'  ==8c 3@X8 q_   T>      `> 574 Bc `> ZC     a> @@  ;@ @  TK> @ @  TG> @[  )@)@?  T<> ;@ @  T;> @ @  T7> X8 4  B:	  ;@ @  T.> X8  4  B: E>   [  )@)@?!T{ROQWP_OgN_o_WO{C   @@H Rc  > [> 9o    ==<b Y8 4[   > @>  [ = @_   T>   X   = 7Z  = 3@=  Z =  9' == a 3@Y8 q_   T=   /   = ;@ @  T= @ @  T=  qc = @[  )@)@? T{QOPWO_NoM_;@ @  T=  R= 3@[  )@)@?`T= Cog_	W
O{ cA  @A _  T(@+   T"  R+  T H	HH!HAHH _  T=  +@@  v=  @u= +@ 3 '   C C(  5 R  C  )I(ih8
 * RI!?jI R5 T  T#@iw8 QQ q  TR QQ qHT  k	Ijyhx)	
  q/@	*3 6 q T*) R(!		 	 TRk  T@~ 4rq} T@3@H  4! q@E D@7 @+  C  JHih8
 %@( 7  viw8CHih8
 %H 6 TRCHih8
 %7 q. T "H cC T#@I@9?qAg T  T A Th@9q TH	@9q T   R @@(@9(1 7(@ q T@_@y T(@@i 	Cy Tq  qA T  T#@@9 qA T@_@ T(@@i
 	C T!   Rm@ q& T@`J T(@I 	cJ T #@@- 4@ q! T@H 4@ k T(@I 	#k T- 	@- 45R qTrq`Tl  q! T ! T#@@9 q  T@_TR@i
 	" Th H	HH!HAHH _ T<  D   rq*RIRI   Qu q4 T  kY
  jyhx)	
 3@ '@I	
	u7(3 uR Q % q TEh 7@@_
RI?e Th[	HH!HAHH _b TS<  Db  @+ R q`Trq T@J6 H@ q5 TH%E)J	@_	I1?51:@ T(@@*@I	 T R q TrqT@J3 H@ q2 TH%E)J	@_	I1?51:@@ T(@@6@@I	C T:  Q q T) R(!) 	 	@	 T E?  T @9	Cj  JIIii8	 (%+ 6@9q`  T q+ T@#)7 UR@ 4 rqJRI qU q TRk  T@rq	@z  T q`  T qA TE* _  Tm  )
  yjxk	`
@9_ q T q T@h  4rq` T@_ ST(@
 Rk T q@G T q` T a  !H. D@6
 Rk`  T q T@_ T(@@i 	 T 3@[@E@ q DZ7/ @#)3 R: 5R7u R 4)/  UR7 . q T*) R(!		 	 TRk  T@V4rqVT3@  R/@KR*@8*V Q T~SU5@ Q q Ti  ) (hka T F  qaST@"@
@?:1@  T(@@@i	  TY @+ ! /   "@
@?:1@`- T(@@@i	c- T  qa  TUR@-E)	@1
2
) T@ 	\ 4
@  q T q T q@ Ta	 Rk@TEh 7@@_
RI?B Th[	HH!HAHH _ T;   Eh 7@@_
RI?j Th[	HH!HAHH _g T:  Dg ,
 @h ; _`- T(@i 	i Tj 	  T#@I@9?qA Ti@9?q T	 	T a TH	@9q T  U R RkT@h  4rq@TEh 7@@_
RI? Th[	HH!HAHH _` T:   R@i 	! ThS	HH!HAHH _  T:  D` 	 @+ @ q+@
 D@:7@/ 3 7 5R6/ 7  @/ 7  @_D T(@@i 	D T[  5@(%D) 	k Ta  !;B Ru D57@)/  RI 	B) TH H	HH!HAHH & Tc:  D& 	  q TRkaT5RR@@i	* T( H	HH!HAHH  ( TE:  D@( x	 3@'@h 6 /@7@@_
RI? T H	HH!HAHH _  T(:  
 
@9_ q!W TF)) Q@	3_I1_ TK	I	l J
M @9 q@ TJ  _IT 
@9_ qS T
@9_ qS T
	@9Jy_q@T 
@9_ q@Q T_ qAR T
@9_ qQ T
	@9_ qQ T
@9  
@9_ qP T
@9_ qP T
	@9Jy_qP T
@9_ qO T
@9_ qAO T
@9Jy_qTu R@@i	3 T( H	HH!HAHH 0 T9  D 1   T?qTi@9?qv TI	@9?qav TI@9?qv T @T u TH@9q@T 9  9 DZ 5 3@RHk38@  	@? qi  )j  JIB; E+@Q D73 @h ?  q! T@_ T(@i 	 T R'Ri 	; Th[	HH!HAHH _@9 Tv9  D9  Ri 	; Th[	HH!HAHH _8 Tb9  D8  RI 	: TH H	HH!HAHH  8 TM9  D`8  nq  Tvq! T/  89  79 DZ/ 7 3@Vk;83@ 3 R'9  &9 D; 3 @Rhk:x@	  ' URR@i 	"U Th H	HH!HAHH _R T9  DR @ 8  8 D 5 3@@8 @ @ @N =  T(@I 	'@  T"  RI 	'@ THZ	HH!HAHH   T8  D@  8  8 D  3 @@HRhk:8@  7 F)J Q@
j1_	V1Z T)@J?
 THH	HH!HAHH  T8  D   	RJ?
T  8  8 D  3 <@	`8 h@h @)G)J Q	@
s1	u2		 T@+@R; @7b@;  +@ 6  ; +@aR+ D 7@ R@i 	"G ThS	HH!HAHH _D TW8  DD  @_f T(@@i
 	f T ?8  >8 D<  5 3@@48 @ @ #   T(@I 	D  T"  RI 	D THZ	HH!HAHH   T8  D@ N 8  8 D  3 @@HRhk:8@  @ q iT 4rqA T@_ T(@@i
 	 Ts &E)
@_	[1l3 T@_( T(@@@i
 	 ( T &D) @	k T@`] T(@I 	c] T) R@i
 	) Th H	HH!HAHH _ ' T7  D`'  7  7 D / 7 3@Vk;83@ 3 RQ7  7 D  3 @hRHk;8  7  7 D:  3 @hRHk;8@  R17  7 D  3 @Rhk:x@	  '  R ca  ! DO6 
@9_ q T
	@9Jy_q  T
@9_ q T
@_ q T
F)k Q@1
 B T	@9*Ck  kIjij8)	 I%	 6	@9?q`  T? qa  TIR	 9@@_  T(@i 	  T   Ri 	 Th[	HH!HAHH _  T87  D@ k )7  (7 Dz  3 @RHk;8@  @_  T)@3@J ?
  T#  	R3@J ?
 TH H	HH!HAHH _  T	7  D@ < 6  6 D  3 ;@3@@/@6 3@'@	@: 3  q T q+@> TH ; @  T(@I 	  T   RI 	 THZ	HH!HAHH   T6  D@  6  6 D  3 @hRhk:8@  ? R[6  6 D:  5 @RHk3x@	  ' 5RGR@@i
 	 9 Th H	HH!HAHH _6 T6   6  6 D  5 @RHk3x@	  '  Rr6  q6 D  5 @,RrHk3@   R	 # _  T)@
 ?
  T!  	R
 ?
 T H	HH!HAHH _  TQ6  D@  B6  A6 D  3 @HR		 9IR	 y@  '  R+6  *6 D  5 @HRHk38@  c\ D 73 3 @7  5Rh@9q TH	@9q! TH@9q  T  R( R     R( R   "H@@ T(@	 T( H	HH!HAHH  T5  D  ! R	T  5  5 D{  3 <@	`#@5 h@| @H 4  T	 +@@Kii8k2Ki)8) 	AT@  @  TI@9?qA T  ( T , TH@9q+ TH@9qA+ T RY @  Q# +@@* 4_' T(@ 	' Tv +@ @ T	 A( TI@9?q' TI@9?q' T	  T ' TH@9q& TU R4  #T?qTI@9?q% TI@9?q!% TI@9?q$ T  T A$ TH@9q# TR@*@I	+ T ( H	HH!HAHH  ( T_5  B R@6@@I	B/ T( H	HH!HAHH , TI5  f ( R/ Eh 7@@_
RI?@ Th[	HH!HAHH _ > T05   #5  "5 D / 7 3@Vk;83@ 3 RR@i
 	R Th H	HH!HAHH _O T
5  ~ _   T@ q@	@`	C T\  q  T@  4rq  T3 UR_z T(@ RI 	h TH H	HH!HAHH `e T4  , 4  4 D  5 @@@RHk3x@	  *D)) 
@
j1B	) T@	= +@~7@' @HD) ) QJ	@_	S1u2 T@@ARm +@`|7bA# +@{7Rb D {7@@  ' b+  Dy7@/ @-@ 5@	@_	S1u2i\ T@ARD +@@w7bA '@v7@1@3 @ H@9q TH@9q TH@9qA T R  Q# _TR 	 T H	HH!HAHH _ TX4  (   R  Q# U 4@  @ka  T RRB T#@@9 q  T'  R@9 2 9)/ 7 uR*4  )4 Dl  3 @RHk<x@	  ' R4  4 D;j  3 <@@A`4 @ / 7 @hF)) Qk@_	I1?51: T(@I	 T ( H	HH!HAHH   T3  q  RI	T'@r  3  3 Db  3 ;@3 @ / 7 2		 Dc T#@I	*@9KCl  Iik8J	 j%* 6*@9_ q T	  ? T(	@9 Q q T) R(!) 	 	@	= T@HF)) QJ	@_	J1_I1H		 C< T@J@A	) R*hi8_ q  T) 	aT ? : T	1_  (I 	?	 9 T	@9*Ck  kIjij8)	 I%8 6@9 qA8 T D76 y3  x3 D{V  3 <@	@a`m3 h@h R	k T q`B T q@ T2#@ 	 3 67@  @)G)J Q	@
s1	u2	2 T@+@R P7b@;  DO7R93  83 DzN / 7 3@Vk;83@ 3 )3  (3 DzL / 7 3@Vk;83@ 3 UR3  3 zJ / 7 3@@ 3 #ER	 y	R		 93@ 3 '@  
  a  !Hy D@G7   T/@ iu8 qT+@H7@' _  T(@i 	  T   Ri 	 Th[	HH!HAHH _  T2  D@  2  2 DA  3 @HRHk;8@  ( R+  !T@+@H  7' @_  T(@i 	  T  Ri 	B Th[	HH!HAHH _  T2    2  2 D:;  3 @RHk;8@  3 UR( R' 6  u R2  2 D8  ; @RHk3x@	  @L@I)D)) 
1	1@	i T@@ T(@I	 C T-  )@
 T(@@I	
 Tq  RI	  T ( H	HH!HAHH   TM2    @2  ?2 D[/  3 :@@`52 @ ' @HD) ) QJ	@_	S1v2+@ T@:@AR +@`+7bA +@*7R '@ *7@@+ @TR@I	 T( H	HH!HAHH   T1    1  1 D%  3 :@@@`1 @ / h.@ i6@j
@_	I1?D TAR +@ "7@h-@ i5@k@_	I1?(1a"G D  7@7  URf	 D UR` ; R+@[1  1 D;  3 @Rhk:x@	  )/ @7 F)) Q@_	I1?51<@  T(@	 T ( H	HH!HAHH  T1  D@    R	CT  s1  r1 D@  3 :@	a`g1 h@h R	k@ T q T q T ; +@aR '@ 7R+@@)G)J Q	@
s1	u2	 T@+@R 7b@;  D 6s     URD ;  R+@R@i 	 ThS	HH!HAHH _@ T 1    R 	b T\	HH!HAHH _ T1    u R0  0 D:  5 @RHk38( R0  0 DZ  3 @RHk<8( R+@9lCm  Iil8k	 %|6)	@9? q!|T  5 R5 R2#@ b  B  7 R/@@   T  /@ @ @  T0 {LOKWJ_IgHoGC_F)) Q
@_	J1_I1_ TK	@	l JM @9 q  TJ  _IT__ T@ q@	@`	C  TH _+@9lCm  Iil8k	 %6)	@9? q`Tg_WO{  *HC(hh8	 %h 66@ A T
@_	 T;  6@ A  T@? TF  
R_	 T
 )I)	I)I)!I)AI)I7   TZ0   ?  	R? TV	HH!HAHH  TH0   -  :0  90   
 @HG3i  )I(
@y* y	@9(	 9h R  $0  #0   
 @j68( R  R)@(( {DOCWB_Ag_  {DOCWB_Ag_og_WO{	C h  @@  @9mq T 	*@9_uqA T 
 Tl@9 qK T  Th@9 q T`	 ( R 	!K T   R 	 R 7     6 T  R.   T 	 R  	  R* Rk  kI	@9Cnin8	@M!
@9Coio8	@N!
*	@9Coio8	@N!
@9Coio8*	@L!
* q*/ ,! T) T? b  T0   R R R@)
	
 p  J_8@9@9	@9#CC%CFCjc8jd8je8jf81
   ! B q$1 $   $!  $B  * **k*  AT**h* 		k  kI,@8Cmim8	 % *J T r`  T $ @i  )@)@? Tb  BH{IOHWG_FgEoD  	 R* Rk  k@9Cnin8	@M!
@9Coio8	@N!
*	@9Coio8	@N!
@9Coio8*	@L!
* q)* ! T) T b  T0   R R R@

 p  _8@9@9	@9#CC%CFCjc8jd8je8jf81
   ! B q$1 $   $!  $B  )* **k*  AT	*	*i	* k  k@8Cmim8	 % )*J T? r T  A   jz8 q  TZ aT&  T H	HH!HAHH .    ( R	 D#I T 9   RR	 D#IT )I)	I)I)!I)AI)I8 ( 6.   d _@C   T	@?  T 	R?4 T H	HH!HAHH `2 T.  2 (.    @  . @ _ TR  t.  s.    @k78@  Z _B T@9 qS bU T @@i?TW	HH!HAHH @TU.  
 	@9*Ck  kI jij8+	 J%j6	@9
Ck  kI jij8	 J%j6j  JIZii8\ih8 @@i?B TW	HH!HAHH   T+.     .  . 8{   @k78@  z _T@ 	@jh8_ q  T 	iT  6i  T
     	 		 T	jj8 q  TJ _	iT
 I  !K	
5
` T
	 # T*@9_ q T*@9Jy_aqa TJ R	 
1  T)

* R  )   T+@9l Q ) q#Tk kQ qK!k d@ATvb@yB   T)@?# T/  *@9J Q_) qbT)  AT7  jh8? q  T aT 	 7'J*_ q	2k n   T@9 q T@8yaqV TL R	 m1 j T k  RR	 TR. R p  J @9? q  T(jT    	`, T @9q Q1 ?* q Tq 1Q? q!1 $@  Tq@jq8 ? 	 T# @9b QB _( q# Td " RQ q T!   Ta@ja81 ? 	 T$ @9 QB _( qC T B RcQ q( T!  T@ja81 ? 	@ T# @9b QB _( q# Td b RQ qh T!   Ta@ja81 ? 	 R  " R  B R  b R! 7# @9`  q! T   	`T@y!x  ?" qT R R 	R? T H	HH!HAHH ` T-  l  ,  ,   @,  R@   R(S b  BP;o  R, |@o 	 S7uB v^@   T@  MR *@9 Q% qQ T.kiQ T/. k T? P T  C T?P T		d T 
	
ik8 q  Tk _aT l 7_'* qO_M1/M  `O T@9 qO T@8zbqX TH R	 1 cK T . ,  , J @v z
 x@, h@h  R@ H TE  Q-|. k T@9 Q) qTQ qTQ qF T]Q  qF TE 4  qE T-@"	T R
JROR = r  T@9? q= "
CzT 	T@91 Q?& qT-
  R  1  	 T@9! Q?$ q T"> _ kT41~1!!> ?q)T @ j`x1"j x 2=  q	T)> ? q  T	R?b* TW	HH!HAHH  ( T ,  A  R@ Qy)x R?(j	 T@K) ? q	 T
 
_@y
)L} Milx_ yKi,x?	 qK T)@+ Q}Milx[@y[ yNi,xj _	 q T+	 Q
L} MilxW@yW yNi,xk 	 q T+ Q}MilxS@yS yNi,xj _	 qK T+ Q
L} MilxO@yO yNi,xk 	 q T+ Q}MilxK@yK yNi,xj _	 q T(G@y Q} KihxG yIi(x   ! qT[@ C `  T@  	R?B TV	HH!HAHH   T+    +  +   @ 	 RjRj68@J  R 
R  mK	k T !  Tyhx5 T @y/ 4  ?-k1
21  T	 	@y5 T @y5 T @yO5 @T @y5 T @y5  T@ym  4 h}
   R_ q) R5[} W  F;  H+  G+ |X \ Y@HRk98@   Rs
 B @ Th  6jsx 4 TA  !8;0 y7( Rs
 B AT2  jsx o  R,+ |@o  `w7: T@ T@@) 	 T( Rs
 B T  R@) 	T(Y	HH!HAHH @T+  _@ `  T@  	R?" TW	HH!HAHH  T*  G  R
*  *  v x
 w@Rj78h@ h (_S B  BP;o  R* |@o   7v^@ `  T@  	R? TW	HH!HAHH @ T*  #  	R R* RJ!*h T)#9*@*  * g  @ RRj78@  S  *  *  v x
 w@Rj78h@ h (?S B  BP;o  R* |@o w `7v^@ `  T@  	R?" TW	HH!HAHH   Tf*    Y*  X*  v x
 w@Rj78h@ h (  B  BP;o  RQ* |@o E 6@  @  T* @i  )@)@?! T{IOHWG_FgEoD_PR *@91 Q?& qT1kT}1  T T @ T(T!*_	 T )	Jik8 q  Tk _aT l 7_'* qO_M1/   T@9 q T@8zbq TH R	 1 cT .Y   Q|1  `T@9 Q?* qTQ? qTQ? qT^QR	R2PR *@91 Q?& q(T1kT}1  T  T  TT!*_i T ,H*ik8_ q  Tk aT 
 d!J
*H ` T-@9 q T-@8yaq!	 TH R_	 M1_ cT J4  @ Q|1  T@9 Q?* qTQ? qTQ? qT^QR	R`) LR *-@9 Q% qT-kT}-) J T `AT	R Q|-) J T,@9 Q) qTQ qTQ qHT]QR?  T @9	CJ  JIIii8	 (% 6@9 q  T?   T  R_  R_@9 Q) 	 	@)%)  q_og_WO{  a j|8	Cji8	 (%  7 T  A Tv^@xB  T	@? T:  wf@(xB   T	@? TE  	R? T H	HH!HAHH @ T)   o  	R? T H	HH!HAHH @ T(   \  (  ( 
 v y
 w@(   Rh@h J  (  ( ; w z
 y@ #H(  T	@?  T  	R? T H	HH!HAHH   T(    w @h
 y@( h@h B T@97 { !T  R	  (  ( W  {FOEWD_CgBoA_  R_  R_  R_ Z_ Z_
 ( IA ?( T
 
K)@K	 T  R__b T	 

+8 7  q_  R_    
R3* 9
R 3* 9)	   T
A  _i  Tl@9  l5@  T?7, 8E T _LA  T -A  T|`= =)Thh8+ 8 
T _! ?   T  TH  T	 
 	) 	K@8% x) T A_)zH	
 K 	@B/ o%/!oF/Bog/cod>e?f	 gkT?T! ?   T  TH  T	 * 		 	+@8E J T B_)z
 K H   =H  =H  =H  !=	H	DF  N N N N  N N N N  Nr= N N NpE<  N N Nu? NsQ>rv wpEkT?T  ?    T	      _?   T 	 n    oO( RN){ o@  o	 o o o o o o o o o o o o o<Z7!N[/Zo\o o$NsN}oZ/ /$NN\ o$NN o$N1N<{/Z /Z$NBNz /Z$N{ o{$N /$N7!NcN/oNo Nz oZ$N9No/{ /{$NN o{$NN[ o{$NN /{$NRN/Z /Z$NNz oZ$NNz /Z$NNJ TN$NNNNN NBN NbN NN!NAN N ^ f?  T?} T	)}  o oN 
J	+ RcN o o@4"// /#N o#No /1#N o#NNN N!NJ! T!N N N ^ f?  T* 		 	+81J T___ 	   ( RL 8)? T(A  	i  Tl@9  l5@ T,?6 	q T( " T k@9nqA T	 q Te3H R?E T, 	A  T- MA  T|)`=@=JThi8K 8) ?TH_  _  RR  % x b T!    T@9?6  @ T .?6	qa T "	 T@9 3% x	 % T % x " T@9 y	@9	 y@9 y@9 y@9 y@9 y@9 yA q T	  TMS@9 3	@9 3% x qa T  T@9 MS	@9 @9 3	33	N)N* y y   A_  _ 	  R  @987( RLE )?b T,A  	T9@ T L?6	q! T-  T@9qa T 3q TH R?E HT- 	A  T _  TN	 T|) =/"/!o o/ oCB J	 Thi8HE ) ?Tq T-	  T@9q T	@9q T S3k T 3 q# Th Rq T- b T@9q T	@9qa T@9q T	S3ADQD1C T 3* RHB_  _  ?    T	 n    _?   T	 L  ){ o  o N@  o	 o o o o o o o o o o o o o	o9	o/[/Zoo/o=//o9o?/9onn.B.c.!n1n .nn..R.snn. J TNNaNNCNNNN NbN N!NN!N N ^ f? T?} T	)}  o oN 
J	 o o@	///ocnB. n!.J! T!N N N ^ f?  T* 		 	+@8KJ T_    I R  K	@k=S} q+%_ q*1  
	 !   T
@y_qT* R  
	 ! !T_  _  ?@   T	  ~    _ o( R NO)| O co	 o o o o o o oI66n o NsN / NNV6n o NN / NN]6n o9 NN / NN6n o9 NN / NN86n /9 NN o NsNX6n /9 NN o NN6n /9 NN o NN6n /9 NN o NN16n8 / N1 o1 NR6nY /9 NR oR N6n /Z N o N6n /{ N o NsZ n3nX nnZ nUnZ n4nX nnX nEnX nnZ npnJA !TNNNN NN N ^ f? T* 			+E@qq=r J T_@ | __  A @  T$ _WO{   A@ T	@?B T) )I)	I)I)!I)AI)I5  T$     Rv u
 {BOAW_	R?T  R{BOAW_~$  b@}$ v  {BOAW_WO{  A  T @" H Tg$ A$   Rt {BOAW_  R{BOAW_]$      Rh v
 {BOAW_  {BOAW_@_ _@ _?  __WO{  @A  T	@?  T  	R?b TI )I)	I)I)!I)AI)I6  T#$   u v
 @@$   R@h {COBWA__$  b@$ w  {COBWA___WO{  A  T	@?  T  	R?B T )I)	I)I)!I)AI)I7 ` T#   v w
 #   Rt {COBWA__#  b@#   {COBWA___WO{  "@X@I @   T
@_	  T  
R_	 T) )I)	I)I)!I)AI)I7  T#  @ u w
 v@@@#   R@i@(h {COBWA__#  #   {COBWA__g_WO{ \@@   T
@_	  T  
R_	b T) )I)	I)I)!I)AI)I8  Td#  @  
 @U#   R@ {DOCWB_Ag_F#  E#   {DOCWB_Ag__WO{  X@ @   T
@_	  T  
R_	B TV)	I)I)!I)AI)I7 ` T##   u w
 v@  Rj68h@ h {COBWA__	#  #   {COBWA__g_WO{ _ @ Tv^@hB  T
@_	 T  "  v^@ hB T
R_	b T) )I)	I)I)!I)AI)I8  T"  @ v x
 w@"   Rh@h {DOCWB_Ag_"  "   {DOCWB_Ag__WO{  (@X@
	@ 	  T+@
  T  R
 TH H	HH!HAHH 	` T"   u w
 @v@" `@
@"   R@i@(h {COBWA__u"  t"   {COBWA__g_WO{ \@@   T
@_	  T  
R_	b T) )I)	I)I)!I)AI)I8 ` TP"    
 @D" @="   R@ {DOCWB_Ag_."  -"   {DOCWB_Ag__WO{  X@ @   T
@_	  T  
R_	B TV)	I)I)!I)AI)I7   T"  ` u w
 v@ !   Rh@ 9h@ h {COBWA__!  !   {COBWA__g_WO{ _ @ Tv^@hB  T
@_	 T  !  v^@ hB T
R_	b T) )I)	I)I)!I)AI)I8 ` T!   v x
 w@! `@!   Rh@h {DOCWB_Ag_!  !   {DOCWB_Ag_g_WO{@ T  {DOCWB_Ag_ H@ 6A	  T*@_  T   
R_ TH H	HH!HAHH 	  Tj!  @ \!  [! Yv x
 @w@S! h@ 
@L!   Rz {DOCWB_Ag_og_WO{C@b  T  8    A  T	@?  T  	R? Ti )I)	I)I)!I)AI)I9   T!!  @ !  ! w y
 x@! h@ !   R{ {EODWC_BgAo_g_WO{@ T  {DOCWB_Ag_   A  T	@?  T  	R?b TW)	I)I)!I)AI)I8   T   @       
 @      R@i58 {DOCWB_Ag_og_WO{C@b  T  B    @ TA T	@? T'      AT	R? Ti )I)	I)I)!I)AI)I9   T   @ x   w  x y
 w@ p  h@ h    R{ {EODWC_BgAo_og_WO{C@b  T  =   I ?h@: 6A	  T*@_  T   
R_ TH H	HH!HAHH 	  T8   @ *   )  yv x
 @w@h   h@ 
@    Rz {EODWC_BgAo_og_WO{C@b  T  =   I ? A  T	@?  T  	R? Ti )I)	I)I)!I)AI)I9   T  @    z 
 @h @    R {EODWC_BgAo_og_WO{C@b  T  7     A  T	@?  T  	R? Ti )I)	I)I)!I)AI)I9   T  @     
 @     R@i58 {EODWC_BgAo_og_WO{C@b  T  H   I ? ` TA T	@? T(  c   AT	R? Ti )I)	I)I)!I)AI)I9   TF  @ 8  7 x y
 w@ / h@ '   R{ {EODWC_BgAo_O{C @	  T  {AO_ J _4	 @ !

   Rh@h {AO__WO{  U@ U| @(@%  T H	HH!HAHH  ` ` w
 @R 	? T   ( R	R?BTI )I)	I)I)!I)AI)I7  4  ` w
 h@@  @ @w&@6v @H  T@? T   `wZ@@H T	R? T H	HH!HAHH  T   w x
 v@@@   R@i@(h {COBWA__  {COBWA__   w  R{COBWA___WO{  u@ u| H@%  T H	HH!HAHH `   ` x
 R 	? T   ( R	R?BT )I)	I)I)!I)AI)I8  4E  ` x
 h@  @ w"@v @H  T@? T  9 wZ@@H T	R? T H	HH!HAHH  T#   w x
 v@@@   R@i@(h {COBWA__  {COBWA__   w  R{COBWA__g_WO{ v@ v| @H %  T H	HH!HAHH    ` x
 @R 	? T   ( R	R?BTI )I)	I)I)!I)AI)I8  4  ` x
 h@@  @ @x&@7w  T@? T   x^@T	R?b T H	HH!HAHH  T    x y
 w@    Rh@h {DOCWB_Ag_  {DOCWB_Ag_x  w X  R{DOCWB_Ag_g_WO{ @ | h %  T H	HH!HAHH R 
 ` y
 R 	? T   ( R	R?BT )I)	I)I)!I)AI)I9  47  ` y
 h@  2 x"@w  T@? T  , x^@T	R?b T H	HH!HAHH  T    x y
 w@    Rh@h {DOCWB_Ag_  {DOCWB_Ag_   X  R{DOCWB_Ag__WO{  U@ U| @H  )  THB	HH!HAHH  
 ` w
 @R 	? T   ( R	R?BTI )I)	I)I)!I)AI)I7  4  ` w
 h@@  @ @w&@6v   T@? T   wZ@ T	R?B TV	HH!HAHH   T  ` w x
 v@  Rj68h@ h {COBWA__  {COBWA__s  r   R{COBWA___WO{  u@ u| (  )  TV	HH!HAHH Q @
 ` x
 R 	? T   ( R	R?BT )I)	I)I)!I)AI)I8  46  ` x
 h@  1 w"@v   T@? T  + wZ@ T	R?B TV	HH!HAHH   T  ` w x
 v@  Rj68h@ h {COBWA__  {COBWA__     R{COBWA___WO{  w@ w| @H %  T H	HH!HAHH    
 @R 	 ?  T "  ( R	R?bTI )I)	I)I)!I)AI)I8  4       {COBWA__    
 @@@ @@(   R{COBWA__g_WO{ @ | ( %  T H	HH!HAHH z   
 R 	 ?  T "  ( R	R?bT )I)	I)I)!I)AI)I9  4_       {DOCWB_Ag_[  `  
 @ L @ F  R{DOCWB_Ag_O{C   @!$@	1!ZC   q`{AO_O{C ? "03!Z4   q`{AO_O{C  _   T#  "@1!Z   q{AO_WO{     T  2!Z   q{BOAW_	 @
 D J
1 

_?  d H( 	1  		__WO{  @	 D I1`@ `| &  T H	HH!HAHH   ` v
 @   Ru {COBWA__  {COBWA__g_WO{ ?  d H( 1A  T	@?  T  	R?B T )I)	I)I)!I)AI)I7  T   v w
 ~   Ru {DOCWB_Ag_q  b@p x  {DOCWB_Ag_@	 T	 @*ia8_k  T! aT _?   Thb8k  TB ? aT _@?   Th  T
    @	i`8?k  T   iT  __   T? h  T	  " 	hh8?k  T iT _
  	 R
A _  T l-@k T
h8 7 ? TE  J  L	q T	 h Tk@9kJqD	@z TcT4  Lq T  Tl@9q Tk	@9kq TJS3K_ qd!IzAT  
_CT  Lq T h Tl@9q Tm	@9qa Tk@9kq  TMSkK	3jADQ_D1T  R_  R_ ?   T TH  I T
 R	 	) 	l%@x
* 8) TI= ?qh  T _  _  o)z oH 	
 K 	 o o o o o oQA~SIUQ@N NENWYAfNNNNN0NqNNNpE?rMJTNNN@N`NN N@ n 
<<<
j
*J*<J*?T   R	 RR   8 "
 T i  T@y  @	  T= q)Tk` To 5}S2 9R 3 9	  T 8  T	@9 9@9	 9@9 9   T	@y= )
}S12 9RE3 9R.3	 9R 3 9 	 R=3 9R-3 9R 3	 9 _  _a  
 R R  . R-E  Txhx
kT= qh T  T@yra T)A@N R-E CT( B_  __  ?    T	      _?@   T 	 ]   o( R NO)|O	 o  o o o o o oS<t6!Noo o N / N/ o N/o: oZ N / N9 /9 N/ o{ N / NNN1NRNNNNcNs6"nt// / N o No / Nsox/ /9 N o N o Nsoz /Z Ns os NcNNNNRN1NNNA TN!N NNN!N N ^ f?` T6	)} o oN 
J	+ RaN o o@4 /o2 oR!N1 /1!N/ os!N /!NNcNNN4".// /1!N o!No /R!N o!NNNcNNJ! TNaN N ^ f?` T* 		 	,@8,kqJ AT_  ?@   T	  D    _  oao( RN)| o 	 o o o o o oMR6nT /"NR oR"Ns6nYw /"Ns os"N6n /"N o"N6n /9"N o"NcX nCn X nnX nfnX nn1Z nnX nnZ nnX n'nJA !TNN!NNNN N ^ f?@ T* 			+@y q ) J AT_A  	 R
R  b Txkxl 	k!T R T	k! T@y
k  Tl	 ( R_  R_a +m#m?   T TH  i T
 R	 + 			,E@
* 8k T_q#Am+lh  T _  _  o)z oH 	 o
  oK  o o,  %= o	 o o o o o o o o oZ|Y<I~\}aNBN NN9cN[@GNK2NNuNaNIB]ANeNPNNZcNK=QN4NNwNaNyy?zmJTBNNNNN NcNNNNN!N NAN N@ n 
< &j
*?aT	 	   
 8) ? T+	 
	i  TJ@  J@_a` T_qIT_q TK}Sk2 9RK 3 9	 ) ?CT/  K}Sk 5K}Sm q TK}Sk	2 9RK-3 9RK 3	 9 ) ?T  
 9		)@	 9	 T  A qh TK}Sk2 9RKE3 9RK-3	 9RK 3 9 ) ?cT _  _A R    ! ` T @l}S  5l}Sm q  T+% xA q TlL)LRm% 3, y- y) ( A_  __  ?    T	      _?   T 	 n    oO( RN){ o@  o	 o o o o o o o o o o o o o<Z7!N[/Zo\o o$NsN}oZ/ /$NN\ o$NN o$N1N<{/Z /Z$NBNz /Z$N{ o{$N /$N7!NcN/oNo Nz oZ$N9No/{ /{$NN o{$NN[ o{$NN /{$NRN/Z /Z$NNz oZ$NNz /Z$NNJ TN$NNNNN NBN NbN NN!NAN N ^ f?  T?} T	)}  o oN 
J	+ RcN o o@4"// /#N o#No /1#N o#NNN N!NJ! T!N N N ^ f?  T* 		 	+81J T_  ?   T	  u    _  oO( RN){O  o	 o o o o o o o o o o o o o oq}!N!Ncn[ n/o o"NN /"N o"N /"N{cn{[ nN|oN o"N NNy!N{/ /"NRN| /"N{ o{"Ncn[ nsNoN| o"NN!N/{ /{"N9N /{"N o"Ncn[ nNoN o{"NZN/ /"NN| o"NN{ /{"N1NJ !TaNNNCN#NNNNNBN NN N!N N ^ f?@ T
	) 	RL%@xk) aT_A  @	Q}SA q R$Hz  T  R_  R_+ R?   TxjQK 	kHzT_7_  9 |(   = =`  _  @a  @  T _ @_ @ @?!1_$D) @_	I1?(1`!_D) ) Q@_	I1?(1`!_$E)@_	I1?(1`!_,@ 	4@@_	I1?(1`!_F)) Q@_	I1?(1`!_$G)) Q@_	I1?(1`!_<@
@?(1@!_WO{  _   TY  {BOAW  Cog_	W
O{ cA  @A _  T(@+   T"  R+  T H	HH!HAHH _  T!  +@@    @ +@ 3 '   C C(  5 R  C)  )I'(ih8
 * RI!?jI R5 T  T#@iw8 QQ q  TR QQ qHT+  k"Ijyhx)	
  q/@	*3 6 q T*) R(!		 	 TRk  T@~ 4rq} T@3@H  4! q@E D@7 @+  C*  J'Hih8
 %@( 7  viw8CHih8
 %H 6 TRCHih8
 %7 q. T "H cC T#@I@9?qAg T  T A Th@9q TH	@9q T   R @@(@9(1 7(@ q T@_@y T(@@i 	Cy Tq  qA T  T#@@9 qA T@_@ T(@@i
 	C T!   Rm@ q& T@`J T(@I 	cJ T #@@- 4@ q! T@H 4@ k T(@I 	#k T- 	@- 45R qTrq`Tl  q! T ! T#@@9 q  T@_TR@i
 	" Th H	HH!HAHH _ T&  D   rq*RIRI   Qu q4 T+  kY#  jyhx)	
 3@ '@I	
	u7(3 uR Q % q TEh 7@@_
RI?e Th[	HH!HAHH _b T  Db  @+ R q`Trq T@J6 H@ q5 TH%E)J	@_	I1?51:@ T(@@*@I	 T R q TrqT@J3 H@ q2 TH%E)J	@_	I1?51:@@ T(@@6@@I	C T:  Q q T) R(!) 	 	@	 T E?  T @9	C*  JI'Iii8	 (%+ 6@9q`  T q+ T@#)7 UR@ 4 rqJRI qU q TRk  T@rq	@z  T q`  T qA TE* _  T-  )#  yjxk	`
@9_ q T q T@h  4rq` T@_ ST(@
 Rk T q@G T q` T !  !H%. D@6
 Rk`  T q T@_ T(@@i 	 T 3@[@E@ q DZ7/ @#)3 R: 5R7u R 4)/  UR7 . q T*) R(!		 	 TRk  T@V4rqVT3@  R/@KR*@8*V Q T~SU5@ Q q T)  )9(hka T F  qaST@"@
@?:1@  T(@@@i	  TY @+ ! /   "@
@?:1@`- T(@@@i	c- T  qa  TUR@-E)	@1
2
) T@ 	\ 4
@  q T q T q@ Ta	 Rk@TEh 7@@_
RI?B Th[	HH!HAHH _ T   Eh 7@@_
RI?j Th[	HH!HAHH _g T  Dg ,
 @h ; _`- T(@i 	i Tj 	  T#@I@9?qA Ti@9?q T	 	T a TH	@9q T  U R RkT@h  4rq@TEh 7@@_
RI? Th[	HH!HAHH _` TW   R@i 	! ThS	HH!HAHH _  TD  D` 	 @+ @ q+@
 D@:7@/ 3 7 5R6/ 7  @/ 7  @_D T(@@i 	D T[  5@(%D) 	k T!  !;B RD57@)/  RI 	B) TH H	HH!HAHH & T  D& 	  q TRkaT5RR@@i	* T( H	HH!HAHH  ( T  D@( x	 3@'@h 6 /@7@@_
RI? T H	HH!HAHH _  T  
 
@9_ q!W TF)) Q@	3_I1_ TK	I	l J
M @9 q@ TJ  _IT 
@9_ qS T
@9_ qS T
	@9Jy_q@T 
@9_ q@Q T_ qAR T
@9_ qQ T
	@9_ qQ T
@9  
@9_ qP T
@9_ qP T
	@9Jy_qP T
@9_ qO T
@9_ qAO T
@9Jy_qTu R@@i	3 T( H	HH!HAHH 0 Th  D 1   T?qTi@9?qv TI	@9?qav TI@9?qv T @T u TH@9q@T D  C DZ 5 3@RHk38@  	@? q)  )%*  JI&B; E+@Q D73 @h ?  q! T@_ T(@i 	 T R'Ri 	; Th[	HH!HAHH _@9 T  D9  Ri 	; Th[	HH!HAHH _8 T  D8  RI 	: TH H	HH!HAHH  8 T  D`8  nq  Tvq! T/     DZ/ 7 3@Vk;83@ 3 R   D; 3 @Rhk:x@	  ' URR@i 	"U Th H	HH!HAHH _R T  DR @    D 5 3@@ @ @ @N =  T(@I 	'@  T"  RI 	'@ THZ	HH!HAHH   Tu  D@  f  e D  3 @@HRhk:8@  7 F)J Q@
j1_	V1Z T)@J?
 THH	HH!HAHH  TD  D   	RJ?
T  /  . D  3 <@	`$ h@h @)G)J Q	@
s1	u2		 T@+@R@7b@; +@ 6  ; +@aRD 7@ R@i 	"G ThS	HH!HAHH _D T  DD  @_f T(@@i
 	f T    D<  5 3@@ @ @ #   T(@I 	D  T"  RI 	D THZ	HH!HAHH   T  D@ N    D  3 @@HRhk:8@  @ q iT 4rqA T@_ T(@@i
 	 Ts &E)
@_	[1l3 T@_( T(@@@i
 	 ( T &D) @	k T@`] T(@I 	c] T) R@i
 	) Th H	HH!HAHH _ ' Ta  D`'  R  Q D / 7 3@Vk;83@ 3 RQA  @ D  3 @hRHk;8  3  2 D:  3 @hRHk;8@  R1!    D  3 @Rhk:x@	  '  R c!  !$ DO6 
@9_ q T
	@9Jy_q  T
@9_ q T
@_ q T
F)k Q@1
 B T	@9*C+  kI'jij8)	 I%	 6	@9?q`  T? qa  TIR	 9@@_  T(@i 	  T   Ri 	 Th[	HH!HAHH _  T  D@ k    Dz  3 @RHk;8@  @_  T)@3@J ?
  T#  	R3@J ?
 TH H	HH!HAHH _  T  D@ <    D  3 ;@3@@/@ 3@'@	@: 3  q T q+@> TH ; @  T(@I 	  T   RI 	 THZ	HH!HAHH   Tm  D@  ^  ] D  3 @hRhk:8@  ? R[K  J D:  5 @RHk3x@	  ' 5RGR@@i
 	 9 Th H	HH!HAHH _6 T.   !    D  5 @RHk3x@	  '  R   D  5 @,RrHk3@   R	 # _  T)@
 ?
  T!  	R
 ?
 T H	HH!HAHH _  T  D@     D  3 @HR		 9IR	 y@  '  R   D  5 @HRHk38@  cD 73 3 @7  5Rh@9q TH	@9q! TH@9q  T  R( R     R( R   "H@@ T(@	 T( H	HH!HAHH  T  D  ! R	T  u  t D{  3 <@	`#@j h@| @H 4  T	 +@@Kii8k2Ki)8) 	AT@  @  TI@9?qA T  ( T , TH@9q+ TH@9qA+ T RY @  Q# +@@* 4_' T(@ 	' Tv +@ @ T	 A( TI@9?q' TI@9?q' T	  T ' TH@9q& TU R4  #T?qTI@9?q% TI@9?q!% TI@9?q$ T  T A$ TH@9q# TR@*@I	+ T ( H	HH!HAHH  ( T  B R@6@@I	B/ T( H	HH!HAHH , T  f ( R/ Eh 7@@_
RI?@ Th[	HH!HAHH _ > T      D / 7 3@Vk;83@ 3 RR@i
 	R Th H	HH!HAHH _O T  ~ _   T@ q@	@`	C T\  q  T@  4rq  T3 UR_z T(@ RI 	h TH H	HH!HAHH `e T}  , p  o D  5 @@@RHk3x@	  *D)) 
@
j1B	) T@	+@~7@' @HD) ) QJ	@_	S1u2 T@@AR	+@`|7bA+@{7RD {7@@  ' b+ Dy7@/ @-@ 5@	@_	S1u2i\ T@AR+@@w7bA'@v7@1@3 @ H@9q TH@9q TH@9qA T R  Q# _TR 	 T H	HH!HAHH _ T  (   R  Q# U 4@  @ka  T RRB T#@@9 q  T'  R@9 2 9)/ 7 uR   Dl  3 @RHk<x@	  ' R   D;j  3 <@@A` @ / 7 @hF)) Qk@_	I1?51: T(@I	 T ( H	HH!HAHH   T  q  RI	T'@r  y  x Db  3 ;@o @ / 7 2		 Dc T#@I	*@9KC  I'ik8J	 j%* 6*@9_ q T	  ? T(	@9 Q q T) R(!) 	 	@	= T@HF)) QJ	@_	J1_I1H		 C< T@J@A	) R*hi8_ q  T) 	aT ? : T	1_  (I 	?	 9 T	@9*C  kI'jij8)	 I%8 6@9 qA8 TD76    D{V  3 <@	@a`	 h@h R	k T q`B T q@ T2#@ 	 3 67@  @)G)J Q	@
s1	u2	2 T@+@RP7b@; _DO7R
  
 DzN / 7 3@Vk;83@ 3 
  
 DzL / 7 3@Vk;83@ 3 UR
  
 zJ / 7 3@@ 
 #ER	 y	R		 93@ 3 '@  
    !H$y D@G7   T/@ iu8 qT+@H7@' _  T(@i 	  T   Ri 	 Th[	HH!HAHH _  T}
  D@  n
  m
 DA  3 @HRHk;8@  ( R+  !T@+@H  7' @_  T(@i 	  T  Ri 	B Th[	HH!HAHH _  TH
    ;
  :
 D:;  3 @RHk;8@  3 UR( R' 6  u R"
  !
 D8  ; @RHk3x@	  @L@I)D)) 
1	1@	i T@@ T(@I	 C T-  )@
 T(@@I	
 Tq  RI	  T ( H	HH!HAHH   T	    	  	 D[/  3 :@@`	 @ ' @HD) ) QJ	@_	S1v2+@ T@:@AR+@`+7bA7+@*7Rv'@ *7@@+ @TR@I	 T( H	HH!HAHH   T	    	  	 D%  3 :@@@`	 @ / h.@ i6@j
@_	I1?D TAR6+@ "7@h-@ i5@k@_	I1?(1a"D  7@7  URf	 D UR` ; R+@[K	  J	 D;  3 @Rhk:x@	  )/ @7 F)) Q@_	I1?51<@  T(@	 T ( H	HH!HAHH  T%	  D@    R	CT  	  	 D@  3 :@	a`	 h@h R	k@ T q T q T ; +@aR'@ 7R+@@)G)J Q	@
s1	u2	 T@+@R7b@; VD 6s     URD ;  R+@R@i 	 ThS	HH!HAHH _@ T    R 	b T\	HH!HAHH _ T    u R   D:  5 @RHk38( R   DZ  3 @RHk<8( R+@9lC  I'il8k	 %|6)	@9? q!|T  5 R5 R2#@   B&  7 R/@@   T  /@ @ @  T6 {LOKWJ_IgHoGC_F)) Q
@_	J1_I1_ TK	@	l JM @9 q  TJ  _IT__ T@ q@	@`	C  TH _+@9lC  I'il8k	 %6)	@9? q`Tg_WO{  *HC(hh8	 %h 66@ A T
@_	 T;  6@ A  T@? TF  
R_	 T
 )I)	I)I)!I)AI)I7   T   ?  	R? TV	HH!HAHH  T   -       
 @HG3	  )I((
@y* y	@9(	 9h R       
 @j68( R  R)@(( {DOCWB_Ag_  {DOCWB_Ag_og_WO{	C   @@  @9mq T 	*@9_uqA T 
 Tl@9 qK T  Th@9 q T`	 ( R 	!K T   R 	 R 7     6 T  R.   T 	 R  	  R* R  kI8	@9Cnin8	@M!
@9Coio8	@N!
*	@9Coio8	@N!
@9Coio8*	@L!
* q*/ ,! T) T? b  T0   R R R@)
	
   J8_8@9@9	@9#CC%CFCjc8jd8je8jf81
   ! B q$1 $   $!  $B  * **k*  AT**h* 		  kI8,@8Cmim8	 % *J T r`  T $ @	  )@)@? T  BH%{IOHWG_FgEoD  	 R* R  k8@9Cnin8	@M!
@9Coio8	@N!
*	@9Coio8	@N!
@9Coio8*	@L!
* q)* ! T) T b  T0   R R R@

   8_8@9@9	@9#CC%CFCjc8jd8je8jf81
   ! B q$1 $   $!  $B  )* **k*  AT	*	*i	*   k8@8Cmim8	 % )*J T? r T  A   jz8 q  TZ aT&  T H	HH!HAHH a    ( R	 D#I T 9   RR	 D#IT )I)	I)I)!I)AI)I8 ( 6J   d _@C   T	@?  T 	R?4 T H	HH!HAHH `2 T/  2 (!    @   @ _ TR        @k78@  Z _B T@9 qS bU T @@i?TW	HH!HAHH @T  
 	@9*C  kI9jij8+	 J%j6	@9
C  kI9jij8	 J%j6
  JI4Zii8\ih8 @@i?B TW	HH!HAHH   T        8{   @k78@  z _T@ 	@jh8_ q  T 	iT  6i  T
     	 		 T	jj8 q  TJ _	iT
 I  !K	
5
` T
	 # T*@9_ q T*@9Jy_aqa TJ R	 
1  T)

* R  )   T+@9l Q ) q#Tk kQ qK!k d@ATvb@yB   T)@?# T/  *@9J Q_) qbT)  AT7  jh8? q  T aT 	 7'J*_ q	2k n   T@9 q T@8yaqV TL R	 m1 j T k  RR	 TR. R   J4 @9? q  T(jT    	`, T @9q Q1 ?* q Tq 1Q? q!1 $@  Tq@jq8 ? 	 T# @9b QB _( q# Td " RQ q T!   Ta@ja81 ? 	 T$ @9 QB _( qC T B RcQ q( T!  T@ja81 ? 	@ T# @9b QB _( q# Td b RQ qh T!   Ta@ja81 ? 	 R  " R  B R  b R! 7# @9`  q! T   	`T@y!x  ?" qT R R 	R? T H	HH!HAHH ` T  l       @  R@   R(S   BP;o  R |@o |S7uB v^@   T@  MR *@9 Q% qQ T.kiQ T/. k T? P T  C T?P T		d T 
	
ik8 q  Tk _aT l 7_'* qO_M1/M  `O T@9 qO T@8zbqX TH R	 1 cK T . 0  / J @v z
 x@& h@h  R@ H TE  Q-|. k T@9 Q) qTQ qTQ qF T]Q  qF TE 4  qE T-@"	T R
JROR = r  T@9? q= "
CzT 	T@91 Q?& qT-
  R  1  	 T@9! Q?$ q T"> _ kT41~1!!> ?q)T @ j`x1"j x 2=  q	T)> ? q  T	R?b* TW	HH!HAHH  ( T  A  R@ Qy)x R?(j	 T@K) ? q	 T
 
_@y
)L} Milx_ yKi,x?	 qK T)@+ Q}Milx[@y[ yNi,xj _	 q T+	 Q
L} MilxW@yW yNi,xk 	 q T+ Q}MilxS@yS yNi,xj _	 qK T+ Q
L} MilxO@yO yNi,xk 	 q T+ Q}MilxK@yK yNi,xj _	 q T(G@y Q} KihxG yIi(x   ! qT[@ C `  T@  	R?B TV	HH!HAHH   TJ    =  <   @ 	 RjRj68@J  R 
R  mK	k T !  Tyhx5 T @y/ 4  ?-k1
21  T	 	@y5 T @y5 T @yO5 @T @y5 T @y5  T@ym  4 h}
   R_ q) R5[}   F;     |X \ Y@HRk98@   Rs
 B @ Th  6jsx 4 T  !8;y7( Rs
 B AT2  jsx o  R |@o `w7: T@ T@@) 	 T( Rs
 B T  R@) 	T(Y	HH!HAHH @T  _@ `  T@  	R?" TW	HH!HAHH  T  G  R
u  t  v x
 w@Rj78h@ h (_S   BP;o  Rm |@o a 7v^@ `  T@  	R? TW	HH!HAHH @ TP  #  	R R* RJ!*h T)#9*@8  7 g  @ RRj78@  S  '  &  v x
 w@Rj78h@ h (?S   BP;o  R |@o `7v^@ `  T@  	R?" TW	HH!HAHH   T        v x
 w@Rj78h@ h (    BP;o  R |@o 6@  @  T @	  )@)@?! T{IOHWG_FgEoD_PR *@91 Q?& qT1kT}1  T T @ T(T!*_	 T )	Jik8 q  Tk _aT l 7_'* qO_M1/   T@9 q T@8zbq TH R	 1 cT .Y   Q|1  `T@9 Q?* qTQ? qTQ? qT^QR	R2PR *@91 Q?& q(T1kT}1  T  T  TT!*_i T ,H*ik8_ q  Tk aT 
 d!J
*H ` T-@9 q T-@8yaq!	 TH R_	 M1_ cT J4  @ Q|1  T@9 Q?* qTQ? qTQ? qT^QR	R  LR *-@9 Q% qT-kT}-) J T `AT	R Q|-) J T,@9 Q) qTQ qTQ qHT]QR?  T @9	C
  JI'Iii8	 (% 6@9 q  T?   T  R_  R_@9 Q) 	 	@)%)  q_og_WO{  a j|8	Cji8	 (%  7 T  A Tv^@xB  T	@? T:  wf@(xB   T	@? TE  	R? T H	HH!HAHH @ T    o  	R? T H	HH!HAHH @ T    \       
 v y
 w@~    Rh@h J  t   s  ; w z
 y@ #H(  T	@?  T  	R? T H	HH!HAHH   TX     w @h
 y@H  h@h B T@97 { !T  R	  3   2  W  {FOEWD_CgBoA_0  @ 0  @ 0  
@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  "@ 0  &@ 0  *@ 0  .@ 0  2@ 0  6@ 0  :@ 0  >@ 0  B@ 0  F@ 0  J@ 1  1bG  @ P      P     P  $   P  >   P  [   P  q   P     P     P     P     P     P    P  +  P  9  P  G  P  V  P  e  P  v  P          F z        " " ;Ww  i      6   x                       P         P         P                                   h                %00%01%02%03%04%05%06%07%08%09%0A%0B%0C%0D%0E%0F%10%11%12%13%14%15%16%17%18%19%1A%1B%1C%1D%1E%1F%20%21%22%23%24%25%26%27%28%29%2A%2B%2C%2D%2E%2F%30%31%32%33%34%35%36%37%38%39%3A%3B%3C%3D%3E%3F%40%41%42%43%44%45%46%47%48%49%4A%4B%4C%4D%4E%4F%50%51%52%53%54%55%56%57%58%59%5A%5B%5C%5D%5E%5F%60%61%62%63%64%65%66%67%68%69%6A%6B%6C%6D%6E%6F%70%71%72%73%74%75%76%77%78%79%7A%7B%7C%7D%7E%7F%80%81%82%83%84%85%86%87%88%89%8A%8B%8C%8D%8E%8F%90%91%92%93%94%95%96%97%98%99%9A%9B%9C%9D%9E%9F%A0%A1%A2%A3%A4%A5%A6%A7%A8%A9%AA%AB%AC%AD%AE%AF%B0%B1%B2%B3%B4%B5%B6%B7%B8%B9%BA%BB%BC%BD%BE%BF%C0%C1%C2%C3%C4%C5%C6%C7%C8%C9%CA%CB%CC%CD%CE%CF%D0%D1%D2%D3%D4%D5%D6%D7%D8%D9%DA%DB%DC%DD%DE%DF%E0%E1%E2%E3%E4%E5%E6%E7%E8%E9%EA%EB%EC%ED%EE%EF%F0%F1%F2%F3%F4%F5%F6%F7%F8%F9%FA%FB%FC%FD%FE%FF                                                 	       
                          
                                                                                                                                                         &  	   x                   )   x                                           P     P                 	
  $(,048<  F z        " " ;Ww  i      6   x                       P         P         P                                   h                %00%01%02%03%04%05%06%07%08%09%0A%0B%0C%0D%0E%0F%10%11%12%13%14%15%16%17%18%19%1A%1B%1C%1D%1E%1F%20%21%22%23%24%25%26%27%28%29%2A%2B%2C%2D%2E%2F%30%31%32%33%34%35%36%37%38%39%3A%3B%3C%3D%3E%3F%40%41%42%43%44%45%46%47%48%49%4A%4B%4C%4D%4E%4F%50%51%52%53%54%55%56%57%58%59%5A%5B%5C%5D%5E%5F%60%61%62%63%64%65%66%67%68%69%6A%6B%6C%6D%6E%6F%70%71%72%73%74%75%76%77%78%79%7A%7B%7C%7D%7E%7F%80%81%82%83%84%85%86%87%88%89%8A%8B%8C%8D%8E%8F%90%91%92%93%94%95%96%97%98%99%9A%9B%9C%9D%9E%9F%A0%A1%A2%A3%A4%A5%A6%A7%A8%A9%AA%AB%AC%AD%AE%AF%B0%B1%B2%B3%B4%B5%B6%B7%B8%B9%BA%BB%BC%BD%BE%BF%C0%C1%C2%C3%C4%C5%C6%C7%C8%C9%CA%CB%CC%CD%CE%CF%D0%D1%D2%D3%D4%D5%D6%D7%D8%D9%DA%DB%DC%DD%DE%DF%E0%E1%E2%E3%E4%E5%E6%E7%E8%E9%EA%EB%EC%ED%EE%EF%F0%F1%F2%F3%F4%F5%F6%F7%F8%F9%FA%FB%FC%FD%FE%FF                                                 	       
                          
                                                                                                                                                         &  	   x                   )   x                                           P     P        bare-url@2.3.1 parse canParse Invalid base URL Invalid URL // :// %40 :: %x %d           4       4                   4  X   X   p0     X                   ,             9 \:  H< V pW HZ i Tk k xn  o xp  q r  s t  hw x  y   l       P          d 4          #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             l1     x1     1     1     1     1     1     1     1     1     1     1     1     2     2      2     ,2     82     D2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             " `   @___stack_chk_guard Qq @dyld_stub_binder     r @___stack_chk_fail  r@_free  r>@_js_create_function  r>@_js_create_string_utf8  r >@_js_get_boolean  r(>@_js_get_callback_info  r0>@_js_get_typedarray_info  r8>@_js_get_value_bool  r@>@_js_get_value_string_utf8  rH>@_js_is_string  rP>@_js_set_named_property  rX>@_js_throw_error  r`@_malloc  rh@_memcpy  rp@_memmove  rx@_realloc  r@_snprintf  r@_strlen  r@_strncmp      _       i  i  get_module_name_v0 register_module_v0        16le C32 I8 O       16le d32 j8 p convert_to_utf Ulength_from_utf v         ost ref      ssword th    a ort        fragment h p query scheme username      destroy get_ init parse        32 8  latin1 utf        32 8  latin1 utf    convert_to_ validate  _length_from_ le_        16le 8  latin1 utf        16le 8  latin1 utf    convert_to_ length_from_ validate        16le 32  latin1 utf        16le 32  latin1 utf        character literal view  _      _literal        character literal view  _    mpare ncat py  lear o        mpty rase            character literal view  _  dex_of_character it sert          character literal view  _        character literal 	view 	 _ 	   place 	serve 	     _copy 	 hrink_to_fit 	ubstring 	   _literal 
       character 
literal 
view 
 _ 
   mpare 
ncat 
py 
       dex_of_character 
it 
     _copy  co 
empty 
in last_index_of_character substring  _  
append c destroy e in last_index_of_character prepend re 	s 	view    convert_to_ length_from_ string_ validate        be le      16 32  endianness is_ swap_uint  16 32_ 8_ _  rl_ tf  ascii_validate 	bare_ latin1_ u    ig5tlhl<<Xd($4,D@|h$(,$,((Lg5t     
    L5      
    8      $
    l:      0
    <n      C
    n      b
    p      s
          
          
          
         
         
    p         $-     ,    -     H    2     j    2         3         23         R3         r3         3     4    3     O    3     a    6     s    7         7         8         9         29     "    R9     F    r9     m    9         9         9         9         :         =         >     0    2>     U    R>     |  	                       4      +     4      D     P      _           x     t                                            h                                                ,    D      :          H    l      W          g          y    D                                                             t                '           9          R          l    P                              $                                              (          A          [          s                                                                                 3    l      Q    T      m    4                    D                               t          4                    (      7    D      S           l              H                              `                          0    0      M          g    \      |    4          L                              T                           1    d      T          u    T                                        @                (    t      D    \      e    X      t                                                                                                               	            "	            8	            P	            c	            }	            	            	            	            	            	            	            	            	            	            	                                                                                                                                      _ascii_validate _bare_get_module_name_v0 _bare_register_module_v0 _latin1_convert_to_utf16le _latin1_convert_to_utf32 _latin1_convert_to_utf8 _latin1_length_from_utf16le _latin1_length_from_utf32 _latin1_length_from_utf8 _url_destroy _url_get_fragment _url_get_host _url_get_href _url_get_password _url_get_path _url_get_port _url_get_query _url_get_scheme _url_get_username _url_init _url_parse _utf16_length_from_latin1 _utf16_length_from_utf32 _utf16_length_from_utf8 _utf16le_convert_to_latin1 _utf16le_convert_to_utf32 _utf16le_convert_to_utf8 _utf16le_validate _utf32_convert_to_latin1 _utf32_convert_to_utf16le _utf32_convert_to_utf8 _utf32_length_from_latin1 _utf32_length_from_utf16le _utf32_length_from_utf8 _utf32_validate _utf8_convert_to_latin1 _utf8_convert_to_utf16le _utf8_convert_to_utf32 _utf8_length_from_latin1 _utf8_length_from_utf16le _utf8_length_from_utf32 _utf8_string_append _utf8_string_append_character _utf8_string_append_literal _utf8_string_append_view _utf8_string_clear _utf8_string_compare _utf8_string_compare_literal _utf8_string_concat _utf8_string_concat_character _utf8_string_concat_literal _utf8_string_concat_view _utf8_string_copy _utf8_string_destroy _utf8_string_empty _utf8_string_erase _utf8_string_index_of_character _utf8_string_init _utf8_string_insert _utf8_string_insert_character _utf8_string_insert_literal _utf8_string_insert_view _utf8_string_last_index_of_character _utf8_string_prepend _utf8_string_prepend_character _utf8_string_prepend_literal _utf8_string_prepend_view _utf8_string_replace _utf8_string_replace_character _utf8_string_replace_literal _utf8_string_replace_view _utf8_string_reserve _utf8_string_shrink_to_fit _utf8_string_substring _utf8_string_substring_copy _utf8_string_view _utf8_string_view_compare _utf8_string_view_compare_literal _utf8_string_view_concat _utf8_string_view_concat_character _utf8_string_view_concat_literal _utf8_string_view_concat_view _utf8_string_view_copy _utf8_string_view_empty _utf8_string_view_index_of_character _utf8_string_view_init _utf8_string_view_last_index_of_character _utf8_string_view_substring _utf8_string_view_substring_copy _utf8_validate _utf_endianness _utf_is_be _utf_is_le _utf_swap_uint16 _utf_swap_uint32 ___stack_chk_fail ___stack_chk_guard _free _js_create_function _js_create_string_utf8 _js_get_boolean _js_get_callback_info _js_get_typedarray_info _js_get_value_bool _js_get_value_string_utf8 _js_is_string _js_set_named_property _js_throw_error _malloc _memcpy _memmove _realloc _snprintf _strlen _strncmp dyld_stub_binder _bare_url_parse _bare_url_can_parse _url__parse _url__shorten_path _url__percent_encode_character _url__parse_host _url__starts_with_windows_drive_letter _url__percent_encode_string _url__parse _url__shorten_path _url__percent_encode_character _url__parse_host _url__starts_with_windows_drive_letter _url__percent_encode_string _url__userinfo_percent_encode_set _url__path_percent_encode_set _url__c0_control_percent_encode_set _url__special_query_percent_encode_set _url__query_percent_encode_set _url__fragment_percent_encode_set _url__ascii_alpha_character_set _url__scheme_character_set _url__hex_encoded _url__hex_decoded _url__forbidden_host_character_set _url__forbidden_domain_character_set _url__ascii_alphanumeric_character_set _url__userinfo_percent_encode_set _url__path_percent_encode_set _url__c0_control_percent_encode_set _url__special_query_percent_encode_set _url__query_percent_encode_set _url__fragment_percent_encode_set _url__ascii_alpha_character_set _url__scheme_character_set _url__hex_encoded _url__hex_decoded _url__forbidden_host_character_set _url__forbidden_domain_character_set _url__ascii_alphanumeric_character_set __dyld_private        \            H       h   X                                                        bare-url@2.bare WPX5t Y]XofkOX||zH,XofkOX||zH,bllw(b-[sS6#;)dO!W#>DfN/&$0^28xRZj:-V ps8$(S#<QcN6ae:{=8x#F+c\-\Tu;ucWU3rb^5?SqJzyJAUi ,|-nk@6$ZD}-IA>;~!R;c
|"~J}/|I^l.gL\v6mCo?p}
;egRhh=+7YzN|jHR:onOHvql4:jlnQF7'Bt,JJIVxa4&zldp$n1 T[~XofkOX||zH,XofkOX||zH,XofkOX||zH,XofkOX||zH,Y!!DScd>!:E	4#)VXofkOX||zH,XofkOX||zH,XofkOX||zH,\)*!\8C+<5&V=6$aa%/a?p$n*f8io?yh{HxaauCC0X    const LE = exports.LE = (new Uint8Array(new Uint16Array([0xff]).buffer))[0] === 0xff

exports.BE = !LE
const b4a = require('b4a')

const { BE } = require('./endian')

exports.state = function (start = 0, end = 0, buffer = null) {
  return { start, end, buffer, cache: null }
}

const raw = exports.raw = require('./raw')

const uint = exports.uint = {
  preencode (state, n) {
    state.end += n <= 0xfc ? 1 : n <= 0xffff ? 3 : n <= 0xffffffff ? 5 : 9
  },
  encode (state, n) {
    if (n <= 0xfc) uint8.encode(state, n)
    else if (n <= 0xffff) {
      state.buffer[state.start++] = 0xfd
      uint16.encode(state, n)
    } else if (n <= 0xffffffff) {
      state.buffer[state.start++] = 0xfe
      uint32.encode(state, n)
    } else {
      state.buffer[state.start++] = 0xff
      uint64.encode(state, n)
    }
  },
  decode (state) {
    const a = uint8.decode(state)
    if (a <= 0xfc) return a
    if (a === 0xfd) return uint16.decode(state)
    if (a === 0xfe) return uint32.decode(state)
    return uint64.decode(state)
  }
}

const uint8 = exports.uint8 = {
  preencode (state, n) {
    state.end += 1
  },
  encode (state, n) {
    validateUint(n)
    state.buffer[state.start++] = n
  },
  decode (state) {
    if (state.start >= state.end) throw new Error('Out of bounds')
    return state.buffer[state.start++]
  }
}

const uint16 = exports.uint16 = {
  preencode (state, n) {
    state.end += 2
  },
  encode (state, n) {
    validateUint(n)
    state.buffer[state.start++] = n
    state.buffer[state.start++] = n >>> 8
  },
  decode (state) {
    if (state.end - state.start < 2) throw new Error('Out of bounds')
    return (
      state.buffer[state.start++] +
      state.buffer[state.start++] * 0x100
    )
  }
}

const uint24 = exports.uint24 = {
  preencode (state, n) {
    state.end += 3
  },
  encode (state, n) {
    validateUint(n)
    state.buffer[state.start++] = n
    state.buffer[state.start++] = n >>> 8
    state.buffer[state.start++] = n >>> 16
  },
  decode (state) {
    if (state.end - state.start < 3) throw new Error('Out of bounds')
    return (
      state.buffer[state.start++] +
      state.buffer[state.start++] * 0x100 +
      state.buffer[state.start++] * 0x10000
    )
  }
}

const uint32 = exports.uint32 = {
  preencode (state, n) {
    state.end += 4
  },
  encode (state, n) {
    validateUint(n)
    state.buffer[state.start++] = n
    state.buffer[state.start++] = n >>> 8
    state.buffer[state.start++] = n >>> 16
    state.buffer[state.start++] = n >>> 24
  },
  decode (state) {
    if (state.end - state.start < 4) throw new Error('Out of bounds')
    return (
      state.buffer[state.start++] +
      state.buffer[state.start++] * 0x100 +
      state.buffer[state.start++] * 0x10000 +
      state.buffer[state.start++] * 0x1000000
    )
  }
}

const uint40 = exports.uint40 = {
  preencode (state, n) {
    state.end += 5
  },
  encode (state, n) {
    validateUint(n)
    const r = Math.floor(n / 0x100)
    uint8.encode(state, n)
    uint32.encode(state, r)
  },
  decode (state) {
    if (state.end - state.start < 5) throw new Error('Out of bounds')
    return uint8.decode(state) + 0x100 * uint32.decode(state)
  }
}

const uint48 = exports.uint48 = {
  preencode (state, n) {
    state.end += 6
  },
  encode (state, n) {
    validateUint(n)
    const r = Math.floor(n / 0x10000)
    uint16.encode(state, n)
    uint32.encode(state, r)
  },
  decode (state) {
    if (state.end - state.start < 6) throw new Error('Out of bounds')
    return uint16.decode(state) + 0x10000 * uint32.decode(state)
  }
}

const uint56 = exports.uint56 = {
  preencode (state, n) {
    state.end += 7
  },
  encode (state, n) {
    validateUint(n)
    const r = Math.floor(n / 0x1000000)
    uint24.encode(state, n)
    uint32.encode(state, r)
  },
  decode (state) {
    if (state.end - state.start < 7) throw new Error('Out of bounds')
    return uint24.decode(state) + 0x1000000 * uint32.decode(state)
  }
}

const uint64 = exports.uint64 = {
  preencode (state, n) {
    state.end += 8
  },
  encode (state, n) {
    validateUint(n)
    const r = Math.floor(n / 0x100000000)
    uint32.encode(state, n)
    uint32.encode(state, r)
  },
  decode (state) {
    if (state.end - state.start < 8) throw new Error('Out of bounds')
    return uint32.decode(state) + 0x100000000 * uint32.decode(state)
  }
}

const int = exports.int = zigZagInt(uint)
exports.int8 = zigZagInt(uint8)
exports.int16 = zigZagInt(uint16)
exports.int24 = zigZagInt(uint24)
exports.int32 = zigZagInt(uint32)
exports.int40 = zigZagInt(uint40)
exports.int48 = zigZagInt(uint48)
exports.int56 = zigZagInt(uint56)
exports.int64 = zigZagInt(uint64)

const biguint64 = exports.biguint64 = {
  preencode (state, n) {
    state.end += 8
  },
  encode (state, n) {
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 8)
    view.setBigUint64(0, n, true) // little endian
    state.start += 8
  },
  decode (state) {
    if (state.end - state.start < 8) throw new Error('Out of bounds')
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 8)
    const n = view.getBigUint64(0, true) // little endian
    state.start += 8
    return n
  }
}

exports.bigint64 = zigZagBigInt(biguint64)

const biguint = exports.biguint = {
  preencode (state, n) {
    let len = 0
    for (let m = n; m; m = m >> 64n) len++
    uint.preencode(state, len)
    state.end += 8 * len
  },
  encode (state, n) {
    let len = 0
    for (let m = n; m; m = m >> 64n) len++
    uint.encode(state, len)
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 8 * len)
    for (let m = n, i = 0; m; m = m >> 64n, i += 8) {
      view.setBigUint64(i, BigInt.asUintN(64, m), true) // little endian
    }
    state.start += 8 * len
  },
  decode (state) {
    const len = uint.decode(state)
    if (state.end - state.start < 8 * len) throw new Error('Out of bounds')
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 8 * len)
    let n = 0n
    for (let i = len - 1; i >= 0; i--) n = (n << 64n) + view.getBigUint64(i * 8, true) // little endian
    state.start += 8 * len
    return n
  }
}

exports.bigint = zigZagBigInt(biguint)

exports.lexint = require('./lexint')

exports.float32 = {
  preencode (state, n) {
    state.end += 4
  },
  encode (state, n) {
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 4)
    view.setFloat32(0, n, true) // little endian
    state.start += 4
  },
  decode (state) {
    if (state.end - state.start < 4) throw new Error('Out of bounds')
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 4)
    const float = view.getFloat32(0, true) // little endian
    state.start += 4
    return float
  }
}

exports.float64 = {
  preencode (state, n) {
    state.end += 8
  },
  encode (state, n) {
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 8)
    view.setFloat64(0, n, true) // little endian
    state.start += 8
  },
  decode (state) {
    if (state.end - state.start < 8) throw new Error('Out of bounds')
    const view = new DataView(state.buffer.buffer, state.start + state.buffer.byteOffset, 8)
    const float = view.getFloat64(0, true) // little endian
    state.start += 8
    return float
  }
}

const buffer = exports.buffer = {
  preencode (state, b) {
    if (b) uint8array.preencode(state, b)
    else state.end++
  },
  encode (state, b) {
    if (b) uint8array.encode(state, b)
    else state.buffer[state.start++] = 0
  },
  decode (state) {
    const len = uint.decode(state)
    if (len === 0) return null
    if (state.end - state.start < len) throw new Error('Out of bounds')
    return state.buffer.subarray(state.start, (state.start += len))
  }
}

exports.binary = {
  ...buffer,
  preencode (state, b) {
    if (typeof b === 'string') utf8.preencode(state, b)
    else buffer.preencode(state, b)
  },
  encode (state, b) {
    if (typeof b === 'string') utf8.encode(state, b)
    else buffer.encode(state, b)
  }
}

exports.arraybuffer = {
  preencode (state, b) {
    uint.preencode(state, b.byteLength)
    state.end += b.byteLength
  },
  encode (state, b) {
    uint.encode(state, b.byteLength)

    const view = new Uint8Array(b)

    state.buffer.set(view, state.start)
    state.start += b.byteLength
  },
  decode (state) {
    const len = uint.decode(state)

    const b = new ArrayBuffer(len)
    const view = new Uint8Array(b)

    view.set(state.buffer.subarray(state.start, state.start += len))

    return b
  }
}

function typedarray (TypedArray, swap) {
  const n = TypedArray.BYTES_PER_ELEMENT

  return {
    preencode (state, b) {
      uint.preencode(state, b.length)
      state.end += b.byteLength
    },
    encode (state, b) {
      uint.encode(state, b.length)

      const view = new Uint8Array(b.buffer, b.byteOffset, b.byteLength)

      if (BE && swap) swap(view)

      state.buffer.set(view, state.start)
      state.start += b.byteLength
    },
    decode (state) {
      const len = uint.decode(state)

      let b = state.buffer.subarray(state.start, state.start += len * n)
      if (b.byteLength !== len * n) throw new Error('Out of bounds')
      if ((b.byteOffset % n) !== 0) b = new Uint8Array(b)

      if (BE && swap) swap(b)

      return new TypedArray(b.buffer, b.byteOffset, b.byteLength / n)
    }
  }
}

const uint8array = exports.uint8array = typedarray(Uint8Array)
exports.uint16array = typedarray(Uint16Array, b4a.swap16)
exports.uint32array = typedarray(Uint32Array, b4a.swap32)

exports.int8array = typedarray(Int8Array)
exports.int16array = typedarray(Int16Array, b4a.swap16)
exports.int32array = typedarray(Int32Array, b4a.swap32)

exports.biguint64array = typedarray(BigUint64Array, b4a.swap64)
exports.bigint64array = typedarray(BigInt64Array, b4a.swap64)

exports.float32array = typedarray(Float32Array, b4a.swap32)
exports.float64array = typedarray(Float64Array, b4a.swap64)

function string (encoding) {
  return {
    preencode (state, s) {
      const len = b4a.byteLength(s, encoding)
      uint.preencode(state, len)
      state.end += len
    },
    encode (state, s) {
      const len = b4a.byteLength(s, encoding)
      uint.encode(state, len)
      b4a.write(state.buffer, s, state.start, encoding)
      state.start += len
    },
    decode (state) {
      const len = uint.decode(state)
      if (state.end - state.start < len) throw new Error('Out of bounds')
      return b4a.toString(state.buffer, encoding, state.start, (state.start += len))
    },
    fixed (n) {
      return {
        preencode (state) {
          state.end += n
        },
        encode (state, s) {
          b4a.write(state.buffer, s, state.start, n, encoding)
          state.start += n
        },
        decode (state) {
          if (state.end - state.start < n) throw new Error('Out of bounds')
          return b4a.toString(state.buffer, encoding, state.start, (state.start += n))
        }
      }
    }
  }
}

const utf8 = exports.string = exports.utf8 = string('utf-8')
exports.ascii = string('ascii')
exports.hex = string('hex')
exports.base64 = string('base64')
exports.ucs2 = exports.utf16le = string('utf16le')

exports.bool = {
  preencode (state, b) {
    state.end++
  },
  encode (state, b) {
    state.buffer[state.start++] = b ? 1 : 0
  },
  decode (state) {
    if (state.start >= state.end) throw Error('Out of bounds')
    return state.buffer[state.start++] === 1
  }
}

const fixed = exports.fixed = function fixed (n) {
  return {
    preencode (state, s) {
      if (s.byteLength !== n) throw new Error('Incorrect buffer size')
      state.end += n
    },
    encode (state, s) {
      state.buffer.set(s, state.start)
      state.start += n
    },
    decode (state) {
      if (state.end - state.start < n) throw new Error('Out of bounds')
      return state.buffer.subarray(state.start, (state.start += n))
    }
  }
}

exports.fixed32 = fixed(32)
exports.fixed64 = fixed(64)

exports.array = function array (enc) {
  return {
    preencode (state, list) {
      uint.preencode(state, list.length)
      for (let i = 0; i < list.length; i++) enc.preencode(state, list[i])
    },
    encode (state, list) {
      uint.encode(state, list.length)
      for (let i = 0; i < list.length; i++) enc.encode(state, list[i])
    },
    decode (state) {
      const len = uint.decode(state)
      if (len > 0x100000) throw new Error('Array is too big')
      const arr = new Array(len)
      for (let i = 0; i < len; i++) arr[i] = enc.decode(state)
      return arr
    }
  }
}

exports.frame = function frame (enc) {
  const dummy = exports.state()

  return {
    preencode (state, m) {
      const end = state.end
      enc.preencode(state, m)
      uint.preencode(state, state.end - end)
    },
    encode (state, m) {
      dummy.end = 0
      enc.preencode(dummy, m)
      uint.encode(state, dummy.end)
      enc.encode(state, m)
    },
    decode (state) {
      const end = state.end
      const len = uint.decode(state)
      state.end = state.start + len
      const m = enc.decode(state)
      state.start = state.end
      state.end = end
      return m
    }
  }
}

exports.date = {
  preencode (state, d) {
    int.preencode(state, d.getTime())
  },
  encode (state, d) {
    int.encode(state, d.getTime())
  },
  decode (state, d) {
    return new Date(int.decode(state))
  }
}

exports.json = {
  preencode (state, v) {
    utf8.preencode(state, JSON.stringify(v))
  },
  encode (state, v) {
    utf8.encode(state, JSON.stringify(v))
  },
  decode (state) {
    return JSON.parse(utf8.decode(state))
  }
}

exports.ndjson = {
  preencode (state, v) {
    utf8.preencode(state, JSON.stringify(v) + '\n')
  },
  encode (state, v) {
    utf8.encode(state, JSON.stringify(v) + '\n')
  },
  decode (state) {
    return JSON.parse(utf8.decode(state))
  }
}

// simple helper for when you want to just express nothing
exports.none = {
  preencode (state, n) {
    // do nothing
  },
  encode (state, n) {
    // do nothing
  },
  decode (state) {
    return null
  }
}

// "any" encoders here for helping just structure any object without schematising it

const anyArray = {
  preencode (state, arr) {
    uint.preencode(state, arr.length)
    for (let i = 0; i < arr.length; i++) {
      any.preencode(state, arr[i])
    }
  },
  encode (state, arr) {
    uint.encode(state, arr.length)
    for (let i = 0; i < arr.length; i++) {
      any.encode(state, arr[i])
    }
  },
  decode (state) {
    const arr = []
    let len = uint.decode(state)
    while (len-- > 0) {
      arr.push(any.decode(state))
    }
    return arr
  }
}

const anyObject = {
  preencode (state, o) {
    const keys = Object.keys(o)
    uint.preencode(state, keys.length)
    for (const key of keys) {
      utf8.preencode(state, key)
      any.preencode(state, o[key])
    }
  },
  encode (state, o) {
    const keys = Object.keys(o)
    uint.encode(state, keys.length)
    for (const key of keys) {
      utf8.encode(state, key)
      any.encode(state, o[key])
    }
  },
  decode (state) {
    let len = uint.decode(state)
    const o = {}
    while (len-- > 0) {
      const key = utf8.decode(state)
      o[key] = any.decode(state)
    }
    return o
  }
}

const anyTypes = [
  exports.none,
  exports.bool,
  exports.string,
  exports.buffer,
  exports.uint,
  exports.int,
  exports.float64,
  anyArray,
  anyObject,
  exports.date
]

const any = exports.any = {
  preencode (state, o) {
    const t = getType(o)
    uint.preencode(state, t)
    anyTypes[t].preencode(state, o)
  },
  encode (state, o) {
    const t = getType(o)
    uint.encode(state, t)
    anyTypes[t].encode(state, o)
  },
  decode (state) {
    const t = uint.decode(state)
    if (t >= anyTypes.length) throw new Error('Unknown type: ' + t)
    return anyTypes[t].decode(state)
  }
}

function getType (o) {
  if (o === null || o === undefined) return 0
  if (typeof o === 'boolean') return 1
  if (typeof o === 'string') return 2
  if (b4a.isBuffer(o)) return 3
  if (typeof o === 'number') {
    if (Number.isInteger(o)) return o >= 0 ? 4 : 5
    return 6
  }
  if (Array.isArray(o)) return 7
  if (o instanceof Date) return 9
  if (typeof o === 'object') return 8

  throw new Error('Unsupported type for ' + o)
}

exports.from = function from (enc) {
  if (typeof enc === 'string') return fromNamed(enc)
  if (enc.preencode) return enc
  if (enc.encodingLength) return fromAbstractEncoder(enc)
  return fromCodec(enc)
}

function fromNamed (enc) {
  switch (enc) {
    case 'ascii': return raw.ascii
    case 'utf-8':
    case 'utf8': return raw.utf8
    case 'hex': return raw.hex
    case 'base64': return raw.base64
    case 'utf16-le':
    case 'utf16le':
    case 'ucs-2':
    case 'ucs2': return raw.ucs2
    case 'ndjson': return raw.ndjson
    case 'json': return raw.json
    case 'binary':
    default: return raw.binary
  }
}

function fromCodec (enc) {
  let tmpM = null
  let tmpBuf = null

  return {
    preencode (state, m) {
      tmpM = m
      tmpBuf = enc.encode(m)
      state.end += tmpBuf.byteLength
    },
    encode (state, m) {
      raw.encode(state, m === tmpM ? tmpBuf : enc.encode(m))
      tmpM = tmpBuf = null
    },
    decode (state) {
      return enc.decode(raw.decode(state))
    }
  }
}

function fromAbstractEncoder (enc) {
  return {
    preencode (state, m) {
      state.end += enc.encodingLength(m)
    },
    encode (state, m) {
      enc.encode(m, state.buffer, state.start)
      state.start += enc.encode.bytes
    },
    decode (state) {
      const m = enc.decode(state.buffer, state.start, state.end)
      state.start += enc.decode.bytes
      return m
    }
  }
}

exports.encode = function encode (enc, m) {
  const state = exports.state()
  enc.preencode(state, m)
  state.buffer = b4a.allocUnsafe(state.end)
  enc.encode(state, m)
  return state.buffer
}

exports.decode = function decode (enc, buffer) {
  return enc.decode(exports.state(0, buffer.byteLength, buffer))
}

function zigZagInt (enc) {
  return {
    preencode (state, n) {
      enc.preencode(state, zigZagEncodeInt(n))
    },
    encode (state, n) {
      enc.encode(state, zigZagEncodeInt(n))
    },
    decode (state) {
      return zigZagDecodeInt(enc.decode(state))
    }
  }
}

function zigZagDecodeInt (n) {
  return n === 0 ? n : (n & 1) === 0 ? n / 2 : -(n + 1) / 2
}

function zigZagEncodeInt (n) {
  // 0, -1, 1, -2, 2, ...
  return n < 0 ? (2 * -n) - 1 : n === 0 ? 0 : 2 * n
}

function zigZagBigInt (enc) {
  return {
    preencode (state, n) {
      enc.preencode(state, zigZagEncodeBigInt(n))
    },
    encode (state, n) {
      enc.encode(state, zigZagEncodeBigInt(n))
    },
    decode (state) {
      return zigZagDecodeBigInt(enc.decode(state))
    }
  }
}

function zigZagDecodeBigInt (n) {
  return n === 0n ? n : (n & 1n) === 0n ? n / 2n : -(n + 1n) / 2n
}

function zigZagEncodeBigInt (n) {
  // 0, -1, 1, -2, 2, ...
  return n < 0n ? (2n * -n) - 1n : n === 0n ? 0n : 2n * n
}

function validateUint (n) {
  if ((n >= 0) === false /* Handles NaN as well */) throw new Error('uint must be positive')
}
module.exports = {
  preencode,
  encode,
  decode
}

function preencode (state, num) {
  if (num < 251) {
    state.end++
  } else if (num < 256) {
    state.end += 2
  } else if (num < 0x10000) {
    state.end += 3
  } else if (num < 0x1000000) {
    state.end += 4
  } else if (num < 0x100000000) {
    state.end += 5
  } else {
    state.end++
    const exp = Math.floor(Math.log(num) / Math.log(2)) - 32
    preencode(state, exp)
    state.end += 6
  }
}

function encode (state, num) {
  const max = 251
  const x = num - max

  if (num < max) {
    state.buffer[state.start++] = num
  } else if (num < 256) {
    state.buffer[state.start++] = max
    state.buffer[state.start++] = x
  } else if (num < 0x10000) {
    state.buffer[state.start++] = max + 1
    state.buffer[state.start++] = x >> 8 & 0xff
    state.buffer[state.start++] = x & 0xff
  } else if (num < 0x1000000) {
    state.buffer[state.start++] = max + 2
    state.buffer[state.start++] = x >> 16
    state.buffer[state.start++] = x >> 8 & 0xff
    state.buffer[state.start++] = x & 0xff
  } else if (num < 0x100000000) {
    state.buffer[state.start++] = max + 3
    state.buffer[state.start++] = x >> 24
    state.buffer[state.start++] = x >> 16 & 0xff
    state.buffer[state.start++] = x >> 8 & 0xff
    state.buffer[state.start++] = x & 0xff
  } else {
    // need to use Math here as bitwise ops are 32 bit
    const exp = Math.floor(Math.log(x) / Math.log(2)) - 32
    state.buffer[state.start++] = 0xff

    encode(state, exp)
    const rem = x / Math.pow(2, exp - 11)

    for (let i = 5; i >= 0; i--) {
      state.buffer[state.start++] = rem / Math.pow(2, 8 * i) & 0xff
    }
  }
}

function decode (state) {
  const max = 251

  if (state.end - state.start < 1) throw new Error('Out of bounds')

  const flag = state.buffer[state.start++]

  if (flag < max) return flag

  if (state.end - state.start < flag - max + 1) {
    throw new Error('Out of bounds.')
  }

  if (flag < 252) {
    return state.buffer[state.start++] +
      max
  }

  if (flag < 253) {
    return (state.buffer[state.start++] << 8) +
      state.buffer[state.start++] +
      max
  }

  if (flag < 254) {
    return (state.buffer[state.start++] << 16) +
      (state.buffer[state.start++] << 8) +
      state.buffer[state.start++] +
      max
  }

  // << 24 result may be interpreted as negative
  if (flag < 255) {
    return (state.buffer[state.start++] * 0x1000000) +
      (state.buffer[state.start++] << 16) +
      (state.buffer[state.start++] << 8) +
      state.buffer[state.start++] +
      max
  }

  const exp = decode(state)

  if (state.end - state.start < 6) throw new Error('Out of bounds')

  let rem = 0
  for (let i = 5; i >= 0; i--) {
    rem += state.buffer[state.start++] * Math.pow(2, 8 * i)
  }

  return (rem * Math.pow(2, exp - 11)) + max
}
{
  "name": "compact-encoding",
  "version": "2.16.1",
  "description": "A series of compact encoding schemes for building small and fast parsers and serializers",
  "main": "index.js",
  "dependencies": {
    "b4a": "^1.3.0"
  },
  "devDependencies": {
    "brittle": "^3.0.0",
    "standard": "^16.0.3"
  },
  "scripts": {
    "test": "standard && brittle test.js"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/compact-encoding/compact-encoding.git"
  },
  "author": "Mathias Buus (@mafintosh)",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/compact-encoding/compact-encoding/issues"
  },
  "homepage": "https://github.com/compact-encoding/compact-encoding"
}
const b4a = require('b4a')

const { BE } = require('./endian')

exports = module.exports = {
  preencode (state, b) {
    state.end += b.byteLength
  },
  encode (state, b) {
    state.buffer.set(b, state.start)
    state.start += b.byteLength
  },
  decode (state) {
    const b = state.buffer.subarray(state.start, state.end)
    state.start = state.end
    return b
  }
}

const buffer = exports.buffer = {
  preencode (state, b) {
    if (b) uint8array.preencode(state, b)
    else state.end++
  },
  encode (state, b) {
    if (b) uint8array.encode(state, b)
    else state.buffer[state.start++] = 0
  },
  decode (state) {
    const b = state.buffer.subarray(state.start)
    if (b.byteLength === 0) return null
    state.start = state.end
    return b
  }
}

exports.binary = {
  ...buffer,
  preencode (state, b) {
    if (typeof b === 'string') utf8.preencode(state, b)
    else buffer.preencode(state, b)
  },
  encode (state, b) {
    if (typeof b === 'string') utf8.encode(state, b)
    else buffer.encode(state, b)
  }
}

exports.arraybuffer = {
  preencode (state, b) {
    state.end += b.byteLength
  },
  encode (state, b) {
    const view = new Uint8Array(b)

    state.buffer.set(view, state.start)
    state.start += b.byteLength
  },
  decode (state) {
    const b = new ArrayBuffer(state.end - state.start)
    const view = new Uint8Array(b)

    view.set(state.buffer.subarray(state.start))

    state.start = state.end

    return b
  }
}

function typedarray (TypedArray, swap) {
  const n = TypedArray.BYTES_PER_ELEMENT

  return {
    preencode (state, b) {
      state.end += b.byteLength
    },
    encode (state, b) {
      const view = new Uint8Array(b.buffer, b.byteOffset, b.byteLength)

      if (BE && swap) swap(view)

      state.buffer.set(view, state.start)
      state.start += b.byteLength
    },
    decode (state) {
      let b = state.buffer.subarray(state.start)
      if ((b.byteOffset % n) !== 0) b = new Uint8Array(b)

      if (BE && swap) swap(b)

      state.start = state.end

      return new TypedArray(b.buffer, b.byteOffset, b.byteLength / n)
    }
  }
}

const uint8array = exports.uint8array = typedarray(Uint8Array)
exports.uint16array = typedarray(Uint16Array, b4a.swap16)
exports.uint32array = typedarray(Uint32Array, b4a.swap32)

exports.int8array = typedarray(Int8Array)
exports.int16array = typedarray(Int16Array, b4a.swap16)
exports.int32array = typedarray(Int32Array, b4a.swap32)

exports.biguint64array = typedarray(BigUint64Array, b4a.swap64)
exports.bigint64array = typedarray(BigInt64Array, b4a.swap64)

exports.float32array = typedarray(Float32Array, b4a.swap32)
exports.float64array = typedarray(Float64Array, b4a.swap64)

function string (encoding) {
  return {
    preencode (state, s) {
      state.end += b4a.byteLength(s, encoding)
    },
    encode (state, s) {
      state.start += b4a.write(state.buffer, s, state.start, encoding)
    },
    decode (state) {
      const s = b4a.toString(state.buffer, encoding, state.start)
      state.start = state.end
      return s
    }
  }
}

const utf8 = exports.string = exports.utf8 = string('utf-8')
exports.ascii = string('ascii')
exports.hex = string('hex')
exports.base64 = string('base64')
exports.ucs2 = exports.utf16le = string('utf16le')

exports.array = function array (enc) {
  return {
    preencode (state, list) {
      for (const value of list) enc.preencode(state, value)
    },
    encode (state, list) {
      for (const value of list) enc.encode(state, value)
    },
    decode (state) {
      const arr = []
      while (state.start < state.end) arr.push(enc.decode(state))
      return arr
    }
  }
}

exports.json = {
  preencode (state, v) {
    utf8.preencode(state, JSON.stringify(v))
  },
  encode (state, v) {
    utf8.encode(state, JSON.stringify(v))
  },
  decode (state) {
    return JSON.parse(utf8.decode(state))
  }
}

exports.ndjson = {
  preencode (state, v) {
    utf8.preencode(state, JSON.stringify(v) + '\n')
  },
  encode (state, v) {
    utf8.encode(state, JSON.stringify(v) + '\n')
  },
  decode (state) {
    return JSON.parse(utf8.decode(state))
  }
}
module.exports = class FixedFIFO {
  constructor (hwm) {
    if (!(hwm > 0) || ((hwm - 1) & hwm) !== 0) throw new Error('Max size for a FixedFIFO should be a power of two')
    this.buffer = new Array(hwm)
    this.mask = hwm - 1
    this.top = 0
    this.btm = 0
    this.next = null
  }

  clear () {
    this.top = this.btm = 0
    this.next = null
    this.buffer.fill(undefined)
  }

  push (data) {
    if (this.buffer[this.top] !== undefined) return false
    this.buffer[this.top] = data
    this.top = (this.top + 1) & this.mask
    return true
  }

  shift () {
    const last = this.buffer[this.btm]
    if (last === undefined) return undefined
    this.buffer[this.btm] = undefined
    this.btm = (this.btm + 1) & this.mask
    return last
  }

  peek () {
    return this.buffer[this.btm]
  }

  isEmpty () {
    return this.buffer[this.btm] === undefined
  }
}
const FixedFIFO = require('./fixed-size')

module.exports = class FastFIFO {
  constructor (hwm) {
    this.hwm = hwm || 16
    this.head = new FixedFIFO(this.hwm)
    this.tail = this.head
    this.length = 0
  }

  clear () {
    this.head = this.tail
    this.head.clear()
    this.length = 0
  }

  push (val) {
    this.length++
    if (!this.head.push(val)) {
      const prev = this.head
      this.head = prev.next = new FixedFIFO(2 * this.head.buffer.length)
      this.head.push(val)
    }
  }

  shift () {
    if (this.length !== 0) this.length--
    const val = this.tail.shift()
    if (val === undefined && this.tail.next) {
      const next = this.tail.next
      this.tail.next = null
      this.tail = next
      return this.tail.shift()
    }

    return val
  }

  peek () {
    const val = this.tail.peek()
    if (val === undefined && this.tail.next) return this.tail.next.peek()
    return val
  }

  isEmpty () {
    return this.length === 0
  }
}
{
  "name": "fast-fifo",
  "version": "1.3.2",
  "description": "A fast fifo implementation similar to the one powering nextTick in Node.js core",
  "main": "index.js",
  "files": [
    "./index.js",
    "./fixed-size.js"
  ],
  "dependencies": {},
  "devDependencies": {
    "standard": "^17.1.0",
    "brittle": "^3.3.2"
  },
  "scripts": {
    "test": "standard && brittle test.js"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/mafintosh/fast-fifo.git"
  },
  "author": "Mathias Buus (@mafintosh)",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/mafintosh/fast-fifo/issues"
  },
  "homepage": "https://github.com/mafintosh/fast-fifo"
}
const { Duplex, getStreamError } = require('streamx')
const b4a = require('b4a')

module.exports = class FramedStream extends Duplex {
  constructor (rawStream, { bits = 32 } = {}) {
    super({ mapWritable })

    if (bits !== 32 && bits !== 24 && bits !== 16 && bits !== 8) throw new Error('Frame bits is invalid')

    this.rawStream = rawStream
    this.frameBits = bits
    this.frameBytes = this.frameBits / 8
    this.maxMessageLength = 0xffffffff >>> (32 - this.frameBits)

    this._factor = 0
    this._missingBytes = 0
    this._message = null
    this._writeCallback = null
    this._ended = 2

    rawStream.on('data', this._ondata.bind(this))
    rawStream.on('end', this._onend.bind(this))
    rawStream.on('drain', this._ondrain.bind(this))
    rawStream.on('error', this._onerror.bind(this))
    rawStream.on('close', this._onclose.bind(this))
  }

  _predestroy () {
    this.rawStream.destroy(getStreamError(this))

    this._maybeContinue(new Error('Stream destroyed'))
  }

  _read (cb) {
    this.rawStream.resume() // restart state machine
    cb(null)
  }

  _write (data, cb) {
    const wrap = this._frame(data.byteLength)
    wrap.set(data, this.frameBytes)

    if (this.rawStream.write(wrap) === true) return cb(null)
    this._writeCallback = cb
  }

  _maybeContinue (err) {
    const cb = this._writeCallback
    this._writeCallback = null
    if (cb !== null) cb(err)
  }

  _frame (len) {
    if (len > this.maxMessageLength) throw new Error('Message length (' + len + ') is longer than max frame (' + this.maxMessageLength + ')')

    const wrap = b4a.allocUnsafe(len + this.frameBytes)

    for (let i = 0; i < this.frameBytes; i++) {
      wrap[i] = len
      len >>>= 8
    }

    return wrap
  }

  _onclose () {
    if (this._ended !== 0) this.destroy()
  }

  _ondrain () {
    this._maybeContinue(null)
  }

  _onerror (err) {
    this.destroy(err)
  }

  _ondata (data) {
    let read = 0

    while (read < data.byteLength && !this.destroying) {
      if (this._factor < this.frameBits) {
        const byte = data[read++]
        this._missingBytes += (1 << this._factor) * byte
        this._factor += 8

        if (this._factor === this.frameBits) {
          if (data.byteLength - read >= this._missingBytes) { // quick check if we can avoid a copy
            this._push(data.subarray(read, read += this._missingBytes))
          } else { // otherwise make a buffer to read into
            this._message = b4a.allocUnsafe(this._missingBytes)
          }
        }

        continue
      }

      const chunk = data.subarray(read, read += this._missingBytes)
      this._message.set(chunk, this._message.byteLength - this._missingBytes)

      if (read > data.byteLength) {
        this._missingBytes -= chunk.byteLength
        return
      }

      this._push(this._message)
    }
  }

  _push (message) {
    this._factor = 0
    this._missingBytes = 0
    this._message = null

    // pause state machine if our buffer is full
    if (this.push(message) === false) this.rawStream.pause()
  }

  _onend () {
    if (this._factor) {
      this.destroy(new Error('Stream interrupted'))
      return
    }

    this._ended--
    this.push(null)
  }

  _final (cb) {
    this._ended--
    this.rawStream.end()
    cb(null)
  }
}

function mapWritable (s) {
  return typeof s === 'string' ? b4a.from(s) : s
}
{
  "name": "framed-stream",
  "version": "1.0.1",
  "description": "Read/write stream messages prefixed 8, 16, 24 or 32 bit length",
  "main": "index.js",
  "scripts": {
    "test": "standard && brittle test.js --coverage",
    "lint": "standard"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/holepunchto/framed-stream.git"
  },
  "author": "",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/holepunchto/framed-stream/issues"
  },
  "homepage": "https://github.com/holepunchto/framed-stream",
  "dependencies": {
    "b4a": "^1.6.1",
    "streamx": "^2.13.0"
  },
  "devDependencies": {
    "brittle": "^3.1.1",
    "duplex-through": "^1.0.2",
    "standard": "^17.0.0"
  }
}
require.addon = require('require-addon')

module.exports = require.addon('.', __filename)
const { isWindows } = require('which-runtime')
const binding = require('./binding')

function onwork(err, result) {
  if (err) this.reject(err)
  else this.resolve(result)
}

exports.tryLock = function tryLock(fd, offset = 0, length = 0, opts = {}) {
  if (typeof offset === 'object') {
    opts = offset
    offset = 0
  }

  if (typeof length === 'object') {
    opts = length
    length = 0
  }

  if (typeof opts !== 'object') {
    opts = {}
  }

  try {
    binding.fs_ext_napi_try_lock(fd, offset, length, opts.shared ? 0 : 1)
  } catch (err) {
    if (err.code === 'EAGAIN') return false
    throw err
  }

  return true
}

exports.waitForLock = function waitForLock(
  fd,
  offset = 0,
  length = 0,
  opts = {}
) {
  if (typeof offset === 'object') {
    opts = offset
    offset = 0
  }

  if (typeof length === 'object') {
    opts = length
    length = 0
  }

  if (typeof opts !== 'object') {
    opts = {}
  }

  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_lock_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_wait_for_lock(
      req,
      fd,
      offset,
      length,
      opts.shared ? 0 : 1,
      ctx,
      onwork
    )
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.tryDowngradeLock = function tryDowngradeLock(
  fd,
  offset = 0,
  length = 0
) {
  try {
    binding.fs_ext_napi_try_downgrade_lock(fd, offset, length)
  } catch (err) {
    if (err.code === 'EAGAIN') return false
    throw err
  }

  return true
}

exports.waitForDowngradeLock = function downgradeLock(
  fd,
  offset = 0,
  length = 0
) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_lock_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_wait_for_downgrade_lock(
      req,
      fd,
      offset,
      length,
      ctx,
      onwork
    )
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.tryUpgradeLock = function tryUpgradeLock(fd, offset = 0, length = 0) {
  try {
    binding.fs_ext_napi_try_upgrade_lock(fd, offset, length)
  } catch (err) {
    if (err.code === 'EAGAIN') return false
    throw err
  }

  return true
}

exports.waitForUpgradeLock = function upgradeLock(fd, offset = 0, length = 0) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_lock_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_wait_for_upgrade_lock(
      req,
      fd,
      offset,
      length,
      ctx,
      onwork
    )
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.unlock = function unlock(fd, offset = 0, length = 0) {
  binding.fs_ext_napi_unlock(fd, offset, length)
}

exports.trim = function trim(fd, offset, length) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_trim_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_trim(req, fd, offset, length, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.sparse = function sparse(fd) {
  // Short circuit on everything but Windows
  if (!isWindows) return Promise.resolve()

  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_sparse_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_sparse(req, fd, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.swap = function swap(from, to) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_swap_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_swap(req, from, to, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.getAttr = function getAttr(fd, name) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_get_attr_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_get_attr(req, fd, name, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise.then((buffer) =>
    buffer === null ? null : Buffer.from(buffer)
  )
}

exports.setAttr = function setAttr(fd, name, value, encoding) {
  if (typeof value === 'string') value = Buffer.from(value, encoding)

  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_set_attr_t)
  const ctx = {
    req,
    value,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_set_attr(req, fd, name, value, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.removeAttr = function removeAttr(fd, name) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_remove_attr_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_remove_attr(req, fd, name, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}

exports.listAttrs = function listAttrs(fd) {
  const req = Buffer.alloc(binding.sizeof_fs_ext_napi_list_attrs_t)
  const ctx = {
    req,
    resolve: null,
    reject: null
  }

  const promise = new Promise((resolve, reject) => {
    ctx.resolve = resolve
    ctx.reject = reject
  })

  try {
    binding.fs_ext_napi_list_attrs(req, fd, ctx, onwork)
  } catch (err) {
    return Promise.reject(err)
  }

  return promise
}
{
  "name": "fs-native-extensions",
  "version": "1.4.2",
  "description": "Native file system extensions for advanced file operations",
  "main": "index.js",
  "files": [
    "index.js",
    "macros.h",
    "binding.c",
    "binding.js",
    "CMakeLists.txt",
    "include",
    "src",
    "prebuilds"
  ],
  "imports": {
    "child_process": {
      "bare": "bare-subprocess",
      "default": "child_process"
    },
    "fs": {
      "bare": "bare-fs",
      "default": "fs"
    },
    "fs/*": {
      "bare": "bare-fs/*",
      "default": "fs/*"
    },
    "path": {
      "bare": "bare-path",
      "default": "path"
    }
  },
  "addon": true,
  "scripts": {
    "test": "npm run lint && npm run test:bare && npm run test:node",
    "test:bare": "bare test.js",
    "test:node": "node test.js",
    "lint": "prettier . --check"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/fs-native-extensions.git"
  },
  "author": "Kasper Isager Dalsgar <kasper@funktionel.co>",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/fs-native-extensions/issues"
  },
  "homepage": "https://github.com/holepunchto/fs-native-extensions#readme",
  "dependencies": {
    "require-addon": "^1.1.0",
    "which-runtime": "^1.2.0"
  },
  "devDependencies": {
    "bare-fs": "^3.0.2",
    "bare-path": "^3.0.0",
    "bare-subprocess": "^4.0.1",
    "brittle": "^3.1.1",
    "cmake-bare": "^1.1.10",
    "cmake-napi": "^1.0.5",
    "minimist": "^1.2.6",
    "prettier": "^3.5.3",
    "prettier-config-standard": "^7.0.0",
    "test-tmp": "^1.2.1"
  }
}
            p           (  __TEXT                                                     __text          __TEXT          L:      Dh      L:                           __stubs         __TEXT                                               __stub_helper   __TEXT          0            0                           __cstring       __TEXT                                                   __const         __TEXT                L                                    __unwind_info   __TEXT                (                                         __DATA_CONST            @              @                  __got           __DATA_CONST                                   8                 __DATA                  @              @                   __la_symbol_ptr __DATA                                        :           __data          __DATA                                                     H   __LINKEDIT       @      @       @                             8             fs-native-extensions@1.bare     "  0    @    @ 0           8@ `  E p        hI    0S 0
     P             +   F   :                           hQ r                         ~Q1.{(2                      *                 8         xA   /usr/lib/libSystem.B.dylib      &      I `   )      hI           `] H                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              WO{ H  @@ R C c   F   	 q TH  !;"	@ z  4"  B S   	 qh
 TH  !;"	@O  !R g 5@3 5   	 qH TH  !;"	@ W  5  !R Q   5@#    	 qH TH  !;"	@ A   5  !R ; ` 5@ 	   	 q  TH  !;"	@  !R ) ` 4!  ! "  B    	 qT!R  ]I  )@)@? T  {FOEWD_@    4!  ! "  B  @ @)@ q( R  6     n WO{	C H  @@ R        	 q TH  !;"	@    4"  B  !R   5@  c    7@ Q q  TI  )!:(h@(!   4"  B!    	 q TH  !;"	@<    1(R  `5@S m   	 qH TH  !;"	@    5  !R  ` 5#@C W   	 q  TH  !;"	@  !R w ` 4!  ! "  B O   	 qIT!R h ]I  )@)@?! T  {IOHWG_'@3 U   5+@# P   4!  ! "  B O @] /@6 R" R1 3@@!" R+  1 @@@N  A)@ q   4 6 >  D   O{C H  @@\@    	 q  T(  !;"	@  !R  b@c    	 q  T(  !;"	@  !R  f@C    	 q T(  !;"	@  @`7    	 q T(  !;"	@8  !R  @6       	 q  T(  !;"	@  !R  @  #  k   	 q  T(  !;"	@  !R  @@ P   	 qT!R  A # R 6   	 qh T(  !;"	@  ( q  T:  !R  ( q T v @@	 1  T f d '  # 3   	 qh T(  !;"	@ j @ !R c @   	 q  T(  !;"	@  !R R @   	 q  T(  !;"	@  !R B f@   	 q  T(  !;"	@  !R 2 b@   	 q  T(  !;"	@  !R " ^I  )@)@?  T{EOD_ WO{ H  @@h R c       	 q T(  !;"	@   4"  B    	 qh
 T(  !;"	@O  !R  5@S    	 qH T(  !;"	@   5  !R    5@C    	 qH T(  !;"	@    5  !R  ` 5@3    	 q  T(  !;"	@  !R  ` 4!  ! "  B    	 qT!R  ]I  )@)@? T  {FOEWD_@ A)  6       WO{	C H  @@ R     /   	 q T(  !;"	@ c   4"  B  !R [  5@#      7@ Q q  T)  )!:(h@(! 0  4"  B!    	 q T(  !;"	@<    1(R / `5#@s    	 qH T(  !;"	@    5  !R  ` 5'@c    	 q  T(  !;"	@  !R  ` 4!  ! "  B    	 qIT!R  ]I  )@)@? T  {IOHWG_+@S    4!  ! "  B  @] /@" R 3@@!" R #  @@@  B)    6     9 WO{ H  @@h R c    j   	 q T(  !;"	@   4"  B w   	 qh
 T(  !;"	@O  !R  5@S Y   	 qH T(  !;"	@ {  5  !R u   5@C C   	 qH T(  !;"	@ e   5  !R _ ` 5@3 -   	 q  T(  !;"	@  !R M ` 4!  ! "  B %   	 qT!R > ]I  )@)@? T  {FOEWD_@H A)t  6 @  F  '  WO{	C H  @@ R        	 q T(  !;"	@    4"  B  !R   5@#      7@ Q q  T)  )!:(h@(!   4"  B!    	 q T(  !;"	@<    1(R  `5#@s    	 qH T(  !;"	@    5  !R  ` 5'@c    	 q  T(  !;"	@  !R  ` 4!  ! "  B    	 qIT!R  ]I  )@)@? T  {IOHWG_+@S    4!  ! "  B  @] /@" Rj 3@@!" Rd # j @@@  B)    6 z     WO{ H  @@h R c       	 q T(  !;"	@ A  4"  B    	 qh
 T(  !;"	@O  !R . 5@S    	 qH T(  !;"	@   5  !R    5@C    	 qH T(  !;"	@    5  !R  ` 5@3    	 q  T(  !;"	@  !R  ` 4!  ! "  B    	 qT!R  ])  )@)@? T  {FOEWD_@ A)9  6      D WO{	C (  @@ R     u   	 q T(  !;"	@    4"  B  !R   5@#     e 7@ Q q  T)  )!:(h@(! v  4"  B! d   	 q T(  !;"	@<    1(R u `5#@s C   	 qH T(  !;"	@ e   5  !R _ ` 5'@c -   	 q  T(  !;"	@  !R M ` 4!  ! "  B %   	 qIT!R > ])  )@)@? T  {IOHWG_+@S +   4!  ! "  B * @Y /@" R 3@@" R #  @@@*  B)  t 6   #   O{C (  @@X@    	 q  T(  !;"	@  !R  ^@c    	 q  T(  !;"	@  !R  b@C    	 q T(  !;"	@  @`7    	 q T(  !;"	@8  !R  @6    ^   	 q  T(  !;"	@  !R  @  #  J   	 q  T(  !;"	@  !R  @@ /   	 qT!R ~ A # R    	 qh T(  !;"	@ m ( q  T:  !R f ( q T U @@	 1  T E C '  #    	 qh T(  !;"	@ I @ !R B @   	 q  T(  !;"	@  !R 1 @   	 q  T(  !;"	@  !R ! b@   	 q  T(  !;"	@  !R  ^@   	 q  T(  !;"	@  !R  ^)  )@)@?  T{EOD_u WO{ (  @@ R        	 q T(  !;"	@    4"  B  !R   5@ c C    7@ Q q  T)  )!:(h@(!   4"  B!    	 q T(  !;"	@$    1(R  `5@3 t   	 qh T(  !;"	@    4!  ! "  B n   	 qIT!R  ])  )@)@? T  {GOFWE_!R w @5@Q @" R   	 q  T(  !;"	@  !R b #@@" R   	 q  T(  !;"	@  !R O     	 q  T(  !;"	@  !R ? @@@S    c@0 6 G  M  
   	 qTu O{C (  @@P@    	 q  T(  !;"	@  !R  V@c    	 q  T(  !;"	@  !R  Z@C    	 q T(  !;"	@  @`7    	 q T(  !;"	@8  !R  @6       	 q  T(  !;"	@  !R  @  #  o   	 q  T(  !;"	@  !R  @@ T   	 qT!R  A # R :   	 qh T(  !;"	@  ( q  T:  !R  ( q T z @@	 1  T j h '  # 7   	 qh T(  !;"	@ n @ !R g @   	 q  T(  !;"	@  !R V @   	 q  T(  !;"	@  !R F Z@   	 q  T(  !;"	@  !R 6 V@   	 q  T(  !;"	@  !R & ^)  )@)@?  T{EOD_ _WO	{
 (  @@ R       	 q T(  !;"	@    4"  BQ  !R   5#@       7#@ Q q  T)  )!:(h@(!   4"  B!3    1(R  5 '@     7  4"  B("    1(R  5@ #  '@c  7U  j78   4"  BT#    	 q  T(  !;"	@  !R  \)  )@)@?A
 T  {JOIWH_G_  1(R  @5@j(8 +@C   v   4"  B$  @ V  +@# g   4"  B% j @j(8@U /@" RK 3@@" RE  K @@  p `6 _  e   O{C (  @@T@    	 q  T(  !;"	@  !R ( Z@c    	 q  T(  !;"	@  !R  ^@C    	 q T(  !;"	@  @`7    	 q T(  !;"	@8  !R  @6       	 q  T(  !;"	@  !R  @  #     	 q  T(  !;"	@  !R  @@ q   	 qT!R  A # R W   	 qh T(  !;"	@  ( q  T:  !R  ( q T  @@	 1  T   '  # T   	 qh T(  !;"	@  @ !R  @;   	 q  T(  !;"	@  !R s @   	 q  T(  !;"	@  !R c B@ F@ ^@   	 q  T(  !;"	@  !R O Z@   	 q  T(  !;"	@  !R ? ^)  )@)@?  T{EOD_ WO{	C (  @@ R       	 q T(  !;"	@    4"  B  !R   5#@c      7@ Q q  T)  )!:(h@(!   4"  B!    	 q T(  !;"	@$    1(R  `5'@    	 qh T(  !;"	@    4!  ! "  B    	 qIT!R  ])  )@)@?a T  {IOHWG_!R  @5 +@c   }  7  4"  B`'  1(R  5@ |  +@C    4"  Bx(  @j(8@] /@" Rq 3@@!" Rk # q @@'@    P," @6      WO{ (  @@\@c +   	 q  T(  !;"	@  !R H b@C    	 q  T(  !;"	@  !R 7 f@#    	 qh T(  !;"	@ ( @ 7  !R ! @@61  T1       	 q T(  !;"	@3      	 qH T(  !;"	@   @1 T@ !     	 q(
 T(  !;"	@M  !R  @1aT !    	 q T!R7  !R  @       	 q  T(  !;"	@  !R  @@  h   	 q  T(  !;"	@  !R  " v   	 qT(  !;"	@    !R  @
@ @ C R 3   	 qh T(  !;"	@  ( q  T:  !R  ( q T s @@	 1  T c a '   0   	 qh T(  !;"	@ g @ !R ` @   	 q  T(  !;"	@  !R O @   	 q  T(  !;"	@  !R ? F@ f@   	 q  T(  !;"	@  !R - b@   	 q  T(  !;"	@  !R  ])  )@)@?  T{FOEWD_ W	O
{ (  @@ R+ Cc     	 q T(  !;"	@    4  B  !R   5/@ #   7@ Q q  T)  )!:(h#@(!#   4  B!    	 q T(  !;"	@$    1(R  `53@    	 qh T(  !;"	@    4  !   B    	 qIT!R  ])  )@)@?! T  {KOJWI_!R  @5 7@   Z  7r  4  B`'  1(R | 5@ Y  7@ j   4  Bx(  @j(8;@ c V   4  B) b '@] ?@" RE C@'@!" R? C E @@]  @'@?@^    ` 
 6 P  V   O{C (  @@\@    	 q  T(  !;"	@  !R  b@c    	 q  T(  !;"	@  !R  f@C    	 q T(  !;"	@  @`7    	 q T(  !;"	@8  !R  @6       	 q  T(  !;"	@  !R  @  #  }   	 q  T(  !;"	@  !R  @@ b   	 qT!R  A # R H   	 qh T(  !;"	@  ( q  T:  !R  ( q T  @@	 1  T x v '  # E   	 qh T(  !;"	@ | @ !R u @,   	 q  T(  !;"	@  !R d @   	 q  T(  !;"	@  !R T F@
 f@   	 q  T(  !;"	@  !R B b@
   	 q  T(  !;"	@  !R 2 ^)  )@)@?  T{EOD_
 WO{	C (  @@ R    
   	 q T(  !;"	@    4  B  !R   5#@c     
 7@ Q q  T)  )!:(h@(! 
  4  B! 
   	 q T(  !;"	@$    1(R 
 `5'@ 
   	 qh T(  !;"	@ 
   4  !   B 
   	 qIT!R 
 ])  )@)@?a T  {IOHWG_!R 
 @5 +@c   p
  7
  4  B`'  1(R 
 5@ o
  +@C 
   4  Bx( 
 @j(8@U /@" Rd
 3@@" R^
 # d
 @@'@
     -W @6 t
  z
  	 O{C (  @@T@  
   	 q  T(  !;"	@  !R =
 Z@c 
   	 q  T(  !;"	@  !R ,
 ^@C 	   	 qh T(  !;"	@ 
 @ 7  !R 
 @@61  T&
    	   	 qH T(  !;"	@   	   	 q T(  !;"	@#  !R 	 @
  #  	   	 q  T(  !;"	@  !R 	 @@ 	   	 qiT!R 	 A # R i	   	 qh T(  !;"	@ 	 ( q  T:  !R 	 ( q T 	 @@	 1  T 	 	 '  # f	   	 qh T(  !;"	@ 	 @ !R 	 @M	   	 q  T(  !;"	@  !R 	 @"	   	 q  T(  !;"	@  !R u	 F@	 ^@(	   	 q  T(  !;"	@  !R c	 Z@	   	 q  T(  !;"	@  !R S	 ^)  )@)@?  T{EOD_ WO{ (  @@ R        	 q T(  !;"	@ ,	   4  B  !R $	  5@ c C    7@ Q q  T	  )!:(h@(!   4  B!    	 q T  !;"	@$    1(R  `5@3    	 qh T  !;"	@    4  !   B    	 qIT!R  ])  )@)@? T  {GOFWE_!R  @5@Y @" Rp   	 q  T  !;"	@  !R  #@@" R]   	 q  T  !;"	@  !R   b   	 q  T  !;"	@  !R  @@@    c  6     \   	 qTu _WO{ (  @@ X@c <     #;	 q  T"	@  !R Y ^@C    	 q  T"	@  !R J b@#    	 qh T"	@ = @@7     	 q T"	@  !R , @ 6>       	 q T"	@E  !R  "    	 q T"	@    f  !R  5  	  "	@   
 Tzw     	 q  T"	@  !R  @@   	 q	T!R   !T6  !R  @       	 q  T"	@  !R  @@  g   	 q  T"	@  !R  " w   	 q  T"	@  !R  @ C R <   	 q( T"	@  ( q  T6  !R  ( q T ~ @@	 1  T n    =   	 q( T"	@ v @ -   	 q T"	@  !R g @AN   !R ^ @   	 q  T"	@  !R P b@   	 q  T"	@  !R B ^@   	 q  T"	@  !R 4 @)  )@)@?  T{GOFWE_D_  O{  # R   	 q T  !;"	@    4  B* !R   5@  B@,   	 q T  !;"	@    4  B, !R   5# R   	 q T  !;"	@    4  BL. !R   5@  B/   	 q  T  !;"	@  !R    4  B0 # Rr   	 q  T  !;"	@  !R    4  B1 @  B(3   	 q  T  !;"	@  !R    4  B3| # RF   	 q  T  !;"	@  !R    4  BL5g @  B6V   	 q  T  !;"	@  !R m   4  B7P # R   	 q  T  !;"	@  !R X   4  B8; @  B8:*   	 q  T  !;"	@  !R A   4  B:$ # R   	 q  T  !;"	@  !R ,   4  Bt< @  B=   	 q  T  !;"	@  !R    4  Bl> # R   	 q  T  !;"	@  !R     4  B0  @  B   	 q  T  !;"	@  !R    4  BL # R   	 q  T  !;"	@  !R    4  B( @  B   	 q  T  !;"	@  !R    4  B8 c0)#    ]   	 q  T  !;"	@  !R    4  B @  B	v   	 q  T  !;"	@  !R    4  B	p c3#    -   	 q  T  !;"	@  !R t   4  B`W @  BF   	 q  T  !;"	@  !R ]   4  Bt@ c #       	 q  T  !;"	@  !R D   4  B' @  B   	 q  T  !;"	@  !R -   4  Bh c#       	 q  T  !;"	@  !R    4  B4 @  B0   	 q  T  !;"	@  !R    4  B c&#       	 q  T  !;"	@  !R    4  B @  Bx   	 q  T  !;"	@  !R    4  B cp0#    m   	 q  T  !;"	@  !R    4  B @  B   	 q  T  !;"	@  !R    4  B c<#    =   	 q  T  !;"	@  !R    4  B  g @  Bt!V   	 q  T  !;"	@  !R m   4  B!P c@#       	 q  T  !;"	@  !R T   4  B,#7 @  B$&   	 q  T  !;"	@  !R =   4  B$  c0##       	 q  T  !;"	@  !R $   4  B0& @  B'   	 q  T  !;"	@  !R    4  B'  c #       	 q  T  !;"	@  !R    4  B\)  @  B*   	 q  T  !;"	@  !R    4  B+  cP#    }   	 q  T  !;"	@  !R    4  B`,  @  B-   	 q  T  !;"	@  !R    4  B8.  c#    M   	 q  T  !;"	@  !R    4  B/w  @  B81f   	 q  T  !;"	@  !R }   4  B1`  c  #       	 q  T  !;"	@  !R d   4  B3G  @  B46   	 q  T  !;"	@  !R M   4  B50  c>#       	 q  T  !;"	@  !R 4   4  B6  @  B,8   	 q  T  !;"	@  !R  ` 4  B8    	 q  T  !;"	@  !R 
 {BOA _{ =  1HzHzH {_" #%   B#&P !    c`$
 O{C  @`@aHc@5 ` {AO_  @P@b  @@ _{   1HzHzH {_" #( R(   B0&%P !    c`$ O{C  @`@aH  ` {AO_{    1HzHzH {_" #H R(   BP(%P !    c`$ O{C  @`@aH  ` {AO_  " #%L   B)!    cP* O{C  @`@aH  ` {AO_  @L@b  @@ _" #D !    B0+  c+ O{C  @`@  ` {AO_  @D@b  @@ _"$H !    B,  cP-y O{C  @`H ` {AO_  @H@b  @@ _" #  B@.?	!    c /` O{C  @`@aF@bB ` {AO_ {C   @ $==P@  @  ?@ {A _" #D  = $=%P !    B0  cp19 O{C  @`@aF@bB ` {AO_  @P@b  @@ _" #!    BP2  c 3 O{C  @`@aF@ ` {AO_  @H@b  @@ _" #L !    B3  c4 O{C  @`@a"bB ` {AO_O{C   @D@L@  @H@ ?{AOa # R	  # R  C R  C R    R_{ H   {_ q RI  1`  T{_2   @{ { H   {_ q( R6  1`  T{_   @{ { H   {_R%  1`  T{_   @{ Cog_WO{    1  T ` Tv2  R   t     @ Tsv T  #  aR   1 Ts   R   U     `  T  R      @f {POOWN_MgLoKC_{    " D RA  1`  T{_    @{N WO{     R R    1 T~@  ,    R R     R 1 T{BOAW_   @uq  T{BOAW_|    @{BOAW { H@ R R   1  T  R{_j    @{ {  R{     R 1`  T{_\   @uq  T{_U    @{  g_WO{    RT   1 T|@   `   RH   1! T6    @{DOCWB_Ag  @ v@         #T}      `        y@(    5k6" T  R{DOCWB_Ag_0  @ 0  @ 0  
@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  "@ 0  &@ 0  *@ 0  .@ 0  2@ 0  6@ 0  :@ 0  >@ 0  B@ 0  F@ 0  J@ 0  N@ 0  R@ 0  V@ 0  Z@ 0  ^@ 0  b@ 0  f@ 0  j@ 0  n@ 0  r@ 0  v@ 0  z@ 0  ~@ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 0  @ 1  1G  @ P      P     P  '   P  5   P  B   P  S   P  e   P  r   P  ~   P     P     P     P     P     P    P  5  P  L  P  g  P    P    P    P    P    P    P  6  P  N  P  b  P    P    P    P    P    P    P  /  P  F  P  U  P  d  P  t  P    P    P    P  ~  P  {  P  x5  P  uS  P  rt  P  o  P  l  P  i  P  f  P  c  P  `  P  ]  P  Z  P  W'  P  T;  napi_get_cb_info(env, info, &argc, argv, NULL, NULL) failed! EINVAL Expected unsigned number napi_get_buffer_info(env, argv[0], (void **) &req, &req_len) failed! napi_get_value_string_utf8(env, argv[1], NULL, 0, &from_path_size) failed! napi_get_value_string_utf8(env, argv[1], from_path, from_path_size + 1, &from_path_len) failed! napi_get_value_string_utf8(env, argv[2], NULL, 0, &to_path_size) failed! napi_get_value_string_utf8(env, argv[2], to_path, to_path_size + 1, &to_path_len) failed! napi_get_value_string_utf8(env, argv[2], NULL, 0, &name_size) failed! napi_get_value_string_utf8(env, argv[2], name, name_size + 1, &name_len) failed! napi_get_buffer_info(env, argv[3], (void **) &value, &value_len) failed! napi_create_uint32(env, sizeof(fs_ext_napi_lock_t), &fs_ext_napi_lock_t_sizeof) failed! sizeof_fs_ext_napi_lock_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_lock_t", fs_ext_napi_lock_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_trim_t), &fs_ext_napi_trim_t_sizeof) failed! sizeof_fs_ext_napi_trim_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_trim_t", fs_ext_napi_trim_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_sparse_t), &fs_ext_napi_sparse_t_sizeof) failed! sizeof_fs_ext_napi_sparse_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_sparse_t", fs_ext_napi_sparse_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_swap_t), &fs_ext_napi_swap_t_sizeof) failed! sizeof_fs_ext_napi_swap_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_swap_t", fs_ext_napi_swap_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_get_attr_t), &fs_ext_napi_get_attr_t_sizeof) failed! sizeof_fs_ext_napi_get_attr_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_get_attr_t", fs_ext_napi_get_attr_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_set_attr_t), &fs_ext_napi_set_attr_t_sizeof) failed! sizeof_fs_ext_napi_set_attr_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_set_attr_t", fs_ext_napi_set_attr_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_remove_attr_t), &fs_ext_napi_remove_attr_t_sizeof) failed! sizeof_fs_ext_napi_remove_attr_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_remove_attr_t", fs_ext_napi_remove_attr_t_sizeof) failed! napi_create_uint32(env, sizeof(fs_ext_napi_list_attrs_t), &fs_ext_napi_list_attrs_t_sizeof) failed! sizeof_fs_ext_napi_list_attrs_t napi_set_named_property(env, exports, "sizeof_" "fs_ext_napi_list_attrs_t", fs_ext_napi_list_attrs_t_sizeof) failed! napi_create_function(env, NULL, 0, fs_ext_napi_try_lock, NULL, &fs_ext_napi_try_lock_fn) failed! fs_ext_napi_try_lock napi_set_named_property(env, exports, "fs_ext_napi_try_lock", fs_ext_napi_try_lock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_wait_for_lock, NULL, &fs_ext_napi_wait_for_lock_fn) failed! fs_ext_napi_wait_for_lock napi_set_named_property(env, exports, "fs_ext_napi_wait_for_lock", fs_ext_napi_wait_for_lock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_try_downgrade_lock, NULL, &fs_ext_napi_try_downgrade_lock_fn) failed! fs_ext_napi_try_downgrade_lock napi_set_named_property(env, exports, "fs_ext_napi_try_downgrade_lock", fs_ext_napi_try_downgrade_lock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_wait_for_downgrade_lock, NULL, &fs_ext_napi_wait_for_downgrade_lock_fn) failed! fs_ext_napi_wait_for_downgrade_lock napi_set_named_property(env, exports, "fs_ext_napi_wait_for_downgrade_lock", fs_ext_napi_wait_for_downgrade_lock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_try_upgrade_lock, NULL, &fs_ext_napi_try_upgrade_lock_fn) failed! fs_ext_napi_try_upgrade_lock napi_set_named_property(env, exports, "fs_ext_napi_try_upgrade_lock", fs_ext_napi_try_upgrade_lock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_wait_for_upgrade_lock, NULL, &fs_ext_napi_wait_for_upgrade_lock_fn) failed! fs_ext_napi_wait_for_upgrade_lock napi_set_named_property(env, exports, "fs_ext_napi_wait_for_upgrade_lock", fs_ext_napi_wait_for_upgrade_lock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_unlock, NULL, &fs_ext_napi_unlock_fn) failed! fs_ext_napi_unlock napi_set_named_property(env, exports, "fs_ext_napi_unlock", fs_ext_napi_unlock_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_trim, NULL, &fs_ext_napi_trim_fn) failed! fs_ext_napi_trim napi_set_named_property(env, exports, "fs_ext_napi_trim", fs_ext_napi_trim_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_sparse, NULL, &fs_ext_napi_sparse_fn) failed! fs_ext_napi_sparse napi_set_named_property(env, exports, "fs_ext_napi_sparse", fs_ext_napi_sparse_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_swap, NULL, &fs_ext_napi_swap_fn) failed! fs_ext_napi_swap napi_set_named_property(env, exports, "fs_ext_napi_swap", fs_ext_napi_swap_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_get_attr, NULL, &fs_ext_napi_get_attr_fn) failed! fs_ext_napi_get_attr napi_set_named_property(env, exports, "fs_ext_napi_get_attr", fs_ext_napi_get_attr_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_set_attr, NULL, &fs_ext_napi_set_attr_fn) failed! fs_ext_napi_set_attr napi_set_named_property(env, exports, "fs_ext_napi_set_attr", fs_ext_napi_set_attr_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_remove_attr, NULL, &fs_ext_napi_remove_attr_fn) failed! fs_ext_napi_remove_attr napi_set_named_property(env, exports, "fs_ext_napi_remove_attr", fs_ext_napi_remove_attr_fn) failed! napi_create_function(env, NULL, 0, fs_ext_napi_list_attrs, NULL, &fs_ext_napi_list_attrs_fn) failed! fs_ext_napi_list_attrs napi_set_named_property(env, exports, "fs_ext_napi_list_attrs", fs_ext_napi_list_attrs_fn) failed!                                                            
   
                0       0                  L:  T   T         T                   /        	 X   !  % P)  - 9  = @  8E |H M  D^ t^ ^  ^ ^ _ @_  l_ _ _  _ `  H` `  ` `  a Da  ta a a  b Hb  tb b  c @c d de e lf  g                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             H      T      `      l      x                                                                                           ,      8      D      P      \      h      t                                                                                          (      4      @      L      X      d      p      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      " `8   @___stack_chk_guard Qq @dyld_stub_binder     r @___error  r@___stack_chk_fail  r@_calloc  r@_fcntl  r @_fgetxattr  r(@_flistxattr  r0@_flock  r8@_free  r@@_fremovexattr  rH@_fsetxattr  rP@_fstat  rX>@_js_call_function_with_checkpoint  r`>@_js_close_handle_scope  rh>@_js_create_array_with_length  rp>@_js_create_arraybuffer  rx>@_js_create_error  r>@_js_create_function  r>@_js_create_reference  r>@_js_create_string_utf8  r>@_js_create_uint32  r>@_js_delete_reference  r>@_js_fatal_exception  r>@_js_get_and_clear_last_exception  r>@_js_get_callback_info  r>@_js_get_env_loop  r>@_js_get_null  r>@_js_get_reference_value  r>@_js_get_typedarray_info  r>@_js_get_value_string_utf8  r>@_js_get_value_uint32  r>@_js_open_handle_scope  r>@_js_set_element  r>@_js_set_named_property  r>@_js_throw_error  r@_malloc  r@_memcpy  r@_memmove  r>@_napi_clear_last_error_info  r>@_napi_create_reference  r>@_napi_get_buffer_info  r>@_napi_get_last_error_info  r>@_napi_get_uv_event_loop  r>@_napi_get_value_string_utf8  r>@_napi_get_value_uint32  r>@_napi_set_last_error_info  r>@_napi_throw_error  r@_pwrite  r@_realloc  r@_renameatx_np  r@_strlen  r>@_uv_buf_init  r>@_uv_err_name  r>@_uv_get_osfhandle  r>@_uv_queue_work  r>@_uv_strerror  r>@_uv_translate_sys_error         _                 et_attr parse !wap '         downgrade_lock Jlock Pupgrade_lock V im Dy_ \         downgrade_lock lock upgrade_lock  get_attr 	list_attrs remove_attr s -tr unlock wait_for_                  et_attr parse wap      t    downgrade_lock lock upgrade_lock  im y_      y    downgrade_lock lock upgrade_lock  get_attr list_attrs remove_attr s tr unlock wait_for_          et_attr parse wap          downgrade_lock lock upgrade_lock  im y_          downgrade_lock lock upgrade_lock  	_ get_attr list_attrs napi_ remove_attr s tr unlock wait_for_    fs_ext_ napi_register_module_v1        t

!0(00,,0,,$, ( ($0@,0 , 0<LLD@@T      @          T          \          c          k          s      -    H{      D          Z          m                                  h                                    	    ,      -	    T      F	          ]	          z	    ,      	    \      	          	          	          
    (       
  	                       L      (           =           O           _           m     h      {     d                      t           $           l                     |      *    l      ;          N    g      d          |    x          `p          X          8`          Q          HD          L:          I      7    0O      K    F      p    <          L          t                                         D          0                (          A    @      P    `      p                                                                                                                                                      ,            7            >            `            w                                                                                                #            7            X            n                                                                                                            (            8            @            H            Q            m                                                                                                +            3            <            J            R            _            l            ~                                                F   G   I   J   K   L   M   N   O   P   Q   R   S   T   U   V   W   X   Y   Z   [   \   ]   ^   _   `   a   b   c   d   e   f   g   h   i   j   k   l   m   n   o   p   q   r   s   t   u   v   w   x   y   z   {   |   }   ~   H      F   G   I   J   K   L   M   N   O   P   Q   R   S   T   U   V   W   X   Y   Z   [   \   ]   ^   _   `   a   b   c   d   e   f   g   h   i   j   k   l   m   n   o   p   q   r   s   t   u   v   w   x   y   z   {   |   }   ~     _fs_ext__get_attr _fs_ext__list_attrs _fs_ext__remove_attr _fs_ext__set_attr _fs_ext__sparse _fs_ext__swap _fs_ext__trim _fs_ext__try_downgrade_lock _fs_ext__try_lock _fs_ext__try_upgrade_lock _fs_ext__unlock _fs_ext__wait_for_downgrade_lock _fs_ext__wait_for_lock _fs_ext__wait_for_upgrade_lock _fs_ext_get_attr _fs_ext_list_attrs _fs_ext_napi_get_attr _fs_ext_napi_list_attrs _fs_ext_napi_remove_attr _fs_ext_napi_set_attr _fs_ext_napi_sparse _fs_ext_napi_swap _fs_ext_napi_trim _fs_ext_napi_try_downgrade_lock _fs_ext_napi_try_lock _fs_ext_napi_try_upgrade_lock _fs_ext_napi_unlock _fs_ext_napi_wait_for_downgrade_lock _fs_ext_napi_wait_for_lock _fs_ext_napi_wait_for_upgrade_lock _fs_ext_remove_attr _fs_ext_set_attr _fs_ext_sparse _fs_ext_swap _fs_ext_trim _fs_ext_try_downgrade_lock _fs_ext_try_lock _fs_ext_try_upgrade_lock _fs_ext_unlock _fs_ext_wait_for_downgrade_lock _fs_ext_wait_for_lock _fs_ext_wait_for_upgrade_lock _napi_register_module_v1 ___error ___stack_chk_fail ___stack_chk_guard _calloc _fcntl _fgetxattr _flistxattr _flock _free _fremovexattr _fsetxattr _fstat _js_call_function_with_checkpoint _js_close_handle_scope _js_create_array_with_length _js_create_arraybuffer _js_create_error _js_create_function _js_create_reference _js_create_string_utf8 _js_create_uint32 _js_delete_reference _js_fatal_exception _js_get_and_clear_last_exception _js_get_callback_info _js_get_env_loop _js_get_null _js_get_reference_value _js_get_typedarray_info _js_get_value_string_utf8 _js_get_value_uint32 _js_open_handle_scope _js_set_element _js_set_named_property _js_throw_error _malloc _memcpy _memmove _napi_clear_last_error_info _napi_create_reference _napi_get_buffer_info _napi_get_last_error_info _napi_get_uv_event_loop _napi_get_value_string_utf8 _napi_get_value_uint32 _napi_set_last_error_info _napi_throw_error _pwrite _realloc _renameatx_np _strlen _uv_buf_init _uv_err_name _uv_get_osfhandle _uv_queue_work _uv_strerror _uv_translate_sys_error dyld_stub_binder _on_fs_ext_lock _on_fs_ext_trim _on_fs_ext_sparse _on_fs_ext_swap _on_fs_ext_get_attr _on_fs_ext_set_attr _on_fs_ext_remove_attr _on_fs_ext_list_attrs _fs_ext__lock_work _fs_ext__lock_after_work _fs_ext__downgrade_lock_work _fs_ext__upgrade_lock_work _fs_ext__trim_work _fs_ext__trim_after_work _fs_ext__sparse_work _fs_ext__sparse_after_work _fs_ext__swap_work _fs_ext__swap_after_work _fs_ext__get_attr_work _fs_ext__get_attr_after_work _fs_ext__set_attr_work _fs_ext__set_attr_after_work _fs_ext__remove_attr_work _fs_ext__remove_attr_after_work _fs_ext__list_attrs_work _fs_ext__list_attrs_after_work __dyld_private    H            4       t   X        ]`                                        hD        fs-native-extensions@1.bare G[&!8 -|XofkOX||zH,XofkOX||zH,Y1_Ess7..S WznNkX!QHv"a7A_f{V}8QDWisU%C">!L	G 'iN_PFp8]6*S=?tK7&hTYIpP5HVR= lOlkEjgI? .UY;4
R2CrD	HpVWXYJ3N<^$HJCb#|9d*bY!s<.XofkOX||zH,XofkOX||zH,XofkOX||zH,XofkOX||zH,d1$.	 ,A08xLcTDwEXofkOX||zH,XofkOX||zH,XofkOX||zH,2eikz7e{
	,fJ[TC\7w\b'use strict'
const fs = require('fs')
const fsext = require('fs-native-extensions')

const LOCK_POLL_INTERVAL = 500
const POLL_MAX_TRIES = 20

class Internal {
  _pinging = true
  _ping (method) { return () => this._pinging && method.request({ beat: 'ping' }) }
}

class API extends Internal {
  #ipc = null

  constructor (ipc) {
    super()
    this.#ipc = ipc
  }

  wakeup (method) {
    return (link, storage, appdev, selfwake, startId) => method.request({ args: [link, storage, appdev, selfwake, startId] })
  }

  shutdown (method) {
    return async () => {
      if (this.#ipc.closed || this.#ipc.closing) return
      this._pinging = false
      method.send()
      const fd = await new Promise((resolve, reject) => {
        let tries = 0
        let interval = null
        const poll = () => {
          fs.open(this.#ipc._lock, 'r+', (err, fd) => {
            if (!err) {
              clearInterval(interval)
              resolve(fd)
            } else {
              tries++
              if (tries > POLL_MAX_TRIES) {
                clearInterval(interval)
                reject(err)
              }
            }
          })
        }
        interval = setInterval(poll, LOCK_POLL_INTERVAL)
        poll()
      })

      await fsext.waitForLock(fd)
      fsext.unlock(fd)
      await new Promise((resolve, reject) => fs.close(fd, (err) => {
        if (err) {
          reject(err)
          return
        }
        resolve()
      }))
      await this.#ipc.close()
    }
  }
}

module.exports = API
'use strict'
const { isBare } = require('which-runtime')
const Pipe = require('net') // import mapped to bare-pipe, less resolves
const path = require('path')
const RPC = require('tiny-buffer-rpc')
const any = require('tiny-buffer-rpc/any')
const ReadyResource = require('ready-resource')
const FramedStream = require('framed-stream')

const API = require('./api')
const methods = require('./methods')
const constants = require('./constants')

class PearIPCClient extends ReadyResource {
  #connect = null
  constructor (opts = {}) {
    super()
    this._opts = opts
    this._socketPath = opts.socketPath
    this._methods = opts.methods ? [...methods, ...opts.methods] : methods
    this._lock = opts.lock || path.join(constants.PEAR_DIR, 'corestores', 'platform', 'db', 'LOCK')
    const api = new API(this)
    if (opts.api) Object.assign(api, opts.api)
    this._api = api
    this._connectTimeout = opts.connectTimeout || constants.CONNECT_TIMEOUT
    this.#connect = opts.connect || null
    this._rpc = null
    this._internalHandlers = null

    this._rawStream = opts.stream || null
    this._stream = null

    this.userData = opts.userData || null

    this._onclose = this.close.bind(this)
  }

  ref () {
    this._heartbeat?.ref()
    this._timeout?.ref()
    if (this._rawStream?.ref) this._rawStream.ref()
  }

  unref () {
    this._heartbeat?.unref()
    this._timeout?.unref()
    if (this._rawStream?.unref) this._rawStream.unref()
  }

  async _open () {
    if (this._rawStream === null) {
      await this._connect()
    }
  }

  _setup () {
    this._stream = new FramedStream(this._rawStream)

    this._rpc = new RPC((data) => { this._stream.write(data) })
    this._stream.on('data', (data) => { this._rpc.recv(data) })
    this._stream.on('end', () => { this._stream.end() })
    this._stream.on('error', this._onclose)
    this._stream.on('close', this._onclose)

    this._register()

    this._heartbeat = setInterval(() => {
      this._beat()
    }, constants.HEARTBEAT_INTERVAL)
    this._beat()
  }

  async _beat () {
    try { await this._ping() } catch { /* ignore */ }
  }

  _createSendMethod (method) {
    return (params = {}) => method.send(params)
  }

  _createRequestMethod (method) {
    return (params = {}) => method.request(params)
  }

  _createStreamMethod (method) {
    return (params = {}) => {
      const stream = method.createRequestStream()
      stream.on('end', () => { stream.end() })
      stream.write(params)
      return stream
    }
  }

  _createMethod (definition) {
    if (definition.send) {
      return this._createSendMethod
    }

    if (!definition.stream) {
      return this._createRequestMethod
    }

    return this._createStreamMethod
  }

  _register () {
    for (const { id, ...def } of this._methods) {
      if (constants.ILLEGAL_METHODS.has(def.name)) throw new Error('Illegal Method: ' + def.name)
      const api = this._api[def.name]?.bind(this._api) || this._createMethod(def)

      this[def.name] = api(this._rpc.register(+id, {
        request: any,
        response: any
      }), this)
    }
  }

  _pipe () {
    if (isBare) return new Pipe(this._socketPath)
    const sock = new Pipe.Socket()
    sock.setNoDelay(true)
    sock.connect(this._socketPath)
    return sock
  }

  async _connect () {
    let trycount = 0
    let timedout = false
    let next = null

    this._timeout = setTimeout(() => {
      timedout = true
      this.close()
    }, this._connectTimeout)

    const onerror = () => {
      this._rawStream.removeListener('error', onerror)
      this._rawStream.removeListener('connect', onconnect)
      next(false)
    }

    const onconnect = () => {
      this._rawStream.removeListener('error', onerror)
      this._rawStream.removeListener('connect', onconnect)
      clearTimeout(this._timeout)
      next(true)
    }

    while (!this.closing) {
      const promise = new Promise((resolve) => { next = resolve })
      this._rawStream = this._pipe(this._socketPath)
      this._rawStream.on('connect', onconnect)
      this._rawStream.on('error', onerror)

      if (await promise) break
      if (timedout) throw new Error('Could not connect in time')
      if (trycount++ === 0 && typeof this.#connect === 'function') this.#connect()

      await new Promise((resolve) => setTimeout(resolve, trycount < 2 ? 5 : trycount < 10 ? 10 : 100))
    }

    clearTimeout(this._timeout)

    this._setup()

    if (this.closing) {
      if (this._rawStream) this._rawStream.destroy()
    }
  }

  _waitForClose () {
    return new Promise((resolve) => {
      if (this._stream.destroyed) {
        resolve()
      } else {
        this._stream.once('close', resolve)
        this._stream.end()
      }
    })
  }

  async _close () { // never throws, must never throw
    clearInterval(this._heartbeat)
    clearTimeout(this._timeout)

    if (this._stream) {
      await this._waitForClose()
      this._rawStream = null
      this._stream = null
    }
    this._rpc.destroy()
  }
}

module.exports = PearIPCClient
const { isWindows, isMac } = require('which-runtime')
const path = require('path')
const os = require('os')

const PEAR_DIR = global.Pear?.config.pearDir || (isMac
  ? path.join(os.homedir(), 'Library', 'Application Support', 'pear')
  : isWindows
    ? path.join(os.homedir(), 'AppData', 'Roaming', 'pear')
    : path.join(os.homedir(), '.config', 'pear'))

const CONNECT_TIMEOUT = 20_000
const HEARTBEAT_INTERVAL = 1500
const HEARBEAT_CLOCK = 5
const ILLEGAL_METHODS = new Set(['id', 'userData', 'clients', 'hasClients', 'client', 'ref', 'unref', 'ready', 'opening', 'opened', 'close', 'closing', 'closed'])

module.exports = {
  PEAR_DIR,
  CONNECT_TIMEOUT,
  HEARTBEAT_INTERVAL,
  HEARBEAT_CLOCK,
  ILLEGAL_METHODS
}
'use strict'
const PearIPCServer = require('./server')
const PearIPCClient = require('./client')

module.exports = { Server: PearIPCServer, Client: PearIPCClient }
'use strict'
const methods = [
  { id: 0, name: 'info', stream: true },
  { id: 1, name: 'dump', stream: true },
  { id: 2, name: 'seed', stream: true },
  { id: 3, name: 'stage', stream: true },
  { id: 4, name: 'release', stream: true },
  { id: 5, name: 'messages', stream: true },
  { id: 6, name: 'message' },
  { id: 7, name: 'config' },
  { id: 8, name: 'checkpoint' },
  { id: 9, name: 'versions' },
  { id: 10, name: 'address' },
  { id: 11, name: 'detached' },
  { id: 12, name: 'permit' },
  { id: 13, name: 'identify' },
  { id: 14, name: 'wakeup' },
  { id: 15, name: 'warming', stream: true },
  { id: 16, name: 'warmup' },
  { id: 17, name: 'run', stream: true },
  { id: 18, name: 'restart' },
  { id: 19, name: 'unloading' },
  { id: 20, name: 'closeClients' },
  { id: 21, name: 'createReport' },
  { id: 22, name: 'reports', stream: true },
  { id: 23, name: 'shutdown', send: true },
  { id: 24, name: 'shift', stream: true },
  { id: 25, name: 'build', stream: true },
  { id: 26, name: 'gc', stream: true },
  { id: 27, name: 'clearIdentity' },
  { id: 28, name: 'shareIdentity' },
  { id: 29, name: 'requestIdentity' },
  { id: 30, name: 'trustIdentity' },
  { id: 31, name: 'encryptionKey', stream: true },
  { id: 32, name: 'trusted' },
  { id: 33, name: 'touch', stream: true },
  { id: 34, name: '_ping' },
  { id: 35, name: 'drop', stream: true },
  { id: 36, name: 'data', stream: true },
  { id: 37, name: 'get' },
  { id: 38, name: 'entry' },
  { id: 39, name: 'exists' },
  { id: 40, name: 'compare' },
  { id: 41, name: 'reported' },
  { id: 42, name: 'cutover' }
]

module.exports = methods
{
  "name": "pear-ipc",
  "version": "6.4.0",
  "description": "IPC for Pear",
  "main": "index.js",
  "scripts": {
    "test": "brittle test.js",
    "lint": "standard"
  },
  "files": [
    "api.js",
    "index.js",
    "methods.js",
    "server.js",
    "client.js",
    "constants.js"
  ],
  "keywords": [],
  "author": "Holepunch",
  "license": "Apache-2.0",
  "dependencies": {
    "bare-fs": "^4.0.1",
    "bare-os": "^3.2.0",
    "bare-path": "^3.0.0",
    "bare-pipe": "^4.0.5",
    "framed-stream": "^1.0.1",
    "fs-native-extensions": "^1.2.7",
    "ready-resource": "^1.0.3",
    "streamx": "^2.16.1",
    "tiny-buffer-rpc": "^2.2.0",
    "which-runtime": "^1.2.0"
  },
  "imports": {
    "fs": {
      "bare": "bare-fs",
      "default": "fs"
    },
    "os": {
      "bare": "bare-os",
      "default": "os"
    },
    "path": {
      "bare": "bare-path",
      "default": "path"
    },
    "net": {
      "bare": "bare-pipe",
      "default": "net"
    }
  },
  "devDependencies": {
    "brittle": "^3.4.0",
    "standard": "^17.1.0"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/pear-ipc.git"
  },
  "bugs": {
    "url": "https://github.com/holepunchto/pear-ipc/issues"
  },
  "homepage": "https://github.com/holepunchto/pear-ipc#readme"
}
'use strict'
const { isBare, isWindows } = require('which-runtime')
const Pipe = require('net') // import mapped to bare-pipe, less resolves
const path = require('path')
const fs = require('fs')
const streamx = require('streamx')
const RPC = require('tiny-buffer-rpc')
const any = require('tiny-buffer-rpc/any')
const ReadyResource = require('ready-resource')
const FramedStream = require('framed-stream')

const API = require('./api')
const methods = require('./methods')
const constants = require('./constants')

const noop = Function.prototype

class PearIPCServer extends ReadyResource {
  #connect = null
  constructor (opts = {}) {
    super()
    this._opts = opts
    this._socketPath = opts.socketPath
    this._handlers = opts.handlers || {}
    this._methods = opts.methods ? [...methods, ...opts.methods] : methods
    this._lock = opts.lock || path.join(constants.PEAR_DIR, 'corestores', 'platform', 'db', 'LOCK')
    const api = new API(this)
    if (opts.api) Object.assign(api, opts.api)
    this._api = api
    this._connectTimeout = opts.connectTimeout || constants.CONNECT_TIMEOUT
    this.#connect = opts.connect || null
    this._rpc = null
    this._clients = new Freelist()
    this.clock = constants.HEARBEAT_CLOCK
    this._internalHandlers = null

    this._server = null
    this._rawStream = opts.stream || null
    this._stream = null
    this._unhandled = opts.unhandled || ((def) => { throw new Error('Method not found:' + def.name) })

    this.id = null
    this.userData = opts.userData || null

    this._onclose = this.close.bind(this)
    this._onpipeline = opts.onpipeline || null
  }

  get clients () { return this._clients.alloced.filter(Boolean) }

  get hasClients () { return !this._clients.emptied() }

  client (id) { return this._clients.from(id) || null }

  ref () {
    this._heartbeat?.ref()
    if (this._rawStream?.ref) this._rawStream.ref()
    this._server?.ref()
  }

  unref () {
    this._heartbeat?.unref()
    if (this._rawStream?.unref) this._rawStream.unref()
    this._server?.unref()
  }

  async _open () {
    if (this._rawStream === null) {
      this._serve()
    }

    if (this.closing) return

    if (this._server) {
      try {
        if (!isWindows) await fs.promises.unlink(this._socketPath)
      } catch {}
      if (this.closing) return
      this._server.listen(this._socketPath)
    }
  }

  _setup (id) {
    this.id = id
    this._stream = new FramedStream(this._rawStream)

    this._rpc = new RPC((data) => { if (!this.closing) this._stream.write(data) })
    this._stream.on('data', (data) => { this._rpc.recv(data) })
    this._stream.on('end', () => { this._stream.end() })
    this._stream.on('error', this._onclose)
    this._stream.on('close', this._onclose)

    this._internalHandlers = {
      _ping: (_, client) => {
        client.clock = constants.HEARBEAT_CLOCK
        return { beat: 'pong' }
      }
    }

    this._register()
  }

  _createSendMethod (method) {
    return (params = {}) => method.send(params)
  }

  _createRequestMethod (method) {
    return (params = {}) => method.request(params)
  }

  _createStreamMethod (method) {
    return (params = {}) => {
      const stream = method.createRequestStream()
      stream.on('end', () => { stream.end() })
      stream.write(params)
      return stream
    }
  }

  _createMethod (definition) {
    if (definition.send) {
      return this._createSendMethod
    }

    if (!definition.stream) {
      return this._createRequestMethod
    }

    return this._createStreamMethod
  }

  _register () {
    for (const { id, ...def } of this._methods) {
      if (constants.ILLEGAL_METHODS.has(def.name)) throw new Error('Illegal Method: ' + def.name)
      const fn = this._handlers[def.name] || this._internalHandlers?.[def.name] || null
      const callHandler = (params = {}) => fn.call(this._handlers, params, this)
      const api = this._api[def.name]?.bind(this._api) || fn ? () => callHandler : this._createMethod(def)

      this[def.name] = api(this._rpc.register(+id, {
        request: any,
        response: any,
        onrequest: def.stream
          ? null
          : (params) => {
              return fn ? fn.call(this._handlers, params, this) : this._unhandled(def, params)
            },
        onstream: def.stream ? this._createOnStream(fn, (params) => this._unhandled(def, params)) : null
      }), this)
    }
  }

  _createOnStream (fn, unhandled) {
    if (fn === null) fn = unhandled
    return async (stream) => {
      stream.on('end', () => stream.end())
      stream.on('error', (err) => console.log(err))
      try {
        for await (const params of stream) {
          const src = fn.call(this._handlers, params, this)
          const isStream = streamx.isStream(src)
          if (isStream) {
            streamx.pipeline(src, stream)
            if (typeof this._onpipeline === 'function') this._onpipeline(src, stream)
          } else {
            if (typeof this._onpipeline === 'function') this._onpipeline(src, stream)
            for await (const data of src) stream.write(data)
            stream.end()
          }
        }
      } catch (err) {
        stream.destroy(err)
      }
    }
  }

  _serve () {
    this._server = Pipe.createServer()
    this._server.on('connection', (rawStream) => {
      const client = new this.constructor({ ...this._opts, stream: rawStream })
      const id = this._clients.alloc(client)
      client._setup(id)
      client.once('close', () => { this._clients.free(client.id) })
      this.emit('client', client)
    })
    this._heartbeat = setInterval(() => {
      for (const client of this.clients) {
        client.clock--
        if (client.clock <= 0) {
          client.close()
        }
      }
    }, constants.HEARTBEAT_INTERVAL)
    this._rpc = new RPC(noop)
    this._register()
  }

  _pipe () {
    if (isBare) return new Pipe(this._socketPath)
    const sock = new Pipe.Socket()
    sock.setNoDelay(true)
    sock.connect(this._socketPath)
    return sock
  }

  _waitForClose () {
    return new Promise((resolve) => {
      if (this._stream.destroyed) {
        resolve()
      } else {
        this._stream.once('close', resolve)
        if (this.clock > 0) {
          this._stream.end()
        } else {
          this._stream.destroy()
        }
      }
    })
  }

  async _close () { // never throws, must never throw
    clearInterval(this._heartbeat)

    if (this._stream) {
      await this._waitForClose()
      this._rawStream = null
      this._stream = null
    }
    if (this._server) {
      await new Promise((resolve) => {
        const closingClients = []
        for (const client of this._clients) closingClients.push(client.close())
        const clientsClosing = Promise.allSettled(closingClients)
        this._server.close(async () => {
          await clientsClosing
          resolve()
        })
      })
    }
  }
}

class Freelist {
  alloced = []
  freed = []

  nextId () {
    return this.freed.length === 0 ? this.alloced.length : this.freed[this.freed.length - 1]
  }

  alloc (item) {
    const id = this.freed.length === 0 ? this.alloced.push(null) - 1 : this.freed.pop()
    this.alloced[id] = item
    return id
  }

  free (id) {
    this.freed.push(id)
    this.alloced[id] = null
  }

  from (id) {
    return id < this.alloced.length ? this.alloced[id] : null
  }

  emptied () {
    return this.freed.length === this.alloced.length
  }

  * [Symbol.iterator] () {
    for (const item of this.alloced) {
      if (item === null) continue
      yield item
    }
  }
}

module.exports = PearIPCServer
const EventEmitter = require('events')

module.exports = class ReadyResource extends EventEmitter {
  constructor () {
    super()

    this.opening = null
    this.closing = null

    this.opened = false
    this.closed = false
  }

  ready () {
    if (this.opening !== null) return this.opening
    this.opening = open(this)
    return this.opening
  }

  close () {
    if (this.closing !== null) return this.closing
    this.closing = close(this)
    return this.closing
  }

  async _open () {
    // add impl here
  }

  async _close () {
    // add impl here
  }
}

async function open (self) {
  // open after close
  if (self.closing !== null) return

  try {
    await self._open()
  } catch (err) {
    self.close() // safe to run in bg
    throw err
  }

  self.opened = true
  self.emit('ready')
}

async function close (self) {
  try {
    if (self.opened === false && self.opening !== null) await self.opening
  } catch {
    // ignore errors on closing
  }
  if (self.opened === true || self.opening === null) await self._close()
  self.closed = true
  self.emit('close')
}
{
  "name": "ready-resource",
  "version": "1.1.2",
  "description": "Modern single resource management",
  "main": "index.js",
  "imports": {
    "events": {
      "bare": "bare-events",
      "default": "events"
    }
  },
  "files": [
    "index.js"
  ],
  "scripts": {
    "test": "standard && brittle test.js"
  },
  "devDependencies": {
    "brittle": "^3.1.0",
    "standard": "^17.0.0"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/ready-resource.git"
  },
  "author": "Mathias Buus (@mafintosh)",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/holepunchto/ready-resource/issues"
  },
  "homepage": "https://github.com/holepunchto/ready-resource",
  "dependencies": {
    "bare-events": "^2.2.0"
  }
}
const runtime = require('./lib/runtime')

if (runtime === 'bare') {
  module.exports = require('./lib/runtime/bare')
} else if (runtime === 'node') {
  module.exports = require('./lib/runtime/node')
} else {
  module.exports = require('./lib/runtime/default')
}
module.exports =
  typeof Bare !== 'undefined'
    ? 'bare'
    : typeof process !== 'undefined'
      ? 'node'
      : 'unknown'
module.exports = require.addon.bind(require)
if (typeof require.addon === 'function') {
  module.exports = require.addon.bind(require)
} else {
  module.exports = function addon(specifier, parentURL) {
    throw new Error(
      `Cannot find addon '${specifier}' imported from '${parentURL}'`
    )
  }
}
if (typeof require.addon === 'function') {
  module.exports = require.addon.bind(require)
} else {
  const url = require('url')
  const resolve = require('bare-addon-resolve')

  const host = process.platform + '-' + process.arch
  const conditions = ['node', process.platform, process.arch]
  const extensions = ['.node']

  module.exports = function addon(specifier, parentURL) {
    if (typeof parentURL === 'string') parentURL = url.pathToFileURL(parentURL)

    for (const resolution of resolve(
      specifier,
      parentURL,
      { host, conditions, extensions },
      readPackage
    )) {
      switch (resolution.protocol) {
        case 'file:':
          try {
            return require(url.fileURLToPath(resolution))
          } catch {
            continue
          }
      }
    }

    throw new Error(
      `Cannot find addon '${specifier}' imported from '${parentURL.href}'`
    )

    function readPackage(packageURL) {
      try {
        return require(url.fileURLToPath(packageURL))
      } catch (err) {
        return null
      }
    }
  }
}
{
  "name": "require-addon",
  "version": "1.1.0",
  "description": "Import native addons across JavaScript runtimes",
  "exports": {
    ".": "./index.js",
    "./package": "./package.json"
  },
  "imports": {
    "fs": {
      "bare": "bare-fs",
      "default": "fs"
    },
    "path": {
      "bare": "bare-path",
      "default": "path"
    },
    "url": {
      "bare": "bare-url",
      "default": "url"
    }
  },
  "files": [
    "index.js",
    "lib"
  ],
  "scripts": {
    "test": "npm run lint && npm run test:bare && npm run test:node",
    "test:bare": "bare test.js",
    "test:node": "node test.js",
    "lint": "prettier . --check"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/require-addon.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/require-addon/issues"
  },
  "homepage": "https://github.com/holepunchto/require-addon#readme",
  "engines": {
    "bare": ">=1.10.0"
  },
  "dependencies": {
    "bare-addon-resolve": "^1.3.0",
    "bare-url": "^2.1.0"
  },
  "devDependencies": {
    "bare-bundle": "^1.8.1",
    "bare-bundle-evaluate": "^1.1.0",
    "bare-fs": "^4.0.0",
    "bare-path": "^3.0.0",
    "brittle": "^3.7.0",
    "prettier": "^3.4.1",
    "prettier-config-standard": "^7.0.0"
  }
}
module.exports = safetyCatch

function isActuallyUncaught (err) {
  if (!err) return false
  return err instanceof TypeError ||
    err instanceof SyntaxError ||
    err instanceof ReferenceError ||
    err instanceof EvalError ||
    err instanceof RangeError ||
    err instanceof URIError ||
    err.code === 'ERR_ASSERTION'
}

function throwErrorNT (err) {
  queueMicrotask(() => { throw err })
}

function safetyCatch (err) {
  if (isActuallyUncaught(err)) {
    throwErrorNT(err)
    throw err
  }
}
{
  "name": "safety-catch",
  "version": "1.0.2",
  "description": "Small module that makes sure your catch, caught an actual error and not a programming mistake or assertion",
  "main": "index.js",
  "dependencies": {},
  "devDependencies": {},
  "repository": {
    "type": "git",
    "url": "https://github.com/mafintosh/safety-catch.git"
  },
  "author": "Mathias Buus (@mafintosh)",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/mafintosh/safety-catch/issues"
  },
  "homepage": "https://github.com/mafintosh/safety-catch"
}
const { EventEmitter } = require('events')
const STREAM_DESTROYED = new Error('Stream was destroyed')
const PREMATURE_CLOSE = new Error('Premature close')

const FIFO = require('fast-fifo')
const TextDecoder = require('text-decoder')

// if we do a future major, expect queue microtask to be there always, for now a bit defensive
const qmt = typeof queueMicrotask === 'undefined' ? fn => global.process.nextTick(fn) : queueMicrotask

/* eslint-disable no-multi-spaces */

// 29 bits used total (4 from shared, 14 from read, and 11 from write)
const MAX = ((1 << 29) - 1)

// Shared state
const OPENING       = 0b0001
const PREDESTROYING = 0b0010
const DESTROYING    = 0b0100
const DESTROYED     = 0b1000

const NOT_OPENING = MAX ^ OPENING
const NOT_PREDESTROYING = MAX ^ PREDESTROYING

// Read state (4 bit offset from shared state)
const READ_ACTIVE           = 0b00000000000001 << 4
const READ_UPDATING         = 0b00000000000010 << 4
const READ_PRIMARY          = 0b00000000000100 << 4
const READ_QUEUED           = 0b00000000001000 << 4
const READ_RESUMED          = 0b00000000010000 << 4
const READ_PIPE_DRAINED     = 0b00000000100000 << 4
const READ_ENDING           = 0b00000001000000 << 4
const READ_EMIT_DATA        = 0b00000010000000 << 4
const READ_EMIT_READABLE    = 0b00000100000000 << 4
const READ_EMITTED_READABLE = 0b00001000000000 << 4
const READ_DONE             = 0b00010000000000 << 4
const READ_NEXT_TICK        = 0b00100000000000 << 4
const READ_NEEDS_PUSH       = 0b01000000000000 << 4
const READ_READ_AHEAD       = 0b10000000000000 << 4

// Combined read state
const READ_FLOWING = READ_RESUMED | READ_PIPE_DRAINED
const READ_ACTIVE_AND_NEEDS_PUSH = READ_ACTIVE | READ_NEEDS_PUSH
const READ_PRIMARY_AND_ACTIVE = READ_PRIMARY | READ_ACTIVE
const READ_EMIT_READABLE_AND_QUEUED = READ_EMIT_READABLE | READ_QUEUED
const READ_RESUMED_READ_AHEAD = READ_RESUMED | READ_READ_AHEAD

const READ_NOT_ACTIVE             = MAX ^ READ_ACTIVE
const READ_NON_PRIMARY            = MAX ^ READ_PRIMARY
const READ_NON_PRIMARY_AND_PUSHED = MAX ^ (READ_PRIMARY | READ_NEEDS_PUSH)
const READ_PUSHED                 = MAX ^ READ_NEEDS_PUSH
const READ_PAUSED                 = MAX ^ READ_RESUMED
const READ_NOT_QUEUED             = MAX ^ (READ_QUEUED | READ_EMITTED_READABLE)
const READ_NOT_ENDING             = MAX ^ READ_ENDING
const READ_PIPE_NOT_DRAINED       = MAX ^ READ_FLOWING
const READ_NOT_NEXT_TICK          = MAX ^ READ_NEXT_TICK
const READ_NOT_UPDATING           = MAX ^ READ_UPDATING
const READ_NO_READ_AHEAD          = MAX ^ READ_READ_AHEAD
const READ_PAUSED_NO_READ_AHEAD   = MAX ^ READ_RESUMED_READ_AHEAD

// Write state (18 bit offset, 4 bit offset from shared state and 14 from read state)
const WRITE_ACTIVE     = 0b00000000001 << 18
const WRITE_UPDATING   = 0b00000000010 << 18
const WRITE_PRIMARY    = 0b00000000100 << 18
const WRITE_QUEUED     = 0b00000001000 << 18
const WRITE_UNDRAINED  = 0b00000010000 << 18
const WRITE_DONE       = 0b00000100000 << 18
const WRITE_EMIT_DRAIN = 0b00001000000 << 18
const WRITE_NEXT_TICK  = 0b00010000000 << 18
const WRITE_WRITING    = 0b00100000000 << 18
const WRITE_FINISHING  = 0b01000000000 << 18
const WRITE_CORKED     = 0b10000000000 << 18

const WRITE_NOT_ACTIVE    = MAX ^ (WRITE_ACTIVE | WRITE_WRITING)
const WRITE_NON_PRIMARY   = MAX ^ WRITE_PRIMARY
const WRITE_NOT_FINISHING = MAX ^ (WRITE_ACTIVE | WRITE_FINISHING)
const WRITE_DRAINED       = MAX ^ WRITE_UNDRAINED
const WRITE_NOT_QUEUED    = MAX ^ WRITE_QUEUED
const WRITE_NOT_NEXT_TICK = MAX ^ WRITE_NEXT_TICK
const WRITE_NOT_UPDATING  = MAX ^ WRITE_UPDATING
const WRITE_NOT_CORKED    = MAX ^ WRITE_CORKED

// Combined shared state
const ACTIVE = READ_ACTIVE | WRITE_ACTIVE
const NOT_ACTIVE = MAX ^ ACTIVE
const DONE = READ_DONE | WRITE_DONE
const DESTROY_STATUS = DESTROYING | DESTROYED | PREDESTROYING
const OPEN_STATUS = DESTROY_STATUS | OPENING
const AUTO_DESTROY = DESTROY_STATUS | DONE
const NON_PRIMARY = WRITE_NON_PRIMARY & READ_NON_PRIMARY
const ACTIVE_OR_TICKING = WRITE_NEXT_TICK | READ_NEXT_TICK
const TICKING = ACTIVE_OR_TICKING & NOT_ACTIVE
const IS_OPENING = OPEN_STATUS | TICKING

// Combined shared state and read state
const READ_PRIMARY_STATUS = OPEN_STATUS | READ_ENDING | READ_DONE
const READ_STATUS = OPEN_STATUS | READ_DONE | READ_QUEUED
const READ_ENDING_STATUS = OPEN_STATUS | READ_ENDING | READ_QUEUED
const READ_READABLE_STATUS = OPEN_STATUS | READ_EMIT_READABLE | READ_QUEUED | READ_EMITTED_READABLE
const SHOULD_NOT_READ = OPEN_STATUS | READ_ACTIVE | READ_ENDING | READ_DONE | READ_NEEDS_PUSH | READ_READ_AHEAD
const READ_BACKPRESSURE_STATUS = DESTROY_STATUS | READ_ENDING | READ_DONE
const READ_UPDATE_SYNC_STATUS = READ_UPDATING | OPEN_STATUS | READ_NEXT_TICK | READ_PRIMARY
const READ_NEXT_TICK_OR_OPENING = READ_NEXT_TICK | OPENING

// Combined write state
const WRITE_PRIMARY_STATUS = OPEN_STATUS | WRITE_FINISHING | WRITE_DONE
const WRITE_QUEUED_AND_UNDRAINED = WRITE_QUEUED | WRITE_UNDRAINED
const WRITE_QUEUED_AND_ACTIVE = WRITE_QUEUED | WRITE_ACTIVE
const WRITE_DRAIN_STATUS = WRITE_QUEUED | WRITE_UNDRAINED | OPEN_STATUS | WRITE_ACTIVE
const WRITE_STATUS = OPEN_STATUS | WRITE_ACTIVE | WRITE_QUEUED | WRITE_CORKED
const WRITE_PRIMARY_AND_ACTIVE = WRITE_PRIMARY | WRITE_ACTIVE
const WRITE_ACTIVE_AND_WRITING = WRITE_ACTIVE | WRITE_WRITING
const WRITE_FINISHING_STATUS = OPEN_STATUS | WRITE_FINISHING | WRITE_QUEUED_AND_ACTIVE | WRITE_DONE
const WRITE_BACKPRESSURE_STATUS = WRITE_UNDRAINED | DESTROY_STATUS | WRITE_FINISHING | WRITE_DONE
const WRITE_UPDATE_SYNC_STATUS = WRITE_UPDATING | OPEN_STATUS | WRITE_NEXT_TICK | WRITE_PRIMARY
const WRITE_DROP_DATA = WRITE_FINISHING | WRITE_DONE | DESTROY_STATUS

const asyncIterator = Symbol.asyncIterator || Symbol('asyncIterator')

class WritableState {
  constructor (stream, { highWaterMark = 16384, map = null, mapWritable, byteLength, byteLengthWritable } = {}) {
    this.stream = stream
    this.queue = new FIFO()
    this.highWaterMark = highWaterMark
    this.buffered = 0
    this.error = null
    this.pipeline = null
    this.drains = null // if we add more seldomly used helpers we might them into a subobject so its a single ptr
    this.byteLength = byteLengthWritable || byteLength || defaultByteLength
    this.map = mapWritable || map
    this.afterWrite = afterWrite.bind(this)
    this.afterUpdateNextTick = updateWriteNT.bind(this)
  }

  get ended () {
    return (this.stream._duplexState & WRITE_DONE) !== 0
  }

  push (data) {
    if ((this.stream._duplexState & WRITE_DROP_DATA) !== 0) return false
    if (this.map !== null) data = this.map(data)

    this.buffered += this.byteLength(data)
    this.queue.push(data)

    if (this.buffered < this.highWaterMark) {
      this.stream._duplexState |= WRITE_QUEUED
      return true
    }

    this.stream._duplexState |= WRITE_QUEUED_AND_UNDRAINED
    return false
  }

  shift () {
    const data = this.queue.shift()

    this.buffered -= this.byteLength(data)
    if (this.buffered === 0) this.stream._duplexState &= WRITE_NOT_QUEUED

    return data
  }

  end (data) {
    if (typeof data === 'function') this.stream.once('finish', data)
    else if (data !== undefined && data !== null) this.push(data)
    this.stream._duplexState = (this.stream._duplexState | WRITE_FINISHING) & WRITE_NON_PRIMARY
  }

  autoBatch (data, cb) {
    const buffer = []
    const stream = this.stream

    buffer.push(data)
    while ((stream._duplexState & WRITE_STATUS) === WRITE_QUEUED_AND_ACTIVE) {
      buffer.push(stream._writableState.shift())
    }

    if ((stream._duplexState & OPEN_STATUS) !== 0) return cb(null)
    stream._writev(buffer, cb)
  }

  update () {
    const stream = this.stream

    stream._duplexState |= WRITE_UPDATING

    do {
      while ((stream._duplexState & WRITE_STATUS) === WRITE_QUEUED) {
        const data = this.shift()
        stream._duplexState |= WRITE_ACTIVE_AND_WRITING
        stream._write(data, this.afterWrite)
      }

      if ((stream._duplexState & WRITE_PRIMARY_AND_ACTIVE) === 0) this.updateNonPrimary()
    } while (this.continueUpdate() === true)

    stream._duplexState &= WRITE_NOT_UPDATING
  }

  updateNonPrimary () {
    const stream = this.stream

    if ((stream._duplexState & WRITE_FINISHING_STATUS) === WRITE_FINISHING) {
      stream._duplexState = stream._duplexState | WRITE_ACTIVE
      stream._final(afterFinal.bind(this))
      return
    }

    if ((stream._duplexState & DESTROY_STATUS) === DESTROYING) {
      if ((stream._duplexState & ACTIVE_OR_TICKING) === 0) {
        stream._duplexState |= ACTIVE
        stream._destroy(afterDestroy.bind(this))
      }
      return
    }

    if ((stream._duplexState & IS_OPENING) === OPENING) {
      stream._duplexState = (stream._duplexState | ACTIVE) & NOT_OPENING
      stream._open(afterOpen.bind(this))
    }
  }

  continueUpdate () {
    if ((this.stream._duplexState & WRITE_NEXT_TICK) === 0) return false
    this.stream._duplexState &= WRITE_NOT_NEXT_TICK
    return true
  }

  updateCallback () {
    if ((this.stream._duplexState & WRITE_UPDATE_SYNC_STATUS) === WRITE_PRIMARY) this.update()
    else this.updateNextTick()
  }

  updateNextTick () {
    if ((this.stream._duplexState & WRITE_NEXT_TICK) !== 0) return
    this.stream._duplexState |= WRITE_NEXT_TICK
    if ((this.stream._duplexState & WRITE_UPDATING) === 0) qmt(this.afterUpdateNextTick)
  }
}

class ReadableState {
  constructor (stream, { highWaterMark = 16384, map = null, mapReadable, byteLength, byteLengthReadable } = {}) {
    this.stream = stream
    this.queue = new FIFO()
    this.highWaterMark = highWaterMark === 0 ? 1 : highWaterMark
    this.buffered = 0
    this.readAhead = highWaterMark > 0
    this.error = null
    this.pipeline = null
    this.byteLength = byteLengthReadable || byteLength || defaultByteLength
    this.map = mapReadable || map
    this.pipeTo = null
    this.afterRead = afterRead.bind(this)
    this.afterUpdateNextTick = updateReadNT.bind(this)
  }

  get ended () {
    return (this.stream._duplexState & READ_DONE) !== 0
  }

  pipe (pipeTo, cb) {
    if (this.pipeTo !== null) throw new Error('Can only pipe to one destination')
    if (typeof cb !== 'function') cb = null

    this.stream._duplexState |= READ_PIPE_DRAINED
    this.pipeTo = pipeTo
    this.pipeline = new Pipeline(this.stream, pipeTo, cb)

    if (cb) this.stream.on('error', noop) // We already error handle this so supress crashes

    if (isStreamx(pipeTo)) {
      pipeTo._writableState.pipeline = this.pipeline
      if (cb) pipeTo.on('error', noop) // We already error handle this so supress crashes
      pipeTo.on('finish', this.pipeline.finished.bind(this.pipeline)) // TODO: just call finished from pipeTo itself
    } else {
      const onerror = this.pipeline.done.bind(this.pipeline, pipeTo)
      const onclose = this.pipeline.done.bind(this.pipeline, pipeTo, null) // onclose has a weird bool arg
      pipeTo.on('error', onerror)
      pipeTo.on('close', onclose)
      pipeTo.on('finish', this.pipeline.finished.bind(this.pipeline))
    }

    pipeTo.on('drain', afterDrain.bind(this))
    this.stream.emit('piping', pipeTo)
    pipeTo.emit('pipe', this.stream)
  }

  push (data) {
    const stream = this.stream

    if (data === null) {
      this.highWaterMark = 0
      stream._duplexState = (stream._duplexState | READ_ENDING) & READ_NON_PRIMARY_AND_PUSHED
      return false
    }

    if (this.map !== null) {
      data = this.map(data)
      if (data === null) {
        stream._duplexState &= READ_PUSHED
        return this.buffered < this.highWaterMark
      }
    }

    this.buffered += this.byteLength(data)
    this.queue.push(data)

    stream._duplexState = (stream._duplexState | READ_QUEUED) & READ_PUSHED

    return this.buffered < this.highWaterMark
  }

  shift () {
    const data = this.queue.shift()

    this.buffered -= this.byteLength(data)
    if (this.buffered === 0) this.stream._duplexState &= READ_NOT_QUEUED
    return data
  }

  unshift (data) {
    const pending = [this.map !== null ? this.map(data) : data]
    while (this.buffered > 0) pending.push(this.shift())

    for (let i = 0; i < pending.length - 1; i++) {
      const data = pending[i]
      this.buffered += this.byteLength(data)
      this.queue.push(data)
    }

    this.push(pending[pending.length - 1])
  }

  read () {
    const stream = this.stream

    if ((stream._duplexState & READ_STATUS) === READ_QUEUED) {
      const data = this.shift()
      if (this.pipeTo !== null && this.pipeTo.write(data) === false) stream._duplexState &= READ_PIPE_NOT_DRAINED
      if ((stream._duplexState & READ_EMIT_DATA) !== 0) stream.emit('data', data)
      return data
    }

    if (this.readAhead === false) {
      stream._duplexState |= READ_READ_AHEAD
      this.updateNextTick()
    }

    return null
  }

  drain () {
    const stream = this.stream

    while ((stream._duplexState & READ_STATUS) === READ_QUEUED && (stream._duplexState & READ_FLOWING) !== 0) {
      const data = this.shift()
      if (this.pipeTo !== null && this.pipeTo.write(data) === false) stream._duplexState &= READ_PIPE_NOT_DRAINED
      if ((stream._duplexState & READ_EMIT_DATA) !== 0) stream.emit('data', data)
    }
  }

  update () {
    const stream = this.stream

    stream._duplexState |= READ_UPDATING

    do {
      this.drain()

      while (this.buffered < this.highWaterMark && (stream._duplexState & SHOULD_NOT_READ) === READ_READ_AHEAD) {
        stream._duplexState |= READ_ACTIVE_AND_NEEDS_PUSH
        stream._read(this.afterRead)
        this.drain()
      }

      if ((stream._duplexState & READ_READABLE_STATUS) === READ_EMIT_READABLE_AND_QUEUED) {
        stream._duplexState |= READ_EMITTED_READABLE
        stream.emit('readable')
      }

      if ((stream._duplexState & READ_PRIMARY_AND_ACTIVE) === 0) this.updateNonPrimary()
    } while (this.continueUpdate() === true)

    stream._duplexState &= READ_NOT_UPDATING
  }

  updateNonPrimary () {
    const stream = this.stream

    if ((stream._duplexState & READ_ENDING_STATUS) === READ_ENDING) {
      stream._duplexState = (stream._duplexState | READ_DONE) & READ_NOT_ENDING
      stream.emit('end')
      if ((stream._duplexState & AUTO_DESTROY) === DONE) stream._duplexState |= DESTROYING
      if (this.pipeTo !== null) this.pipeTo.end()
    }

    if ((stream._duplexState & DESTROY_STATUS) === DESTROYING) {
      if ((stream._duplexState & ACTIVE_OR_TICKING) === 0) {
        stream._duplexState |= ACTIVE
        stream._destroy(afterDestroy.bind(this))
      }
      return
    }

    if ((stream._duplexState & IS_OPENING) === OPENING) {
      stream._duplexState = (stream._duplexState | ACTIVE) & NOT_OPENING
      stream._open(afterOpen.bind(this))
    }
  }

  continueUpdate () {
    if ((this.stream._duplexState & READ_NEXT_TICK) === 0) return false
    this.stream._duplexState &= READ_NOT_NEXT_TICK
    return true
  }

  updateCallback () {
    if ((this.stream._duplexState & READ_UPDATE_SYNC_STATUS) === READ_PRIMARY) this.update()
    else this.updateNextTick()
  }

  updateNextTickIfOpen () {
    if ((this.stream._duplexState & READ_NEXT_TICK_OR_OPENING) !== 0) return
    this.stream._duplexState |= READ_NEXT_TICK
    if ((this.stream._duplexState & READ_UPDATING) === 0) qmt(this.afterUpdateNextTick)
  }

  updateNextTick () {
    if ((this.stream._duplexState & READ_NEXT_TICK) !== 0) return
    this.stream._duplexState |= READ_NEXT_TICK
    if ((this.stream._duplexState & READ_UPDATING) === 0) qmt(this.afterUpdateNextTick)
  }
}

class TransformState {
  constructor (stream) {
    this.data = null
    this.afterTransform = afterTransform.bind(stream)
    this.afterFinal = null
  }
}

class Pipeline {
  constructor (src, dst, cb) {
    this.from = src
    this.to = dst
    this.afterPipe = cb
    this.error = null
    this.pipeToFinished = false
  }

  finished () {
    this.pipeToFinished = true
  }

  done (stream, err) {
    if (err) this.error = err

    if (stream === this.to) {
      this.to = null

      if (this.from !== null) {
        if ((this.from._duplexState & READ_DONE) === 0 || !this.pipeToFinished) {
          this.from.destroy(this.error || new Error('Writable stream closed prematurely'))
        }
        return
      }
    }

    if (stream === this.from) {
      this.from = null

      if (this.to !== null) {
        if ((stream._duplexState & READ_DONE) === 0) {
          this.to.destroy(this.error || new Error('Readable stream closed before ending'))
        }
        return
      }
    }

    if (this.afterPipe !== null) this.afterPipe(this.error)
    this.to = this.from = this.afterPipe = null
  }
}

function afterDrain () {
  this.stream._duplexState |= READ_PIPE_DRAINED
  this.updateCallback()
}

function afterFinal (err) {
  const stream = this.stream
  if (err) stream.destroy(err)
  if ((stream._duplexState & DESTROY_STATUS) === 0) {
    stream._duplexState |= WRITE_DONE
    stream.emit('finish')
  }
  if ((stream._duplexState & AUTO_DESTROY) === DONE) {
    stream._duplexState |= DESTROYING
  }

  stream._duplexState &= WRITE_NOT_FINISHING

  // no need to wait the extra tick here, so we short circuit that
  if ((stream._duplexState & WRITE_UPDATING) === 0) this.update()
  else this.updateNextTick()
}

function afterDestroy (err) {
  const stream = this.stream

  if (!err && this.error !== STREAM_DESTROYED) err = this.error
  if (err) stream.emit('error', err)
  stream._duplexState |= DESTROYED
  stream.emit('close')

  const rs = stream._readableState
  const ws = stream._writableState

  if (rs !== null && rs.pipeline !== null) rs.pipeline.done(stream, err)

  if (ws !== null) {
    while (ws.drains !== null && ws.drains.length > 0) ws.drains.shift().resolve(false)
    if (ws.pipeline !== null) ws.pipeline.done(stream, err)
  }
}

function afterWrite (err) {
  const stream = this.stream

  if (err) stream.destroy(err)
  stream._duplexState &= WRITE_NOT_ACTIVE

  if (this.drains !== null) tickDrains(this.drains)

  if ((stream._duplexState & WRITE_DRAIN_STATUS) === WRITE_UNDRAINED) {
    stream._duplexState &= WRITE_DRAINED
    if ((stream._duplexState & WRITE_EMIT_DRAIN) === WRITE_EMIT_DRAIN) {
      stream.emit('drain')
    }
  }

  this.updateCallback()
}

function afterRead (err) {
  if (err) this.stream.destroy(err)
  this.stream._duplexState &= READ_NOT_ACTIVE
  if (this.readAhead === false && (this.stream._duplexState & READ_RESUMED) === 0) this.stream._duplexState &= READ_NO_READ_AHEAD
  this.updateCallback()
}

function updateReadNT () {
  if ((this.stream._duplexState & READ_UPDATING) === 0) {
    this.stream._duplexState &= READ_NOT_NEXT_TICK
    this.update()
  }
}

function updateWriteNT () {
  if ((this.stream._duplexState & WRITE_UPDATING) === 0) {
    this.stream._duplexState &= WRITE_NOT_NEXT_TICK
    this.update()
  }
}

function tickDrains (drains) {
  for (let i = 0; i < drains.length; i++) {
    // drains.writes are monotonic, so if one is 0 its always the first one
    if (--drains[i].writes === 0) {
      drains.shift().resolve(true)
      i--
    }
  }
}

function afterOpen (err) {
  const stream = this.stream

  if (err) stream.destroy(err)

  if ((stream._duplexState & DESTROYING) === 0) {
    if ((stream._duplexState & READ_PRIMARY_STATUS) === 0) stream._duplexState |= READ_PRIMARY
    if ((stream._duplexState & WRITE_PRIMARY_STATUS) === 0) stream._duplexState |= WRITE_PRIMARY
    stream.emit('open')
  }

  stream._duplexState &= NOT_ACTIVE

  if (stream._writableState !== null) {
    stream._writableState.updateCallback()
  }

  if (stream._readableState !== null) {
    stream._readableState.updateCallback()
  }
}

function afterTransform (err, data) {
  if (data !== undefined && data !== null) this.push(data)
  this._writableState.afterWrite(err)
}

function newListener (name) {
  if (this._readableState !== null) {
    if (name === 'data') {
      this._duplexState |= (READ_EMIT_DATA | READ_RESUMED_READ_AHEAD)
      this._readableState.updateNextTick()
    }
    if (name === 'readable') {
      this._duplexState |= READ_EMIT_READABLE
      this._readableState.updateNextTick()
    }
  }

  if (this._writableState !== null) {
    if (name === 'drain') {
      this._duplexState |= WRITE_EMIT_DRAIN
      this._writableState.updateNextTick()
    }
  }
}

class Stream extends EventEmitter {
  constructor (opts) {
    super()

    this._duplexState = 0
    this._readableState = null
    this._writableState = null

    if (opts) {
      if (opts.open) this._open = opts.open
      if (opts.destroy) this._destroy = opts.destroy
      if (opts.predestroy) this._predestroy = opts.predestroy
      if (opts.signal) {
        opts.signal.addEventListener('abort', abort.bind(this))
      }
    }

    this.on('newListener', newListener)
  }

  _open (cb) {
    cb(null)
  }

  _destroy (cb) {
    cb(null)
  }

  _predestroy () {
    // does nothing
  }

  get readable () {
    return this._readableState !== null ? true : undefined
  }

  get writable () {
    return this._writableState !== null ? true : undefined
  }

  get destroyed () {
    return (this._duplexState & DESTROYED) !== 0
  }

  get destroying () {
    return (this._duplexState & DESTROY_STATUS) !== 0
  }

  destroy (err) {
    if ((this._duplexState & DESTROY_STATUS) === 0) {
      if (!err) err = STREAM_DESTROYED
      this._duplexState = (this._duplexState | DESTROYING) & NON_PRIMARY

      if (this._readableState !== null) {
        this._readableState.highWaterMark = 0
        this._readableState.error = err
      }
      if (this._writableState !== null) {
        this._writableState.highWaterMark = 0
        this._writableState.error = err
      }

      this._duplexState |= PREDESTROYING
      this._predestroy()
      this._duplexState &= NOT_PREDESTROYING

      if (this._readableState !== null) this._readableState.updateNextTick()
      if (this._writableState !== null) this._writableState.updateNextTick()
    }
  }
}

class Readable extends Stream {
  constructor (opts) {
    super(opts)

    this._duplexState |= OPENING | WRITE_DONE | READ_READ_AHEAD
    this._readableState = new ReadableState(this, opts)

    if (opts) {
      if (this._readableState.readAhead === false) this._duplexState &= READ_NO_READ_AHEAD
      if (opts.read) this._read = opts.read
      if (opts.eagerOpen) this._readableState.updateNextTick()
      if (opts.encoding) this.setEncoding(opts.encoding)
    }
  }

  setEncoding (encoding) {
    const dec = new TextDecoder(encoding)
    const map = this._readableState.map || echo
    this._readableState.map = mapOrSkip
    return this

    function mapOrSkip (data) {
      const next = dec.push(data)
      return next === '' && (data.byteLength !== 0 || dec.remaining > 0) ? null : map(next)
    }
  }

  _read (cb) {
    cb(null)
  }

  pipe (dest, cb) {
    this._readableState.updateNextTick()
    this._readableState.pipe(dest, cb)
    return dest
  }

  read () {
    this._readableState.updateNextTick()
    return this._readableState.read()
  }

  push (data) {
    this._readableState.updateNextTickIfOpen()
    return this._readableState.push(data)
  }

  unshift (data) {
    this._readableState.updateNextTickIfOpen()
    return this._readableState.unshift(data)
  }

  resume () {
    this._duplexState |= READ_RESUMED_READ_AHEAD
    this._readableState.updateNextTick()
    return this
  }

  pause () {
    this._duplexState &= (this._readableState.readAhead === false ? READ_PAUSED_NO_READ_AHEAD : READ_PAUSED)
    return this
  }

  static _fromAsyncIterator (ite, opts) {
    let destroy

    const rs = new Readable({
      ...opts,
      read (cb) {
        ite.next().then(push).then(cb.bind(null, null)).catch(cb)
      },
      predestroy () {
        destroy = ite.return()
      },
      destroy (cb) {
        if (!destroy) return cb(null)
        destroy.then(cb.bind(null, null)).catch(cb)
      }
    })

    return rs

    function push (data) {
      if (data.done) rs.push(null)
      else rs.push(data.value)
    }
  }

  static from (data, opts) {
    if (isReadStreamx(data)) return data
    if (data[asyncIterator]) return this._fromAsyncIterator(data[asyncIterator](), opts)
    if (!Array.isArray(data)) data = data === undefined ? [] : [data]

    let i = 0
    return new Readable({
      ...opts,
      read (cb) {
        this.push(i === data.length ? null : data[i++])
        cb(null)
      }
    })
  }

  static isBackpressured (rs) {
    return (rs._duplexState & READ_BACKPRESSURE_STATUS) !== 0 || rs._readableState.buffered >= rs._readableState.highWaterMark
  }

  static isPaused (rs) {
    return (rs._duplexState & READ_RESUMED) === 0
  }

  [asyncIterator] () {
    const stream = this

    let error = null
    let promiseResolve = null
    let promiseReject = null

    this.on('error', (err) => { error = err })
    this.on('readable', onreadable)
    this.on('close', onclose)

    return {
      [asyncIterator] () {
        return this
      },
      next () {
        return new Promise(function (resolve, reject) {
          promiseResolve = resolve
          promiseReject = reject
          const data = stream.read()
          if (data !== null) ondata(data)
          else if ((stream._duplexState & DESTROYED) !== 0) ondata(null)
        })
      },
      return () {
        return destroy(null)
      },
      throw (err) {
        return destroy(err)
      }
    }

    function onreadable () {
      if (promiseResolve !== null) ondata(stream.read())
    }

    function onclose () {
      if (promiseResolve !== null) ondata(null)
    }

    function ondata (data) {
      if (promiseReject === null) return
      if (error) promiseReject(error)
      else if (data === null && (stream._duplexState & READ_DONE) === 0) promiseReject(STREAM_DESTROYED)
      else promiseResolve({ value: data, done: data === null })
      promiseReject = promiseResolve = null
    }

    function destroy (err) {
      stream.destroy(err)
      return new Promise((resolve, reject) => {
        if (stream._duplexState & DESTROYED) return resolve({ value: undefined, done: true })
        stream.once('close', function () {
          if (err) reject(err)
          else resolve({ value: undefined, done: true })
        })
      })
    }
  }
}

class Writable extends Stream {
  constructor (opts) {
    super(opts)

    this._duplexState |= OPENING | READ_DONE
    this._writableState = new WritableState(this, opts)

    if (opts) {
      if (opts.writev) this._writev = opts.writev
      if (opts.write) this._write = opts.write
      if (opts.final) this._final = opts.final
      if (opts.eagerOpen) this._writableState.updateNextTick()
    }
  }

  cork () {
    this._duplexState |= WRITE_CORKED
  }

  uncork () {
    this._duplexState &= WRITE_NOT_CORKED
    this._writableState.updateNextTick()
  }

  _writev (batch, cb) {
    cb(null)
  }

  _write (data, cb) {
    this._writableState.autoBatch(data, cb)
  }

  _final (cb) {
    cb(null)
  }

  static isBackpressured (ws) {
    return (ws._duplexState & WRITE_BACKPRESSURE_STATUS) !== 0
  }

  static drained (ws) {
    if (ws.destroyed) return Promise.resolve(false)
    const state = ws._writableState
    const pending = (isWritev(ws) ? Math.min(1, state.queue.length) : state.queue.length)
    const writes = pending + ((ws._duplexState & WRITE_WRITING) ? 1 : 0)
    if (writes === 0) return Promise.resolve(true)
    if (state.drains === null) state.drains = []
    return new Promise((resolve) => {
      state.drains.push({ writes, resolve })
    })
  }

  write (data) {
    this._writableState.updateNextTick()
    return this._writableState.push(data)
  }

  end (data) {
    this._writableState.updateNextTick()
    this._writableState.end(data)
    return this
  }
}

class Duplex extends Readable { // and Writable
  constructor (opts) {
    super(opts)

    this._duplexState = OPENING | (this._duplexState & READ_READ_AHEAD)
    this._writableState = new WritableState(this, opts)

    if (opts) {
      if (opts.writev) this._writev = opts.writev
      if (opts.write) this._write = opts.write
      if (opts.final) this._final = opts.final
    }
  }

  cork () {
    this._duplexState |= WRITE_CORKED
  }

  uncork () {
    this._duplexState &= WRITE_NOT_CORKED
    this._writableState.updateNextTick()
  }

  _writev (batch, cb) {
    cb(null)
  }

  _write (data, cb) {
    this._writableState.autoBatch(data, cb)
  }

  _final (cb) {
    cb(null)
  }

  write (data) {
    this._writableState.updateNextTick()
    return this._writableState.push(data)
  }

  end (data) {
    this._writableState.updateNextTick()
    this._writableState.end(data)
    return this
  }
}

class Transform extends Duplex {
  constructor (opts) {
    super(opts)
    this._transformState = new TransformState(this)

    if (opts) {
      if (opts.transform) this._transform = opts.transform
      if (opts.flush) this._flush = opts.flush
    }
  }

  _write (data, cb) {
    if (this._readableState.buffered >= this._readableState.highWaterMark) {
      this._transformState.data = data
    } else {
      this._transform(data, this._transformState.afterTransform)
    }
  }

  _read (cb) {
    if (this._transformState.data !== null) {
      const data = this._transformState.data
      this._transformState.data = null
      cb(null)
      this._transform(data, this._transformState.afterTransform)
    } else {
      cb(null)
    }
  }

  destroy (err) {
    super.destroy(err)
    if (this._transformState.data !== null) {
      this._transformState.data = null
      this._transformState.afterTransform()
    }
  }

  _transform (data, cb) {
    cb(null, data)
  }

  _flush (cb) {
    cb(null)
  }

  _final (cb) {
    this._transformState.afterFinal = cb
    this._flush(transformAfterFlush.bind(this))
  }
}

class PassThrough extends Transform {}

function transformAfterFlush (err, data) {
  const cb = this._transformState.afterFinal
  if (err) return cb(err)
  if (data !== null && data !== undefined) this.push(data)
  this.push(null)
  cb(null)
}

function pipelinePromise (...streams) {
  return new Promise((resolve, reject) => {
    return pipeline(...streams, (err) => {
      if (err) return reject(err)
      resolve()
    })
  })
}

function pipeline (stream, ...streams) {
  const all = Array.isArray(stream) ? [...stream, ...streams] : [stream, ...streams]
  const done = (all.length && typeof all[all.length - 1] === 'function') ? all.pop() : null

  if (all.length < 2) throw new Error('Pipeline requires at least 2 streams')

  let src = all[0]
  let dest = null
  let error = null

  for (let i = 1; i < all.length; i++) {
    dest = all[i]

    if (isStreamx(src)) {
      src.pipe(dest, onerror)
    } else {
      errorHandle(src, true, i > 1, onerror)
      src.pipe(dest)
    }

    src = dest
  }

  if (done) {
    let fin = false

    const autoDestroy = isStreamx(dest) || !!(dest._writableState && dest._writableState.autoDestroy)

    dest.on('error', (err) => {
      if (error === null) error = err
    })

    dest.on('finish', () => {
      fin = true
      if (!autoDestroy) done(error)
    })

    if (autoDestroy) {
      dest.on('close', () => done(error || (fin ? null : PREMATURE_CLOSE)))
    }
  }

  return dest

  function errorHandle (s, rd, wr, onerror) {
    s.on('error', onerror)
    s.on('close', onclose)

    function onclose () {
      if (rd && s._readableState && !s._readableState.ended) return onerror(PREMATURE_CLOSE)
      if (wr && s._writableState && !s._writableState.ended) return onerror(PREMATURE_CLOSE)
    }
  }

  function onerror (err) {
    if (!err || error) return
    error = err

    for (const s of all) {
      s.destroy(err)
    }
  }
}

function echo (s) {
  return s
}

function isStream (stream) {
  return !!stream._readableState || !!stream._writableState
}

function isStreamx (stream) {
  return typeof stream._duplexState === 'number' && isStream(stream)
}

function isEnded (stream) {
  return !!stream._readableState && stream._readableState.ended
}

function isFinished (stream) {
  return !!stream._writableState && stream._writableState.ended
}

function getStreamError (stream, opts = {}) {
  const err = (stream._readableState && stream._readableState.error) || (stream._writableState && stream._writableState.error)

  // avoid implicit errors by default
  return (!opts.all && err === STREAM_DESTROYED) ? null : err
}

function isReadStreamx (stream) {
  return isStreamx(stream) && stream.readable
}

function isDisturbed (stream) {
  return (stream._duplexState & OPENING) !== OPENING || (stream._duplexState & ACTIVE_OR_TICKING) !== 0
}

function isTypedArray (data) {
  return typeof data === 'object' && data !== null && typeof data.byteLength === 'number'
}

function defaultByteLength (data) {
  return isTypedArray(data) ? data.byteLength : 1024
}

function noop () {}

function abort () {
  this.destroy(new Error('Stream aborted.'))
}

function isWritev (s) {
  return s._writev !== Writable.prototype._writev && s._writev !== Duplex.prototype._writev
}

module.exports = {
  pipeline,
  pipelinePromise,
  isStream,
  isStreamx,
  isEnded,
  isFinished,
  isDisturbed,
  getStreamError,
  Stream,
  Writable,
  Readable,
  Duplex,
  Transform,
  // Export PassThrough for compatibility with Node.js core's stream module
  PassThrough
}
{
  "name": "streamx",
  "version": "2.22.1",
  "description": "An iteration of the Node.js core streams with a series of improvements",
  "main": "index.js",
  "dependencies": {
    "fast-fifo": "^1.3.2",
    "text-decoder": "^1.1.0"
  },
  "devDependencies": {
    "b4a": "^1.6.6",
    "brittle": "^3.1.1",
    "end-of-stream": "^1.4.4",
    "standard": "^17.0.0"
  },
  "optionalDependencies": {
    "bare-events": "^2.2.0"
  },
  "files": [
    "index.js"
  ],
  "imports": {
    "events": {
      "bare": "bare-events",
      "default": "events"
    }
  },
  "scripts": {
    "test": "standard && brittle test/*.js"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/mafintosh/streamx.git"
  },
  "author": "Mathias Buus (@mafintosh)",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/mafintosh/streamx/issues"
  },
  "homepage": "https://github.com/mafintosh/streamx"
}
const PassThroughDecoder = require('./lib/pass-through-decoder')
const UTF8Decoder = require('./lib/utf8-decoder')

module.exports = class TextDecoder {
  constructor (encoding = 'utf8') {
    this.encoding = normalizeEncoding(encoding)

    switch (this.encoding) {
      case 'utf8':
        this.decoder = new UTF8Decoder()
        break
      case 'utf16le':
      case 'base64':
        throw new Error('Unsupported encoding: ' + this.encoding)
      default:
        this.decoder = new PassThroughDecoder(this.encoding)
    }
  }

  get remaining () {
    return this.decoder.remaining
  }

  push (data) {
    if (typeof data === 'string') return data
    return this.decoder.decode(data)
  }

  // For Node.js compatibility
  write (data) {
    return this.push(data)
  }

  end (data) {
    let result = ''
    if (data) result = this.push(data)
    result += this.decoder.flush()
    return result
  }
}

function normalizeEncoding (encoding) {
  encoding = encoding.toLowerCase()

  switch (encoding) {
    case 'utf8':
    case 'utf-8':
      return 'utf8'
    case 'ucs2':
    case 'ucs-2':
    case 'utf16le':
    case 'utf-16le':
      return 'utf16le'
    case 'latin1':
    case 'binary':
      return 'latin1'
    case 'base64':
    case 'ascii':
    case 'hex':
      return encoding
    default:
      throw new Error('Unknown encoding: ' + encoding)
  }
};
const b4a = require('b4a')

module.exports = class PassThroughDecoder {
  constructor (encoding) {
    this.encoding = encoding
  }

  get remaining () {
    return 0
  }

  decode (tail) {
    return b4a.toString(tail, this.encoding)
  }

  flush () {
    return ''
  }
}
const b4a = require('b4a')

/**
 * https://encoding.spec.whatwg.org/#utf-8-decoder
 */
module.exports = class UTF8Decoder {
  constructor () {
    this.codePoint = 0
    this.bytesSeen = 0
    this.bytesNeeded = 0
    this.lowerBoundary = 0x80
    this.upperBoundary = 0xbf
  }

  get remaining () {
    return this.bytesSeen
  }

  decode (data) {
    // If we have a fast path, just sniff if the last part is a boundary
    if (this.bytesNeeded === 0) {
      let isBoundary = true

      for (let i = Math.max(0, data.byteLength - 4), n = data.byteLength; i < n && isBoundary; i++) {
        isBoundary = data[i] <= 0x7f
      }

      if (isBoundary) return b4a.toString(data, 'utf8')
    }

    let result = ''

    for (let i = 0, n = data.byteLength; i < n; i++) {
      const byte = data[i]

      if (this.bytesNeeded === 0) {
        if (byte <= 0x7f) {
          result += String.fromCharCode(byte)
        } else {
          this.bytesSeen = 1

          if (byte >= 0xc2 && byte <= 0xdf) {
            this.bytesNeeded = 2
            this.codePoint = byte & 0x1f
          } else if (byte >= 0xe0 && byte <= 0xef) {
            if (byte === 0xe0) this.lowerBoundary = 0xa0
            else if (byte === 0xed) this.upperBoundary = 0x9f
            this.bytesNeeded = 3
            this.codePoint = byte & 0xf
          } else if (byte >= 0xf0 && byte <= 0xf4) {
            if (byte === 0xf0) this.lowerBoundary = 0x90
            if (byte === 0xf4) this.upperBoundary = 0x8f
            this.bytesNeeded = 4
            this.codePoint = byte & 0x7
          } else {
            result += '\ufffd'
          }
        }

        continue
      }

      if (byte < this.lowerBoundary || byte > this.upperBoundary) {
        this.codePoint = 0
        this.bytesNeeded = 0
        this.bytesSeen = 0
        this.lowerBoundary = 0x80
        this.upperBoundary = 0xbf

        result += '\ufffd'

        continue
      }

      this.lowerBoundary = 0x80
      this.upperBoundary = 0xbf

      this.codePoint = (this.codePoint << 6) | (byte & 0x3f)
      this.bytesSeen++

      if (this.bytesSeen !== this.bytesNeeded) continue

      result += String.fromCodePoint(this.codePoint)

      this.codePoint = 0
      this.bytesNeeded = 0
      this.bytesSeen = 0
    }

    return result
  }

  flush () {
    const result = this.bytesNeeded > 0 ? '\ufffd' : ''

    this.codePoint = 0
    this.bytesNeeded = 0
    this.bytesSeen = 0
    this.lowerBoundary = 0x80
    this.upperBoundary = 0xbf

    return result
  }
}
{
  "name": "text-decoder",
  "version": "1.2.3",
  "description": "Streaming text decoder that preserves multibyte Unicode characters",
  "main": "index.js",
  "files": [
    "index.js",
    "lib"
  ],
  "browser": {
    "./lib/pass-through-decoder.js": "./lib/browser-decoder.js",
    "./lib/utf8-decoder.js": "./lib/browser-decoder.js"
  },
  "react-native": {
    "./lib/pass-through-decoder.js": "./lib/pass-through-decoder.js",
    "./lib/utf8-decoder.js": "./lib/utf8-decoder.js"
  },
  "scripts": {
    "test": "standard && brittle test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/text-decoder.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/text-decoder/issues"
  },
  "homepage": "https://github.com/holepunchto/text-decoder#readme",
  "dependencies": {
    "b4a": "^1.6.4"
  },
  "devDependencies": {
    "brittle": "^3.3.2",
    "standard": "^17.0.0"
  }
}
// This file is a tmp workaround until variadic args land in tiny-buffer-rpc

const b4a = require('b4a')
const c = require('compact-encoding')
const { uint, utf8 } = c

const anyUndefined = {
  preencode (state, n) {
    // do nothing
  },
  encode (state, n) {
    // do nothing
  },
  decode (state) {
    return undefined
  }
}

// "any" encoders here for helping just structure any object without schematising it

const anyArray = {
  preencode (state, arr) {
    uint.preencode(state, arr.length)
    for (let i = 0; i < arr.length; i++) {
      any.preencode(state, arr[i])
    }
  },
  encode (state, arr) {
    uint.encode(state, arr.length)
    for (let i = 0; i < arr.length; i++) {
      any.encode(state, arr[i])
    }
  },
  decode (state) {
    const arr = []
    let len = uint.decode(state)
    while (len-- > 0) {
      arr.push(any.decode(state))
    }
    return arr
  }
}

const anyObject = {
  preencode (state, o) {
    const keys = Object.keys(o)
    uint.preencode(state, keys.length)
    for (const key of keys) {
      utf8.preencode(state, key)
      any.preencode(state, o[key])
    }
  },
  encode (state, o) {
    const keys = Object.keys(o)
    uint.encode(state, keys.length)
    for (const key of keys) {
      utf8.encode(state, key)
      any.encode(state, o[key])
    }
  },
  decode (state) {
    let len = uint.decode(state)
    const o = {}
    while (len-- > 0) {
      const key = utf8.decode(state)
      o[key] = any.decode(state)
    }
    return o
  }
}

const anyTypes = [
  c.none,
  anyUndefined,
  c.bool,
  c.string,
  c.buffer,
  c.uint,
  c.int,
  c.float64,
  anyArray,
  anyObject
]

const any = module.exports = {
  preencode (state, o) {
    const t = getType(o)
    uint.preencode(state, t)
    anyTypes[t].preencode(state, o)
  },
  encode (state, o) {
    const t = getType(o)
    uint.encode(state, t)
    anyTypes[t].encode(state, o)
  },
  decode (state) {
    const t = uint.decode(state)
    if (t >= anyTypes.length) throw new Error('Unknown type: ' + t)
    return anyTypes[t].decode(state)
  }
}

function getType (o) {
  if (o === null) return 0
  if (o === undefined) return 1
  if (typeof o === 'boolean') return 2
  if (typeof o === 'string') return 3
  if (b4a.isBuffer(o)) return 4
  if (typeof o === 'number') {
    if (Number.isInteger(o)) return o >= 0 ? 5 : 6
    return 7
  }
  if (Array.isArray(o)) return 8
  if (typeof o === 'object') return 9

  throw new Error('Unsupported type for ' + o)
}
const { getStreamError, Duplex } = require('streamx')
const c = require('compact-encoding')
const safetyCatch = require('safety-catch')
const b4a = require('b4a')

// Primary message flags (4 bits)
const MESSAGE_SEND = 0b0001
const MESSAGE_REQUEST = 0b0010
const MESSAGE_RESPONSE = 0b0100
const MESSAGE_ERROR = 0b1000

// Stream message flags (6 bits, with a 4 bit offset for primary message flags)
const STREAMING_MASK = ((1 << 6) - 1) << 4
const STREAM_OPEN = 0b000001 << 4
const STREAM_CLOSE = 0b000010 << 4
const STREAM_PAUSE = 0b000100 << 4
const STREAM_RESUME = 0b001000 << 4
const STREAM_DATA = 0b010000 << 4
const STREAM_END = 0b100000 << 4

// Stream status flags (2 bits, with a 10 bit offset)
const STREAM_IS_INITIATOR = 0b01 << 10
const STREAM_HAS_ERROR = 0b10 << 10

const REQUEST = MESSAGE_SEND | MESSAGE_REQUEST

const {
  Header,
  Message,
  ErrorMessage
} = require('./messages.js')

class Request {
  constructor (method, id, type, data) {
    this.type = type
    this.id = id
    this.method = method
    this.sent = false
    this.data = data
  }

  _respond (data) {
    if (this._sent) throw new Error('Response already sent')
    this.sent = true
    this.method._rpc._sendMessage({
      bitfield: MESSAGE_RESPONSE,
      id: this.id,
      method: this.method._method,
      data: c.encode(this.method._response, data)
    })
  }

  _error (err) {
    if (this._sent) throw new Error('Response already sent')
    this.sent = true
    this.method._rpc._sendMessage({
      bitfield: MESSAGE_ERROR,
      id: this.id,
      method: this.method._method,
      data: c.encode(ErrorMessage, err)
    })
  }
}

class RPCStream extends Duplex {
  constructor (method, id, initiator, remoteId, dedup) {
    super({ eagerOpen: true })

    this._method = method
    this._initiator = initiator

    this._localId = id
    this._remoteId = remoteId
    this._dedup = dedup
    this._lastMessage = null

    this._remotePaused = true
    this._sentPause = false
    this._sentOpen = false
    this._initiatedDestroy = false

    this._writeBatch = null
    this._writeCallback = null
    this._openCallback = null
  }

  _sendBatch (batch) {
    const bitfield = MESSAGE_SEND | STREAM_DATA
    const dataEncoding = this._initiator ? this._method._responseArray : this._method._requestArray
    const data = c.encode(dataEncoding, batch)

    if (this._dedup) {
      if (this._lastMessage && b4a.equals(this._lastMessage, data)) return
      this._lastMessage = data
    }

    this._method._sendMessage(this._remoteId, bitfield, data)
  }

  _remoteOpened (remoteId) {
    this._remoteId = remoteId
    this._continueOpen(null)
  }

  _remoteClosed (err) {
    this._remoteId = -1
    this.destroy(err)
  }

  _remotePause () {
    this._remotePaused = true
  }

  _remoteResume () {
    this._remotePaused = false
    if (!this._writeBatch) return

    this._sendBatch(this._writeBatch)
    this._writeBatch = null
    this._continueWrite(null)
  }

  _sendOpen () {
    if (this._sentOpen) return

    let bitfield = MESSAGE_SEND | STREAM_OPEN
    if (this._initiator) bitfield |= STREAM_IS_INITIATOR

    const id = this._initiator ? this._localId : this._remoteId
    const data = this._initiator ? null : c.encode(c.uint, this._localId)

    this._sentOpen = true
    this._method._sendMessage(id, bitfield, data)
  }

  _open (cb) {
    this._sendOpen()

    if (this._initiator) {
      this._openCallback = cb
    } else {
      cb()
    }
  }

  _continueOpen (err) {
    if (this._openCallback === null) return
    const cb = this._openCallback
    this._openCallback = null
    cb(err)
  }

  _read (cb) {
    this._method._sendMessage(this._remoteId, MESSAGE_SEND | STREAM_RESUME)
    cb()
  }

  _writev (batch, cb) {
    if (this._remotePaused) {
      this._writeBatch = batch
      this._writeCallback = cb
    } else {
      this._sendBatch(batch)
      cb()
    }
  }

  _continueWrite (err) {
    if (this._writeCallback === null) return
    const cb = this._writeCallback
    this._writeCallback = null
    cb(err)
  }

  _final (cb) {
    this._method._sendMessage(this._remoteId, MESSAGE_SEND | STREAM_END)
    cb()
  }

  _predestroy () {
    this._initiatedDestroy = true
    this._continueWrite(null)
  }

  _destroy (cb) {
    if (this._remoteId === -1 || this._initiatedDestroy === false || this._method.destroyed) {
      // if the remote side already sent a close or we are the initiator and we didn't open,
      // then we don't need to send a close message
      cb()
      return
    }

    const err = getStreamError(this)

    let bitfield = MESSAGE_SEND | STREAM_CLOSE
    if (err) bitfield |= STREAM_HAS_ERROR
    const data = err ? c.encode(ErrorMessage, err) : null

    this._method._sendMessage(this._remoteId, bitfield, data)
    cb()
  }
}

class Method {
  constructor (rpc, method, { request, response, dedup = false, onrequest, onstream } = {}) {
    this.destroyed = false

    this._rpc = rpc
    this._method = method

    this._request = request || c.buffer
    this._response = response || c.buffer
    this._requestArray = c.array(this._request)
    this._responseArray = c.array(this._response)

    this._dedup = dedup
    this._onrequest = onrequest
    this._onstream = onstream

    this._streams = []
    this._free = []
  }

  async _callOnRequest (req) {
    try {
      const data = await this._onrequest(req.data)
      req._respond(data)
    } catch (err) {
      req._error(err)
    }
  }

  async _callOnSend (data) {
    try {
      await this._onrequest(data)
    } catch (err) {
      safetyCatch(err)
    }
  }

  _createStream (initiator, remoteId) {
    const id = this._free.length ? this._free.pop() : (this._streams.push(null) - 1)
    const stream = new RPCStream(this, id, initiator, remoteId, this._dedup)
    this._streams[id] = stream
    return stream
  }

  _handleStreamOpen (id, bitfield, state) {
    if (bitfield & STREAM_IS_INITIATOR) {
      // Create the responder stream
      const stream = this._createStream(false, id)
      this._onstream(stream)
    } else {
      const stream = this._streams[id]
      stream._remoteOpened(c.uint.decode(state))
    }
  }

  _handleStreamClose (id, bitfield, state) {
    const stream = this._streams[id]
    if (bitfield & STREAM_HAS_ERROR) {
      const err = ErrorMessage.decode(state)
      stream._remoteClosed(err)
    } else {
      stream._remoteClosed(null)
    }
    this._streams[id] = null
    this._free.push(id)
  }

  _handleStreamPause (id) {
    const stream = this._streams[id]
    if (stream) stream._remotePause()
  }

  _handleStreamResume (id) {
    const stream = this._streams[id]
    if (stream) stream._remoteResume()
  }

  _handleStreamEnd (id) {
    const stream = this._streams[id]
    if (stream) stream.push(null)
  }

  _handleStreamData (id, state) {
    const stream = this._streams[id]
    if (!stream) return

    let data = null
    if (stream._initiator) {
      data = this._responseArray.decode(state)
    } else {
      data = this._requestArray.decode(state)
    }

    // TODO: Should we buffer the remainder of the array?
    let stop = false
    for (const item of data) {
      stop = stream.push(item)
    }

    if (stop === false) {
      if (!stream._sentPause) {
        stream._sentPause = true
        this._sendMessage(stream._remoteId, MESSAGE_SEND | STREAM_PAUSE)
      }
    }
  }

  _handleStreamSend (id, bitfield, state) {
    if (bitfield & STREAM_OPEN) {
      this._handleStreamOpen(id, bitfield, state)
    } else if (bitfield & STREAM_CLOSE) {
      this._handleStreamClose(id, bitfield, state)
    } else if (bitfield & STREAM_PAUSE) {
      this._handleStreamPause(id)
    } else if (bitfield & STREAM_RESUME) {
      this._handleStreamResume(id)
    } else if (bitfield & STREAM_DATA) {
      this._handleStreamData(id, state)
    } else if (bitfield & STREAM_END) {
      this._handleStreamEnd(id)
    }
  }

  _handleSend (id, bitfield, state) {
    if (bitfield & STREAMING_MASK) {
      this._handleStreamSend(id, bitfield, state)
    } else {
      this._callOnSend(this._request.decode(state))
    }
  }

  _handleRequest (id, bitfield, state) {
    if (this.destroyed) return
    if (bitfield & MESSAGE_SEND) {
      this._handleSend(id, bitfield, state)
    } else {
      const req = new Request(this, id, bitfield, this._request.decode(state))
      this._callOnRequest(req)
    }
  }

  _handleResponse (req, bitfield, state) {
    if (this.destroyed) return
    if (bitfield & MESSAGE_ERROR) {
      const { errno, message, stack, code } = ErrorMessage.decode(state)
      const err = new Error()
      err.errno = errno
      err.message = message
      err.stack = stack
      err.code = code
      req.reject(err)
    } else {
      req.resolve(this._response.decode(state))
    }
    this._rpc._reqs[req.id] = null
    this._rpc._free.push(req.id)
  }

  _sendMessage (id, bitfield, data) {
    this._rpc._sendMessage({
      method: this._method,
      bitfield,
      id,
      data
    })
  }

  request (data) {
    if (this.destroyed) return Promise.reject(new Error('RPC destroyed'))
    const req = this._rpc._createRequest()
    this._sendMessage(req.id, MESSAGE_REQUEST, c.encode(this._request, data))
    return req.promise
  }

  send (data) {
    if (this.destroyed) return
    this._sendMessage(0, MESSAGE_SEND, c.encode(this._request, data))
  }

  createRequestStream () {
    if (this.destroyed) throw new Error('RPC destroyed')
    return this._createStream(true, -1)
  }

  destroy () {
    this.destroyed = true
    for (const s of this._streams) {
      if (s === null) continue
      s.destroy(new Error('RPC destroyed'))
    }
  }
}

module.exports = class TinyBufferRPC {
  constructor (send) {
    this.destroyed = false
    this._send = send
    this._handlers = []
    this._pending = []
    this._reqs = []
    this._free = []
    this._corked = false
  }

  _createRequest () {
    const id = this._free.length ? this._free.pop() : (this._reqs.push(null) - 1)
    const req = { id, promise: null, resolve: null, reject: null }
    this._reqs[id] = req
    req.promise = new Promise((resolve, reject) => {
      req.resolve = resolve
      req.reject = reject
    })
    return req
  }

  _sendMessage (msg) {
    if (this.destroyed) return
    const data = c.encode(Message, msg)
    if (this._corked) {
      this._pending.push(data)
      return
    }
    this._send(data)
  }

  register (id, opts = {}) {
    if (this._handlers[id]) throw new Error('Handler for this ID already exists')
    while (this._handlers.length <= id) this._handlers.push(null)
    const method = new Method(this, id, opts)
    this._handlers[id] = method
    return method
  }

  cork () {
    this._corked = true
  }

  uncork () {
    this._corked = false
    // TODO: Use a slab pattern here to avoid the concat
    if (!this.destroyed) this._send(b4a.concat(this._pending))
    this._pending = []
  }

  recv (buf) {
    const state = { start: 0, end: buf.length, buffer: buf }
    while (state.start < state.end) {
      const { id, bitfield, method } = Header.decode(state)
      if (bitfield & REQUEST) {
        const handler = this._handlers[method]
        if (!handler) throw new Error('Got a request for an unsupported method')
        else handler._handleRequest(id, bitfield, state)
      } else {
        const req = this._reqs[id]
        const handler = this._handlers[method]
        if (!req) throw new Error('Got a response for an invalid request ID')
        if (!handler) throw new Error('Got a response for an invalid method ID')
        handler._handleResponse(req, bitfield, state)
      }
    }
  }

  destroy () {
    this.destroyed = true
    while (this._reqs.length) {
      const req = this._reqs.pop()
      if (req === null) continue
      req.reject(new Error('RPC destroyed'))
    }
    for (const h of this._handlers) {
      if (h === null) continue
      h.destroy()
    }
  }
}
const c = require('compact-encoding')

const KNOWN_BYTE = 0x74 // 't' for tiny-buffer-rpc

const Header = {
  preencode (state, h) {
    c.uint.preencode(state, KNOWN_BYTE)
    c.uint.preencode(state, h.method)
    c.uint.preencode(state, h.id)
    c.uint.preencode(state, h.bitfield)
  },
  encode (state, h) {
    c.uint.encode(state, KNOWN_BYTE)
    c.uint.encode(state, h.method)
    c.uint.encode(state, h.id)
    c.uint.encode(state, h.bitfield)
  },
  decode (state) {
    const known = c.uint.decode(state)
    if (known !== KNOWN_BYTE) throw Error('Message at start = ' + state.start + ' end = ' + state.end + ' does not look like a TinyRPC message')

    return {
      method: c.uint.decode(state),
      id: c.uint.decode(state),
      bitfield: c.uint.decode(state)
    }
  }
}
module.exports.Header = Header

module.exports.Message = {
  preencode (state, m) {
    Header.preencode(state, m)
    if (m.data) c.raw.preencode(state, m.data)
  },
  encode (state, m) {
    Header.encode(state, m)
    if (m.data) c.raw.encode(state, m.data)
  },
  decode (state) {
    return {
      ...Header.decode(state),
      data: c.raw.decode(state)
    }
  }
}

module.exports.ErrorMessage = {
  preencode (state, e) {
    state.end++ // flags
    c.int.preencode(state, e.errno || 0)
    if (e.message) c.string.preencode(state, e.message)
    if (e.stack) c.string.preencode(state, e.stack)
    if (e.code) c.string.preencode(state, e.code)
  },
  encode (state, e) {
    const start = state.start++ // flags
    c.int.encode(state, e.errno || 0)

    let flags = 0
    if (e.message) {
      flags |= 1
      c.string.encode(state, e.message)
    }
    if (e.stack) {
      flags |= 2
      c.string.encode(state, e.stack)
    }
    if (e.code) {
      flags |= 4
      c.string.encode(state, e.code)
    }

    state.buffer[start] = flags
  },
  decode (state) {
    const flags = c.uint.decode(state)
    return {
      errno: c.int.decode(state),
      message: (flags & 1) !== 0 ? c.string.decode(state) : null,
      stack: (flags & 2) !== 0 ? c.string.decode(state) : null,
      code: (flags & 4) !== 0 ? c.string.decode(state) : null
    }
  }
}
{
  "name": "tiny-buffer-rpc",
  "version": "2.3.0",
  "description": "Lightweight binary RPC",
  "main": "index.js",
  "scripts": {
    "test": "standard && brittle test.js"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/holepunchto/tiny-buffer-rpc.git"
  },
  "author": "Holepunch",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/tiny-buffer-rpc/issues"
  },
  "homepage": "https://github.com/holepunchto/tiny-buffer-rpc#readme",
  "devDependencies": {
    "brittle": "^3.2.1",
    "standard": "^17.0.0"
  },
  "dependencies": {
    "b4a": "^1.6.3",
    "compact-encoding": "^2.11.0",
    "safety-catch": "^1.0.2",
    "streamx": "^2.13.2"
  }
}
const { runtime, platform, arch } = typeof Bare !== 'undefined'
  ? { runtime: 'bare', platform: global.Bare.platform, arch: global.Bare.arch }
  : typeof process !== 'undefined'
    ? { runtime: 'node', platform: global.process.platform, arch: global.process.arch }
    : typeof Window !== 'undefined'
      ? { runtime: 'browser', platform: 'unknown', arch: 'unknown' }
      : { runtime: 'unknown', platform: 'unknown', arch: 'unknown' }

exports.runtime = runtime
exports.platform = platform
exports.arch = arch
exports.isBare = runtime === 'bare'
exports.isBareKit = exports.isBare && typeof BareKit !== 'undefined'
exports.isPear = exports.isBare && typeof Pear !== 'undefined'
exports.isNode = runtime === 'node'
exports.isBrowser = runtime === 'browser'
exports.isWindows = platform === 'win32'
exports.isLinux = platform === 'linux'
exports.isMac = platform === 'darwin'
exports.isIOS = platform === 'ios' || platform === 'ios-simulator'
exports.isAndroid = platform === 'android'
exports.isElectron = typeof process !== 'undefined' && !!global.process.versions.electron
exports.isElectronRenderer = exports.isElectron && global.process.type === 'renderer'
exports.isElectronWorker = exports.isElectron && global.process.type === 'worker'
{
  "name": "which-runtime",
  "version": "1.3.0",
  "description": "Detect if you are in Bare or Node and which os etc",
  "main": "index.js",
  "files": [
    "index.js"
  ],
  "dependencies": {},
  "devDependencies": {
    "standard": "^17.0.0"
  },
  "scripts": {
    "test": "standard"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/holepunchto/which-runtime.git"
  },
  "author": "Holepunch Inc.",
  "license": "Apache-2.0",
  "bugs": {
    "url": "https://github.com/holepunchto/which-runtime/issues"
  },
  "homepage": "https://github.com/holepunchto/which-runtime"
}
{
  "name": "pearpass-native-messaging-bridge",
  "version": "0.0.1",
  "description": "Native messaging bridge for PearPass browser extension",
  "main": "index.js",
  "type": "commonjs",
  "scripts": {
    "start": "node index.js",
    "bundle:darwin": "bare-pack --platform darwin --arch arm64 index.js -o dist/index-macos-arm64",
    "bundle:linux": "bare-pack --platform linux --arch x64 index.js -o dist/index-linux-x64",
    "bundle:win32": "bare-pack --platform win32 --arch x64 index.js -o dist/index-win-x64",
    "bundle:all": "npm run bundle:darwin && npm run bundle:linux && npm run bundle:win32"
  },
  "dependencies": {
    "bare-fs": "4.5.0",
    "bare-os": "3.6.2",
    "bare-path": "3.0.0",
    "pear-ipc": "6.4.0"
  },
  "devDependencies": {
    "bare-pack": "1.4.8"
  },
  "engines": {
    "node": ">=14.0.0"
  }
}
const fs = require('bare-fs')
const os = require('bare-os')
const path = require('bare-path')

const DEBUG_MODE = false

/**
 * Returns cross-platform IPC path
 * Socket is stored in temp directory
 * @param {string} socketName
 * @returns {string}
 */
const getIpcPath = (socketName) => {
  if (os.platform() === 'win32') {
    return `\\\\?\\pipe\\${socketName}`
  }

  // Socket is in temp directory
  return path.join(os.tmpdir(), `${socketName}.sock`)
}

/**
 * Dedicated logger for native messaging bridge
 * Logs to the logs directory within the bridge module directory when in debug mode
 * @param {'INFO'|'ERROR'|'DEBUG'|'WARN'} level - Log level
 * @param {string} message - Log message
 */
const log = (level, message) => {
  if (!DEBUG_MODE) return

  try {
    const bridgeDir = path.dirname(__dirname)
    const logDir = path.join(bridgeDir, 'logs')
    const logFile = path.join(logDir, 'native-messaging-bridge.log')

    // Create logs directory if it doesn't exist
    if (!fs.existsSync(logDir)) {
      fs.mkdirSync(logDir, { recursive: true })
    }

    const timestamp = new Date().toISOString()
    const logMsg = `${timestamp} [${level}] [IPC-BRIDGE] ${message}\n`
    fs.appendFileSync(logFile, logMsg)
  } catch (e) {
    // eslint-disable-next-line no-console
    console.error(`Failed to write log: ${e.message}`)
  }
}

module.exports = {
  getIpcPath,
  log
}
